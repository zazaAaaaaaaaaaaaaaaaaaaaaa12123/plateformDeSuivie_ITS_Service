<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Connexion - Responsable Livraison</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <style>
      body {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        font-family: "Montserrat", sans-serif;
        min-height: 100vh;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .container {
        background: #fff;
        border-radius: 22px;
        box-shadow: 0 12px 40px rgba(30, 60, 114, 0.18);
        padding: 1rem 1.1rem 1.1rem 1.1rem;
        width: 100%;
        max-width: 420px;
        position: relative;
        overflow: visible;
        transition: box-shadow 0.3s;
        z-index: 2;
        min-height: unset;
      }
      .container:hover {
        box-shadow: 0 18px 60px rgba(30, 60, 114, 0.22);
      }
      .form-illustration {
        width: 65px;
        height: 65px;
        display: block;
        margin: 0 auto 0.5rem auto;
        border-radius: 50%;
        box-shadow: 0 4px 18px rgba(30, 60, 114, 0.13);
        object-fit: cover;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        padding: 6px;
        animation: truckMove 1.7s ease-in-out infinite;
      }
      @keyframes truckMove {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(12px);
        }
        100% {
          transform: translateY(0);
        }
      }
      .form-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        animation: fadeIn 0.5s;
        max-height: none;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        position: relative;
      }
      label {
        font-size: 1.08rem;
        color: #1e3c72;
        font-weight: 700;
        margin-bottom: 0.2rem;
        letter-spacing: 0.5px;
      }
      input[type="text"],
      input[type="email"],
      input[type="password"] {
        padding: 0.85rem 1.1rem 0.85rem 2.7rem;
        border: 2px solid #e3ecfa;
        border-radius: 10px;
        font-size: 1.08rem;
        background: #f7faff;
        transition: border 0.2s, box-shadow 0.2s;
        outline: none;
        box-shadow: 0 2px 8px rgba(30, 60, 114, 0.07);
      }
      input:focus {
        border: 2px solid #1e3c72;
        background: #e3ecfa;
        box-shadow: 0 4px 16px rgba(30, 60, 114, 0.13);
      }
      .input-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #1e3c72;
        font-size: 1.15rem;
        opacity: 0.8;
      }
      .btn {
        background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 1rem 0;
        font-size: 1.15rem;
        font-weight: 700;
        cursor: pointer;
        margin-top: 0.5rem;
        box-shadow: 0 4px 16px rgba(30, 60, 114, 0.13);
        transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
        letter-spacing: 1px;
      }
      .btn:hover {
        background: linear-gradient(90deg, #2a5298 0%, #1e3c72 100%);
        box-shadow: 0 8px 32px rgba(30, 60, 114, 0.18);
        transform: translateY(-2px) scale(1.03);
      }
      .btn-secondary {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        margin-top: 1rem;
      }
      .btn-secondary:hover {
        background: linear-gradient(90deg, #20c997 0%, #28a745 100%);
      }
      .message {
        margin-top: 0.5rem;
        font-size: 1.05rem;
        text-align: center;
        color: #e74c3c;
        min-height: 1.2em;
        font-weight: 600;
      }
      .success {
        color: #27ae60;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .show-password {
        position: absolute;
        right: 1.2rem;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #b0b8c1;
        font-size: 1.15rem;
        z-index: 2;
      }
      .form-group.password-group {
        position: relative;
      }
      .forgot-link {
        text-align: right;
        margin-top: 0.5rem;
      }
      .forgot-link a {
        color: #1e3c72;
        font-size: 1.05rem;
        text-decoration: underline;
        font-weight: 600;
      }
      @media (max-width: 1200px) {
        .container {
          max-width: 520px;
          padding: 2rem 1.5rem 1.5rem 1.5rem;
        }
      }
      @media (max-width: 900px) {
        .container {
          max-width: 97vw;
          padding: 2rem 1.2rem 1.2rem 1.2rem;
        }
        label {
          font-size: 1.03rem;
        }
        input[type="text"],
        input[type="email"],
        input[type="password"] {
          font-size: 1.03rem;
          padding: 0.7rem 0.8rem 0.7rem 2.2rem;
        }
        .btn {
          font-size: 1.08rem;
          padding: 0.8rem 0;
        }
      }
      @media (max-width: 600px) {
        body {
          align-items: flex-start;
          padding-top: 2.5vw;
        }
        .container {
          max-width: 99vw;
          min-width: 0;
          padding: 1.2rem 0.5rem 1.2rem 0.5rem;
          border-radius: 14px;
          box-shadow: 0 4px 18px rgba(255, 193, 7, 0.13);
        }
        .form-container {
          gap: 0.7rem;
        }
        .form-group {
          gap: 0.15rem;
        }
        label {
          font-size: 0.98rem;
        }
        input[type="text"],
        input[type="email"],
        input[type="password"] {
          font-size: 0.98rem;
          padding: 0.6rem 0.6rem 0.6rem 1.7rem;
        }
        .btn {
          font-size: 1rem;
          padding: 0.7rem 0;
        }
        .show-password {
          right: 0.7rem;
          font-size: 1.08rem;
        }
      }
      @media (min-width: 1600px) {
        .container {
          max-width: 600px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <img
        src="https://cdn-icons-png.flaticon.com/512/1048/1048953.png"
        alt="Icône camion de livraison"
        class="form-illustration"
      />
      <h2
        style="
          text-align: center;
          color: #ff9800;
          font-size: 2.1rem;
          font-weight: 900;
          margin-bottom: 1.7rem;
          margin-top: 0.2rem;
          letter-spacing: 2px;
          text-shadow: 0 2px 8px rgba(255, 193, 7, 0.18), 0 1px 0 #fff;
        "
      >
        Espace Responsable de Livraison
      </h2>

      <!-- Formulaire de connexion -->
      <div class="form-container">
        <div class="form-group">
          <span class="input-icon"><i class="fa fa-envelope"></i></span>
          <label for="login-email">Email</label>
          <input
            type="email"
            id="login-email"
            name="email"
            placeholder="Votre email"
            required
          />
        </div>
        <div class="form-group password-group">
          <span class="input-icon"><i class="fa fa-key"></i></span>
          <label for="login-code">Code d'accès</label>
          <input
            type="password"
            id="login-code"
            name="code"
            placeholder="Code d'accès"
            required
          />
          <span
            class="show-password"
            onclick="togglePassword('login-code', this)"
            ><i class="fa fa-eye"></i
          ></span>
        </div>
        <button type="submit" class="btn" id="login-btn">Se connecter</button>
        <button type="button" class="btn btn-secondary" id="request-access-btn">
          Demander l'accès
        </button>
        <div class="message" id="login-message"></div>
        <div class="forgot-link">
          <a href="#" id="forgot-link">Code d'accès oublié ?</a>
        </div>
      </div>

      <!-- Popup code d'accès oublié -->
      <div
        id="forgot-popup"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(30, 60, 114, 0.13);
          z-index: 1000;
          align-items: center;
          justify-content: center;
        "
      >
        <div
          style="
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(30, 60, 114, 0.18);
            padding: 2rem 1.5rem;
            max-width: 350px;
            width: 90vw;
            margin: auto;
            position: relative;
          "
        >
          <span
            id="close-forgot"
            style="
              position: absolute;
              top: 10px;
              right: 14px;
              font-size: 1.3rem;
              color: #1e3c72;
              cursor: pointer;
            "
            >&times;</span
          >
          <h3
            style="
              color: #1e3c72;
              margin-bottom: 1.2rem;
              font-size: 1.15rem;
              text-align: center;
            "
          >
            Récupérer le code d'accès
          </h3>
          <form id="forgot-form" autocomplete="off">
            <div class="form-group">
              <span class="input-icon"><i class="fa fa-envelope"></i></span>
              <label for="forgot-email">Email</label>
              <input
                type="email"
                id="forgot-email"
                name="email"
                placeholder="Votre email"
                required
              />
            </div>
            <button type="submit" class="btn" style="width: 100%">
              Envoyer le code d'accès
            </button>
            <div class="message" id="forgot-message"></div>
          </form>
        </div>
      </div>

      <!-- Popup demande d'accès -->
      <div
        id="request-popup"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(30, 60, 114, 0.13);
          z-index: 1000;
          align-items: center;
          justify-content: center;
        "
      >
        <div
          style="
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(30, 60, 114, 0.18);
            padding: 2rem 1.5rem;
            max-width: 400px;
            width: 90vw;
            margin: auto;
            position: relative;
          "
        >
          <span
            id="close-request"
            style="
              position: absolute;
              top: 10px;
              right: 14px;
              font-size: 1.3rem;
              color: #1e3c72;
              cursor: pointer;
            "
            >&times;</span
          >
          <h3
            style="
              color: #1e3c72;
              margin-bottom: 1.2rem;
              font-size: 1.15rem;
              text-align: center;
            "
          >
            Demande d'Accès - Responsable de Livraison
          </h3>
          <form id="request-form" autocomplete="off">
            <div class="form-group">
              <span class="input-icon"><i class="fa fa-user"></i></span>
              <label for="request-nom">Nom complet</label>
              <input
                type="text"
                id="request-nom"
                name="nom"
                placeholder="Votre nom complet"
                required
              />
            </div>
            <div class="form-group">
              <span class="input-icon"><i class="fa fa-envelope"></i></span>
              <label for="request-email">Email</label>
              <input
                type="email"
                id="request-email"
                name="email"
                placeholder="Votre email"
                required
              />
            </div>
            <div class="form-group">
              <span class="input-icon"><i class="fa fa-building"></i></span>
              <label for="request-societe">Société</label>
              <input
                type="text"
                id="request-societe"
                name="societe"
                placeholder="Nom de votre société"
                required
              />
            </div>
            <div class="form-group">
              <span class="input-icon"><i class="fa fa-comment"></i></span>
              <label for="request-justification">Justification</label>
              <input
                type="text"
                id="request-justification"
                name="justification"
                placeholder="Raison de votre demande d'accès"
                required
              />
            </div>
            <button type="submit" class="btn" style="width: 100%">
              Envoyer la demande
            </button>
            <div class="message" id="request-message"></div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Affichage/masquage du code d'accès
      function togglePassword(id, el) {
        const input = document.getElementById(id);
        if (input.type === "password") {
          input.type = "text";
          el.innerHTML = '<i class="fa fa-eye-slash"></i>';
        } else {
          input.type = "password";
          el.innerHTML = '<i class="fa fa-eye"></i>';
        }
      }

      // Code d'accès oublié : ouverture popup
      document.getElementById("forgot-link").onclick = function (e) {
        e.preventDefault();
        document.getElementById("forgot-popup").style.display = "flex";
        document.getElementById("forgot-message").textContent = "";
      };

      document.getElementById("close-forgot").onclick = function () {
        document.getElementById("forgot-popup").style.display = "none";
      };

      // Demande d'accès : ouverture popup
      document.getElementById("request-access-btn").onclick = function (e) {
        e.preventDefault();
        document.getElementById("request-popup").style.display = "flex";
        document.getElementById("request-message").textContent = "";
      };

      document.getElementById("close-request").onclick = function () {
        document.getElementById("request-popup").style.display = "none";
      };

      // Envoi du formulaire code d'accès oublié
      document.getElementById("forgot-form").onsubmit = function (e) {
        e.preventDefault();
        var email = document.getElementById("forgot-email").value.trim();
        if (!email) return;

        document.getElementById("forgot-message").textContent =
          "Envoi en cours...";
        document.getElementById("forgot-message").classList.remove("success");

        fetch("/api/admin/send-access-code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: email,
            role: "responsable_livraison",
          }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (data.success) {
              document.getElementById("forgot-message").textContent =
                "Un nouveau code d'accès a été envoyé par email !";
              document
                .getElementById("forgot-message")
                .classList.add("success");
              setTimeout(() => {
                document.getElementById("forgot-popup").style.display = "none";
              }, 2000);
            } else {
              document.getElementById("forgot-message").textContent =
                data.message || "Erreur lors de l'envoi.";
              document
                .getElementById("forgot-message")
                .classList.remove("success");
            }
          })
          .catch(() => {
            document.getElementById("forgot-message").textContent =
              "Erreur serveur. Réessayez plus tard.";
            document
              .getElementById("forgot-message")
              .classList.remove("success");
          });
      };

      // Envoi du formulaire de demande d'accès
      document.getElementById("request-form").onsubmit = function (e) {
        e.preventDefault();

        var nom = document.getElementById("request-nom").value.trim();
        var email = document.getElementById("request-email").value.trim();
        var societe = document.getElementById("request-societe").value.trim();
        var justification = document
          .getElementById("request-justification")
          .value.trim();

        if (!nom || !email || !societe || !justification) {
          document.getElementById("request-message").textContent =
            "Veuillez remplir tous les champs.";
          document
            .getElementById("request-message")
            .classList.remove("success");
          return;
        }

        document.getElementById("request-message").textContent =
          "Envoi en cours...";
        document.getElementById("request-message").classList.remove("success");

        fetch("/api/admin/access-request", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nom: nom,
            email: email,
            societe: societe,
            justification: justification,
            role: "responsable_livraison",
          }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (data.success) {
              document.getElementById("request-message").textContent =
                "Demande envoyée avec succès ! Vous recevrez votre code d'accès par email une fois approuvé.";
              document
                .getElementById("request-message")
                .classList.add("success");
              setTimeout(() => {
                document.getElementById("request-popup").style.display = "none";
                document.getElementById("request-form").reset();
              }, 3000);
            } else {
              document.getElementById("request-message").textContent =
                data.message || "Erreur lors de l'envoi.";
              document
                .getElementById("request-message")
                .classList.remove("success");
            }
          })
          .catch(() => {
            document.getElementById("request-message").textContent =
              "Erreur serveur. Réessayez plus tard.";
            document
              .getElementById("request-message")
              .classList.remove("success");
          });
      };

      // Gestion du formulaire de connexion
      document.getElementById("login-btn").onclick = function (e) {
        e.preventDefault();

        var email = document.getElementById("login-email").value.trim();
        var code = document.getElementById("login-code").value.trim();

        if (!email || !code) {
          document.getElementById("login-message").textContent =
            "Veuillez remplir tous les champs.";
          document.getElementById("login-message").classList.remove("success");
          return;
        }

        document.getElementById("login-message").textContent =
          "Connexion en cours...";
        document.getElementById("login-message").classList.remove("success");

        fetch("/api/acconier-login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: email,
            accessCode: code,
            actorType: "responsable_livraison",
          }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (data.success) {
              document.getElementById("login-message").textContent =
                "Connexion réussie ! Redirection...";
              document.getElementById("login-message").classList.add("success");

              // Sauvegarde dans localStorage
              localStorage.setItem("userEmail", email);
              localStorage.setItem("userName", data.user.name || "");
              localStorage.setItem("userId", data.user.id || email);
              localStorage.setItem("userRole", "responsable_livraison");

              setTimeout(() => {
                window.location.href =
                  "https://dossiv.ci/html/resp_liv.html?fromAuth=true";
              }, 1200);
            } else {
              document.getElementById("login-message").textContent =
                data.message || "Email ou code d'accès incorrect.";
              document
                .getElementById("login-message")
                .classList.remove("success");
            }
          })
          .catch(() => {
            document.getElementById("login-message").textContent =
              "Erreur serveur. Réessayez plus tard.";
            document
              .getElementById("login-message")
              .classList.remove("success");
          });
      };

      // Fermer les popups en cliquant à l'extérieur
      window.onclick = function (event) {
        var forgotPopup = document.getElementById("forgot-popup");
        var requestPopup = document.getElementById("request-popup");

        if (event.target == forgotPopup) {
          forgotPopup.style.display = "none";
        }
        if (event.target == requestPopup) {
          requestPopup.style.display = "none";
        }
      };
    </script>
  </body>
</html>
