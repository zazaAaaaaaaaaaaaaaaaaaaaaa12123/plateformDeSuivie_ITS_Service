<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Centre de Contact Clients</title>

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    />

    <link rel="stylesheet" href="/css/styledeTabBord.css" />
    <link rel="stylesheet" href="/css/styleDeSuivie.css" />
    <link rel="stylesheet" href="/css/styleHistoriqueAgents.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      /* Styles généraux pour le corps */
      html,
      body {
        overflow: hidden;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      body {
        background: linear-gradient(145deg, #007bff, #0056b3);
        color: #333;
        min-height: 90vh;
        padding: 20px;
      }

      .layout {
        display: flex;
        max-width: 100%;
        margin: 0 auto;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        background: white;
        transition: all 0.3s ease;
        height: 100vh;
      }

      /* --- AMELIORATIONS POUR LA SIDEBAR - Version "Sublimée" --- */

      /* SIDEBAR - Styles généraux */
      .sidebar {
        background: linear-gradient(180deg, #303d4c 0%, #212a33 100%);
        color: #e0e6ec;
        padding: 25px 20px;
        width: 250px;
        min-height: 100vh;
        box-shadow: 8px 0 25px rgba(0, 0, 0, 0.3);
        font-family: "Inter", sans-serif;
        transition: width 0.4s ease-in-out, padding 0.4s ease-in-out,
          background 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
      }

      /* Titre du menu */
      .sidebar h2 {
        font-size: 1.8em;
        margin-bottom: 35px;
        font-weight: 700;
        color: #a3daff;
        border-bottom: 2px solid #63b3ed;
        padding-bottom: 15px;
        text-align: center;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        overflow: hidden;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      /* Cache l'icône de bascule du H2 si tu ne l'utilises pas en mode déplié */
      .sidebar h2 .toggle-icon {
        display: none;
      }

      /* Liste menu */
      .sidebar ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .sidebar ul li {
        margin-bottom: 12px;
        width: 100%;
      }

      /* Liens du menu */
      .sidebar ul li a {
        display: flex;
        align-items: center;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.05rem;
        padding: 12px 18px;
        border-radius: 8px;
        transition: background-color 0.25s ease, color 0.25s ease,
          transform 0.25s ease, box-shadow 0.25s ease;
        color: #e0e6ec;
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 0 0 0px rgba(99, 179, 237, 0.4);
      }

      /* Hover des liens - Effet de surbrillance plus doux et élégant */
      .sidebar ul li a:hover {
        background-color: #3f5166;
        color: #a3daff;
        transform: translateX(8px);
        box-shadow: inset 0 0 0 2px #63b3ed, 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      /* Icône des liens */
      .sidebar ul li a .icon {
        margin-right: 18px;
        font-size: 1.3em;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: transparent;
        color: #a3daff;
        border-radius: 0;
        transition: color 0.25s ease, transform 0.25s ease;
      }

      /* Icône hover avec lien */
      .sidebar ul li a:hover .icon {
        color: #e0e6ec;
        transform: scale(1.15) rotate(5deg);
      }

      /* Texte des liens */
      .link-text {
        opacity: 1;
        transition: opacity 0.3s ease, width 0.3s ease;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      /* Style pour le calendrier - Visibilité par défaut */
      .calendar-container {
        margin-top: 40px;
        padding: 0 10px;
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .calendar-container label {
        font-weight: 500;
        color: #b0bec5;
        display: block;
        margin-bottom: 10px;
        font-size: 0.95rem;
      }

      .calendar-container input[type="date"] {
        width: 100%;
        padding: 10px 12px;
        font-size: 0.95rem;
        border: 1px solid #4a5d6f;
        background-color: #2a3540;
        color: #e0e6ec;
        border-radius: 6px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        -webkit-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%23e0e6ec"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 30px;
      }

      .calendar-container input[type="date"]:focus {
        border-color: #63b3ed;
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.4);
      }

      /* --- État COLLAPSED de la sidebar (quand le body a la classe 'sidebar-collapsed') --- */
      body.sidebar-collapsed .sidebar {
        width: 90px;
        padding: 20px 0;
        background: linear-gradient(180deg, #303d4c 0%, #212a33 100%);
        box-shadow: 8px 0 25px rgba(0, 0, 0, 0.3);
      }
      body.sidebar-collapsed
        #sidebarUserProfile
        > div[style*="flex-direction: row"] {
        justify-content: center !important;
        gap: 8px !important;
        margin-top: 8px !important;
      }
      body.sidebar-collapsed
        #sidebarUserProfile
        > div[style*="flex-direction: row"]
        span {
        width: 28px !important;
        height: 28px !important;
        font-size: 1em !important;
        margin: 0 1px !important;
        box-shadow: none !important;
        padding: 0 !important;
      }
      body.sidebar-collapsed
        #sidebarUserProfile
        > div[style*="flex-direction: row"]
        i {
        font-size: 1em !important;
      }

      body.sidebar-collapsed .sidebar h2 {
        justify-content: center;
        border-bottom: none;
        padding-bottom: 0;
        color: #a3daff;
        font-size: 1.5em;
      }

      /* Texte "Menu" à masquer quand la sidebar est pliée */
      body.sidebar-collapsed .sidebar h2 span.link-text {
        opacity: 0;
        visibility: hidden;
        width: 0;
        margin-right: 0;
      }

      /* Centrage des éléments de la liste UL en mode plié */
      body.sidebar-collapsed .sidebar ul {
        align-items: center;
      }

      /* Centrage des liens LI en mode plié */
      body.sidebar-collapsed .sidebar ul li {
        justify-content: center;
        width: auto;
      }

      /* Texte des liens (masqué en mode plié) */
      body.sidebar-collapsed .link-text {
        opacity: 0;
        visibility: hidden;
        width: 0;
        padding: 0;
        margin: 0;
      }

      body.sidebar-collapsed .calendar-container label,
      body.sidebar-collapsed .calendar-container input {
        opacity: 0;
        visibility: hidden;
        width: 0;
        padding: 0;
        margin: 0;
        height: 0;
      }

      /* Styles pour les bulles en mode plié */
      body.sidebar-collapsed .sidebar ul li a .icon {
        margin-right: 0;
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background-color: #63b3ed;
        color: white !important;
        font-size: 1.6em;
        box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.4);
        transform: scale(1);
        transition: all 0.3s ease;
      }

      /* Ajustements pour l'icône au survol en mode plié */
      body.sidebar-collapsed .sidebar ul li a:hover .icon {
        background-color: #4299e1;
        transform: translateY(-5px) scale(1.15);
        box-shadow: 6px 6px 15px rgba(0, 0, 0, 0.5);
      }

      body.sidebar-collapsed .sidebar ul li a {
        justify-content: center;
        padding: 10px 0;
        align-items: center;
        background-color: transparent !important;
        color: white !important;
        width: 100%;
      }

      /* Supprime le pseudo-élément au survol qui était caché précédemment */
      body.sidebar-collapsed .sidebar ul li a:hover::before {
        display: none !important;
      }

      /* Médias queries pour les petits écrans - S'assure que les icônes redeviennent normales */
      @media (max-width: 768px) {
        .sidebar ul li a .icon {
          width: auto !important;
          height: auto !important;
          border-radius: 0 !important;
          background-color: transparent !important;
          box-shadow: none !important;
          transform: none !important;
          font-size: 1em !important;
          margin-right: 14px !important;
        }

        .sidebar ul li a:hover .icon {
          background-color: transparent !important;
          transform: none !important;
          box-shadow: none !important;
        }
        .sidebar ul li a {
          padding: 10px 15px !important;
          justify-content: flex-start !important;
        }
      }

      /* --- Styles pour l'indicateur de connexion --- */
      .connection-status {
        margin-left: 10px;
        font-size: 1.2em;
        transition: color 0.3s ease, transform 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* Couleur par défaut (connecté) */
      .connection-status .fas {
        color: #28a745; /* Vert pour connecté */
      }

      /* Style quand l'utilisateur est hors ligne */
      .connection-status.offline .fas {
        color: #dc3545; /* Rouge pour déconnecté */
        transform: rotate(
          45deg
        ); /* Petite rotation pour indiquer le changement */
      }

      /* Ajustements pour le mode plié de la sidebar */
      body.sidebar-collapsed .sidebar h2 .connection-status {
        margin-left: 0;
        font-size: 1.5em;
      }

      body.sidebar-collapsed .sidebar h2 {
        justify-content: center;
      }

      /* --- Styles pour l'alerte de connexion/déconnexion --- */
      .custom-alert {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 25px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .custom-alert.success {
        background-color: #28a745;
      }

      .custom-alert.error {
        background-color: #dc3545;
      }

      .custom-alert.show {
        opacity: 1;
        visibility: visible;
      }

      /* --- Styles pour le contenu principal (welcome, buttons) --- */
      .welcome-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 80vh;
        text-align: center;
        padding: 0 20px;
        background: linear-gradient(to right, #ffffff, #f3f4f6);
        animation: fadeIn 1.2s ease-in-out;
      }

      .welcome-container h1 {
        font-size: 3rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1rem;
        font-family: "Inter", sans-serif;
      }

      .welcome-container p {
        font-size: 1.2rem;
        color: #4b5563;
        margin-bottom: 2.5rem;
        max-width: 600px;
        line-height: 1.6;
      }

      .bottom-buttons {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 18px;
        z-index: 10;
        width: 100%;
        padding: 0;
      }

      .bottom-buttons button {
        background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%);
        color: #fff;
        border: none;
        padding: 7px 10px;
        border-radius: 8px;
        font-size: 0.92rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 8px #2563eb22, 0 1px 4px #0001;
        transition: background 0.25s, transform 0.18s, box-shadow 0.25s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-family: "Inter", sans-serif;
        letter-spacing: 0.2px;
        outline: none;
        min-width: 90px;
        max-width: 160px;
        height: 32px;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .bottom-buttons button:hover,
      .bottom-buttons button:focus {
        background: linear-gradient(90deg, #1d4ed8 0%, #2563eb 100%);
        transform: translateY(-3px) scale(1.04);
        box-shadow: 0 12px 32px #2563eb33, 0 4px 16px #0002;
      }

      .bottom-buttons i {
        font-size: 1.05em;
        margin-right: 4px;
      }

      @media (max-width: 700px) {
        .bottom-buttons {
          flex-direction: column;
          gap: 10px;
          bottom: 12px;
        }
        .bottom-buttons button {
          width: 90vw;
          max-width: 320px;
          font-size: 0.98em;
          padding: 10px 0;
          height: 40px;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .main-content {
        flex-grow: 1;
        padding: 30px;
        background-color: #f7f9fc;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
        min-width: 0;
        transition: margin-left 0.3s ease, width 0.3s ease;
        box-sizing: border-box;
      }
      .dynamic-content-area,
      #content {
        flex-grow: 1;
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        min-width: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .green-dot-animated {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #28a745;
        margin-left: 12px;
        box-shadow: 0 0 0 0 #28a745;
        animation: greenDotPulse 1s infinite cubic-bezier(0.66, 0, 0, 1);
        vertical-align: middle;
      }
      #btnResumeJoursPrecedents {
        font-size: 0.8rem;
      }
      @keyframes greenDotPulse {
        0% {
          box-shadow: 0 0 0 0 #28a74599;
          opacity: 1;
        }
        70% {
          box-shadow: 0 0 0 10px #28a74500;
          opacity: 1;
        }
        100% {
          box-shadow: 0 0 0 0 #28a74500;
          opacity: 1;
        }
      }

      /* === POPUP MODIFICATION CODE ENTREPRISE (ADMIN) === */
      #popupEditCompanyCode {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(30, 41, 59, 0.55);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }

      #popupEditCompanyCode .content {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 40px #05966944;
        padding: 38px 32px 28px 32px;
        max-width: 420px;
        width: 96vw;
        max-height: 92vh;
        overflow-y: auto;
        position: relative;
      }

      #popupEditCompanyCode h2 {
        font-size: 1.3em;
        font-weight: 700;
        color: #059669;
        margin-bottom: 18px;
      }

      #popupEditCompanyCode label {
        font-weight: 600;
        color: #374151;
      }

      #popupEditCompanyCode input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1.1em;
        margin-top: 6px;
        margin-bottom: 14px;
      }

      #popupEditCompanyCode button {
        width: 100%;
        background: #059669;
        color: #fff;
        font-weight: 700;
        padding: 10px 0;
        border-radius: 8px;
        font-size: 1.1em;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
      }

      #popupEditCompanyCode button:hover {
        background: #047857;
      }

      #popupEditCompanyCode .close {
        position: absolute;
        top: 18px;
        right: 18px;
        background: none;
        border: none;
        font-size: 1.5em;
        color: #059669;
        cursor: pointer;
      }

      #popupEditCompanyCode .message {
        font-size: 0.98em;
        margin-bottom: 10px;
        text-align: center;
      }

      /* --- Fin styles popup admin --- */
    </style>
  </head>

  <body class="sidebar-expanded">
    <div class="layout">
      <aside class="sidebar">
        <h2 id="sidebarTitle" style="position: relative">
          <span class="link-text">Menu</span>
          <span class="connection-status" id="connectionStatusIcon">
            <i class="fas fa-wifi"></i>
          </span>
        </h2>
        <ul>
          <li>
            <a href="tableauDeBord.html" id="lienAccueil">
              <span class="icon"><i class="fas fa-home"></i></span>
              <span class="link-text">Accueil</span>
            </a>
          </li>

          <li>
            <a href="#" id="lienSuivi">
              <span class="icon"><i class="fas fa-chart-bar"></i></span>
              <span class="link-text">Suivi des Livraisons de Conteneurs</span>
            </a>
          </li>
          <li id="lienStatistiques">
            <a href="#">
              <span class="icon"><i class="fas fa-chart-pie"></i></span>
              <span class="link-text">Statistiques</span>
            </a>
          </li>
        </ul>
        <div class="calendar-container">
          <label for="date-selection">Sélectionner une date :</label>
          <input type="date" id="date-selection" />
        </div>
        <!-- Avatar utilisateur moderne sous la date -->
        <div
          id="sidebarUserProfile"
          style="
            margin-top: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
          "
        >
          <div
            id="userAvatarCircle"
            style="
              width: 56px;
              height: 56px;
              border-radius: 50%;
              background: linear-gradient(135deg, #2563eb 60%, #06b6d4 100%);
              color: #fff;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 2em;
              font-weight: 700;
              box-shadow: 0 2px 8px #2563eb22;
              cursor: pointer;
              transition: filter 0.18s;
              position: relative;
            "
          >
            <i class="fas fa-user"></i>
          </div>
          <div
            id="userNameSidebar"
            style="
              font-size: 1.08em;
              font-weight: 700;
              color: #2563eb;
              text-align: center;
              max-width: 140px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            "
          ></div>
          <div
            id="userProfilSidebar"
            style="
              font-size: 0.98em;
              color: #374151;
              text-align: center;
              max-width: 140px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            "
          ></div>
          <button
            id="logoutSidebarBtn"
            style="
              margin-top: 6px;
              background: linear-gradient(90deg, #2563eb 0%, #06b6d4 100%);
              color: #fff;
              border: none;
              border-radius: 8px;
              padding: 7px 18px;
              font-size: 0.98em;
              font-weight: 600;
              box-shadow: 0 2px 8px #2563eb22;
              cursor: pointer;
              transition: filter 0.18s;
            "
          >
            Se déconnecter
          </button>
          <!-- Icônes responsables sous l'avatar -->
          <div
            style="
              display: flex;
              flex-direction: row;
              align-items: center;
              gap: 18px;
              margin-top: 8px;
            "
          >
            <span
              id="iconRespAcconier"
              title="Responsable Acconier"
              style="
                display: flex;
                align-items: center;
                justify-content: center;
                background: #fff7e3;
                border-radius: 50%;
                width: 38px;
                height: 38px;
                box-shadow: 0 2px 8px #f59e0b22;
                cursor: pointer;
              "
            >
              <i
                class="fas fa-user-shield"
                style="font-size: 1.45em; color: #f59e0b"
              ></i>
            </span>
            <span
              id="iconRespLivraison"
              title="Responsable Livraison"
              style="
                display: flex;
                align-items: center;
                justify-content: center;
                background: #e3ffe3;
                border-radius: 50%;
                width: 38px;
                height: 38px;
                box-shadow: 0 2px 8px #05966922;
                cursor: pointer;
              "
            >
              <i
                class="fas fa-user-check"
                style="font-size: 1.45em; color: #059669"
              ></i>
            </span>
          </div>
        </div>
        <!-- Popup modification code entreprise -->
        <div
          id="popupEditCompanyCode"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            class="content"
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #05966944;
              padding: 38px 32px 28px 32px;
              max-width: 420px;
              width: 96vw;
              max-height: 92vh;
              overflow-y: auto;
              position: relative;
            "
          >
            <button
              class="close"
              id="closeEditCompanyCode"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #059669;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <h2
              style="
                font-size: 1.3em;
                font-weight: 700;
                color: #059669;
                margin-bottom: 18px;
              "
            >
              Modifier le code de l'entreprise
            </h2>
            <form id="formEditCompanyCode">
              <label
                for="newCompanyCode"
                style="font-weight: 600; color: #374151"
                >Nouveau code :</label
              >
              <input
                type="text"
                id="newCompanyCode"
                name="newCompanyCode"
                required
                style="
                  width: 100%;
                  padding: 8px 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 8px;
                  font-size: 1.1em;
                  margin-top: 6px;
                  margin-bottom: 14px;
                "
              />
              <button
                type="submit"
                style="
                  width: 100%;
                  background: #059669;
                  color: #fff;
                  font-weight: 700;
                  padding: 10px 0;
                  border-radius: 8px;
                  font-size: 1.1em;
                  border: none;
                  cursor: pointer;
                  transition: background 0.2s;
                "
              >
                Enregistrer
              </button>
              <div
                id="editCompanyCodeMsg"
                class="message"
                style="font-size: 0.98em; margin-top: 10px; text-align: center"
              ></div>
            </form>
          </div>
        </div>
      </aside>

      <main class="main-content">
        <!-- Popup demande code entreprise -->
        <div
          id="popupDemandeCodeEntreprise"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #2563eb44;
              padding: 32px 28px 24px 28px;
              max-width: 900px;
              width: 98vw;
              max-height: 96vh;
              overflow-y: auto;
              position: relative;
              border: 3px solid #2563eb;
              font-size: 1.08em;
            "
          >
            <button
              id="closeDemandeCodeEntreprise"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #2563eb;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <h2
              style="
                font-size: 1.15em;
                font-weight: 700;
                color: #2563eb;
                margin-bottom: 18px;
                text-align: center;
              "
            >
              Demandes de code entreprise
            </h2>
            <div
              id="tableDemandesCodeEntreprise"
              style="
                margin-bottom: 18px;
                border: 1px dashed #2563eb;
                min-height: 40px;
                padding: 8px;
                background: #f7faff;
                text-align: center;
              "
            >
              <!-- Les demandes seront affichées ici par JS -->
            </div>
            <div
              id="demandeCodeEntrepriseMsg"
              style="
                margin-top: 10px;
                font-size: 0.98em;
                text-align: center;
                color: #dc3545;
              "
            >
              <!-- Les messages d'erreur ou d'information JS s'affichent ici -->
            </div>
          </div>
        </div>
        <!-- Section Statistiques (masquée par défaut) -->
        <section
          id="statistiquesSection"
          class="dynamic-content-area"
          style="display: none; min-height: 70vh"
        >
          <div style="width: 100%; max-width: 1200px; margin: 0 auto">
            <h1
              style="
                font-size: 2.3em;
                font-weight: 800;
                color: #2563eb;
                text-align: center;
                margin-bottom: 32px;
                letter-spacing: 1px;
              "
            >
              Statistiques par Acteur
            </h1>
            <div
              style="
                display: flex;
                gap: 32px;
                flex-wrap: wrap;
                justify-content: center;
                align-items: stretch;
              "
            >
              <div
                class="stat-bloc"
                style="
                  flex: 1 1 320px;
                  min-width: 280px;
                  background: linear-gradient(
                    135deg,
                    #e3f0ff 60%,
                    #f7faff 100%
                  );
                  border-radius: 18px;
                  box-shadow: 0 4px 18px #2563eb18, 0 2px 8px #0001;
                  padding: 32px 24px 24px 24px;
                  margin-bottom: 18px;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                "
              >
                <div
                  style="
                    font-size: 1.4em;
                    font-weight: 700;
                    color: #2563eb;
                    margin-bottom: 10px;
                  "
                >
                  <i class="fas fa-user-tie"></i> Agent Acconier
                </div>
                <div
                  id="statAgentAcconier"
                  style="
                    font-size: 2.2em;
                    font-weight: 900;
                    color: #1d3557;
                    margin-bottom: 8px;
                  "
                >
                  -
                </div>
                <div style="font-size: 1.05em; color: #374151">
                  Livraisons traitées
                </div>
                <div
                  id="stats-agentAcconier"
                  style="width: 100%; margin-top: 12px"
                ></div>
              </div>
              <div
                class="stat-bloc"
                style="
                  flex: 1 1 320px;
                  min-width: 280px;
                  background: linear-gradient(
                    135deg,
                    #fff7e3 60%,
                    #fffbe9 100%
                  );
                  border-radius: 18px;
                  box-shadow: 0 4px 18px #f59e0b18, 0 2px 8px #0001;
                  padding: 32px 24px 24px 24px;
                  margin-bottom: 18px;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                "
              >
                <div
                  style="
                    font-size: 1.4em;
                    font-weight: 700;
                    color: #f59e0b;
                    margin-bottom: 10px;
                  "
                >
                  <i class="fas fa-user-shield"></i> Responsable Acconier
                </div>
                <div
                  id="statRespAcconier"
                  style="
                    font-size: 2.2em;
                    font-weight: 900;
                    color: #b26a00;
                    margin-bottom: 8px;
                  "
                >
                  -
                </div>
                <div style="font-size: 1.05em; color: #7c5e2a">
                  Validations réalisées
                </div>
                <div
                  id="stats-responsableAcconier"
                  style="width: 100%; margin-top: 12px"
                ></div>
              </div>
              <div
                class="stat-bloc"
                style="
                  flex: 1 1 320px;
                  min-width: 280px;
                  background: linear-gradient(
                    135deg,
                    #e3ffe3 60%,
                    #f7fff7 100%
                  );
                  border-radius: 18px;
                  box-shadow: 0 4px 18px #05966918, 0 2px 8px #0001;
                  padding: 32px 24px 24px 24px;
                  margin-bottom: 18px;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                "
              >
                <div
                  style="
                    font-size: 1.4em;
                    font-weight: 700;
                    color: #059669;
                    margin-bottom: 10px;
                  "
                >
                  <i class="fas fa-user-check"></i> Responsable Livraison
                </div>
                <div
                  id="statRespLivraison"
                  style="
                    font-size: 2.2em;
                    font-weight: 900;
                    color: #059669;
                    margin-bottom: 8px;
                  "
                >
                  -
                </div>
                <div style="font-size: 1.05em; color: #27734d">
                  Livraisons validées
                </div>
                <div
                  id="stats-responsableLivraison"
                  style="width: 100%; margin-top: 12px"
                ></div>
              </div>
            </div>
            <div id="statistiquesDetails" style="margin-top: 32px"></div>
          </div>
        </section>
        <!-- Section demandes code entreprise oublié (admin) -->
        <!-- Section demandes de code d'entreprise oublié supprimée (remplacée par le bouton sidebar) -->

        <div
          id="welcomeSection"
          class="welcome-container"
          style="
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            background: none;
            box-shadow: none;
            min-height: 320px;
            gap: 0;
            margin-top: 0;
            padding-top: 18px;
            position: relative;
            height: 100%;
          "
        >
          <!-- Message de bienvenue animé -->
          <div id="welcomeTypewriter" class="welcome-typewriter"></div>
          <div style="height: 38px"></div>
          <div class="etat-cards-row">
            <div
              class="etat-card dossier-attente animated-card"
              id="carteAttentePaiement"
              style="cursor: pointer"
            >
              <div class="etat-icon"><i class="fas fa-hourglass-half"></i></div>
              <div class="etat-title">En attente de paiement</div>
              <div class="etat-desc">
                Dossiers en attente de règlement avant traitement.
              </div>
            </div>
            <!-- Popup dossiers en attente de paiement -->
            <div
              id="popupAttentePaiement"
              style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(30, 41, 59, 0.55);
                z-index: 10000;
                align-items: center;
                justify-content: center;
              "
            >
              <div
                style="
                  background: #fff;
                  border-radius: 18px;
                  box-shadow: 0 8px 40px #2563eb44;
                  padding: 32px 28px 24px 28px;
                  max-width: 700px;
                  width: 96vw;
                  max-height: 90vh;
                  overflow-y: auto;
                  position: relative;
                "
              >
                <button
                  id="closePopupAttentePaiement"
                  style="
                    position: absolute;
                    top: 18px;
                    right: 18px;
                    background: none;
                    border: none;
                    font-size: 1.5em;
                    color: #2563eb;
                    cursor: pointer;
                  "
                >
                  &times;
                </button>
                <h2
                  style="
                    font-size: 1.18em;
                    font-weight: 700;
                    color: #f59e0b;
                    margin-bottom: 18px;
                    text-align: center;
                  "
                >
                  Dossiers en attente de paiement
                </h2>
                <div id="listeAttentePaiement" style="min-height: 40px"></div>
                <div
                  id="msgAttentePaiement"
                  style="
                    margin-top: 10px;
                    font-size: 0.98em;
                    text-align: center;
                    color: #dc3545;
                  "
                ></div>
              </div>
            </div>

            <!-- Popup détails dossier -->
            <div
              id="popupDetailDossier"
              style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(30, 41, 59, 0.55);
                z-index: 10001;
                align-items: center;
                justify-content: center;
              "
            >
              <div
                style="
                  background: #fff;
                  border-radius: 18px;
                  box-shadow: 0 8px 40px #2563eb44;
                  padding: 32px 28px 24px 28px;
                  max-width: 600px;
                  width: 95vw;
                  max-height: 88vh;
                  overflow-y: auto;
                  position: relative;
                "
              >
                <button
                  id="closePopupDetailDossier"
                  style="
                    position: absolute;
                    top: 18px;
                    right: 18px;
                    background: none;
                    border: none;
                    font-size: 1.5em;
                    color: #2563eb;
                    cursor: pointer;
                  "
                >
                  &times;
                </button>
                <h2
                  style="
                    font-size: 1.12em;
                    font-weight: 700;
                    color: #2563eb;
                    margin-bottom: 18px;
                    text-align: center;
                  "
                >
                  Détails du dossier
                </h2>
                <div id="contenuDetailDossier"></div>
              </div>
            </div>
            <style>
              /* Liste stylisée des dossiers en attente de paiement */
              #listeAttentePaiement {
                display: flex;
                flex-direction: column;
                gap: 14px;
                margin-bottom: 8px;
              }
              .dossier-item-liste {
                background: linear-gradient(90deg, #fff7e3 80%, #f8fafc 100%);
                border: 1.5px solid #f59e0b;
                border-radius: 12px;
                padding: 14px 18px;
                cursor: pointer;
                transition: box-shadow 0.15s, transform 0.15s;
                box-shadow: 0 2px 8px #f59e0b11;
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
              }
              .dossier-item-liste:hover {
                box-shadow: 0 6px 18px #f59e0b33;
                transform: translateY(-2px) scale(1.01);
              }
              .dossier-item-info {
                display: flex;
                flex-direction: column;
                gap: 2px;
              }
              .dossier-item-date {
                font-size: 0.98em;
                color: #b26a00;
                font-weight: 600;
              }
              .dossier-item-nom {
                font-size: 1.08em;
                color: #1d3557;
                font-weight: 700;
              }
            </style>
            <script>
              // Gestion pop-up dossiers en attente de paiement
              document.getElementById("carteAttentePaiement").onclick =
                function () {
                  document.getElementById(
                    "popupAttentePaiement"
                  ).style.display = "flex";
                  chargerDossiersAttentePaiement();
                };
              document.getElementById("closePopupAttentePaiement").onclick =
                function () {
                  document.getElementById(
                    "popupAttentePaiement"
                  ).style.display = "none";
                };
              document.getElementById("closePopupDetailDossier").onclick =
                function () {
                  document.getElementById("popupDetailDossier").style.display =
                    "none";
                };

              // Fonction pour charger les dossiers en attente de paiement
              function chargerDossiersAttentePaiement() {
                const listeDiv = document.getElementById(
                  "listeAttentePaiement"
                );
                const msgDiv = document.getElementById("msgAttentePaiement");
                listeDiv.innerHTML =
                  '<div style="text-align:center;color:#888;">Chargement...</div>';
                msgDiv.textContent = "";
                fetch(
                  "https://plateformdesuivie-its-service-1cjx.onrender.com/api/dossiers/attente-paiement"
                )
                  .then((res) => res.json())
                  .then((data) => {
                    if (!data.success || !Array.isArray(data.dossiers)) {
                      listeDiv.innerHTML = "";
                      msgDiv.textContent = "Aucun dossier trouvé.";
                      return;
                    }
                    // Tri par date décroissante (plus récent en haut)
                    data.dossiers.sort(
                      (a, b) => new Date(b.date) - new Date(a.date)
                    );
                    if (data.dossiers.length === 0) {
                      listeDiv.innerHTML =
                        '<div style="text-align:center;color:#888;">Aucun dossier en attente de paiement.</div>';
                      return;
                    }
                    // Affichage sous forme de tableau lisible
                    let table = `<div style='overflow-x:auto;'><table style='width:100%;min-width:520px;border-collapse:collapse;'>`;
                    table += `<thead><tr style='background:#fff7e3;'><th style='padding:8px 6px;border-bottom:1.5px solid #f59e0b;'>Date</th><th style='padding:8px 6px;border-bottom:1.5px solid #f59e0b;'>Agent</th><th style='padding:8px 6px;border-bottom:1.5px solid #f59e0b;'>Client</th><th style='padding:8px 6px;border-bottom:1.5px solid #f59e0b;'>N° BL</th><th style='padding:8px 6px;border-bottom:1.5px solid #f59e0b;'>N° Dossier</th></tr></thead><tbody>`;
                    data.dossiers.forEach((dossier) => {
                      table += `<tr class='dossier-item-liste' style='background:linear-gradient(90deg,#fff7e3 80%,#f8fafc 100%);'>`;
                      table += `<td style='padding:8px 6px;font-size:0.98em;color:#b26a00;font-weight:600;'>${
                        dossier.date
                          ? new Date(dossier.date).toLocaleDateString("fr-FR")
                          : ""
                      }</td>`;
                      table += `<td style='padding:8px 6px;font-size:1.08em;color:#1d3557;font-weight:700;'>${
                        dossier.agent || "-"
                      }</td>`;
                      table += `<td style='padding:8px 6px;'>${
                        dossier.nom || "-"
                      }</td>`;
                      table += `<td style='padding:8px 6px;'>${
                        dossier.bl || "-"
                      }</td>`;
                      table += `<td style='padding:8px 6px;'>${
                        dossier.dossier || "-"
                      }</td>`;
                      table += `</tr>`;
                    });
                    table += `</tbody></table></div>`;
                    listeDiv.innerHTML = table;
                  })
                  .catch(() => {
                    listeDiv.innerHTML = "";
                    msgDiv.textContent = "Erreur de chargement.";
                  });
              }

              // Afficher le détail d'un dossier dans un pop-up
              function afficherDetailDossier(dossier) {
                const popup = document.getElementById("popupDetailDossier");
                const contenu = document.getElementById("contenuDetailDossier");
                contenu.innerHTML =
                  '<div style="text-align:center;color:#888;">Chargement...</div>';
                popup.style.display = "flex";
                // Si on a déjà toutes les infos, on affiche, sinon on peut re-fetcher par id
                if (dossier && dossier.id) {
                  fetch(
                    `https://plateformdesuivie-its-service-1cjx.onrender.com/api/dossiers/${dossier.id}`
                  )
                    .then((res) => res.json())
                    .then((data) => {
                      if (!data.success || !data.dossier) {
                        contenu.innerHTML =
                          '<div style="color:#dc3545;text-align:center;">Dossier introuvable.</div>';
                        return;
                      }
                      const d = data.dossier;
                      contenu.innerHTML = `<div style='font-size:1.08em;font-weight:700;color:#2563eb;margin-bottom:8px;'>${
                        d.nom || d.reference || "Dossier"
                      }</div>
                  <div style='margin-bottom:8px;'><b>Date création :</b> ${
                    d.date_creation
                      ? new Date(d.date_creation).toLocaleString("fr-FR")
                      : "-"
                  }</div>
                  <div style='margin-bottom:8px;'><b>Statut :</b> ${
                    d.statut || "-"
                  }</div>
                  <div style='margin-bottom:8px;'><b>Client :</b> ${
                    d.client || "-"
                  }</div>
                  <div style='margin-bottom:8px;'><b>Montant :</b> ${
                    d.montant ? d.montant + " €" : "-"
                  }</div>
                  <div style='margin-bottom:8px;'><b>Description :</b> ${
                    d.description || "-"
                  }</div>
                  <div style='margin-bottom:8px;'><b>Référence :</b> ${
                    d.reference || "-"
                  }</div>
                  <div style='margin-bottom:8px;'><b>Autres infos :</b> ${
                    d.autres_infos || "-"
                  }</div>`;
                    })
                    .catch(() => {
                      contenu.innerHTML =
                        '<div style="color:#dc3545;text-align:center;">Erreur de chargement.</div>';
                    });
                } else {
                  contenu.innerHTML =
                    '<div style="color:#dc3545;text-align:center;">Dossier non valide.</div>';
                }
              }
            </script>
            <div class="etat-card dossier-cours animated-card">
              <div class="etat-icon"><i class="fas fa-truck-loading"></i></div>
              <div class="etat-title">En cours de mise en livraison</div>
              <div class="etat-desc">
                Dossiers en préparation pour la livraison.
              </div>
            </div>
          </div>
          <div class="etat-cards-row">
            <div class="etat-card dossier-livre animated-card">
              <div class="etat-icon"><i class="fas fa-check-circle"></i></div>
              <div class="etat-title">Dossier livré</div>
              <div class="etat-desc">
                Dossiers livrés avec succès au client.
              </div>
            </div>
            <div class="etat-card dossier-retard animated-card">
              <div class="etat-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="etat-title">Dossier en retard</div>
              <div class="etat-desc">
                Dossiers dont la livraison a dépassé le délai prévu.
              </div>
            </div>
          </div>
        </div>
        <style>
          /* Cartes états des dossiers (3D, moderne, esthétique) */
          .etat-cards-row {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 38px;
            margin-bottom: 22px;
          }
          /* Décalage vertical des cartes sous le message de bienvenue */
          .etat-cards-row:first-of-type {
            margin-top: 18px;
          }
          .etat-card {
            border-radius: 18px;
            box-shadow: 0 8px 24px #2563eb18, 0 2px 0 #fff8;
            padding: 28px 16px 22px 16px;
            min-width: 190px;
            max-width: 230px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin: 0 10px;
            transition: transform 0.18s, box-shadow 0.18s;
            position: relative;
            cursor: default;
            opacity: 0;
            animation: cardFadeInUp 0.7s cubic-bezier(0.23, 1.01, 0.32, 1)
              forwards;
          }
          .dossier-attente.etat-card {
            background: linear-gradient(135deg, #fff7e3 80%, #f8fafc 100%);
            border: 2.5px solid #f59e0b;
          }
          .dossier-cours.etat-card {
            background: linear-gradient(135deg, #e3f0ff 80%, #f8fafc 100%);
            border: 2.5px solid #2563eb;
          }
          .dossier-livre.etat-card {
            background: linear-gradient(135deg, #e3ffe3 80%, #f8fafc 100%);
            border: 2.5px solid #059669;
          }
          .dossier-retard.etat-card {
            background: linear-gradient(135deg, #ffe3e3 80%, #f8fafc 100%);
            border: 2.5px solid #dc3545;
          }
          .etat-cards-row .etat-card:nth-child(1) {
            animation-delay: 0.05s;
          }
          .etat-cards-row .etat-card:nth-child(2) {
            animation-delay: 0.18s;
          }
          .etat-cards-row + .etat-cards-row .etat-card:nth-child(1) {
            animation-delay: 0.32s;
          }
          .etat-cards-row + .etat-cards-row .etat-card:nth-child(2) {
            animation-delay: 0.45s;
          }
          @keyframes cardFadeInUp {
            0% {
              opacity: 0;
              transform: translateY(40px) scale(0.98);
            }
            60% {
              opacity: 1;
              transform: translateY(-8px) scale(1.03);
            }
            100% {
              opacity: 1;
              transform: translateY(0) scale(1);
            }
          }
          .etat-card:hover {
            transform: translateY(-8px) scale(1.035) rotate(-1deg);
            box-shadow: 0 16px 48px #2563eb33, 0 4px 16px #0002;
            z-index: 2;
          }
          .etat-icon {
            font-size: 2.2em;
            margin-bottom: 12px;
            color: #2563eb;
            filter: drop-shadow(0 2px 8px #2563eb22);
            background: #fff;
            border-radius: 50%;
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #2563eb18, 0 1px 2px #0001;
            margin-top: -28px;
            margin-bottom: 12px;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translate(-50%, -50%);
          }
          .etat-title {
            font-size: 1.18em;
            font-weight: 700;
            color: #1d3557;
            margin-bottom: 10px;
            text-align: center;
            letter-spacing: 0.2px;
          }
          .etat-desc {
            font-size: 1.01em;
            color: #374151;
            text-align: center;
            margin-bottom: 0;
            margin-top: 0;
            line-height: 1.5;
          }
          .dossier-attente .etat-icon {
            color: #f59e0b;
            background: #fff7e3;
            box-shadow: 0 2px 12px #f59e0b22, 0 1px 2px #0001;
          }
          .dossier-cours .etat-icon {
            color: #2563eb;
            background: #e3f0ff;
            box-shadow: 0 2px 12px #2563eb22, 0 1px 2px #0001;
          }
          .dossier-livre .etat-icon {
            color: #059669;
            background: #e3ffe3;
            box-shadow: 0 2px 12px #05966922, 0 1px 2px #0001;
          }
          .dossier-retard .etat-icon {
            color: #dc3545;
            background: #ffe3e3;
            box-shadow: 0 2px 12px #dc354522, 0 1px 2px #0001;
          }
          .etat-card:not(:hover) {
            will-change: auto;
          }
          @media (max-width: 1100px) {
            .etat-cards-row {
              gap: 16px;
            }
            .etat-card {
              min-width: 140px;
              max-width: 98vw;
              padding: 18px 6px 14px 6px;
            }
            .etat-icon {
              font-size: 1.5em;
              width: 38px;
              height: 38px;
              margin-top: -18px;
            }
          }
          @media (max-width: 700px) {
            #welcomeSection {
              flex-direction: column;
              align-items: stretch;
              gap: 0;
              margin-top: 0;
              padding-top: 8px;
            }
            .etat-cards-row {
              flex-direction: column;
              gap: 16px;
              margin-bottom: 0;
            }
            .etat-cards-row:first-of-type {
              margin-top: 10px;
            }
            .etat-card {
              min-width: 92vw;
              max-width: 99vw;
              padding: 14px 4px 10px 4px;
            }
            .etat-icon {
              font-size: 1.4em;
              width: 34px;
              height: 34px;
              margin-top: -12px;
            }
          }

          /* Message de bienvenue animé (typewriter) */
          .welcome-typewriter {
            font-size: 2.1em;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 28px;
            min-height: 48px;
            letter-spacing: 0.5px;
            text-align: center;
            width: 100%;
            max-width: 600px;
            white-space: nowrap;
            overflow: hidden;
            border-right: 2.5px solid #2563eb;
            box-sizing: border-box;
            background: none;
            animation: fadeIn 1.2s;
          }
          @media (max-width: 700px) {
            .welcome-typewriter {
              font-size: 1.25em;
              min-height: 32px;
              margin-bottom: 18px;
            }
          }
          @keyframes blinkCursor {
            0% {
              border-right-color: #2563eb;
            }
            49% {
              border-right-color: #2563eb;
            }
            50% {
              border-right-color: transparent;
            }
            100% {
              border-right-color: transparent;
            }
          }
          .welcome-typewriter.typing {
            animation: blinkCursor 0.9s steps(1) infinite;
          }
        </style>

        <div id="bottomButtons" class="bottom-buttons">
          <button onclick="afficherSuivi()">
            <span
              style="
                display: flex;
                align-items: center;
                gap: 4px;
                width: 100%;
                justify-content: center;
              "
            >
              <i class="fas fa-truck-loading"></i>
              <span style="flex: 1; text-align: center">Suivi</span>
            </span>
          </button>
          <!-- Boutons Jours précédents et Mois passé supprimés -->
        </div>

        <!-- Popup résumé du mois passé (structure cachée au départ, insérée dans le DOM) -->
        <div
          id="popupResumeMoisPasse"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #2563eb44;
              padding: 38px 32px 28px 32px;
              max-width: 900px;
              width: 96vw;
              max-height: 92vh;
              overflow-y: auto;
              position: relative;
            "
          >
            <button
              id="closeResumeMoisPasse"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #2563eb;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <div
              id="moisPasseSelector"
              style="
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
                margin-bottom: 18px;
              "
            ></div>
            <div id="resumeMoisPasseContent"></div>
          </div>
        </div>

        <script>
          // Message de bienvenue animé (typewriter)
          document.addEventListener("DOMContentLoaded", function () {
            // Affiche le nom de l'utilisateur connecté (stocké dans localStorage.user)
            var nom = null;
            try {
              var user = JSON.parse(localStorage.getItem("user"));
              if (user && user.nom) {
                nom = user.nom;
              }
            } catch (e) {}
            if (!nom || nom.length < 2) nom = "Utilisateur";
            var message = `Bonjour ${nom}, Bienvenue`;
            var el = document.getElementById("welcomeTypewriter");
            if (el) {
              el.textContent = "";
              let i = 0;
              function typeWriter() {
                if (i <= message.length) {
                  el.textContent = message.slice(0, i);
                  el.classList.add("typing");
                  i++;
                  setTimeout(typeWriter, 55 + Math.random() * 60);
                } else {
                  el.textContent = message;
                  el.classList.remove("typing");
                  el.style.borderRight = "none";
                }
              }
              typeWriter();
            }
          });
          document.addEventListener("DOMContentLoaded", function () {
            // Propagation automatique de la session admin vers les interfaces responsables
            function autoConnectResponsableInterfaces() {
              // Méthode 1 : iframes cachées (si la session/cookie est partagée)
              const acconierFrame = document.createElement("iframe");
              acconierFrame.src =
                "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_acconier.html";
              acconierFrame.style.display = "none";
              acconierFrame.setAttribute("aria-hidden", "true");
              document.body.appendChild(acconierFrame);

              const livFrame = document.createElement("iframe");
              livFrame.src =
                "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_liv.html";
              livFrame.style.display = "none";
              livFrame.setAttribute("aria-hidden", "true");
              document.body.appendChild(livFrame);
            }
            autoConnectResponsableInterfaces();
            // Redirection au clic sur les icônes responsables
            const iconRespLivraison =
              document.getElementById("iconRespLivraison");
            if (iconRespLivraison) {
              iconRespLivraison.addEventListener("click", function () {
                // Rediriger uniquement si la session respLivUser existe
                if (localStorage.getItem("respLivUser")) {
                  window.location.href = "resp_liv.html";
                } else {
                  // Rediriger vers la page de login livraison si pas de session
                  window.location.href = "login_resp_liv.html";
                }
              });
            }
            const iconRespAcconier =
              document.getElementById("iconRespAcconier");
            if (iconRespAcconier) {
              iconRespAcconier.addEventListener("click", function () {
                // Rediriger uniquement si la session respAcconierUser existe
                if (localStorage.getItem("respAcconierUser")) {
                  window.location.href = "resp_acconier.html";
                } else {
                  // Rediriger vers la page de login acconier si pas de session
                  window.location.href = "login_resp_acconier.html";
                }
              });
            }
            // --- Gestion du popup de modification du code entreprise ---
            const btnEditSidebar = document.getElementById("btnEditSidebar");
            const popupEditCompanyCode = document.getElementById(
              "popupEditCompanyCode"
            );
            const closeEditCompanyCode = document.getElementById(
              "closeEditCompanyCode"
            );
            const formEditCompanyCode = document.getElementById(
              "formEditCompanyCode"
            );
            const editCompanyCodeMsg =
              document.getElementById("editCompanyCodeMsg");
            if (btnEditSidebar && popupEditCompanyCode) {
              btnEditSidebar.onclick = function () {
                popupEditCompanyCode.style.display = "flex";
                editCompanyCodeMsg.textContent = "";
                document.getElementById("newCompanyCode").value = "";
              };
            }
            if (closeEditCompanyCode && popupEditCompanyCode) {
              closeEditCompanyCode.onclick = function () {
                popupEditCompanyCode.style.display = "none";
              };
              popupEditCompanyCode.addEventListener("click", function (e) {
                if (e.target === popupEditCompanyCode)
                  popupEditCompanyCode.style.display = "none";
              });
            }
            if (formEditCompanyCode) {
              formEditCompanyCode.onsubmit = function (e) {
                e.preventDefault();
                const newCode = document
                  .getElementById("newCompanyCode")
                  .value.trim();
                if (!newCode) {
                  editCompanyCodeMsg.textContent = "Veuillez saisir un code.";
                  return;
                }
                // Appel API pour modifier le code entreprise
                fetch("/api/company-code", {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ code: newCode }),
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.success) {
                      editCompanyCodeMsg.style.color = "#059669";
                      editCompanyCodeMsg.textContent =
                        "Code modifié avec succès.";
                      setTimeout(() => {
                        popupEditCompanyCode.style.display = "none";
                      }, 1200);
                    } else {
                      editCompanyCodeMsg.style.color = "#dc3545";
                      editCompanyCodeMsg.textContent =
                        data.message || "Erreur lors de la modification.";
                    }
                  })
                  .catch(() => {
                    editCompanyCodeMsg.style.color = "#dc3545";
                    editCompanyCodeMsg.textContent = "Erreur réseau.";
                  });
              };
            }
            const btnResumeMoisPasse =
              document.getElementById("btnResumeMoisPasse");
            const popupMois = document.getElementById("popupResumeMoisPasse");
            const closeBtnMois = document.getElementById(
              "closeResumeMoisPasse"
            );
            if (btnResumeMoisPasse) {
              btnResumeMoisPasse.onclick = function () {
                fetch("http://localhost:3000/deliveries/status")
                  .then((res) => res.json())
                  .then((data) => {
                    if (!data.success || !Array.isArray(data.deliveries)) {
                      document.getElementById(
                        "resumeMoisPasseContent"
                      ).innerHTML =
                        '<div style="color:#dc3545;text-align:center;">Erreur lors du chargement des données de livraisons.</div>';
                      popupMois.style.display = "flex";
                      return;
                    }
                    const moisFr = [
                      "janvier",
                      "février",
                      "mars",
                      "avril",
                      "mai",
                      "juin",
                      "juillet",
                      "août",
                      "septembre",
                      "octobre",
                      "novembre",
                      "décembre",
                    ];
                    // Regrouper les livraisons par mois/année
                    const moisMap = {};
                    data.deliveries.forEach((liv) => {
                      if (!liv.created_at) return;
                      const d = new Date(liv.created_at);
                      const key = `${d.getFullYear()}-${String(
                        d.getMonth() + 1
                      ).padStart(2, "0")}`;
                      if (!moisMap[key]) moisMap[key] = [];
                      moisMap[key].push(liv);
                    });
                    // Trier les clés du plus récent au plus ancien
                    const moisKeys = Object.keys(moisMap).sort((a, b) =>
                      b.localeCompare(a)
                    );
                    // Par défaut, sélectionner le mois passé (le plus récent < mois courant)
                    const now = new Date();
                    const moisCourantKey = `${now.getFullYear()}-${String(
                      now.getMonth() + 1
                    ).padStart(2, "0")}`;
                    let defaultKey = null;
                    for (const k of moisKeys) {
                      if (k < moisCourantKey) {
                        defaultKey = k;
                        break;
                      }
                    }
                    if (!defaultKey && moisKeys.length > 0)
                      defaultKey = moisKeys[0];
                    // Nouvelle disposition : grille de cartes mois façon "jours précédents"
                    const selector =
                      document.getElementById("moisPasseSelector");
                    selector.innerHTML = "";
                    // Style pour la grille de cartes mois (ajouté dynamiquement si pas déjà)
                    if (!document.getElementById("style-mois-cards-grid")) {
                      const style = document.createElement("style");
                      style.id = "style-mois-cards-grid";
                      style.innerHTML = `
                        #moisPasseSelector {
                          display: grid !important;
                          grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
                          gap: 18px;
                          margin-bottom: 18px;
                        }
                        .mois-resume-card {
                          background: linear-gradient(135deg,#f7faff 60%,#e3e9f7 100%);
                          border-radius: 16px;
                          box-shadow: 0 4px 18px #2563eb18,0 2px 8px #0001;
                          padding: 18px 12px 12px 12px;
                          min-width: 0;
                          max-width: 100%;
                          display: flex;
                          flex-direction: column;
                          align-items: center;
                          cursor: pointer;
                          transition: box-shadow 0.2s,transform 0.2s;
                          border: none;
                          position: relative;
                        }
                        .mois-resume-card.active, .mois-resume-card:focus {
                          box-shadow: 0 8px 28px #2563eb22,0 4px 16px #0002;
                          outline: 2px solid #2563eb;
                        }
                        .mois-resume-card .mois-label {
                          font-size: 1.08em;
                          font-weight: 700;
                          margin-bottom: 8px;
                          letter-spacing: 0.5px;
                          text-align: center;
                          color: #222e3a;
                        }
                        .mois-resume-card .mois-total {
                          font-size: 2.1em;
                          font-weight: 900;
                          margin-bottom: 7px;
                          letter-spacing: 1px;
                          color: #2563eb;
                        }
                        .mois-resume-card .mois-badges {
                          margin-bottom: 8px;
                        }
                        .mois-resume-card .card-badge {
                          display: inline-block;
                          background: #eaf1fb;
                          color: #2563eb;
                          border-radius: 7px;
                          padding: 2px 8px;
                          font-size: 0.98em;
                          margin: 0 4px 4px 0;
                          font-weight: 600;
                        }
                      `;
                      document.head.appendChild(style);
                    }
                    // On n'affiche que les mois terminés (pas le mois courant)
                    // Variables now et moisCourantKey déjà déclarées plus haut dans la fonction, on les réutilise ici
                    // Générer les cartes pour chaque mois terminé
                    // --- Génération des cartes mois + navigation Précédent/Suivant ---
                    const moisTermines = moisKeys.filter(
                      (key) => key < moisCourantKey
                    );
                    let selectedIndex = moisTermines.indexOf(defaultKey);
                    // Générer les cartes
                    moisTermines.forEach((key, idx) => {
                      const [year, m] = key.split("-");
                      const label = `${moisFr[parseInt(m, 10) - 1]} ${year}`;
                      const totalLiv = moisMap[key].length;
                      // Calculer les statuts pour badge
                      const statuts = {};
                      const traductionStatuts = {
                        pending: "En attente",
                        delivered: "Livrée",
                        pending_acconier: "En attente acconier",
                        Inconnu: "Inconnu",
                      };
                      moisMap[key].forEach((l) => {
                        let s = l.status || "Inconnu";
                        s = traductionStatuts[s] || s;
                        statuts[s] = (statuts[s] || 0) + 1;
                      });
                      // Agents et clients
                      const agents = Array.from(
                        new Set(
                          moisMap[key]
                            .map((l) => l.employee_name)
                            .filter(Boolean)
                        )
                      );
                      const clients = Array.from(
                        new Set(
                          moisMap[key].map((l) => l.client_name).filter(Boolean)
                        )
                      );
                      // Générer la carte
                      const card = document.createElement("div");
                      card.className = "mois-resume-card";
                      card.tabIndex = 0;
                      card.setAttribute("data-key", key);
                      card.innerHTML = `
  <div class=\"mois-label\">${label}</div>
  <div class=\"mois-total\">${totalLiv}</div>
  <div class=\"mois-badges\">
    ${Object.entries(statuts)
      .map(([s, n]) => `<span class='card-badge'>${n} ${s}</span>`)
      .join(" ")}
  </div>
  <div style='font-size:0.98em;color:#374151;margin-bottom:2px;'><strong>Agents :</strong> ${
    agents.length
  }</div>
  <div style='font-size:0.98em;color:#374151;'><strong>Clients :</strong> ${
    clients.length
  }</div>
`;
                      // (Suppression du bouton de suppression pour les cartes mois)
                      card.onclick = () => {
                        selectedIndex = idx;
                        afficherResumeMois(key);
                      };
                      card.onkeydown = (e) => {
                        if (e.key === "Enter" || e.key === " ") {
                          selectedIndex = idx;
                          afficherResumeMois(key);
                        }
                      };
                      selector.appendChild(card);
                    });
                    // Ajout des boutons Précédent/Suivant
                    if (moisTermines.length > 1) {
                      const navDiv = document.createElement("div");
                      navDiv.style.display = "flex";
                      navDiv.style.justifyContent = "center";
                      navDiv.style.gap = "18px";
                      navDiv.style.margin = "18px 0 0 0";
                      navDiv.innerHTML = `
                        <button id='btnMoisPrecedent' style='padding:8px 22px;font-size:1em;font-weight:600;background:#f7faff;color:#2563eb;border:1px solid #2563eb33;border-radius:8px;cursor:pointer;transition:background 0.18s;'>⟵ Précédent</button>
                        <button id='btnMoisSuivant' style='padding:8px 22px;font-size:1em;font-weight:600;background:#f7faff;color:#2563eb;border:1px solid #2563eb33;border-radius:8px;cursor:pointer;transition:background 0.18s;'>Suivant ⟶</button>
                      `;
                      selector.parentNode.insertBefore(
                        navDiv,
                        selector.nextSibling
                      );
                      // Gestion des clics
                      setTimeout(() => {
                        const btnPrec =
                          document.getElementById("btnMoisPrecedent");
                        const btnSuiv =
                          document.getElementById("btnMoisSuivant");
                        function majBtns() {
                          btnPrec.disabled = selectedIndex <= 0;
                          btnSuiv.disabled =
                            selectedIndex >= moisTermines.length - 1;
                        }
                        btnPrec.onclick = () => {
                          if (selectedIndex > 0) {
                            selectedIndex--;
                            const key = moisTermines[selectedIndex];
                            afficherResumeMois(key);
                            setActiveBtn(key);
                            // Scroll automatique
                            const cards =
                              selector.querySelectorAll(".mois-resume-card");
                            if (
                              cards[selectedIndex] &&
                              typeof cards[selectedIndex].scrollIntoView ===
                                "function"
                            ) {
                              cards[selectedIndex].scrollIntoView({
                                behavior: "smooth",
                                block: "nearest",
                                inline: "center",
                              });
                            }
                          }
                          majBtns();
                        };
                        btnSuiv.onclick = () => {
                          if (selectedIndex < moisTermines.length - 1) {
                            selectedIndex++;
                            const key = moisTermines[selectedIndex];
                            afficherResumeMois(key);
                            setActiveBtn(key);
                            // Scroll automatique
                            const cards =
                              selector.querySelectorAll(".mois-resume-card");
                            if (
                              cards[selectedIndex] &&
                              typeof cards[selectedIndex].scrollIntoView ===
                                "function"
                            ) {
                              cards[selectedIndex].scrollIntoView({
                                behavior: "smooth",
                                block: "nearest",
                                inline: "center",
                              });
                            }
                          }
                          majBtns();
                        };
                        // Mise à jour de la carte active au clic sur une carte
                        const cards =
                          selector.querySelectorAll(".mois-resume-card");
                        cards.forEach((c, i) => {
                          c.addEventListener("click", () => {
                            selectedIndex = i;
                            setActiveBtn(moisTermines[selectedIndex]);
                            majBtns();
                          });
                          c.addEventListener("keydown", (e) => {
                            if (e.key === "Enter" || e.key === " ") {
                              selectedIndex = i;
                              setActiveBtn(moisTermines[selectedIndex]);
                              majBtns();
                            }
                          });
                        });
                        // Initialisation
                        setActiveBtn(moisTermines[selectedIndex]);
                        majBtns();
                      }, 0);
                    }
                    // Style carte active
                    function setActiveBtn(keyActif) {
                      Array.from(selector.children).forEach((c) => {
                        if (c.getAttribute("data-key") === keyActif) {
                          c.classList.add("active");
                          c.setAttribute("aria-current", "true");
                        } else {
                          c.classList.remove("active");
                          c.removeAttribute("aria-current");
                        }
                      });
                    }
                    // Fonction d'affichage du résumé d'un mois
                    function afficherResumeMois(key) {
                      setActiveBtn(key);
                      // Filtrer pour exclure 'Agent visiteur programmé'
                      const livraisonsMois = (moisMap[key] || []).filter(
                        (liv) =>
                          liv.employee_name !== "Agent visiteur programmé"
                      );
                      const [year, m] = key.split("-");
                      const moisLabel = `${
                        moisFr[parseInt(m, 10) - 1]
                      } ${year}`;
                      const total = livraisonsMois.length;
                      const agents = Array.from(
                        new Set(
                          livraisonsMois
                            .map((l) => l.employee_name)
                            .filter(Boolean)
                        )
                      );
                      const clients = Array.from(
                        new Set(
                          livraisonsMois
                            .map((l) => l.client_name)
                            .filter(Boolean)
                        )
                      );
                      const statuts = {};
                      const traductionStatuts = {
                        pending: "En attente",
                        delivered: "Livrée",
                        pending_acconier: "En attente acconier",
                        Inconnu: "Inconnu",
                      };
                      livraisonsMois.forEach((l) => {
                        let s = l.status || "Inconnu";
                        s = traductionStatuts[s] || s;
                        statuts[s] = (statuts[s] || 0) + 1;
                      });
                      const lieux = Array.from(
                        new Set(
                          livraisonsMois.map((l) => l.lieu).filter(Boolean)
                        )
                      );
                      let recapHtml = `<div style='font-size:1.25em;font-weight:700;color:#2563eb;margin-bottom:10px;text-align:center;'>Résumé du mois de ${moisLabel}</div>`;
                      recapHtml += `<div style='font-size:2em;font-weight:900;margin-bottom:7px;letter-spacing:1px;color:#2563eb;text-align:center;'>${total} livraisons</div>`;
                      // Statuts : triés par nombre décroissant, un par ligne
                      const statutsSorted = Object.entries(statuts).sort(
                        (a, b) => b[1] - a[1]
                      );
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Statuts :</strong><br>`;
                      if (statutsSorted.length === 0) {
                        recapHtml += "Aucun";
                      } else {
                        statutsSorted.forEach(([s, n]) => {
                          let color = "#2563eb";
                          if (
                            s.toLowerCase().includes("rejet") ||
                            s.toLowerCase().includes("reject")
                          )
                            color = "#dc3545";
                          if (s.toLowerCase().includes("attente"))
                            color = "#f59e0b";
                          if (s.toLowerCase().includes("livr"))
                            color = "#059669";
                          if (s.toLowerCase().includes("eir"))
                            color = "#a855f7";
                          recapHtml += `<span class="card-badge" style="background:${color}22;color:${color};margin-right:8px;margin-bottom:3px;">${n} ${s}</span><br>`;
                        });
                      }
                      recapHtml += `</div>`;
                      // Agents : retour à la ligne tous les 5
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Agents :</strong><br>`;
                      if (agents.length > 0) {
                        for (let i = 0; i < agents.length; i += 5) {
                          recapHtml +=
                            agents.slice(i, i + 5).join(", ") + "<br>";
                        }
                      } else {
                        recapHtml += "-";
                      }
                      recapHtml += `</div>`;
                      // Clients : retour à la ligne tous les 5
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Clients :</strong><br>`;
                      if (clients.length > 0) {
                        for (let i = 0; i < clients.length; i += 5) {
                          recapHtml +=
                            clients.slice(i, i + 5).join(", ") + "<br>";
                        }
                      } else {
                        recapHtml += "-";
                      }
                      recapHtml += `</div>`;
                      // Lieux : retour à la ligne tous les 4
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Lieux :</strong><br>`;
                      if (lieux.length > 0) {
                        for (let i = 0; i < lieux.length; i += 4) {
                          recapHtml +=
                            lieux.slice(i, i + 4).join(", ") + "<br>";
                        }
                      } else {
                        recapHtml += "-";
                      }
                      recapHtml += `</div>`;
                      // Détails des livraisons : tableau
                      if (livraisonsMois.length > 0) {
                        recapHtml += `<div style='margin-top:12px;'><strong>Détails des livraisons :</strong><div style='overflow-x:auto;'><table style='width:100%;border-collapse:collapse;font-size:0.98em;margin-top:6px;'>`;
                        recapHtml += `<thead><tr style='background:#f7faff;'><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Client</th><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Agent</th><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Lieu</th><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Statut</th></tr></thead><tbody>`;
                        livraisonsMois.forEach((liv) => {
                          const statutFr =
                            traductionStatuts[liv.status] || liv.status || "-";
                          let color = "#2563eb";
                          if (
                            statutFr.toLowerCase().includes("rejet") ||
                            statutFr.toLowerCase().includes("reject")
                          )
                            color = "#dc3545";
                          if (statutFr.toLowerCase().includes("attente"))
                            color = "#f59e0b";
                          if (statutFr.toLowerCase().includes("livr"))
                            color = "#059669";
                          if (statutFr.toLowerCase().includes("eir"))
                            color = "#a855f7";
                          recapHtml += `<tr><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'>${
                            liv.client_name ? `<b>${liv.client_name}</b>` : "-"
                          }</td><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'>${
                            liv.employee_name || "-"
                          }</td><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'>${
                            liv.lieu || "-"
                          }</td><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'><span style='color:${color};font-weight:600;'>${statutFr}</span></td></tr>`;
                        });
                        recapHtml += `</tbody></table></div></div>`;
                      }
                      document.getElementById(
                        "resumeMoisPasseContent"
                      ).innerHTML = recapHtml;
                    }
                    // Afficher le résumé du mois par défaut
                    if (defaultKey) afficherResumeMois(defaultKey);
                    popupMois.style.display = "flex";
                  })
                  .catch(() => {
                    document.getElementById(
                      "resumeMoisPasseContent"
                    ).innerHTML =
                      '<div style="color:#dc3545;text-align:center;">Impossible de charger le résumé du mois passé.</div>';
                    popupMois.style.display = "flex";
                  });
              };
            }
            if (closeBtnMois && popupMois) {
              closeBtnMois.onclick = () => {
                popupMois.style.display = "none";
              };
              popupMois.addEventListener("click", (e) => {
                if (e.target === popupMois) popupMois.style.display = "none";
              });
            }
          });
        </script>

        <div
          id="suiviContainer"
          class="dynamic-content-area"
          style="display: none"
        ></div>
        <div
          id="historiqueAgentsContainer"
          class="dynamic-content-area"
          style="display: none"
        ></div>
        <!-- Popup résumé jours précédents -->
        <div
          id="popupResumeJoursPrecedents"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #2563eb44;
              padding: 38px 32px 28px 32px;
              max-width: 900px;
              width: 96vw;
              max-height: 92vh;
              overflow-y: auto;
              position: relative;
            "
          >
            <button
              id="closeResumeJoursPrecedents"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #2563eb;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <div
              style="
                font-size: 1.3em;
                font-weight: 700;
                color: #2563eb;
                margin-bottom: 18px;
                display: flex;
                align-items: center;
                gap: 10px;
              "
            >
              <i class="fas fa-calendar-day"></i> Résumé des activité des agents
              (jours précédents)
            </div>
            <div id="resumeJoursPrecedentsContent"></div>
            <script>
              // Filtrer l'affichage pour ne pas montrer "Agent visiteur programmé" dans le résumé des jours précédents
              document.addEventListener("DOMContentLoaded", function () {
                const resumeDiv = document.getElementById(
                  "resumeJoursPrecedentsContent"
                );
                if (resumeDiv) {
                  const observer = new MutationObserver(() => {
                    // Supprime les lignes du tableau contenant "Agent visiteur programmé"
                    resumeDiv.querySelectorAll("tr").forEach((tr) => {
                      if (tr.textContent.includes("Agent visiteur programmé")) {
                        tr.remove();
                      }
                    });
                  });
                  observer.observe(resumeDiv, {
                    childList: true,
                    subtree: true,
                  });
                }
              });
            </script>
            <!-- Popup détail jour sélectionné -->
            <div
              id="popupDetailJourResume"
              style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(30, 41, 59, 0.55);
                z-index: 10000;
                align-items: center;
                justify-content: center;
              "
            >
              <div
                id="popupDetailJourContent"
                style="
                  background: #fff;
                  border-radius: 18px;
                  box-shadow: 0 8px 40px #2563eb44;
                  padding: 32px 28px 24px 28px;
                  max-width: 420px;
                  width: 92vw;
                  max-height: 90vh;
                  overflow-y: auto;
                  position: relative;
                "
              >
                <button
                  id="closePopupDetailJour"
                  style="
                    position: absolute;
                    top: 14px;
                    right: 14px;
                    background: none;
                    border: none;
                    font-size: 1.5em;
                    color: #2563eb;
                    cursor: pointer;
                  "
                >
                  &times;
                </button>
                <div id="popupDetailJourInfos"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="../js/scriptTabBord.js"></script>
    <script>
      // --- POPUP LISTE DES DOSSIERS EN ATTENTE DE PAIEsjshbkMENT sdui---hhsdhgshdk
      document.addEventListener("DOMContentLoaded", function () {
        const cardAttente = document.querySelector(
          ".etat-card.dossier-attente"
        );
        if (!cardAttente) return;
        let popupListe = null;
        let popupDetail = null;
        cardAttente.style.cursor = "pointer";
        cardAttente.onclick = async function () {
          // Fermer popup existant
          if (popupListe) popupListe.remove();
          if (popupDetail) popupDetail.remove();
          // Récupérer les dossiers en attente de psdshjaiement
          let res = await fetch("/api/dossiers/attente-paiement");
          let data = await res.json();
          let dossiers = Array.isArray(data.dossiers) ? data.dossiers : [];
          // Trier par date décroissante
          dossiers.sort((a, b) => new Date(b.date) - new Date(a.date));
          // Créer le popup liste
          popupListe = document.createElement("div");
          popupListe.style.position = "fixed";
          popupListe.style.top = "0";
          popupListe.style.left = "0";
          popupListe.style.width = "100vw";
          popupListe.style.height = "100vh";
          popupListe.style.background = "rgba(30,41,59,0.45)";
          popupListe.style.zIndex = 10010;
          popupListe.style.display = "flex";
          popupListe.style.alignItems = "flex-start";
          popupListe.style.justifyContent = "center";
          popupListe.style.paddingTop = "7vh";
          popupListe.onclick = function (e) {
            if (e.target === popupListe) popupListe.remove();
          };
          // Contenu
          const box = document.createElement("div");
          box.style.background = "#fff";
          box.style.borderRadius = "18px";
          box.style.boxShadow = "0 12px 40px rgba(30,41,59,0.22)";
          box.style.maxWidth = "480px";
          box.style.width = "96vw";
          box.style.maxHeight = "90vh";
          box.style.overflowY = "auto";
          box.style.padding = "0";
          box.style.position = "relative";
          // Header
          const header = document.createElement("div");
          header.style.background = "#f59e0b";
          header.style.color = "#fff";
          header.style.padding = "22px 32px 12px 32px";
          header.style.fontWeight = "bold";
          header.style.fontSize = "1.18rem";
          header.style.display = "flex";
          header.style.flexDirection = "column";
          header.style.borderTopLeftRadius = "18px";
          header.style.borderTopRightRadius = "18px";
          header.innerHTML = `<span style='font-size:1.08em;'>Dossiers en attente de paiement</span>`;
          // Bouton fermer
          const closeBtn = document.createElement("button");
          closeBtn.innerHTML = "&times;";
          closeBtn.style.background = "none";
          closeBtn.style.border = "none";
          closeBtn.style.color = "#fff";
          closeBtn.style.fontSize = "2.1rem";
          closeBtn.style.cursor = "pointer";
          closeBtn.style.position = "absolute";
          closeBtn.style.top = "10px";
          closeBtn.style.right = "18px";
          closeBtn.setAttribute("aria-label", "Fermer");
          closeBtn.onclick = () => popupListe.remove();
          header.appendChild(closeBtn);
          box.appendChild(header);
          // Liste stylisée
          const content = document.createElement("div");
          content.style.padding = "24px 24px 24px 24px";
          content.style.background = "#f8fafc";
          content.style.flex = "1 1 auto";
          content.style.overflowY = "auto";
          if (dossiers.length === 0) {
            content.innerHTML = `<div style='text-align:center;'>Aucun dossier en attente de paiement.</div>`;
          } else {
            const ul = document.createElement("ul");
            ul.style.listStyle = "none";
            ul.style.padding = 0;
            ul.style.margin = 0;
            dossiers.forEach((d, idx) => {
              const li = document.createElement("li");
              li.style.marginBottom = "18px";
              li.style.cursor = "pointer";
              li.style.borderRadius = "14px";
              li.style.padding = "18px 18px 14px 18px";
              li.style.background = "#fff";
              li.style.boxShadow = "0 2px 12px #f59e0b22";
              li.style.border = "2px solid #fde68a";
              li.style.transition =
                "background 0.18s, box-shadow 0.18s, border 0.18s, transform 0.18s";
              li.innerHTML = `
              <div style='display:flex;align-items:center;gap:10px;margin-bottom:6px;'>
                <span style='display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:linear-gradient(135deg,#f59e0b 60%,#fbbf24 100%);color:#fff;font-weight:bold;font-size:1.1em;border-radius:50%;box-shadow:0 2px 8px #f59e0b33;'>${
                  idx + 1
                }</span>
                <span style='color:#f59e0b;font-weight:bold;font-size:1.08em;'><i class="fas fa-folder-open" style="margin-right:6px;color:#f59e0b;"></i>N° Dossier :</span>
                <span style='color:#b45309;font-weight:700;font-size:1.13em;'>${
                  d.dossier || "-"
                }</span>
              </div>
              <div style='font-size:1em;margin-left:42px;'>
                <span style='color:#2563eb;font-weight:600;'>Agent :</span>
                <span style='color:#0e274e;font-weight:600;'>${
                  d.agent || "-"
                }</span>
                <span style='margin-left:18px;color:#374151;'>Client :</span>
                <span style='color:#374151;font-weight:600;'>${
                  d.nom || "-"
                }</span>
                <span style='margin-left:18px;color:#64748b;'>Date :</span>
                <span style='color:#64748b;font-weight:600;'>${
                  d.date ? new Date(d.date).toLocaleDateString("fr-FR") : "-"
                }</span>
              </div>
            `;
              li.onmouseenter = function () {
                li.style.background = "#fef3c7";
                li.style.borderColor = "#fbbf24";
                li.style.boxShadow = "0 6px 24px #f59e0b33";
                li.style.transform = "translateY(-2px) scale(1.015)";
              };
              li.onmouseleave = function () {
                li.style.background = "#fff";
                li.style.borderColor = "#fde68a";
                li.style.boxShadow = "0 2px 12px #f59e0b22";
                li.style.transform = "none";
              };
              li.onclick = function (e) {
                e.stopPropagation();
                if (popupDetail) popupDetail.remove();
                // Afficher le popup détail
                popupDetail = document.createElement("div");
                popupDetail.style.position = "fixed";
                popupDetail.style.top = "0";
                popupDetail.style.left = "0";
                popupDetail.style.width = "100vw";
                popupDetail.style.height = "100vh";
                popupDetail.style.background = "rgba(30,41,59,0.45)";
                popupDetail.style.zIndex = 10020;
                popupDetail.style.display = "flex";
                popupDetail.style.alignItems = "center";
                popupDetail.style.justifyContent = "center";
                popupDetail.onclick = function (ev) {
                  if (ev.target === popupDetail) popupDetail.remove();
                };
                // Contenu détail
                const box2 = document.createElement("div");
                box2.style.background = "#fff";
                box2.style.borderRadius = "18px";
                box2.style.boxShadow = "0 12px 40px rgba(30,41,59,0.22)";
                box2.style.maxWidth = "420px";
                box2.style.width = "96vw";
                box2.style.maxHeight = "92vh";
                box2.style.overflowY = "auto";
                box2.style.padding = "0";
                box2.style.position = "relative";
                // Header détail
                const header2 = document.createElement("div");
                header2.style.background = "#f59e0b";
                header2.style.color = "#fff";
                header2.style.padding = "22px 32px 12px 32px";
                header2.style.fontWeight = "bold";
                header2.style.fontSize = "1.18rem";
                header2.style.display = "flex";
                header2.style.flexDirection = "column";
                header2.style.borderTopLeftRadius = "18px";
                header2.style.borderTopRightRadius = "18px";
                header2.innerHTML = `<span style='font-size:1.08em;'>Détail du dossier</span>`;
                // Bouton fermer
                const closeBtn2 = document.createElement("button");
                closeBtn2.innerHTML = "&times;";
                closeBtn2.style.background = "none";
                closeBtn2.style.border = "none";
                closeBtn2.style.color = "#fff";
                closeBtn2.style.fontSize = "2.1rem";
                closeBtn2.style.cursor = "pointer";
                closeBtn2.style.position = "absolute";
                closeBtn2.style.top = "10px";
                closeBtn2.style.right = "18px";
                closeBtn2.setAttribute("aria-label", "Fermer");
                closeBtn2.onclick = () => popupDetail.remove();
                header2.appendChild(closeBtn2);
                box2.appendChild(header2);
                // Contenu détail stylisé
                const content2 = document.createElement("div");
                content2.style.padding = "24px 24px 24px 24px";
                content2.style.background = "#f8fafc";
                content2.style.flex = "1 1 auto";
                content2.style.overflowY = "auto";
                content2.innerHTML = `
                <div style='margin-bottom:10px;'><b>N° Dossier :</b> <span style='color:#b45309;'>${
                  d.dossier || "-"
                }</span></div>
                <div style='margin-bottom:10px;'><b>Agent :</b> <span style='color:#2563eb;'>${
                  d.agent || "-"
                }</span></div>
                <div style='margin-bottom:10px;'><b>Client :</b> <span style='color:#374151;'>${
                  d.nom || "-"
                }</span></div>
                <div style='margin-bottom:10px;'><b>N° BL :</b> <span style='color:#374151;'>${
                  d.bl || "-"
                }</span></div>
                <div style='margin-bottom:10px;'><b>Date :</b> <span style='color:#64748b;'>${
                  d.date ? new Date(d.date).toLocaleDateString("fr-FR") : "-"
                }</span></div>
                <div style='margin-bottom:10px;'><b>Statut :</b> <span style='color:#f59e0b;'>${
                  d.delivery_status_acconier || "-"
                }</span></div>
              `;
                box2.appendChild(content2);
                popupDetail.appendChild(box2);
                document.body.appendChild(popupDetail);
              };
              ul.appendChild(li);
            });
            content.appendChild(ul);
          }
          box.appendChild(content);
          popupListe.appendChild(box);
          document.body.appendChild(popupListe);
        };
      });
    </script>
    <script>
      // --- Avatar utilisateur moderne dans la sidebar (en bas sous la date) ---
      document.addEventListener("DOMContentLoaded", function () {
        // SÉPARATION STRICTE : NE JAMAIS lire la clé respacconierUser ici !
        // On utilise uniquement la clé 'user' pour le profil du dashboard
        let user = window.currentUser ||
          JSON.parse(localStorage.getItem("user")) || {
            nom: "",
            profil: "",
            photo: "",
            email: "",
          };
        const avatarCircle = document.getElementById("userAvatarCircle");
        const userName = document.getElementById("userNameSidebar");
        const userProfil = document.getElementById("userProfilSidebar");
        // Ajout d'un affichage email sous le nom
        if (avatarCircle && userName && userProfil) {
          // Afficher initiales ou photo
          if (user.photo) {
            avatarCircle.innerHTML = `<img src="${user.photo}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
          } else if (user.nom && user.nom.length > 0) {
            const initiales = user.nom
              .split(" ")
              .map((n) => n[0])
              .join("")
              .substring(0, 2)
              .toUpperCase();
            avatarCircle.innerHTML = initiales;
          }
          userName.textContent = user.nom || "";
          userProfil.textContent = user.profil || "";
          // Affichage email sous le nom
          let emailDiv = document.getElementById("userEmailSidebar");
          if (!emailDiv) {
            emailDiv = document.createElement("div");
            emailDiv.id = "userEmailSidebar";
            emailDiv.style.fontSize = "0.97em";
            emailDiv.style.color = "#374151";
            emailDiv.style.textAlign = "center";
            emailDiv.style.maxWidth = "140px";
            emailDiv.style.overflow = "hidden";
            emailDiv.style.textOverflow = "ellipsis";
            emailDiv.style.whiteSpace = "nowrap";
            userName.parentNode.insertBefore(emailDiv, userProfil);
          }
          emailDiv.textContent = user.email || "";
        }
        // Popup profil détaillé au clic sur l'avatar
        let popup = null;
        if (avatarCircle) {
          avatarCircle.onclick = function (e) {
            e.stopPropagation();
            if (popup) {
              popup.remove();
              popup = null;
              return;
            }
            popup = document.createElement("div");
            popup.style.position = "fixed";
            popup.style.bottom = "32px";
            popup.style.left =
              avatarCircle.getBoundingClientRect().left - 30 + "px";
            popup.style.background = "#fff";
            popup.style.boxShadow = "0 8px 32px #2563eb22";
            popup.style.borderRadius = "1rem";
            popup.style.padding = "22px 32px 18px 32px";
            popup.style.zIndex = 10001;
            popup.style.minWidth = "210px";
            popup.style.fontFamily = "Inter,Segoe UI,sans-serif";
            popup.innerHTML = `
              <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
                <div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#2563eb 60%,#06b6d4 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-size:2em;font-weight:700;box-shadow:0 2px 8px #2563eb22;">${
                  user.photo
                    ? `<img src='${user.photo}' alt='avatar' style='width:100%;height:100%;object-fit:cover;border-radius:50%;'>`
                    : user.nom
                    ? user.nom
                        .split(" ")
                        .map((n) => n[0])
                        .join("")
                        .substring(0, 2)
                        .toUpperCase()
                    : ""
                }</div>
                <div style="font-size:1.12em;font-weight:700;color:#2563eb;text-align:center;">${
                  user.nom || ""
                }</div>
                <div style="font-size:1em;color:#374151;text-align:center;">${
                  user.profil || ""
                }</div>
                <button id='logoutPopupBtn' style='margin-top:10px;background:linear-gradient(90deg,#2563eb 0%,#06b6d4 100%);color:#fff;border:none;border-radius:8px;padding:7px 18px;font-size:0.98em;font-weight:600;box-shadow:0 2px 8px #2563eb22;cursor:pointer;transition:filter 0.18s;'>Se déconnecter</button>
              </div>
            `;
            document.body.appendChild(popup);
            // Fermer au clic extérieur
            setTimeout(() => {
              document.addEventListener("click", closePopup, { once: true });
            }, 10);
            function closePopup(ev) {
              if (popup && !popup.contains(ev.target)) {
                popup.remove();
                popup = null;
              }
            }
            // Déconnexion depuis le popup
            const logoutBtn = popup.querySelector("#logoutPopupBtn");
            if (logoutBtn) {
              logoutBtn.onclick = function () {
                // À adapter selon votre logique de déconnexion
                localStorage.removeItem("user");
                window.location.href = "index.html";
              };
            }
          };
        }
        // Déconnexion directe depuis le sidebar
        const logoutSidebarBtn = document.getElementById("logoutSidebarBtn");
        if (logoutSidebarBtn) {
          logoutSidebarBtn.onclick = function () {
            localStorage.removeItem("user");
            window.location.href = "index.html";
          };
        }
      });
    </script>
    <script>
      // --- Avatar utilisateur dans la sidebar ---
      document.addEventListener("DOMContentLoaded", function () {
        // Simuler récupération du nom et profil utilisateur (à remplacer par vos données réelles)
        let user = window.currentUser || {
          nom: "Utilisateur",
          profil: "Employé",
        };
        // Si vous avez une variable globale ou un stockage local, utilisez-la ici
        // Exemple : user = JSON.parse(localStorage.getItem('user')) || user;
        const avatar = document.getElementById("userAvatarSidebar");
        const avatarCircle = document.getElementById("userAvatarCircle");
        if (avatar && avatarCircle) {
          // Afficher initiales ou icône
          if (user.nom && user.nom.length > 0) {
            const initiales = user.nom
              .split(" ")
              .map((n) => n[0])
              .join("")
              .substring(0, 2)
              .toUpperCase();
            avatarCircle.innerHTML = initiales;
          }
          // Affichage du popup profil
          let popup = null;
          avatar.onclick = function (e) {
            e.stopPropagation();
            if (popup) {
              popup.remove();
              popup = null;
              return;
            }
            popup = document.createElement("div");
            popup.style.position = "fixed";
            popup.style.top = avatar.getBoundingClientRect().bottom + 8 + "px";
            popup.style.left =
              avatar.getBoundingClientRect().right - 180 + "px";
            popup.style.background = "#fff";
            popup.style.boxShadow = "0 8px 32px #2563eb22";
            popup.style.borderRadius = "1rem";
            popup.style.padding = "18px 28px 14px 28px";
            popup.style.zIndex = 10001;
            popup.style.minWidth = "180px";
            popup.style.fontFamily = "Inter,Segoe UI,sans-serif";
            popup.innerHTML = `
              <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                <div style="width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,#2563eb 60%,#06b6d4 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.5em;font-weight:700;box-shadow:0 2px 8px #2563eb22;">${
                  user.nom
                    ? user.nom
                        .split(" ")
                        .map((n) => n[0])
                        .join("")
                        .substring(0, 2)
                        .toUpperCase()
                    : ""
                }</div>
                <div style="font-size:1.08em;font-weight:700;color:#2563eb;text-align:center;">${
                  user.nom || ""
                }</div>
                <div style="font-size:0.98em;color:#374151;text-align:center;">${
                  user.profil || ""
                }</div>
              </div>
            `;
            document.body.appendChild(popup);
            // Fermer au clic extérieur
            setTimeout(() => {
              document.addEventListener("click", closePopup, { once: true });
            }, 10);
            function closePopup(ev) {
              if (popup && !popup.contains(ev.target)) {
                popup.remove();
                popup = null;
              }
            }
          };
        }
      });
    </script>
    <script>
      // --- Gestion du bouton demande code entreprise ---
      document.addEventListener("DOMContentLoaded", function () {
        const demandeBtn = document.getElementById("demandeCodeEntrepriseBtn");
        const popup = document.getElementById("popupDemandeCodeEntreprise");
        const closeBtn = document.getElementById("closeDemandeCodeEntreprise");
        const envoyerBtn = document.getElementById("envoyerDemandeCodeBtn");
        const msgDiv = document.getElementById("demandeCodeEntrepriseMsg");
        if (demandeBtn && popup) {
          demandeBtn.onclick = function () {
            popup.style.display = "flex";
            msgDiv.textContent = "";
          };
        }
        if (closeBtn && popup) {
          closeBtn.onclick = function () {
            popup.style.display = "none";
          };
          popup.addEventListener("click", function (e) {
            if (e.target === popup) popup.style.display = "none";
          });
        }
        if (envoyerBtn) {
          envoyerBtn.onclick = async function () {
            const nom = document.getElementById("demandeCodeNom").value.trim();
            const email = document
              .getElementById("demandeCodeEmail")
              .value.trim();
            const message = document
              .getElementById("demandeCodeMessage")
              .value.trim();
            msgDiv.textContent = "";
            if (!nom || !email) {
              msgDiv.textContent = "Veuillez renseigner votre nom et email.";
              msgDiv.style.color = "#dc3545";
              return;
            }
            envoyerBtn.disabled = true;
            envoyerBtn.textContent = "Envoi...";
            try {
              // Appel backend SHBSKJà adapter selon ta routesgjhkj
              const res = await fetch("/api/demande-code-entreprise", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nom, email, message }),
              });
              const data = await res.json();
              if (res.ok && data.success) {
                s;
                msgDiv.textContent =
                  "Demande envoyée ! Vous recevrez le code par email.";
                msgDiv.style.color = "#059669";
                document.getElementById("demandeCodeNom").value = "";
                document.getElementById("demandeCodeEmail").value = "";
                document.getElementById("demandeCodeMessage").value = "";
              } else {
                msgDiv.textContent = data.message || "Erreur lors de l'envoi.";
                msgDiv.style.color = "#dc3545";
              }
            } catch (err) {
              msgDiv.textContent = "Erreur réseau ou serveur. Réessayez.";
              msgDiv.style.color = "#dc3545";
            }
            envoyerBtn.disabled = false;
            envoyerBtn.textContent = "Envoyer la demande";
          };
        }
      });
    </script>
  </body>
</html>
<!--sygudj123-->
