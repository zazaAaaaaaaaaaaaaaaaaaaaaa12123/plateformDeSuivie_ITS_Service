<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/reconnecting-websocket@4.4.0/dist/reconnecting-websocket.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Centre de Contact Clients</title>

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    />

    <link rel="stylesheet" href="/css/styledeTabBord.css" />
    <link rel="stylesheet" href="/css/styleDeSuivie.css" />
    <link rel="stylesheet" href="/css/styleHistoriqueAgents.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      /* Animation pour la modal */
      @keyframes modalAppear {
        0% {
          opacity: 0;
          transform: scale(0.8) translateY(-20px);
        }
        100% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      @keyframes modalBackdropAppear {
        0% {
          opacity: 0;
          backdrop-filter: blur(0px);
        }
        100% {
          opacity: 1;
          backdrop-filter: blur(8px);
        }
      }

      /* Styles généraux pour le corps */
      html,
      body {
        overflow: hidden;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      body {
        background: #f8f9fa;
        color: #333;
        min-height: 90vh;
        padding: 20px;
      }

      .layout {
        display: flex;
        max-width: 100%;
        margin: 0 auto;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        background: white;
        transition: all 0.3s ease;
        height: 100vh;
      }

      /* --- AMELIORATIONS POUR LA SIDEBAR - Version "Sublimée" --- */

      /* SIDEBAR - Styles généraux */
      .sidebar {
        background: linear-gradient(180deg, #303d4c 0%, #212a33 100%);
        color: #e0e6ec;
        padding: 15px 12px;
        width: 250px;
        height: calc(100vh + 100px);
        box-shadow: 8px 0 25px rgba(0, 0, 0, 0.3);
        font-family: "Inter", sans-serif;
        transition: width 0.4s ease-in-out, padding 0.4s ease-in-out,
          background 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* Titre du menu */
      .sidebar h2 {
        font-size: 1.6em;
        margin-bottom: 25px;
        font-weight: 700;
        color: #a3daff;
        border-bottom: 2px solid #63b3ed;
        padding-bottom: 12px;
        text-align: center;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        overflow: hidden;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        flex-shrink: 0;
      }

      /* Cache l'icône de bascule du H2 si tu ne l'utilises pas en mode déplié */
      .sidebar h2 .toggle-icon {
        display: none;
      }

      /* Liste menu */
      .sidebar ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        flex-shrink: 0;
      }

      .sidebar ul li {
        margin-bottom: 8px;
        width: 100%;
      }

      /* Liens du menu */
      .sidebar ul li a {
        display: flex;
        align-items: center;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.05rem;
        padding: 12px 18px;
        border-radius: 8px;
        transition: background-color 0.25s ease, color 0.25s ease,
          transform 0.25s ease, box-shadow 0.25s ease;
        color: #e0e6ec;
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 0 0 0px rgba(99, 179, 237, 0.4);
      }

      /* Hover des liens - Effet de surbrillance plus doux et élégant */
      .sidebar ul li a:hover {
        background-color: #3f5166;
        color: #a3daff;
        transform: translateX(8px);
        box-shadow: inset 0 0 0 2px #63b3ed, 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      /* Icône des liens */
      .sidebar ul li a .icon {
        margin-right: 18px;
        font-size: 1.3em;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: transparent;
        color: #a3daff;
        border-radius: 0;
        transition: color 0.25s ease, transform 0.25s ease;
      }

      /* Icône hover avec lien */
      .sidebar ul li a:hover .icon {
        color: #e0e6ec;
        transform: scale(1.15) rotate(5deg);
      }

      /* Texte des liens */
      .link-text {
        opacity: 1;
        transition: opacity 0.3s ease, width 0.3s ease;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      /* Style pour le calendrier - Visibilité par défaut */
      .calendar-container {
        margin-top: 40px;
        padding: 0 10px;
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .calendar-container label {
        font-weight: 500;
        color: #b0bec5;
        display: block;
        margin-bottom: 10px;
        font-size: 0.95rem;
      }

      .calendar-container input[type="date"] {
        width: 100%;
        padding: 10px 12px;
        font-size: 0.95rem;
        border: 1px solid #4a5d6f;
        background-color: #2a3540;
        color: #e0e6ec;
        border-radius: 6px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        -webkit-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%23e0e6ec"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 30px;
      }

      .calendar-container input[type="date"]:focus {
        border-color: #63b3ed;
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.4);
      }

      /* --- État COLLAPSED de la sidebar (quand le body a la classe 'sidebar-collapsed') --- */
      body.sidebar-collapsed .sidebar {
        width: 90px;
        padding: 15px 0;
        background: linear-gradient(180deg, #303d4c 0%, #212a33 100%);
        box-shadow: 8px 0 25px rgba(0, 0, 0, 0.3);
        overflow-y: auto;
        overflow-x: hidden;
      }

      /* Styles pour le profil utilisateur en mode collapsed */
      body.sidebar-collapsed #sidebarUserProfile {
        margin-top: 15px !important;
        padding: 8px 4px !important;
        background: transparent !important;
        border: none !important;
      }

      body.sidebar-collapsed #userAvatarCircle {
        width: 40px !important;
        height: 40px !important;
        font-size: 1.4em !important;
        margin-bottom: 0 !important;
      }

      body.sidebar-collapsed #userNameSidebar,
      body.sidebar-collapsed #userEmailSidebar,
      body.sidebar-collapsed #userProfilSidebar {
        display: none !important;
      }

      /* Styles pour les icônes responsables en mode collapsed */
      body.sidebar-collapsed
        #sidebarUserProfile
        > div[style*="flex-direction: row"] {
        justify-content: center !important;
        gap: 6px !important;
        margin-top: 6px !important;
        padding: 6px !important;
        background: transparent !important;
        border: none !important;
      }
      body.sidebar-collapsed
        #sidebarUserProfile
        > div[style*="flex-direction: row"]
        span {
        width: 26px !important;
        height: 26px !important;
        font-size: 0.9em !important;
        margin: 0 1px !important;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2) !important;
      }
      body.sidebar-collapsed
        #sidebarUserProfile
        > div[style*="flex-direction: row"]
        i {
        font-size: 0.9em !important;
      }

      /* Section connectés en mode collapsed */
      body.sidebar-collapsed #detailedUsersSection {
        margin-top: 6px !important;
        padding: 6px !important;
        background: rgba(37, 99, 235, 0.1) !important;
        border-radius: 8px !important;
        max-height: 180px !important;
        min-height: 120px !important;
      }

      body.sidebar-collapsed #detailedUsersSection h4 {
        font-size: 0.7em !important;
        text-align: center !important;
      }

      body.sidebar-collapsed #totalUsersCount {
        font-size: 0.65em !important;
        padding: 1px 4px !important;
      }

      body.sidebar-collapsed #usersDetailsList {
        font-size: 0.65em !important;
        margin-bottom: 6px !important;
      }

      body.sidebar-collapsed #logoutSidebarBtn {
        padding: 6px 8px !important;
        font-size: 0.7em !important;
        gap: 3px !important;
      }

      body.sidebar-collapsed .sidebar h2 {
        justify-content: center;
        border-bottom: none;
        padding-bottom: 0;
        color: #a3daff;
        font-size: 1.5em;
      }

      /* Texte "Menu" à masquer quand la sidebar est pliée */
      body.sidebar-collapsed .sidebar h2 span.link-text {
        opacity: 0;
        visibility: hidden;
        width: 0;
        margin-right: 0;
      }

      /* Centrage des éléments de la liste UL en mode plié */
      body.sidebar-collapsed .sidebar ul {
        align-items: center;
      }

      /* Centrage des liens LI en mode plié */
      body.sidebar-collapsed .sidebar ul li {
        justify-content: center;
        width: auto;
        margin-bottom: 18px; /* Augmente l'espacement en mode réduit */
      }

      /* Texte des liens (masqué en mode plié) */
      body.sidebar-collapsed .link-text {
        opacity: 0;
        visibility: hidden;
        width: 0;
        padding: 0;
        margin: 0;
      }

      body.sidebar-collapsed .calendar-container label,
      body.sidebar-collapsed .calendar-container input {
        opacity: 0;
        visibility: hidden;
        width: 0;
        padding: 0;
        margin: 0;
        height: 0;
      }

      /* Styles pour les bulles en mode plié */
      body.sidebar-collapsed .sidebar ul li a .icon {
        margin-right: 0;
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background-color: #63b3ed;
        color: white !important;
        font-size: 1.6em;
        box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.4);
        transform: scale(1);
        transition: all 0.3s ease;
      }

      /* Ajustements pour l'icône au survol en mode plié */
      body.sidebar-collapsed .sidebar ul li a:hover .icon {
        background-color: #4299e1;
        transform: translateY(-5px) scale(1.15);
        box-shadow: 6px 6px 15px rgba(0, 0, 0, 0.5);
      }

      body.sidebar-collapsed .sidebar ul li a {
        justify-content: center;
        padding: 10px 0;
        align-items: center;
        background-color: transparent !important;
        color: white !important;
        width: 100%;
      }

      /* Supprime le pseudo-élément au survol qui était caché précédemment */
      body.sidebar-collapsed .sidebar ul li a:hover::before {
        display: none !important;
      }

      /* Médias queries pour les petits écrans - S'assure que les icônes redeviennent normales */
      @media (max-width: 768px) {
        .sidebar ul li a .icon {
          width: auto !important;
          height: auto !important;
          border-radius: 0 !important;
          background-color: transparent !important;
          box-shadow: none !important;
          transform: none !important;
          font-size: 1em !important;
          margin-right: 14px !important;
        }

        .sidebar ul li a:hover .icon {
          background-color: transparent !important;
          transform: none !important;
          box-shadow: none !important;
        }
        .sidebar ul li a {
          padding: 10px 15px !important;
          justify-content: flex-start !important;
        }
      }

      /* --- Styles pour l'indicateur de connexion --- */
      .connection-status {
        margin-left: 10px;
        font-size: 1.2em;
        transition: color 0.3s ease, transform 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* Couleur par défaut (connecté) */
      .connection-status .fas {
        color: #28a745; /* Vert pour connecté */
      }

      /* Style quand l'utilisateur est hors ligne */
      .connection-status.offline .fas {
        color: #dc3545; /* Rouge pour déconnecté */
        transform: rotate(
          45deg
        ); /* Petite rotation pour indiquer le changement */
      }

      /* Ajustements pour le mode plié de la sidebar */
      body.sidebar-collapsed .sidebar h2 .connection-status {
        margin-left: 0;
        font-size: 1.5em;
      }

      body.sidebar-collapsed .sidebar h2 {
        justify-content: center;
      }

      /* --- Styles pour l'alerte de connexion/déconnexion --- */
      .custom-alert {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 25px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .custom-alert.success {
        background-color: #28a745;
      }

      .custom-alert.error {
        background-color: #dc3545;
      }

      .custom-alert.show {
        opacity: 1;
        visibility: visible;
      }

      /* --- Styles pour le contenu principal (welcome, buttons) --- */
      .welcome-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 80vh;
        text-align: center;
        padding: 0 20px;
        background: linear-gradient(to right, #ffffff, #f3f4f6);
        /* animation: fadeIn 1.2s ease-in-out; Désactivé pour enlever l'animation */
      }

      .welcome-container h1 {
        font-size: 3rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1rem;
        font-family: "Inter", sans-serif;
      }

      .welcome-container p {
        font-size: 1.2rem;
        color: #4b5563;
        margin-bottom: 2.5rem;
        max-width: 600px;
        line-height: 1.6;
      }

      .bottom-buttons {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 18px;
        z-index: 10;
        width: 100%;
        padding: 0;
      }

      .bottom-buttons button {
        background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%);
        color: #fff;
        border: none;
        padding: 7px 10px;
        border-radius: 8px;
        font-size: 0.92rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 8px #2563eb22, 0 1px 4px #0001;
        transition: background 0.25s, transform 0.18s, box-shadow 0.25s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-family: "Inter", sans-serif;
        letter-spacing: 0.2px;
        outline: none;
        min-width: 90px;
        max-width: 160px;
        height: 32px;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .bottom-buttons button:hover,
      .bottom-buttons button:focus {
        background: linear-gradient(90deg, #1d4ed8 0%, #2563eb 100%);
        transform: translateY(-3px) scale(1.04);
        box-shadow: 0 12px 32px #2563eb33, 0 4px 16px #0002;
      }

      .bottom-buttons i {
        font-size: 1.05em;
        margin-right: 4px;
      }

      @media (max-width: 700px) {
        .bottom-buttons {
          flex-direction: column;
          gap: 10px;
          bottom: 12px;
        }
        .bottom-buttons button {
          width: 90vw;
          max-width: 320px;
          font-size: 0.98em;
          padding: 10px 0;
          height: 40px;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .main-content {
        flex-grow: 1;
        padding: 30px;
        background-color: #f7f9fc;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
        min-width: 0;
        transition: margin-left 0.3s ease, width 0.3s ease;
        box-sizing: border-box;
      }
      .dynamic-content-area,
      #content {
        flex-grow: 1;
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        min-width: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .green-dot-animated {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #28a745;
        margin-left: 12px;
        box-shadow: 0 0 0 0 #28a745;
        /* animation: greenDotPulse 1s infinite cubic-bezier(0.66, 0, 0, 1); Désactivé pour enlever l'animation */
        vertical-align: middle;
      }
      #btnResumeJoursPrecedents {
        font-size: 0.8rem;
      }
      @keyframes greenDotPulse {
        0% {
          box-shadow: 0 0 0 0 #28a74599;
          opacity: 1;
        }
        70% {
          box-shadow: 0 0 0 10px #28a74500;
          opacity: 1;
        }
        100% {
          box-shadow: 0 0 0 0 #28a74500;
          opacity: 1;
        }
      }

      /* === POPUP MODIFICATION CODE ENTREPRISE (ADMIN) === */
      #popupEditCompanyCode {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(30, 41, 59, 0.55);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }

      #popupEditCompanyCode .content {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 40px #05966944;
        padding: 38px 32px 28px 32px;
        max-width: 420px;
        width: 96vw;
        max-height: 92vh;
        overflow-y: auto;
        position: relative;
      }

      #popupEditCompanyCode h2 {
        font-size: 1.3em;
        font-weight: 700;
        color: #059669;
        margin-bottom: 18px;
      }

      #popupEditCompanyCode label {
        font-weight: 600;
        color: #374151;
      }

      #popupEditCompanyCode input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1.1em;
        margin-top: 6px;
        margin-bottom: 14px;
      }

      #popupEditCompanyCode button {
        width: 100%;
        background: #059669;
        color: #fff;
        font-weight: 700;
        padding: 10px 0;
        border-radius: 8px;
        font-size: 1.1em;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
      }

      #popupEditCompanyCode button:hover {
        background: #047857;
      }

      #popupEditCompanyCode .close {
        position: absolute;
        top: 18px;
        right: 18px;
        background: none;
        border: none;
        font-size: 1.5em;
        color: #059669;
        cursor: pointer;
      }

      #popupEditCompanyCode .message {
        font-size: 0.98em;
        margin-bottom: 10px;
        text-align: center;
      }

      /* --- Fin styles popup admin --- */

      /* === STYLES AMÉLIORÉS POUR LES CARTES ET BADGES === */

      /* Animation de pulsation pour les cartes actives */
      @keyframes cardPulse {
        0% {
          transform: translateY(0) scale(1);
        }
        50% {
          transform: translateY(-2px) scale(1.02);
        }
        100% {
          transform: translateY(0) scale(1);
        }
      }

      /* Animation de rotation douce pour les badges */
      @keyframes badgeRotate {
        0% {
          transform: rotate(0deg) scale(1);
        }
        25% {
          transform: rotate(5deg) scale(1.1);
        }
        75% {
          transform: rotate(-5deg) scale(1.1);
        }
        100% {
          transform: rotate(0deg) scale(1);
        }
      }

      /* Animation de bouncing pour les nouvelles valeurs */
      @keyframes badgeBounce {
        0% {
          transform: scale(1) translateY(0);
        }
        30% {
          transform: scale(1.3) translateY(-8px);
        }
        50% {
          transform: scale(1.1) translateY(-4px);
        }
        70% {
          transform: scale(1.2) translateY(-6px);
        }
        100% {
          transform: scale(1) translateY(0);
        }
      }

      /* Animation de particules flottantes */
      @keyframes floatingParticle {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        50% {
          opacity: 0.7;
          transform: translateY(-20px) scale(1.2);
        }
        100% {
          opacity: 0;
          transform: translateY(-40px) scale(0);
        }
      }

      /* Styles pour les cartes avec effet glassmorphism */
      .etat-card {
        position: relative;
        backdrop-filter: blur(20px);
        background: rgba(255, 255, 255, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        overflow: visible;
      }

      .etat-card:hover {
        transform: translateY(-8px) scale(1.03);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
          0 8px 30px rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.35);
      }

      /* Amélioration des badges de compteurs */
      .card-counter {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif !important;
        font-weight: 800 !important;
        letter-spacing: -0.5px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        user-select: none;
        /* animation: badgeBounce 0.6s ease-out; Désactivé pour enlever l'animation */
      }

      .card-counter:hover {
        /* animation: badgeRotate 0.8s ease-in-out; Désactivé pour enlever l'animation */
      }

      /* Effet de brillance sur les badges */
      .card-counter::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(
          45deg,
          transparent 30%,
          rgba(255, 255, 255, 0.3) 50%,
          transparent 70%
        );
        border-radius: inherit;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: -1;
      }

      .card-counter:hover::before {
        opacity: 0;
        /* animation: shimmer 1.5s ease-in-out infinite; Désactivé pour enlever l'animation */
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) rotate(45deg);
        }
      }

      /* Styles spécifiques selon le type de carte */
      #carteAttentePaiement .card-counter {
        background: linear-gradient(
          135deg,
          #f59e0b 0%,
          #d97706 100%
        ) !important;
        box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3),
          0 2px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      }

      #carteMiseLivraison .card-counter {
        background: linear-gradient(
          135deg,
          #3b82f6 0%,
          #2563eb 100%
        ) !important;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3),
          0 2px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      }

      #carteLivre .card-counter {
        background: linear-gradient(
          135deg,
          #10b981 0%,
          #059669 100%
        ) !important;
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3),
          0 2px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      }

      /* Animation de mise à jour des cartes */
      .card-updating {
        /* animation: cardPulse 1s ease-in-out; Désactivé pour enlever l'animation */
      }

      /* Effet de glow pour les badges actifs */
      .card-counter.updating {
        animation: badgeBounce 0.6s ease-out,
          glow 2s ease-in-out infinite alternate;
      }

      @keyframes glow {
        from {
          filter: drop-shadow(0 0 5px currentColor);
        }
        to {
          filter: drop-shadow(0 0 15px currentColor);
        }
      }

      /* Responsive pour les badges */
      @media (max-width: 768px) {
        .card-counter {
          font-size: 0.8em !important;
          padding: 6px 10px !important;
          min-width: 24px !important;
          min-height: 24px !important;
        }
      }

      /* === FIN STYLES CARTES ET BADGES === */

      /* === ANIMATIONS DE LIAISON DES CARTES SYNCHRONISÉES === */

      /* Conteneur pour les lignes de connexion */
      .card-connections {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
        overflow: hidden;
      }

      /* Lignes de connexion désactivées pour enlever les animations */
      .connection-line {
        display: none !important; /* Supprime toutes les lignes de connexion animées */
      }

      .connection-line::before,
      .connection-line::after {
        display: none !important; /* Supprime les effets de lueur et particules */
      }

      @keyframes connectionPulse {
        0%,
        100% {
          opacity: 0.4;
          transform: scaleX(0.8) scaleY(1);
          filter: brightness(1) drop-shadow(0 0 8px rgba(59, 130, 246, 0.3));
        }
        50% {
          opacity: 0.9;
          transform: scaleX(1.2) scaleY(1.5);
          filter: brightness(1.8) drop-shadow(0 0 15px rgba(59, 130, 246, 0.8));
        }
      }

      @keyframes connectionGlow {
        0%,
        100% {
          opacity: 0.3;
        }
        50% {
          opacity: 0.8;
        }
      }

      @keyframes sparkleTravel {
        0% {
          left: -6px;
          opacity: 0;
          background: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.9) 0%,
            #3b82f6 50%,
            transparent 100%
          );
        }
        10% {
          opacity: 1;
        }
        25% {
          background: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.9) 0%,
            #06b6d4 50%,
            transparent 100%
          );
        }
        50% {
          background: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.9) 0%,
            #8b5cf6 50%,
            transparent 100%
          );
        }
        75% {
          background: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.9) 0%,
            #ec4899 50%,
            transparent 100%
          );
        }
        90% {
          opacity: 1;
        }
        100% {
          left: calc(100% + 6px);
          opacity: 0;
          background: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.9) 0%,
            #3b82f6 50%,
            transparent 100%
          );
        }
      }

      /* Particules de connexion désactivées */
      .connection-particle {
        display: none !important; /* Supprime toutes les particules animées */
      }

      .connection-particle::before {
        content: "";
        position: absolute;
        top: -3px;
        left: -3px;
        width: 16px;
        height: 16px;
        background: radial-gradient(
          circle,
          transparent 40%,
          var(--particle-color-primary) 60%,
          transparent 100%
        );
        border-radius: 50%;
        filter: blur(2px);
        animation: particleAura 3s ease-in-out infinite;
      }

      @keyframes particleAura {
        0%,
        100% {
          opacity: 0.3;
          transform: scale(0.8);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.4);
        }
      }

      /* Animation des particules avec transitions de couleurs fluides */
      @keyframes particleTravel1 {
        0% {
          left: 20%;
          top: 50%;
          opacity: 0;
          transform: scale(0);
        }
        10% {
          opacity: 1;
          transform: scale(1.2);
        }
        25% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          left: 50%;
          top: 45%;
          opacity: 1;
          transform: scale(1);
        }
        75% {
          opacity: 1;
          transform: scale(1);
        }
        90% {
          opacity: 1;
          transform: scale(1.2);
        }
        100% {
          left: 80%;
          top: 50%;
          opacity: 0;
          transform: scale(0);
        }
      }

      @keyframes particleTravel2 {
        0% {
          left: 50%;
          top: 45%;
          opacity: 0;
          transform: scale(0);
        }
        10% {
          opacity: 1;
          transform: scale(1.2);
        }
        25% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          left: 75%;
          top: 70%;
          opacity: 1;
          transform: scale(1);
        }
        75% {
          opacity: 1;
          transform: scale(1);
        }
        90% {
          opacity: 1;
          transform: scale(1.2);
        }
        100% {
          left: 100%;
          top: 95%;
          opacity: 0;
          transform: scale(0);
        }
      }

      @keyframes particleTravel3 {
        0% {
          left: 80%;
          top: 50%;
          opacity: 0;
          transform: scale(0);
        }
        10% {
          opacity: 1;
          transform: scale(1.2);
        }
        25% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          left: 50%;
          top: 75%;
          opacity: 1;
          transform: scale(1);
        }
        75% {
          opacity: 1;
          transform: scale(1);
        }
        90% {
          opacity: 1;
          transform: scale(1.2);
        }
        100% {
          left: 20%;
          top: 50%;
          opacity: 0;
          transform: scale(0);
        }
      }

      /* Effet de synchronisation globale avec couleurs fluides */
      .cards-synchronized {
        animation: syncPulse 2s ease-in-out;
        filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5));
      }

      @keyframes syncPulse {
        0% {
          transform: scale(1);
        }
        25% {
          transform: scale(1.015);
        }
        50% {
          transform: scale(1.03);
        }
        75% {
          transform: scale(1.015);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Onde d'énergie entre les cartes avec couleurs fluides */
      .energy-wave {
        position: absolute;
        width: 120px;
        height: 120px;
        border: 3px solid var(--wave-color);
        --wave-color: #06b6d4;
        border-radius: 50%;
        opacity: 0;
        pointer-events: none;
        z-index: 2;
        background: radial-gradient(
          circle,
          transparent 40%,
          rgba(6, 182, 212, 0.1) 60%,
          transparent 100%
        );
        box-shadow: 0 0 30px var(--wave-color),
          inset 0 0 20px rgba(255, 255, 255, 0.1);
      }

      .energy-wave::before {
        content: "";
        position: absolute;
        top: -10px;
        left: -10px;
        width: calc(100% + 20px);
        height: calc(100% + 20px);
        border: 1px solid var(--wave-color);
        border-radius: 50%;
        background: radial-gradient(
          circle,
          transparent 50%,
          rgba(6, 182, 212, 0.05) 70%,
          transparent 100%
        );
        filter: blur(2px);
      }

      @keyframes energyWave {
        0% {
          transform: scale(0.1);
          opacity: 0.9;
          border-width: 4px;
        }
        20% {
          opacity: 0.8;
        }
        40% {
          opacity: 0.7;
        }
        50% {
          transform: scale(2.5);
          opacity: 0.6;
          border-width: 2px;
        }
        70% {
          opacity: 0.4;
        }
        90% {
          opacity: 0.2;
        }
        100% {
          transform: scale(5);
          opacity: 0;
          border-width: 0px;
        }
      }

      /* === AMÉLIORATION DU FOND WELCOME SECTION AVEC COULEURS FLUIDES === */

      #welcomeSection {
        background: linear-gradient(
          135deg,
          var(--bg-color-1) 0%,
          var(--bg-color-2) 25%,
          var(--bg-color-3) 50%,
          var(--bg-color-4) 75%,
          var(--bg-color-1) 100%
        ) !important;
        --bg-color-1: #f8fafc;
        --bg-color-2: #e2e8f0;
        --bg-color-3: #f1f5f9;
        --bg-color-4: #e8f4f8;
        background-size: 400% 400%;
        animation: gradientShift 12s ease-in-out infinite;
        position: relative;
        overflow: hidden;
      }

      /* Animation du gradient de fond simplifiée */
      @keyframes gradientShift {
        0%,
        100% {
          background-position: 0% 50%;
        }
        25% {
          background-position: 100% 50%;
        }
        50% {
          background-position: 100% 100%;
        }
        75% {
          background-position: 0% 100%;
        }
      }

      /* Motifs géométriques en arrière-plan supprimés pour enlever l'animation */
      #welcomeSection::before {
        display: none; /* Animation de fond désactivée */
      }

      /* Animation de fond supprimée pour nettoyer l'interface */

      /* Effet glassmorphism sur les cartes avec couleurs fluides */
      .etat-card {
        backdrop-filter: blur(12px) saturate(200%);
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.85) 0%,
          rgba(255, 255, 255, 0.75) 100%
        ) !important;
        border: 1px solid rgba(255, 255, 255, 0.4) !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1),
          0 2px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.6),
          0 0 20px var(--card-glow-color) !important;
        --card-glow-color: rgba(59, 130, 246, 0.1);
        position: relative;
        z-index: 2;
        animation: cardGlowCycle 8s ease-in-out infinite;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .dossier-attente.etat-card {
        --card-glow-color: rgba(245, 158, 11, 0.12);
      }

      .dossier-mise-livraison.etat-card {
        --card-glow-color: rgba(14, 165, 233, 0.12);
      }

      .dossier-livre.etat-card {
        --card-glow-color: rgba(16, 185, 129, 0.12);
      }

      .dossier-retard.etat-card {
        --card-glow-color: rgba(220, 53, 69, 0.12);
      }

      @keyframes cardGlowCycle {
        0%,
        100% {
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1),
            0 2px 16px rgba(0, 0, 0, 0.08),
            inset 0 1px 0 rgba(255, 255, 255, 0.6),
            0 0 20px var(--card-glow-color);
          filter: brightness(1) saturate(1);
        }
        50% {
          box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12),
            0 4px 20px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.7),
            0 0 30px var(--card-glow-color);
          filter: brightness(1.05) saturate(1.1);
        }
      }

      /* Amélioration hover avec glassmorphism et couleurs fluides */
      .etat-card:hover {
        backdrop-filter: blur(16px) saturate(250%);
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.92) 0%,
          rgba(255, 255, 255, 0.88) 100%
        ) !important;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
          0 8px 30px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.8),
          0 0 40px var(--card-glow-color) !important;
        transform: translateY(-12px) scale(1.04) rotate(-1.5deg);
        filter: brightness(1.08) saturate(1.2);
      }

      /* === FIN ANIMATIONS DE LIAISON === */

      /* === ANIMATION D'ENTREPRISE PROFESSIONNELLE - VERSION CORRIGÉE === */
      .enterprise-intro {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(
          135deg,
          #ffffff 0%,
          #f8fafc 15%,
          #ede9fe 30%,
          #e0e7ff 45%,
          #c7d2fe 60%,
          #e0e7ff 75%,
          #f8fafc 90%,
          #ffffff 100%
        );
        background-size: 400% 400%;
        animation: enterpriseBgShift 8s ease-in-out infinite;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 1;
        visibility: visible;
        transition: all 0.8s ease;
      }

      @keyframes enterpriseBgShift {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      .enterprise-logo {
        margin-bottom: 40px;
        position: relative;
      }

      .logo-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }

      .logo-symbol {
        width: 120px;
        height: 120px;
        background: linear-gradient(135deg, #fcd34d, #f59e0b, #d97706);
        border-radius: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 48px;
        color: white;
        box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4),
          0 0 20px rgba(252, 211, 77, 0.3);
        animation: logoGlow 2s ease-in-out;
        position: relative;
        overflow: hidden;
      }

      .logo-symbol::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        animation: logoShine 3s ease-in-out 0.5s;
      }

      .loading-bar {
        width: 200px;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
        position: relative;
      }

      .loading-progress {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #7c3aed, #8b5cf6, #a78bfa);
        border-radius: 2px;
        animation: loadingProgress 4s ease-out;
      }

      .enterprise-title {
        font-size: 2.5em;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 10px;
        text-align: center;
        letter-spacing: 1px;
        opacity: 1;
        white-space: nowrap;
      }

      .enterprise-subtitle {
        font-size: 1.2em;
        font-weight: 400;
        color: #6b7280;
        text-align: center;
        opacity: 1;
        margin-bottom: 40px;
        white-space: nowrap;
      }

      .enterprise-dots {
        display: flex;
        gap: 8px;
        opacity: 0;
        animation: dotsFadeIn 1s ease-out 2.5s forwards;
      }

      .enterprise-dots span {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: dotsBlinking 1.5s ease-in-out infinite;
      }

      .enterprise-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .enterprise-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      /* Animations professionnelles */
      @keyframes logoGlow {
        0% {
          transform: scale(0.8);
          opacity: 0;
          box-shadow: 0 10px 30px rgba(245, 158, 11, 0),
            0 0 20px rgba(252, 211, 77, 0);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 15px 40px rgba(245, 158, 11, 0.5),
            0 0 25px rgba(252, 211, 77, 0.4);
        }
        100% {
          transform: scale(1);
          opacity: 1;
          box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4),
            0 0 20px rgba(252, 211, 77, 0.3);
        }
      }

      @keyframes logoShine {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      @keyframes loadingProgress {
        0% {
          width: 0%;
        }
        100% {
          width: 100%;
        }
      }

      @keyframes dotsFadeIn {
        0% {
          opacity: 0;
          transform: translateY(10px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes dotsBlinking {
        0%,
        100% {
          background: #9ca3af;
          transform: scale(1);
        }
        50% {
          background: #7c3aed;
          transform: scale(1.2);
        }
      }

      @keyframes enterpriseSlideUp {
        0% {
          opacity: 1;
          transform: translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateY(-100vh);
        }
      }

      /* === FIN ANIMATION D'ENTREPRISE === */

      /* === FIN ANIMATIONS DE LIAISON === */
    </style>
  </head>

  <body class="sidebar-expanded">
    <!-- Animation d'introduction professionnelle -->
    <div id="enterpriseIntro" class="enterprise-intro">
      <div class="enterprise-logo">
        <div class="logo-container">
          <div class="logo-symbol">
            <i class="fas fa-shipping-fast"></i>
          </div>
          <div class="loading-bar">
            <div class="loading-progress"></div>
          </div>
        </div>
      </div>
      <h1 class="enterprise-title">Suivi de Dossier</h1>
      <p class="enterprise-subtitle">Plateforme de suivi de dossier</p>
      <div class="enterprise-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <h2 id="sidebarTitle" style="position: relative">
          <span class="link-text">Menu</span>
          <span class="connection-status" id="connectionStatusIcon">
            <i class="fas fa-wifi"></i>
          </span>
        </h2>
        <ul>
          <li>
            <a href="tableauDeBord.html" id="lienAccueil">
              <span class="icon"><i class="fas fa-home"></i></span>
              <span class="link-text">Accueil</span>
            </a>
          </li>

          <li>
            <a href="#" id="lienSuivi">
              <span class="icon"><i class="fas fa-chart-bar"></i></span>
              <span class="link-text">Suivi des Livraisons de Conteneurs</span>
            </a>
          </li>

          <li>
            <a href="#" id="lienArchive">
              <span class="icon"><i class="fas fa-archive"></i></span>
              <span class="link-text">Archives</span>
            </a>
          </li>
        </ul>

        <!-- Profil utilisateur avec nom et email -->
        <div
          id="sidebarUserProfile"
          style="
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: rgba(37, 99, 235, 0.08);
            border-radius: 10px;
            padding: 6px 5px;
            border: 1px solid rgba(37, 99, 235, 0.2);
            flex-shrink: 0;
          "
        >
          <div
            id="userAvatarCircle"
            style="
              width: 32px;
              height: 32px;
              border-radius: 50%;
              background: linear-gradient(135deg, #2563eb 60%, #06b6d4 100%);
              color: #fff;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.2em;
              font-weight: 700;
              box-shadow: 0 3px 8px rgba(37, 99, 235, 0.3);
              cursor: pointer;
              transition: all 0.3s ease;
              margin-bottom: 1px;
            "
          >
            BM
          </div>
          <div
            id="userNameSidebar"
            style="
              font-size: 0.9em;
              font-weight: 700;
              color: #1e293b;
              text-align: center;
              max-width: 180px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
              line-height: 1.2;
            "
          >
            batiene mohamed
          </div>
          <div
            id="userEmailSidebar"
            style="
              font-size: 0.75em;
              color: #64748b;
              text-align: center;
              max-width: 180px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
              line-height: 1.1;
              margin-bottom: 1px;
            "
          >
            batienemohamed@its.com
          </div>
          <div
            id="userProfilSidebar"
            style="
              font-size: 0.75em;
              color: #2563eb;
              text-align: center;
              max-width: 180px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
              line-height: 1.1;
              font-weight: 600;
              background: rgba(37, 99, 235, 0.1);
              padding: 3px 6px;
              border-radius: 6px;
            "
          >
            Responsable
          </div>
          <!-- Indicateurs responsables compacts -->
          <div
            style="
              display: flex;
              flex-direction: row;
              justify-content: space-between;
              align-items: center;
              gap: 10px;
              margin-top: 8px;
              padding: 6px 8px;
              background: rgba(37, 99, 235, 0.08);
              border-radius: 12px;
              border: 1px solid rgba(37, 99, 235, 0.15);
              min-height: 50px;
            "
          >
            <!-- Responsable Acconier -->
            <div
              style="
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                flex: 1;
              "
            >
              <span
                id="iconRespAcconier"
                title="Responsable Acconier"
                style="
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  background: #fff7e3;
                  border-radius: 50%;
                  width: 24px;
                  height: 24px;
                  box-shadow: 0 3px 8px rgba(245, 158, 11, 0.25);
                  cursor: default;
                  transition: all 0.3s ease;
                "
              >
                <i
                  class="fas fa-user-shield"
                  style="font-size: 1em; color: #f59e0b"
                ></i>
              </span>
              <!-- Indicateur de connexion Acconier -->
              <div
                id="acconiersConnected"
                style="
                  font-size: 9.5px;
                  color: #6b7280;
                  text-align: center;
                  white-space: nowrap;
                  max-width: 80px;
                  font-weight: 600;
                  margin-top: 2px;
                "
                title="Utilisateurs connectés sur resp_acconier.html"
              >
                <i
                  class="fas fa-circle"
                  style="color: #dc2626; font-size: 5px; margin-right: 2px"
                ></i
                >2 connecté(s)
              </div>
            </div>

            <!-- Responsable Livraison -->
            <div
              style="
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                flex: 1;
              "
            >
              <span
                id="iconRespLivraison"
                title="Responsable Livraison"
                style="
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  background: #e3ffe3;
                  border-radius: 50%;
                  width: 24px;
                  height: 24px;
                  box-shadow: 0 3px 8px rgba(5, 150, 105, 0.25);
                  cursor: default;
                  transition: all 0.3s ease;
                "
              >
                <i
                  class="fas fa-user-check"
                  style="font-size: 1em; color: #059669"
                ></i>
              </span>
              <!-- Indicateur de connexion Livraison -->
              <div
                id="livraisonsConnected"
                style="
                  font-size: 9.5px;
                  color: #6b7280;
                  text-align: center;
                  white-space: nowrap;
                  max-width: 80px;
                  font-weight: 600;
                  margin-top: 2px;
                "
                title="Utilisateurs connectés sur resp_liv.html"
              >
                <i
                  class="fas fa-circle"
                  style="color: #dc2626; font-size: 5px; margin-right: 2px"
                ></i
                >1 connecté(s)
              </div>
            </div>
          </div>
        </div>

        <!-- Section compacte des utilisateurs connectés -->
        <div
          id="detailedUsersSection"
          style="
            margin-top: 6px;
            background: rgba(37, 99, 235, 0.08);
            border-radius: 10px;
            padding: 8px;
            border: 1px solid rgba(37, 99, 235, 0.2);
            max-height: 280px;
            min-height: 200px;
            overflow: hidden;
            flex-shrink: 0;
          "
        >
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              margin-bottom: 10px;
              cursor: pointer;
            "
            onclick="toggleUsersDetails()"
          >
            <h4
              style="
                font-size: 0.85em;
                color: #2563eb;
                margin: 0;
                font-weight: 700;
              "
            >
              👥 Connectés
            </h4>
            <div
              id="totalUsersCount"
              style="
                font-size: 0.72em;
                color: #6b7280;
                background: #f3f4f6;
                padding: 2px 8px;
                border-radius: 10px;
                font-weight: 600;
              "
            >
              3 total
            </div>
          </div>

          <div
            id="usersDetailsList"
            style="
              font-size: 0.72em;
              color: #374151;
              line-height: 1.5;
              margin-bottom: 12px;
              min-height: 120px;
              max-height: 180px;
              overflow-y: auto;
              overflow-x: hidden;
              word-wrap: break-word;
            "
          >
            <div
              style="
                text-align: center;
                color: #6b7280;
                font-style: italic;
                padding: 15px 0;
              "
            >
              Aucun utilisateur connecté
            </div>
          </div>

          <!-- Bouton de déconnexion en bas de la carte -->
          <button
            id="logoutSidebarBtn"
            style="
              width: 100%;
              background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);
              color: #fff;
              border: none;
              border-radius: 8px;
              padding: 8px 16px;
              font-size: 0.8em;
              font-weight: 600;
              box-shadow: 0 3px 10px rgba(220, 38, 38, 0.3);
              cursor: pointer;
              transition: all 0.3s ease;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 6px;
            "
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(220, 38, 38, 0.4)'"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(220, 38, 38, 0.3)'"
          >
            <i class="fas fa-sign-out-alt"></i>
            Déconnexion
          </button>
        </div>
        <!-- Popup modification code entreprise -->
        <div
          id="popupEditCompanyCode"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            class="content"
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #05966944;
              padding: 38px 32px 28px 32px;
              max-width: 420px;
              width: 96vw;
              max-height: 92vh;
              overflow-y: auto;
              position: relative;
            "
          >
            <button
              class="close"
              id="closeEditCompanyCode"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #059669;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <h2
              style="
                font-size: 1.3em;
                font-weight: 700;
                color: #059669;
                margin-bottom: 18px;
              "
            >
              Modifier le code de l'entreprise
            </h2>
            <form id="formEditCompanyCode">
              <label
                for="newCompanyCode"
                style="font-weight: 600; color: #374151"
                >Nouveau code :</label
              >
              <input
                type="text"
                id="newCompanyCode"
                name="newCompanyCode"
                required
                style="
                  width: 100%;
                  padding: 8px 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 8px;
                  font-size: 1.1em;
                  margin-top: 6px;
                  margin-bottom: 14px;
                "
              />
              <button
                type="submit"
                style="
                  width: 100%;
                  background: #059669;
                  color: #fff;
                  font-weight: 700;
                  padding: 10px 0;
                  border-radius: 8px;
                  font-size: 1.1em;
                  border: none;
                  cursor: pointer;
                  transition: background 0.2s;
                "
              >
                Enregistrer
              </button>
              <div
                id="editCompanyCodeMsg"
                class="message"
                style="font-size: 0.98em; margin-top: 10px; text-align: center"
              ></div>
            </form>
          </div>
        </div>
      </aside>

      <main class="main-content">
        <!-- Popup demande code entreprise -->
        <div
          id="popupDemandeCodeEntreprise"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #2563eb44;
              padding: 32px 28px 24px 28px;
              max-width: 900px;
              width: 98vw;
              max-height: 96vh;
              overflow-y: auto;
              position: relative;
              border: 3px solid #2563eb;
              font-size: 1.08em;
            "
          >
            <button
              id="closeDemandeCodeEntreprise"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #2563eb;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <h2
              style="
                font-size: 1.15em;
                font-weight: 700;
                color: #2563eb;
                margin-bottom: 18px;
                text-align: center;
              "
            >
              Demandes de code entreprise
            </h2>
            <div
              id="tableDemandesCodeEntreprise"
              style="
                margin-bottom: 18px;
                border: 1px dashed #2563eb;
                min-height: 40px;
                padding: 8px;
                background: #f7faff;
                text-align: center;
              "
            >
              <!-- Les demandes seront affichées ici par JS -->
            </div>
            <div
              id="demandeCodeEntrepriseMsg"
              style="
                margin-top: 10px;
                font-size: 0.98em;
                text-align: center;
                color: #dc3545;
              "
            >
              <!-- 1234QLes messages d'erreur ou d'information JS s'affichent ici -->
            </div>
          </div>
        </div>
        <!-- Section demandes code entreprise oublié (admin) -->
        <!-- Section demandes de code d'entreprise oublié supprimée (remplacée par le bouton sidebar) -->

        <div
          id="welcomeSection"
          class="welcome-container"
          style="
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            background: none;
            box-shadow: none;
            min-height: 320px;
            gap: 0;
            margin-top: 0;
            padding-top: 18px;
            position: relative;
            height: 100%;
          "
        >
          <!-- Message de bienvenue animé -->
          <div id="welcomeTypewriter" class="welcome-typewriter"></div>
          <div style="height: 38px"></div>
          <div class="etat-cards-row">
            <div
              class="etat-card dossier-attente animated-card"
              id="carteAttentePaiement"
              style="cursor: pointer"
              title="💡 Synchronisation: Dossiers visibles dans resp_acconier.html. Décrément automatique quand un dossier passe en 'mise en livraison'."
            >
              <div class="etat-icon"><i class="fas fa-hourglass-half"></i></div>
              <div class="etat-title">Dossier soumis</div>
              <div class="etat-desc">
                Dossiers en attente de règlement avant traitement.
              </div>
            </div>

            <div
              class="etat-card dossier-mise-livraison animated-card"
              id="carteMiseLivraison"
              style="cursor: pointer"
              title="💡 Synchronisation: Dossiers visibles dans resp_liv.html. Incrément quand un dossier quitte resp_acconier, décrément quand tous conteneurs sont livrés. ✨ Cliquez pour voir uniquement les dossiers en cours de livraison."
            >
              <div class="etat-icon"><i class="fas fa-truck-loading"></i></div>
              <div class="etat-title">Dossiers mis en livraison</div>
              <div class="etat-desc">
                Dossiers prêts pour la livraison et en cours de traitement.
              </div>
            </div>
            <!-- La pop-up dossiers en attentes de paiement a été supprimée -->

            <!-- Popup détails dossier -->
            <div
              id="popupDetailDossier"
              style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(30, 41, 59, 0.55);
                z-index: 10001;
                align-items: center;
                justify-content: center;
              "
            >
              <div
                style="
                  background: #fff;
                  border-radius: 18px;
                  box-shadow: 0 8px 40px #2563eb44;
                  padding: 32px 28px 24px 28px;
                  max-width: 600px;
                  width: 95vw;
                  max-height: 88vh;
                  overflow-y: auto;
                  position: relative;
                "
              >
                <button
                  id="closePopupDetailDossier"
                  style="
                    position: absolute;
                    top: 18px;
                    right: 18px;
                    background: none;
                    border: none;
                    font-size: 1.5em;
                    color: #2563eb;
                    cursor: pointer;
                  "
                >
                  &times;
                </button>
                <h2
                  style="
                    font-size: 1.12em;
                    font-weight: 700;
                    color: #2563eb;
                    margin-bottom: 18px;
                    text-align: center;
                  "
                >
                  Détails du dossier
                </h2>
                <div id="contenuDetailDossier"></div>
              </div>
            </div>
            <style>
              /* Liste stylisée des dossiers en attente de paiement */
              #listeAttentePaiement {
                display: flex;
                flex-direction: column;
                gap: 14px;
                margin-bottom: 8px;
              }
              .dossier-item-liste {
                background: linear-gradient(90deg, #fff7e3 80%, #f8fafc 100%);
                border: 1.5px solid #f59e0b;
                border-radius: 12px;
                padding: 14px 18px;
                cursor: pointer;
                transition: box-shadow 0.15s, transform 0.15s;
                box-shadow: 0 2px 8px #f59e0b11;
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
              }
              .dossier-item-liste:hover {
                box-shadow: 0 6px 18px #f59e0b33;
                transform: translateY(-2px) scale(1.01);
              }
              .dossier-item-info {
                display: flex;
                flex-direction: column;
                gap: 2px;
              }
              .dossier-item-date {
                font-size: 0.98em;
                color: #b26a00;
                font-weight: 600;
              }
              .dossier-item-nom {
                font-size: 1.08em;
                color: #1d3557;
                font-weight: 700;
              }
            </style>
            <!-- Carte 'En cours de mise en livraison' supprimée -->
          </div>
          <div class="etat-cards-row">
            <div
              class="etat-card dossier-livre animated-card"
              id="carteLivre"
              style="cursor: pointer"
              title="💡 Synchronisation: Incrément automatique quand tous les conteneurs d'un dossier sont marqués 'livré' dans resp_liv.html. ✨ Cliquez pour voir uniquement les dossiers livrés."
            >
              <div class="etat-icon"><i class="fas fa-check-circle"></i></div>
              <div class="etat-title">Dossier livré</div>
              <div class="etat-desc">
                Dossiers livrés avec succès au client.
              </div>
            </div>
            <div class="etat-card dossier-retard animated-card">
              <div class="etat-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="etat-title">Dossier en retard</div>
              <div class="etat-desc">
                Dossiers dont la livraison a dépassé le délai prévu.
              </div>
            </div>
            <!-- Popup dossiers en retard -->
            <div
              id="popupDossiersRetard"
              style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
                z-index: 10001;
                align-items: center;
                justify-content: center;
                padding: 20px;
                box-sizing: border-box;
              "
            >
              <div
                style="
                  background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
                  border-radius: 20px;
                  box-shadow: 0 20px 60px rgba(220, 53, 69, 0.25),
                    0 8px 32px rgba(0, 0, 0, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8);
                  padding: 36px 32px 28px 32px;
                  max-width: 750px;
                  width: 100%;
                  max-height: 90vh;
                  overflow-y: auto;
                  position: relative;
                  border: 3px solid transparent;
                  background-clip: padding-box;
                  transform: scale(1);
                  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                  animation: modalAppear 0.4s ease-out;
                "
              >
                <button
                  id="closePopupDossiersRetard"
                  style="
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #dc3545, #c82333);
                    border: none;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    font-size: 1.4em;
                    color: white;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
                    transition: all 0.3s ease;
                  "
                  onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 6px 20px rgba(220, 53, 69, 0.4)'"
                  onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.3)'"
                >
                  &times;
                </button>
                <h2
                  style="
                    font-size: 1.6em;
                    font-weight: 700;
                    background: linear-gradient(135deg, #dc3545, #c82333);
                    background-clip: text;
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    color: #dc3545;
                    margin-bottom: 28px;
                    text-align: center;
                    position: relative;
                    padding-bottom: 16px;
                  "
                >
                  <i
                    class="fas fa-exclamation-triangle"
                    style="margin-right: 10px; color: #dc3545"
                  ></i>
                  Dossiers en retard
                  <div
                    style="
                      position: absolute;
                      bottom: 0;
                      left: 50%;
                      transform: translateX(-50%);
                      width: 80px;
                      height: 3px;
                      background: linear-gradient(90deg, #dc3545, #c82333);
                      border-radius: 2px;
                    "
                  ></div>
                </h2>

                <!-- Champ de recherche -->
                <div style="margin-bottom: 24px; position: relative">
                  <div
                    style="
                      position: absolute;
                      left: 16px;
                      top: 50%;
                      transform: translateY(-50%);
                      color: #999;
                      font-size: 1.1em;
                      pointer-events: none;
                    "
                  >
                    <i class="fas fa-search"></i>
                  </div>
                  <input
                    type="text"
                    id="rechercheRetard"
                    placeholder="Rechercher par client, agent ou dossier..."
                    style="
                      width: 100%;
                      padding: 16px 20px 16px 50px;
                      border: 2px solid #e8ecf4;
                      border-radius: 12px;
                      font-size: 1em;
                      outline: none;
                      transition: all 0.3s ease;
                      background: #fafbfc;
                      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                      box-sizing: border-box;
                    "
                    onkeyup="filtrerDossiers()"
                    onfocus="
                      this.style.borderColor='#dc3545';
                      this.style.background='#fff';
                      this.style.boxShadow='0 4px 16px rgba(220, 53, 69, 0.15)';
                      this.style.transform='translateY(-2px)';
                    "
                    onblur="
                      this.style.borderColor='#e8ecf4';
                      this.style.background='#fafbfc';
                      this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.08)';
                      this.style.transform='translateY(0)';
                    "
                  />
                </div>

                <div id="contenuDossiersRetard"></div>
              </div>
            </div>
          </div>
        </div>
        <style>
          /* Cartes états des dossiers (3D, moderne, esthétique) */
          .etat-cards-row {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 38px;
            margin-bottom: 22px;
          }
          /* Décalage vertical des cartes sous le message de bienvenue */
          .etat-cards-row:first-of-type {
            margin-top: 18px;
          }
          .etat-card {
            border-radius: 18px;
            box-shadow: 0 8px 24px #2563eb18, 0 2px 0 #fff8;
            padding: 28px 16px 22px 16px;
            min-width: 240px;
            max-width: 300px;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin: 0 10px;
            transition: transform 0.18s, box-shadow 0.18s;
            position: relative;
            cursor: default;
            opacity: 0;
            animation: cardFadeInUp 0.7s cubic-bezier(0.23, 1.01, 0.32, 1)
              forwards;
          }
          .dossier-attente.etat-card {
            background: linear-gradient(135deg, #fff7e3 80%, #f8fafc 100%);
            border: 2.5px solid #f59e0b;
          }
          .dossier-mise-livraison.etat-card {
            background: linear-gradient(135deg, #e3f2ff 80%, #f8fafc 100%);
            border: 2.5px solid #0ea5e9;
          }
          .dossier-cours.etat-card {
            background: linear-gradient(135deg, #e3f0ff 80%, #f8fafc 100%);
            border: 2.5px solid #2563eb;
          }
          .dossier-livre.etat-card {
            background: linear-gradient(135deg, #e3ffe3 80%, #f8fafc 100%);
            border: 2.5px solid #059669;
          }
          .dossier-retard.etat-card {
            background: linear-gradient(135deg, #ffe3e3 80%, #f8fafc 100%);
            border: 2.5px solid #dc3545;
          }
          .etat-cards-row .etat-card:nth-child(1) {
            animation-delay: 0.05s;
          }
          .etat-cards-row .etat-card:nth-child(2) {
            animation-delay: 0.18s;
          }
          .etat-cards-row + .etat-cards-row .etat-card:nth-child(1) {
            animation-delay: 0.32s;
          }
          .etat-cards-row + .etat-cards-row .etat-card:nth-child(2) {
            animation-delay: 0.45s;
          }
          @keyframes cardFadeInUp {
            0% {
              opacity: 0;
              transform: translateY(40px) scale(0.98);
            }
            60% {
              opacity: 1;
              transform: translateY(-8px) scale(1.03);
            }
            100% {
              opacity: 1;
              transform: translateY(0) scale(1);
            }
          }
          .etat-card:hover {
            transform: translateY(-8px) scale(1.035) rotate(-1deg);
            box-shadow: 0 16px 48px #2563eb33, 0 4px 16px #0002;
            z-index: 2;
          }
          .etat-icon {
            font-size: 2.7em;
            margin-bottom: 12px;
            color: #2563eb;
            filter: drop-shadow(0 2px 8px #2563eb22);
            background: #fff;
            border-radius: 50%;
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #2563eb18, 0 1px 2px #0001;
            margin-top: -28px;
            margin-bottom: 12px;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translate(-50%, -50%);
          }
          .etat-title {
            font-size: 1.45em;
            font-weight: 700;
            color: #1d3557;
            margin-bottom: 10px;
            text-align: center;
            letter-spacing: 0.2px;
          }
          .etat-desc {
            font-size: 1.18em;
            color: #374151;
            text-align: center;
            margin-bottom: 0;
            margin-top: 0;
            line-height: 1.5;
          }
          .dossier-attente .etat-icon {
            color: #f59e0b;
            background: #fff7e3;
            box-shadow: 0 2px 12px #f59e0b22, 0 1px 2px #0001;
          }
          .dossier-mise-livraison .etat-icon {
            color: #0ea5e9;
            background: #e3f2ff;
            box-shadow: 0 2px 12px #0ea5e922, 0 1px 2px #0001;
          }
          .dossier-cours .etat-icon {
            color: #2563eb;
            background: #e3f0ff;
            box-shadow: 0 2px 12px #2563eb22, 0 1px 2px #0001;
          }
          .dossier-livre .etat-icon {
            color: #059669;
            background: #e3ffe3;
            box-shadow: 0 2px 12px #05966922, 0 1px 2px #0001;
          }
          .dossier-retard .etat-icon {
            color: #dc3545;
            background: #ffe3e3;
            box-shadow: 0 2px 12px #dc354522, 0 1px 2px #0001;
          }
          .etat-card:not(:hover) {
            will-change: auto;
          }
          @media (max-width: 1100px) {
            .etat-cards-row {
              gap: 16px;
            }
            .etat-card {
              min-width: 140px;
              max-width: 98vw;
              padding: 18px 6px 14px 6px;
            }
            .etat-icon {
              font-size: 1.5em;
              width: 38px;
              height: 38px;
              margin-top: -18px;
            }
          }
          @media (max-width: 700px) {
            #welcomeSection {
              flex-direction: column;
              align-items: stretch;
              gap: 0;
              margin-top: 0;
              padding-top: 8px;
            }
            .etat-cards-row {
              flex-direction: column;
              gap: 16px;
              margin-bottom: 0;
            }
            .etat-cards-row:first-of-type {
              margin-top: 10px;
            }
            .etat-card {
              min-width: 92vw;
              max-width: 99vw;
              padding: 14px 4px 10px 4px;
            }
            .etat-icon {
              font-size: 1.4em;
              width: 34px;
              height: 34px;
              margin-top: -12px;
            }
          }

          /* Message de bienvenue animé (typewriter) */
          .welcome-typewriter {
            font-size: 2.1em;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 28px;
            min-height: 48px;
            letter-spacing: 0.5px;
            text-align: center;
            width: 100%;
            max-width: 600px;
            white-space: nowrap;
            overflow: hidden;
            border-right: 2.5px solid #2563eb;
            box-sizing: border-box;
            background: none;
            animation: fadeIn 1.2s;
          }
          @media (max-width: 700px) {
            .welcome-typewriter {
              font-size: 1.25em;
              min-height: 32px;
              margin-bottom: 18px;
            }
          }
          @keyframes blinkCursor {
            0% {
              border-right-color: #2563eb;
            }
            49% {
              border-right-color: #2563eb;
            }
            50% {
              border-right-color: transparent;
            }
            100% {
              border-right-color: transparent;
            }
          }
          .welcome-typewriter.typing {
            animation: blinkCursor 0.9s steps(1) infinite;
          }
        </style>

        <div id="bottomButtons" class="bottom-buttons">
          <button onclick="afficherSuivi()">
            <span
              style="
                display: flex;
                align-items: center;
                gap: 4px;
                width: 100%;
                justify-content: center;
              "
            >
              <i class="fas fa-truck-loading"></i>
              <span style="flex: 1; text-align: center">Suivi</span>
            </span>
          </button>
          <!-- Boutons Jours précédents et Mois passé supprimés -->
        </div>

        <!-- Popup résumé du mois passé (structure cachée au départ, insérée dans le DOM) -->
        <div
          id="popupResumeMoisPasse"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #2563eb44;
              padding: 38px 32px 28px 32px;
              max-width: 900px;
              width: 96vw;
              max-height: 92vh;
              overflow-y: auto;
              position: relative;
            "
          >
            <button
              id="closeResumeMoisPasse"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #2563eb;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <div
              id="moisPasseSelector"
              style="
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
                margin-bottom: 18px;
              "
            ></div>
            <div id="resumeMoisPasseContent"></div>
          </div>
        </div>

        <script>
          // === SOLUTION DÉFINITIVE POUR LES UTILISATEURS CONNECTÉS ===
          window.API_BASE_URL =
            "https://plateformdesuivie-its-service-1cjx.onrender.com";

          function updateConnectedUsersNow() {
            fetch(`${window.API_BASE_URL}/api/active-users/stats`)
              .then((response) => response.json())
              .then((data) => {
                // Acconiers
                const acconiersDiv =
                  document.getElementById("acconiersConnected");
                if (acconiersDiv) {
                  const count =
                    data.pageStats && data.pageStats["resp_acconier.html"]
                      ? data.pageStats["resp_acconier.html"].count
                      : 0;
                  const color = count > 0 ? "#10b981" : "#dc2626";
                  acconiersDiv.innerHTML = `<i class="fas fa-circle" style="color: ${color}; font-size: 6px; margin-right: 2px;"></i>${count} connecté(s)`;
                }

                // Livraisons
                const livraisonsDiv = document.getElementById(
                  "livraisonsConnected"
                );
                if (livraisonsDiv) {
                  const count =
                    data.pageStats && data.pageStats["resp_liv.html"]
                      ? data.pageStats["resp_liv.html"].count
                      : 0;
                  const color = count > 0 ? "#10b981" : "#dc2626";
                  livraisonsDiv.innerHTML = `<i class="fas fa-circle" style="color: ${color}; font-size: 6px; margin-right: 2px;"></i>${count} connecté(s)`;
                }

                // Total
                const totalDiv = document.getElementById("totalUsersCount");
                if (totalDiv) {
                  totalDiv.textContent = `${
                    data.totalConnectedUsers || 0
                  } total`;
                }

                // Liste détaillée
                const listDiv = document.getElementById("usersDetailsList");
                if (listDiv) {
                  if (data.totalConnectedUsers === 0) {
                    listDiv.innerHTML = `<div style="text-align: center; color: #6b7280; font-style: italic; padding: 8px 0; font-size: 0.8em;">Aucun utilisateur connecté</div>`;
                  } else {
                    let html = "";
                    Object.keys(data.pageStats || {}).forEach((pageName) => {
                      const pageData = data.pageStats[pageName];
                      if (pageData.count > 0) {
                        const title =
                          pageName === "resp_acconier.html"
                            ? "🛡️ Acconiers"
                            : "📦 Livraisons";
                        html += `<div style="margin-bottom: 8px;"><div style="font-weight: 600; color: white; font-size: 0.85em; margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between;"><span>${title}</span><span style="background: #10b981; color: white; font-size: 0.7em; padding: 1px 4px; border-radius: 6px;">${pageData.count}</span></div>`;
                        pageData.users.forEach((user) => {
                          html += `<div style="display: flex; align-items: center; justify-content: space-between; padding: 3px 6px; background: #f9fafb; border-radius: 4px; margin-bottom: 2px; border-left: 2px solid #10b981; font-size: 0.8em;"><div>${
                            user.nom || user.username || "Utilisateur"
                          }</div></div>`;
                        });
                        html += "</div>";
                      }
                    });
                    listDiv.innerHTML = html;
                  }
                }
              })
              .catch(() => {
                // En cas d'erreur, afficher 0
                const elements = ["acconiersConnected", "livraisonsConnected"];
                elements.forEach((id) => {
                  const el = document.getElementById(id);
                  if (el)
                    el.innerHTML = `<i class="fas fa-circle" style="color: #dc2626; font-size: 6px; margin-right: 2px;"></i>0 connecté(s)`;
                });
              });
          }

          // Démarrer dès que possible
          setTimeout(updateConnectedUsersNow, 1000);
          setInterval(updateConnectedUsersNow, 10000);

          // Fonction pour forcer la mise à jour
          window.updateUsers = updateConnectedUsersNow;

          // Message de bienvenue animé (typewriter)
          document.addEventListener("DOMContentLoaded", function () {
            // === MARQUER LA SESSION ADMIN POUR LES REDIRECTIONS ===
            // Marquer cette session comme étant une session administrateur
            // pour que les pages responsables sachent qu'elles sont accédées en mode visualisation
            const adminUser = localStorage.getItem("user");
            if (adminUser) {
              try {
                const user = JSON.parse(adminUser);
                if (user && user.role === "admin") {
                  // Marquer la session admin pour les redirections
                  localStorage.setItem("adminViewMode", "true");
                  localStorage.setItem(
                    "adminViewTimestamp",
                    Date.now().toString()
                  );
                }
              } catch (e) {
                console.log(
                  "Erreur lors de la vérification de la session admin:",
                  e
                );
              }
            }

            // --- WebSocket notification temps réel dossier mis en livraison ---
            try {
              const wsUrl =
                (window.location.protocol === "https:" ? "wss://" : "ws://") +
                window.location.hostname +
                ":3000";
              const ws = new ReconnectingWebSocket(wsUrl);
              ws.onmessage = function (event) {
                let data;
                try {
                  data = JSON.parse(event.data);
                } catch (e) {
                  return;
                }
                if (
                  data &&
                  data.type === "dossier-mise-en-livraison" &&
                  data.dossierNumber
                ) {
                  // Affiche l'alerte
                  if (typeof showCustomAlert === "function") {
                    showCustomAlert(
                      `Le dossier [${data.dossierNumber}] a été mis en livraison.`,
                      "success",
                      5000
                    );
                  } else {
                    alert(
                      `Le dossier [${data.dossierNumber}] a été mis en livraison.`
                    );
                  }
                  // Met à jour le statut dans le tableau si affiché11
                  const row = document.querySelector(
                    `[data-delivery-id='${data.deliveryId}']`
                  );
                  if (row) {
                    const statusCell = Array.from(row.cells).find(
                      (cell) =>
                        cell.dataset.fieldName === "delivery_status_acconier"
                    );
                    if (statusCell) {
                      statusCell.innerHTML = `<span class='text-blue-600'><i class='fas fa-truck mr-1' style='color:#2563eb;'></i> Mise en livraison</span>`;
                    }
                  }
                }
              };
            } catch (e) {
              /* ignore erreur ws */
            }
            // Affiche le nom de l'utilisateur connecté (stocké dans localStorage.user)
            var nom = null;
            try {
              var user = JSON.parse(localStorage.getItem("user"));
              if (user && user.nom) {
                nom = user.nom;
              }
            } catch (e) {}
            if (!nom || nom.length < 2) nom = "Utilisateur";
            var message = `Bonjour ${nom}, Bienvenue`;
            var el = document.getElementById("welcomeTypewriter");
            if (el) {
              el.textContent = "";
              let i = 0;
              function typeWriter() {
                if (i <= message.length) {
                  el.textContent = message.slice(0, i);
                  el.classList.add("typing");
                  i++;
                  setTimeout(typeWriter, 55 + Math.random() * 60);
                } else {
                  el.textContent = message;
                  el.classList.remove("typing");
                  el.style.borderRight = "none";
                }
              }
              typeWriter();
            }
            // Ajout du filtre : redirection sur la carte "En attente de paiement"
            var carteAttentePaiement = document.getElementById(
              "carteAttentePaiement"
            );
            if (carteAttentePaiement) {
              carteAttentePaiement.addEventListener("click", function () {
                // Redirection vers l'interface de suivi intégrée (comme le bouton Suivi)
                window.afficherSuivi();
              });
            }

            // Ajout de la logique pour la carte "Dossiers mis en livraison"
            var carteMiseLivraison =
              document.getElementById("carteMiseLivraison");
            if (carteMiseLivraison) {
              carteMiseLivraison.addEventListener("click", function () {
                // Redirection avec filtre pour dossiers en cours de livraison (non livrés)
                window.location.href =
                  "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_liv.html?filter=mise_en_livraison&autoFilter=true";
              });
            }
            // --- Ajout gestion carte dossier en retard ---
            // Fonction de filtrage métier des dossiers en retard (copiée de scriptRespAcconier.js)
            function getLateDeliveries(allDeliveries) {
              const now = new Date();
              return (allDeliveries || []).filter((d) => {
                let dDate = d.delivery_date || d.created_at;
                if (!dDate) return false;
                let dateObj = new Date(dDate);
                if (isNaN(dateObj.getTime())) return false;
                const diffDays = Math.floor(
                  (now - dateObj) / (1000 * 60 * 60 * 24)
                );
                if (diffDays <= 2) return false;
                if (d.delivery_status_acconier === "en attente de paiement") {
                  return true;
                }
                let blList = [];
                if (Array.isArray(d.bl_number)) {
                  blList = d.bl_number.filter(Boolean);
                } else if (typeof d.bl_number === "string") {
                  blList = d.bl_number.split(/[,;\s]+/).filter(Boolean);
                }
                let blStatuses = blList.map((bl) =>
                  d.bl_statuses && d.bl_statuses[bl]
                    ? d.bl_statuses[bl]
                    : "aucun"
                );
                if (
                  blStatuses.length > 0 &&
                  blStatuses.every((s) => s === "mise_en_livraison")
                ) {
                  return false;
                }
                if (
                  d.delivery_status_acconier === "mise_en_livraison_acconier"
                ) {
                  return false;
                }
                return true;
              });
            }

            var carteRetard = document.querySelector(
              ".dossier-retard.etat-card"
            );
            var popupRetard = document.getElementById("popupDossiersRetard");
            var closeRetard = document.getElementById(
              "closePopupDossiersRetard"
            );
            var contenuRetard = document.getElementById(
              "contenuDossiersRetard"
            );
            if (carteRetard && popupRetard && contenuRetard) {
              carteRetard.addEventListener("click", function () {
                // Appel API pour récupérer la liste à jour
                fetch("/api/dossiers/retard")
                  .then((res) => res.json())
                  .then((dossiers) => {
                    // Stocker les données pour le filtrage
                    window.tousLesDossiersRetard = dossiers || [];

                    // Réinitialiser le champ de recherche
                    const champRecherche =
                      document.getElementById("rechercheRetard");
                    if (champRecherche) {
                      champRecherche.value = "";
                    }

                    if (!dossiers || dossiers.length === 0) {
                      contenuRetard.innerHTML = `
                                  <div style='text-align:center;padding:40px 20px;color:#6b7280;'>
                                    <i class="fas fa-check-circle" style="font-size:3em;color:#22c55e;margin-bottom:15px;"></i>
                                    <p style="font-size:1.2em;margin:0;">Aucun dossier en retard</p>
                                    <p style="font-size:1em;margin:8px 0 0 0;">Tous les dossiers sont à jour !</p>
                                  </div>
                                `;
                    } else {
                      let html = `
                                  <div style="margin-bottom:12px;">
                                    <p style="color:#374151;font-size:1.05em;margin:0;text-align:center;">
                                      <strong>${
                                        dossiers.length
                                      }</strong> dossier${
                        dossiers.length > 1 ? "s" : ""
                      } en retard
                                    </p>
                                  </div>
                                  <div style="max-height:400px;overflow-y:auto;">
                                    <ul style='list-style:none;padding:0;margin:0;'>
                                `;

                      dossiers.forEach((dossier, index) => {
                        const dossierId =
                          dossier.id ||
                          dossier.numero_bl ||
                          dossier.numero ||
                          dossier._id ||
                          "";
                        const clientName =
                          dossier.client_name ||
                          dossier.client ||
                          dossier.nom ||
                          "Client non défini";
                        const employeeName =
                          dossier.employee_name || "Agent non défini";
                        const dossierNumber =
                          dossier.dossier_number || dossier.numero || dossierId;

                        // 📅 Traitement des dates
                        const createdAtDate = dossier.created_at
                          ? new Date(dossier.created_at)
                          : null;
                        const deliveryDate = dossier.delivery_date
                          ? new Date(dossier.delivery_date)
                          : null;
                        const now = new Date();

                        // Calculer le nombre de jours de retard depuis la création
                        let daysLate = 0;
                        let formattedCreatedDate = "Date non disponible";
                        let formattedDeliveryDate = "Non définie";

                        if (createdAtDate) {
                          daysLate = Math.floor(
                            (now - createdAtDate) / (1000 * 60 * 60 * 24)
                          );
                          formattedCreatedDate =
                            createdAtDate.toLocaleDateString("fr-FR", {
                              day: "2-digit",
                              month: "2-digit",
                              year: "numeric",
                            });
                        }

                        if (deliveryDate) {
                          formattedDeliveryDate =
                            deliveryDate.toLocaleDateString("fr-FR", {
                              day: "2-digit",
                              month: "2-digit",
                              year: "numeric",
                            });
                        }

                        // 🚀 Différencier le type de dossier pour la redirection
                        const isLivraisonType = dossier.type === "livraison";
                        const redirectUrl = isLivraisonType
                          ? `https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_liv.html?dossier=${encodeURIComponent(
                              dossierId
                            )}&flash=true`
                          : `https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_acconier.html?dossier=${encodeURIComponent(
                              dossierId
                            )}&flash=true`;

                        // Couleurs et icônes selon le type
                        const typeColor = isLivraisonType
                          ? "#2563eb"
                          : "#dc3545"; // Bleu pour livraison, rouge pour acconier
                        const typeIcon = isLivraisonType
                          ? "fas fa-truck"
                          : "fas fa-folder-open";
                        const typeLabel = isLivraisonType
                          ? "LIVRAISON"
                          : "ACCONIER";

                        html += `
                                    <li style='
                                      background: linear-gradient(135deg, ${
                                        isLivraisonType ? "#eff6ff" : "#fef2f2"
                                      } 80%, ${
                          isLivraisonType ? "#dbeafe" : "#fecaca"
                        } 100%);
                                      border: 2px solid ${
                                        isLivraisonType ? "#dbeafe" : "#fecaca"
                                      };
                                      border-radius: 12px;
                                      margin-bottom: 12px;
                                      padding: 18px 20px;
                                      cursor: pointer;
                                      transition: all 0.2s ease;
                                      border-left: 4px solid ${typeColor};
                                      position: relative;
                                    '
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(${
                                      isLivraisonType
                                        ? "37, 99, 235"
                                        : "220, 53, 69"
                                    }, 0.25)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                                    onclick="window.location.href='${redirectUrl}'">

                                      <!-- Badge type de dossier -->
                                      <div style="
                                        position: absolute;
                                        top: 8px;
                                        right: 8px;
                                        background: ${typeColor};
                                        color: white;
                                        font-size: 0.7em;
                                        font-weight: 700;
                                        padding: 2px 6px;
                                        border-radius: 4px;
                                        text-transform: uppercase;
                                      ">
                                        ${typeLabel}
                                      </div>

                                      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                                        <span style="
                                          background:${typeColor};
                                          color:#fff;
                                          font-weight:700;
                                          font-size:0.9em;
                                          padding:4px 8px;
                                          border-radius:6px;
                                          min-width:30px;
                                          text-align:center;
                                        ">${index + 1}</span>

                                        <div style="flex:1;">
                                          <div style="font-size:1.15em; font-weight:700; color:${typeColor}; margin-bottom:2px;">
                                            <i class="${typeIcon}" style="margin-right:6px;"></i>
                                            ${clientName}
                                          </div>
                                          <div style="font-size:0.95em; color:#6b7280; margin-bottom:4px;">
                                            Dossier: <strong style="color:#374151;">${dossierNumber}</strong>
                                          </div>
                                          
                                          <!-- 📅 Section des dates ajoutée -->
                                          <div style="
                                            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                                            border: 1px solid #cbd5e1;
                                            border-radius: 8px;
                                            padding: 8px 10px;
                                            margin-top: 6px;
                                            font-size: 0.85em;
                                          ">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                              <span style="color: #475569; font-weight: 600;">
                                                <i class="fas fa-calendar-plus" style="margin-right: 4px; color: #059669;"></i>
                                                Créé le:
                                              </span>
                                              <span style="color: #374151; font-weight: 700;">${formattedCreatedDate}</span>
                                            </div>
                                            <div style="
                                              display: flex; 
                                              justify-content: space-between; 
                                              align-items: center;
                                              padding: 4px 8px;
                                              background: ${
                                                daysLate > 7
                                                  ? "#fef2f2"
                                                  : daysLate > 3
                                                  ? "#fff7ed"
                                                  : "#fefce8"
                                              };
                                              border: 1px solid ${
                                                daysLate > 7
                                                  ? "#fecaca"
                                                  : daysLate > 3
                                                  ? "#fed7aa"
                                                  : "#fde68a"
                                              };
                                              border-radius: 6px;
                                              margin-top: 4px;
                                            ">
                                              <span style="color: #475569; font-weight: 600;">
                                                <i class="fas fa-clock" style="margin-right: 4px; color: ${
                                                  daysLate > 7
                                                    ? "#dc2626"
                                                    : daysLate > 3
                                                    ? "#ea580c"
                                                    : "#d97706"
                                                };"></i>
                                                En retard depuis:
                                              </span>
                                              <span style="
                                                color: ${
                                                  daysLate > 7
                                                    ? "#dc2626"
                                                    : daysLate > 3
                                                    ? "#ea580c"
                                                    : "#d97706"
                                                };
                                                font-weight: 800;
                                                font-size: 0.95em;
                                              ">
                                                ${daysLate} jour${
                          daysLate > 1 ? "s" : ""
                        }
                                              </span>
                                            </div>
                                          </div>
                                        </div>

                                        <div style="text-align:right;">
                                          <div style="font-size:0.9em; color:#6b7280; margin-bottom:2px;">${
                                            isLivraisonType
                                              ? "Livreur"
                                              : "Agent"
                                          }</div>
                                          <div style="font-size:1em; font-weight:600; color:#374151;">${employeeName}</div>
                                        </div>
                                      </div>

                                      <div style="
                                        font-size:0.85em;
                                        color:${typeColor};
                                        background:#fff;
                                        padding:6px 10px;
                                        border-radius:6px;
                                        text-align:center;
                                        font-weight:600;
                                      ">
                                        <i class="fas fa-external-link-alt" style="margin-right:4px;"></i>
                                        ${
                                          isLivraisonType
                                            ? "Livraison en retard - Cliquer pour ouvrir"
                                            : "Dossier en retard - Cliquer pour gérer"
                                        }
                                      </div>
                                    </li>
                                  `;
                      });

                      html += "</ul></div>";
                      contenuRetard.innerHTML = html;
                    }
                    popupRetard.style.display = "flex";
                  })
                  .catch((error) => {
                    console.error(
                      "Erreur lors du chargement des dossiers en retard:",
                      error
                    );
                    contenuRetard.innerHTML = `
                                <div style='text-align:center;padding:40px 20px;color:#dc3545;'>
                                  <i class="fas fa-exclamation-circle" style="font-size:3em;margin-bottom:15px;"></i>
                                  <p style="font-size:1.2em;margin:0;">Erreur de chargement</p>
                                  <p style="font-size:1em;margin:8px 0 0 0;color:#6b7280;">Impossible de récupérer les dossiers en retard</p>
                                </div>
                              `;
                    popupRetard.style.display = "flex";
                  });
              });
              if (closeRetard) {
                closeRetard.onclick = function () {
                  popupRetard.style.display = "none";
                };
                popupRetard.addEventListener("click", function (e) {
                  if (e.target === popupRetard)
                    popupRetard.style.display = "none";
                });
              }
            }
            // --- Ajout gestion carte dossier livré ---
            var carteLivre = document.querySelector(".dossier-livre.etat-card");
            if (carteLivre) {
              carteLivre.style.cursor = "pointer";
              carteLivre.addEventListener("click", function () {
                // Redirection avec filtre pour dossiers livrés uniquement
                window.location.href =
                  "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_liv.html?filter=livre&autoFilter=true";
              });
            }

            // === ANIMATIONS DE LIAISON ENTRE LES CARTES SYNCHRONISÉES ===

            // Initialiser les animations de liaison
            initCardConnectionAnimations();

            function initCardConnectionAnimations() {
              const welcomeSection = document.getElementById("welcomeSection");
              if (!welcomeSection) return;

              // Créer le conteneur des connexions
              const connectionsContainer = document.createElement("div");
              connectionsContainer.className = "card-connections";
              welcomeSection.appendChild(connectionsContainer);

              // Attendre que les cartes soient bien positionnées
              setTimeout(() => {
                createConnectionLines();
                // createFloatingParticles(); // Désactivé pour enlever l'animation d'arrière-plan
                startSynchronizationEffects();
              }, 1000);
            }

            function createConnectionLines() {
              const container = document.querySelector(".card-connections");
              if (!container) return;

              const cards = [
                document.getElementById("carteAttentePaiement"),
                document.getElementById("carteMiseLivraison"),
                document.getElementById("carteLivre"),
              ];

              cards.forEach((card, index) => {
                if (!card) return;

                const nextCard = cards[(index + 1) % cards.length];
                if (!nextCard) return;

                const line = document.createElement("div");
                line.className = "connection-line";
                line.style.animationDelay = `${index * 1.3}s`;

                // Positionner la ligne entre les cartes
                positionConnectionLine(line, card, nextCard);
                container.appendChild(line);
              });
            }

            function positionConnectionLine(line, fromCard, toCard) {
              const fromRect = fromCard.getBoundingClientRect();
              const toRect = toCard.getBoundingClientRect();
              const containerRect = document
                .getElementById("welcomeSection")
                .getBoundingClientRect();

              const fromX =
                fromRect.left + fromRect.width / 2 - containerRect.left;
              const fromY =
                fromRect.top + fromRect.height / 2 - containerRect.top;
              const toX = toRect.left + toRect.width / 2 - containerRect.left;
              const toY = toRect.top + toRect.height / 2 - containerRect.top;

              const length = Math.sqrt(
                Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2)
              );
              const angle =
                (Math.atan2(toY - fromY, toX - fromX) * 180) / Math.PI;

              line.style.left = fromX + "px";
              line.style.top = fromY + "px";
              line.style.width = length + "px";
              line.style.transform = `rotate(${angle}deg)`;
            }

            function createFloatingParticles() {
              const container = document.querySelector(".card-connections");
              if (!container) return;

              for (let i = 0; i < 6; i++) {
                const particle = document.createElement("div");
                particle.className = "connection-particle";

                const animationName = `particleTravel${(i % 3) + 1}`;
                particle.style.animation = `${animationName} ${
                  4 + Math.random() * 2
                }s linear infinite`;
                particle.style.animationDelay = `${Math.random() * 3}s`;

                container.appendChild(particle);
              }
            }

            function startSynchronizationEffects() {
              // Effet de synchronisation toutes les 8 secondes
              setInterval(() => {
                const cards = document.querySelectorAll(".etat-card");
                cards.forEach((card, index) => {
                  setTimeout(() => {
                    card.classList.add("cards-synchronized");
                    setTimeout(() => {
                      card.classList.remove("cards-synchronized");
                    }, 2000);
                  }, index * 200);
                });
              }, 8000);
            }

            // Fonction pour déclencher l'effet de synchronisation lors des mises à jour
            window.triggerCardSyncEffect = function () {
              const cards = document.querySelectorAll(".etat-card");

              // ANIMATION D'EXPLOSION CIRCULAIRE SUPPRIMÉE - Plus d'effet d'onde d'énergie

              // Effet de pulsation synchronisée gardé
              setTimeout(() => {
                cards.forEach((card) => {
                  card.classList.add("cards-synchronized");
                  setTimeout(() => {
                    card.classList.remove("cards-synchronized");
                  }, 2000);
                });
              }, 500);
            };

            // Recalculer les positions des lignes lors du redimensionnement
            window.addEventListener(
              "resize",
              debounce(() => {
                const lines = document.querySelectorAll(".connection-line");
                const cards = [
                  document.getElementById("carteAttentePaiement"),
                  document.getElementById("carteMiseLivraison"),
                  document.getElementById("carteLivre"),
                ];

                lines.forEach((line, index) => {
                  const fromCard = cards[index];
                  const toCard = cards[(index + 1) % cards.length];
                  if (fromCard && toCard) {
                    positionConnectionLine(line, fromCard, toCard);
                  }
                });
              }, 250)
            );

            function debounce(func, wait) {
              let timeout;
              return function executedFunction(...args) {
                const later = () => {
                  clearTimeout(timeout);
                  func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
              };
            }
          });
          document.addEventListener("DOMContentLoaded", function () {
            // Propagation automatique de la session admin vers les interfaces responsables
            function autoConnectResponsableInterfaces() {
              // Méthode 1 : iframes cachées (si la session/cookie est partagée)
              const acconierFrame = document.createElement("iframe");
              acconierFrame.src =
                "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_acconier.html";
              acconierFrame.style.display = "none";
              acconierFrame.setAttribute("aria-hidden", "true");
              document.body.appendChild(acconierFrame);

              const livFrame = document.createElement("iframe");
              livFrame.src =
                "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_liv.html";
              livFrame.style.display = "none";
              livFrame.setAttribute("aria-hidden", "true");
              document.body.appendChild(livFrame);
            }
            autoConnectResponsableInterfaces();
            // Redirection au clic sur les icônes responsables - DÉSACTIVÉE
            const iconRespLivraison =
              document.getElementById("iconRespLivraison");
            if (iconRespLivraison) {
              // iconRespLivraison.addEventListener("click", function () {
              //   redirectToResponsablePage("livraison");
              // });
              iconRespLivraison.style.cursor = "default"; // Cursor par défaut
            }
            const iconRespAcconier =
              document.getElementById("iconRespAcconier");
            if (iconRespAcconier) {
              // iconRespAcconier.addEventListener("click", function () {
              //   redirectToResponsablePage("acconier");
              // });
              iconRespAcconier.style.cursor = "default"; // Cursor par défaut
            }

            // === NETTOYAGE DE LA SESSION ADMIN ===
            // Nettoyer les marqueurs de session admin s'ils sont trop anciens (plus de 2 heures)
            function cleanupAdminSession() {
              const adminTimestamp = localStorage.getItem("adminViewTimestamp");
              if (adminTimestamp) {
                const timeDiff = Date.now() - parseInt(adminTimestamp);
                const twoHoursInMs = 2 * 60 * 60 * 1000; // 2 heures

                if (timeDiff > twoHoursInMs) {
                  localStorage.removeItem("adminViewMode");
                  localStorage.removeItem("adminViewTimestamp");
                  console.log("Session admin expirée - nettoyage effectué");
                }
              }
            }

            // Appeler le nettoyage à l'initialisation
            cleanupAdminSession();

            // Nettoyer périodiquement (toutes les 30 minutes)
            setInterval(cleanupAdminSession, 30 * 60 * 1000);

            // === FONCTION UTILITAIRE POUR LA REDIRECTION RESPONSABLES ===
            function redirectToResponsablePage(pageType) {
              const adminUser = localStorage.getItem("user");
              let isAdmin = false;

              try {
                if (adminUser) {
                  const user = JSON.parse(adminUser);
                  // TOUTE personne avec une session "user" depuis index.html est considérée comme admin
                  isAdmin =
                    user && (user.role === "admin" || user.nom || user.email);
                }
              } catch (e) {
                console.log(
                  "Erreur lors de la vérification de la session admin:",
                  e
                );
              }

              // Forcer le mode admin si on vient du tableau de bord
              isAdmin = true; // FORCE ADMIN MODE pour tous les utilisateurs du tableau de bord

              let targetUrl;

              if (pageType === "acconier") {
                if (isAdmin) {
                  // Redirection en mode admin (visualisation uniquement)
                  targetUrl =
                    "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_acconier.html?mode=admin";
                  // Marquer la session pour la page cible
                  localStorage.setItem("adminViewMode", "true");
                  localStorage.setItem(
                    "adminViewTimestamp",
                    Date.now().toString()
                  );
                  localStorage.setItem("adminViewTarget", "acconier");
                } else {
                  // Redirection normale pour les responsables
                  targetUrl = "resp_acconier.html";
                }
              } else if (pageType === "livraison") {
                if (isAdmin) {
                  // Redirection en mode admin (visualisation uniquement)
                  targetUrl =
                    "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_liv.html?mode=admin";
                  // Marquer la session pour la page cible
                  localStorage.setItem("adminViewMode", "true");
                  localStorage.setItem(
                    "adminViewTimestamp",
                    Date.now().toString()
                  );
                  localStorage.setItem("adminViewTarget", "livraison");
                } else {
                  // Redirection normale pour les responsables
                  targetUrl = "resp_liv.html";
                }
              }

              if (targetUrl) {
                console.log("🔧 [DEBUG] Redirection Details:", {
                  pageType,
                  isAdmin,
                  targetUrl,
                  userInStorage: !!localStorage.getItem("user"),
                  adminViewMode: localStorage.getItem("adminViewMode"),
                  adminViewTimestamp:
                    localStorage.getItem("adminViewTimestamp"),
                  adminViewTarget: localStorage.getItem("adminViewTarget"),
                });
                console.log(
                  `Redirection vers ${targetUrl} - Mode: ${
                    isAdmin ? "Admin (Visualisation)" : "Responsable"
                  }`
                );
                window.location.href = targetUrl;
              }
            }

            // --- Gestion du popup de modification du code entreprise ---
            const btnEditSidebar = document.getElementById("btnEditSidebar");
            const popupEditCompanyCode = document.getElementById(
              "popupEditCompanyCode"
            );
            const closeEditCompanyCode = document.getElementById(
              "closeEditCompanyCode"
            );
            const formEditCompanyCode = document.getElementById(
              "formEditCompanyCode"
            );
            const editCompanyCodeMsg =
              document.getElementById("editCompanyCodeMsg");
            if (btnEditSidebar && popupEditCompanyCode) {
              btnEditSidebar.onclick = function () {
                popupEditCompanyCode.style.display = "flex";
                editCompanyCodeMsg.textContent = "";
                document.getElementById("newCompanyCode").value = "";
              };
            }
            if (closeEditCompanyCode && popupEditCompanyCode) {
              closeEditCompanyCode.onclick = function () {
                popupEditCompanyCode.style.display = "none";
              };
              popupEditCompanyCode.addEventListener("click", function (e) {
                if (e.target === popupEditCompanyCode)
                  popupEditCompanyCode.style.display = "none";
              });
            }
            if (formEditCompanyCode) {
              formEditCompanyCode.onsubmit = function (e) {
                e.preventDefault();
                const newCode = document
                  .getElementById("newCompanyCode")
                  .value.trim();
                if (!newCode) {
                  editCompanyCodeMsg.textContent = "Veuillez saisir un code.";
                  return;
                }
                // Appel API pour modifier le code entreprise
                fetch("/api/company-code", {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ code: newCode }),
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.success) {
                      editCompanyCodeMsg.style.color = "#059669";
                      editCompanyCodeMsg.textContent =
                        "Code modifié avec succès.";
                      setTimeout(() => {
                        popupEditCompanyCode.style.display = "none";
                      }, 1200);
                    } else {
                      editCompanyCodeMsg.style.color = "#dc3545";
                      editCompanyCodeMsg.textContent =
                        data.message || "Erreur lors de la modification.";
                    }
                  })
                  .catch(() => {
                    editCompanyCodeMsg.style.color = "#dc3545";
                    editCompanyCodeMsg.textContent = "Erreur réseau.";
                  });
              };
            }
            const btnResumeMoisPasse =
              document.getElementById("btnResumeMoisPasse");
            const popupMois = document.getElementById("popupResumeMoisPasse");
            const closeBtnMois = document.getElementById(
              "closeResumeMoisPasse"
            );
            if (btnResumeMoisPasse) {
              btnResumeMoisPasse.onclick = function () {
                fetch("http://localhost:3000/deliveries/status")
                  .then((res) => res.json())
                  .then((data) => {
                    if (!data.success || !Array.isArray(data.deliveries)) {
                      document.getElementById(
                        "resumeMoisPasseContent"
                      ).innerHTML =
                        '<div style="color:#dc3545;text-align:center;">Erreur lors du chargement des données de livraisons.</div>';
                      popupMois.style.display = "flex";
                      return;
                    }
                    const moisFr = [
                      "janvier",
                      "février",
                      "mars",
                      "avril",
                      "mai",
                      "juin",
                      "juillet",
                      "août",
                      "septembre",
                      "octobre",
                      "novembre",
                      "décembre",
                    ];
                    // Regrouper les livraisons par mois/année
                    const moisMap = {};
                    data.deliveries.forEach((liv) => {
                      if (!liv.created_at) return;
                      const d = new Date(liv.created_at);
                      const key = `${d.getFullYear()}-${String(
                        d.getMonth() + 1
                      ).padStart(2, "0")}`;
                      if (!moisMap[key]) moisMap[key] = [];
                      moisMap[key].push(liv);
                    });
                    // Trier les clés du plus récent au plus ancien
                    const moisKeys = Object.keys(moisMap).sort((a, b) =>
                      b.localeCompare(a)
                    );
                    // Par défaut, sélectionner le mois passé (le plus récent < mois courant)
                    const now = new Date();
                    const moisCourantKey = `${now.getFullYear()}-${String(
                      now.getMonth() + 1
                    ).padStart(2, "0")}`;
                    let defaultKey = null;
                    for (const k of moisKeys) {
                      if (k < moisCourantKey) {
                        defaultKey = k;
                        break;
                      }
                    }
                    if (!defaultKey && moisKeys.length > 0)
                      defaultKey = moisKeys[0];
                    // Nouvelle disposition : grille de cartes mois façon "jours précédents"
                    const selector =
                      document.getElementById("moisPasseSelector");
                    selector.innerHTML = "";
                    // Style pour la grille de cartes mois (ajouté dynamiquement si pas déjà)
                    if (!document.getElementById("style-mois-cards-grid")) {
                      const style = document.createElement("style");
                      style.id = "style-mois-cards-grid";
                      style.innerHTML = `
                                  #moisPasseSelector {
                                    display: grid !important;
                                    grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
                                    gap: 18px;
                                    margin-bottom: 18px;
                                  }
                                  .mois-resume-card {
                                    background: linear-gradient(135deg,#f7faff 60%,#e3e9f7 100%);
                                    border-radius: 16px;
                                    box-shadow: 0 4px 18px #2563eb18,0 2px 8px #0001;
                                    padding: 18px 12px 12px 12px;
                                    min-width: 0;
                                    max-width: 100%;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    cursor: pointer;
                                    transition: box-shadow 0.2s,transform 0.2s;
                                    border: none;
                                    position: relative;
                                  }
                                  .mois-resume-card.active, .mois-resume-card:focus {
                                    box-shadow: 0 8px 28px #2563eb22,0 4px 16px #0002;
                                    outline: 2px solid #2563eb;
                                  }
                                  .mois-resume-card .mois-label {
                                    font-size: 1.08em;
                                    font-weight: 700;
                                    margin-bottom: 8px;
                                    letter-spacing: 0.5px;
                                    text-align: center;
                                    color: #222e3a;
                                  }
                                  .mois-resume-card .mois-total {
                                    font-size: 2.1em;
                                    font-weight: 900;
                                    margin-bottom: 7px;
                                    letter-spacing: 1px;
                                    color: #2563eb;
                                  }
                                  .mois-resume-card .mois-badges {
                                    margin-bottom: 8px;
                                  }
                                  .mois-resume-card .card-badge {
                                    display: inline-block;
                                    background: #eaf1fb;
                                    color: #2563eb;
                                    border-radius: 7px;
                                    padding: 2px 8px;
                                    font-size: 0.98em;
                                    margin: 0 4px 4px 0;
                                    font-weight: 600;
                                  }
                                `;
                      document.head.appendChild(style);
                    }
                    // On n'affiche que les mois terminés (pas le mois courant)
                    // Variables now et moisCourantKey déjà déclarées plus haut dans la fonction, on les réutilise ici
                    // Générer les cartes pour chaque mois terminé
                    // --- Génération des cartes mois + navigation Précédent/Suivant ---
                    const moisTermines = moisKeys.filter(
                      (key) => key < moisCourantKey
                    );
                    let selectedIndex = moisTermines.indexOf(defaultKey);
                    // Générer les cartes
                    moisTermines.forEach((key, idx) => {
                      const [year, m] = key.split("-");
                      const label = `${moisFr[parseInt(m, 10) - 1]} ${year}`;
                      const totalLiv = moisMap[key].length;
                      // Calculer les statuts pour badge
                      const statuts = {};
                      const traductionStatuts = {
                        pending: "En attente",
                        delivered: "Livrée",

                        pending_acconier: "En attente acconier",

                        Inconnu: "Inconnu",
                      };
                      moisMap[key].forEach((liv) => {
                        let s = liv.status || "Inconnu";
                        s = traductionStatuts[s] || s;
                        statuts[s] = (statuts[s] || 0) + 1;
                      });
                      // Agents et clients
                      const agents = Array.from(
                        new Set(
                          moisMap[key]
                            .map((l) => l.employee_name)
                            .filter(Boolean)
                        )
                      );
                      const clients = Array.from(
                        new Set(
                          moisMap[key].map((l) => l.client_name).filter(Boolean)
                        )
                      );
                      // Générer la carte
                      const card = document.createElement("div");
                      card.className = "mois-resume-card";
                      card.tabIndex = 0;
                      card.setAttribute("data-key", key);
                      card.innerHTML = `
            <div class=\"mois-label\">${label}</div>
            <div class=\"mois-total\">${totalLiv}</div>
            <div class=\"mois-badges\">
              ${Object.entries(statuts)
                .map(([s, n]) => `<span class='card-badge'>${n} ${s}</span>`)
                .join(" ")}
            </div>
            <div style='font-size:0.98em;color:#374151;margin-bottom:2px;'><strong>Agents :</strong> ${
              agents.length
            }</div>
            <div style='font-size:0.98em;color:#374151;'><strong>Clients :</strong> ${
              clients.length
            }</div>
          `;
                      // (Suppression du bouton de suppression pour les cartes mois)
                      card.onclick = () => {
                        selectedIndex = idx;
                        afficherResumeMois(key);
                      };
                      card.onkeydown = (e) => {
                        if (e.key === "Enter" || e.key === " ") {
                          selectedIndex = idx;
                          afficherResumeMois(key);
                        }
                      };
                      selector.appendChild(card);
                    });
                    // Ajout des boutons Précédent/Suivant
                    if (moisTermines.length > 1) {
                      const navDiv = document.createElement("div");
                      navDiv.style.display = "flex";
                      navDiv.style.justifyContent = "center";
                      navDiv.style.gap = "18px";
                      navDiv.style.margin = "18px 0 0 0";
                      navDiv.innerHTML = `
                                  <button id='btnMoisPrecedent' style='padding:8px 22px;font-size:1em;font-weight:600;background:#f7faff;color:#2563eb;border:1px solid #2563eb33;border-radius:8px;cursor:pointer;transition:background 0.18s;'>⟵ Précédent</button>
                                  <button id='btnMoisSuivant' style='padding:8px 22px;font-size:1em;font-weight:600;background:#f7faff;color:#2563eb;border:1px solid #2563eb33;border-radius:8px;cursor:pointer;transition:background 0.18s;'>Suivant ⟶</button>
                                `;
                      selector.parentNode.insertBefore(
                        navDiv,
                        selector.nextSibling
                      );
                      // Gestion des clics
                      setTimeout(() => {
                        const btnPrec =
                          document.getElementById("btnMoisPrecedent");
                        const btnSuiv =
                          document.getElementById("btnMoisSuivant");
                        function majBtns() {
                          btnPrec.disabled = selectedIndex <= 0;
                          btnSuiv.disabled =
                            selectedIndex >= moisTermines.length - 1;
                        }
                        btnPrec.onclick = () => {
                          if (selectedIndex > 0) {
                            selectedIndex--;
                            const key = moisTermines[selectedIndex];
                            afficherResumeMois(key);
                            setActiveBtn(key);
                            // Scroll automatique
                            const cards =
                              selector.querySelectorAll(".mois-resume-card");
                            if (
                              cards[selectedIndex] &&
                              typeof cards[selectedIndex].scrollIntoView ===
                                "function"
                            ) {
                              cards[selectedIndex].scrollIntoView({
                                behavior: "smooth",
                                block: "nearest",
                                inline: "center",
                              });
                            }
                          }
                          majBtns();
                        };
                        btnSuiv.onclick = () => {
                          if (selectedIndex < moisTermines.length - 1) {
                            selectedIndex++;
                            const key = moisTermines[selectedIndex];
                            afficherResumeMois(key);
                            setActiveBtn(key);
                            // Scroll automatique
                            const cards =
                              selector.querySelectorAll(".mois-resume-card");
                            if (
                              cards[selectedIndex] &&
                              typeof cards[selectedIndex].scrollIntoView ===
                                "function"
                            ) {
                              cards[selectedIndex].scrollIntoView({
                                behavior: "smooth",
                                block: "nearest",
                                inline: "center",
                              });
                            }
                          }
                          majBtns();
                        };
                        // Mise à jour de la carte active au clic sur une carte
                        const cards =
                          selector.querySelectorAll(".mois-resume-card");
                        cards.forEach((c, i) => {
                          c.addEventListener("click", () => {
                            selectedIndex = i;
                            setActiveBtn(moisTermines[selectedIndex]);
                            majBtns();
                          });
                          c.addEventListener("keydown", (e) => {
                            if (e.key === "Enter" || e.key === " ") {
                              selectedIndex = i;
                              setActiveBtn(moisTermines[selectedIndex]);
                              majBtns();
                            }
                          });
                        });
                        // Initialisation
                        setActiveBtn(moisTermines[selectedIndex]);
                        majBtns();
                      }, 0);
                    }
                    // Style carte active
                    function setActiveBtn(keyActif) {
                      Array.from(selector.children).forEach((c) => {
                        if (c.getAttribute("data-key") === keyActif) {
                          c.classList.add("active");
                          c.setAttribute("aria-current", "true");
                        } else {
                          c.classList.remove("active");
                          c.removeAttribute("aria-current");
                        }
                      });
                    }
                    // Fonction d'affichage du résumé d'un mois
                    function afficherResumeMois(key) {
                      setActiveBtn(key);
                      // Filtrer pour exclure 'Agent visiteur programmé'
                      const livraisonsMois = (moisMap[key] || []).filter(
                        (liv) =>
                          liv.employee_name !== "Agent visiteur programmé"
                      );
                      const [year, m] = key.split("-");
                      const moisLabel = `${
                        moisFr[parseInt(m, 10) - 1]
                      } ${year}`;
                      const total = livraisonsMois.length;
                      const agents = Array.from(
                        new Set(
                          livraisonsMois
                            .map((l) => l.employee_name)
                            .filter(Boolean)
                        )
                      );
                      const clients = Array.from(
                        new Set(
                          livraisonsMois
                            .map((l) => l.client_name)
                            .filter(Boolean)
                        )
                      );
                      const statuts = {};
                      const traductionStatuts = {
                        pending: "En attente",
                        delivered: "Livrée",
                        pending_acconier: "En attente acconier",
                        Inconnu: "Inconnu",
                      };
                      livraisonsMois.forEach((l) => {
                        let s = l.status || "Inconnu";
                        s = traductionStatuts[s] || s;
                        statuts[s] = (statuts[s] || 0) + 1;
                      });
                      const lieux = Array.from(
                        new Set(
                          livraisonsMois.map((l) => l.lieu).filter(Boolean)
                        )
                      );
                      let recapHtml = `<div style='font-size:1.25em;font-weight:700;color:#2563eb;margin-bottom:10px;text-align:center;'>Résumé du mois de ${moisLabel}</div>`;
                      recapHtml += `<div style='font-size:2em;font-weight:900;margin-bottom:7px;letter-spacing:1px;color:#2563eb;text-align:center;'>${total} livraisons</div>`;
                      // Statuts : triés par nombre décroissant, un par ligne
                      const statutsSorted = Object.entries(statuts).sort(
                        (a, b) => b[1] - a[1]
                      );
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Statuts :</strong><br>`;
                      if (statutsSorted.length === 0) {
                        recapHtml += "Aucun";
                      } else {
                        statutsSorted.forEach(([s, n]) => {
                          let color = "#2563eb";
                          if (
                            s.toLowerCase().includes("rejet") ||
                            s.toLowerCase().includes("reject")
                          )
                            color = "#dc3545";
                          if (s.toLowerCase().includes("attente"))
                            color = "#f59e0b";
                          if (s.toLowerCase().includes("livr"))
                            color = "#059669";
                          if (s.toLowerCase().includes("eir"))
                            color = "#a855f7";
                          recapHtml += `<span class="card-badge" style="background:${color}22;color:${color};margin-right:8px;margin-bottom:3px;">${n} ${s}</span><br>`;
                        });
                      }
                      recapHtml += `</div>`;
                      // Agents : retour à la ligne tous les 5
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Agents :</strong><br>`;
                      if (agents.length > 0) {
                        for (let i = 0; i < agents.length; i += 5) {
                          recapHtml +=
                            agents.slice(i, i + 5).join(", ") + "<br>";
                        }
                      } else {
                        recapHtml += "-";
                      }
                      recapHtml += `</div>`;
                      // Clients : retour à la ligne tous les 5
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Clients :</strong><br>`;
                      if (clients.length > 0) {
                        for (let i = 0; i < clients.length; i += 5) {
                          recapHtml +=
                            clients.slice(i, i + 5).join(", ") + "<br>";
                        }
                      } else {
                        recapHtml += "-";
                      }
                      recapHtml += `</div>`;
                      // Lieux : retour à la ligne tous les 4
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Lieux :</strong><br>`;
                      if (lieux.length > 0) {
                        for (let i = 0; i < lieux.length; i += 4) {
                          recapHtml +=
                            lieux.slice(i, i + 4).join(", ") + "<br>";
                        }
                      } else {
                        recapHtml += "-";
                      }
                      recapHtml += `</div>`;
                      // Détails des livraisons : tableau
                      if (livraisonsMois.length > 0) {
                        recapHtml += `<div style='margin-top:12px;'><strong>Détails des livraisons :</strong><div style='overflow-x:auto;'><table style='width:100%;border-collapse:collapse;font-size:0.98em;margin-top:6px;'>`;
                        recapHtml += `<thead><tr style='background:#f7faff;'><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Client</th><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Agent</th><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Lieu</th><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Statut</th></tr></thead><tbody>`;
                        livraisonsMois.forEach((liv) => {
                          const statutFr =
                            traductionStatuts[liv.status] || liv.status || "-";
                          let color = "#2563eb";
                          if (
                            statutFr.toLowerCase().includes("rejet") ||
                            statutFr.toLowerCase().includes("reject")
                          )
                            color = "#dc3545";
                          if (statutFr.toLowerCase().includes("attente"))
                            color = "#f59e0b";
                          if (statutFr.toLowerCase().includes("livr"))
                            color = "#059669";
                          if (statutFr.toLowerCase().includes("eir"))
                            color = "#a855f7";
                          recapHtml += `<tr><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'>${
                            liv.client_name ? `<b>${liv.client_name}</b>` : "-"
                          }</td><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'>${
                            liv.employee_name || "-"
                          }</td><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'>${
                            liv.lieu || "-"
                          }</td><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'><span style='color:${color};font-weight:600;'>${statutFr}</span></td></tr>`;
                        });
                        recapHtml += `</tbody></table></div></div>`;
                      }
                      document.getElementById(
                        "resumeMoisPasseContent"
                      ).innerHTML = recapHtml;
                    }
                    // Afficher le résumé du mois par défaut
                    if (defaultKey) afficherResumeMois(defaultKey);
                    popupMois.style.display = "flex";
                  })
                  .catch(() => {
                    document.getElementById(
                      "resumeMoisPasseContent"
                    ).innerHTML =
                      '<div style="color:#dc3545;text-align:center;">Impossible de charger le résumé du mois passé.</div>';
                    popupMois.style.display = "flex";
                  });
              };
            }
            if (closeBtnMois && popupMois) {
              closeBtnMois.onclick = () => {
                popupMois.style.display = "none";
              };
              popupMois.addEventListener("click", (e) => {
                if (e.target === popupMois) popupMois.style.display = "none";
              });
            }

            // === FONCTIONS DE MISE À JOUR DES COMPTEURS DE CARTES ===

            // Fonction pour mettre à jour les compteurs des cartes (GLOBALE)
            window.updateCardCounters = function () {
              console.log("[DASHBOARD] 📊 Début mise à jour des compteurs...");

              // Utiliser la même API que le tableau de suivi pour assurer la cohérence
              fetch("/deliveries/status")
                .then((response) => response.json())
                .then((data) => {
                  if (data.success && data.deliveries) {
                    console.log(
                      "[DASHBOARD] ✅ Données de livraisons reçues:",
                      data.deliveries.length
                    );

                    // Calculer les compteurs à partir des mêmes données que le tableau de suivi
                    const counts = calculateCountsFromDeliveries(
                      data.deliveries
                    );

                    console.log("[DASHBOARD] 📊 Compteurs calculés:", counts);

                    // Mise à jour de la carte "Dossier soumis"
                    const oldAttente = window.updateCardCounter(
                      "carteAttentePaiement",
                      counts.en_attente_paiement || 0
                    );
                    console.log(
                      `[DASHBOARD] 📋 Dossier soumis: ${
                        counts.en_attente_paiement || 0
                      }`
                    );

                    // Mise à jour de la carte "Dossiers mis en livraison" avec format "mis en livraison / total"
                    const miseEnLivraisonText = `${
                      counts.mise_en_livraison || 0
                    } / ${counts.en_attente_paiement || 0}`;
                    const oldMiseEnLivraison = window.updateCardCounter(
                      "carteMiseLivraison",
                      miseEnLivraisonText
                    );
                    console.log(
                      `[DASHBOARD] 🚛 Dossiers mis en livraison: ${miseEnLivraisonText} (${counts.mise_en_livraison} sur ${counts.en_attente_paiement} total)`
                    );

                    // Mise à jour de la carte "Dossiers livrés" avec format "livrés / mis en livraison"
                    const livresText = `${counts.livres || 0} / ${
                      counts.mise_en_livraison || 0
                    }`;
                    const oldLivres = window.updateCardCounter(
                      "carteLivre",
                      livresText
                    );
                    console.log(
                      `[DASHBOARD] ✅ Dossiers livrés: ${livresText} (${counts.livres} dossiers livrés sur ${counts.mise_en_livraison} en livraison)`
                    );

                    console.log(
                      "[DASHBOARD] 🔄 Mise à jour terminée - Totaux:",
                      {
                        "En attente": counts.en_attente_paiement || 0,
                        "Mis en livraison": counts.mise_en_livraison || 0,
                        Livrés: counts.livres || 0,
                        "En retard": counts.en_retard || 0,
                      }
                    );
                  } else {
                    console.error(
                      "[DASHBOARD] ❌ Erreur dans la réponse du serveur:",
                      data
                    );
                  }
                })
                .catch((error) => {
                  console.error(
                    "[DASHBOARD] ❌ Erreur lors de la récupération des données:",
                    error
                  );
                });
            };

            // Fonction pour calculer les compteurs à partir des données de livraison (comme dans le tableau de suivi)
            window.calculateCountsFromDeliveries = function (deliveries) {
              console.log(
                "[DASHBOARD] 📋 Calcul des compteurs à partir de",
                deliveries.length,
                "livraisons"
              );

              // Le badge "Dossier soumis" doit toujours afficher le TOTAL des dossiers dans le tableau de suivi
              // Il ne diminue que si un dossier est SUPPRIMÉ du tableau, pas quand il change de statut
              const counts = {
                en_attente_paiement: deliveries.length, // TOTAL des dossiers soumis (TOUS les dossiers du tableau)
                mise_en_livraison: 0,
                livres: 0,
                en_retard: 0,
              };

              // Analyser chaque dossier pour les autres catégories (sous-ensembles du total)
              deliveries.forEach((delivery) => {
                // Debug pour voir les statuts
                console.log(
                  "[DEBUG] Dossier:",
                  delivery.dossier_number,
                  "Statut acconier:",
                  delivery.delivery_status_acconier,
                  "Statut container:",
                  delivery.container_statuses
                );

                // 🎯 LOGIQUE SIMPLIFIÉE : Un dossier est livré si visible_resp_acconier = false
                // Cette logique correspond exactement à ce que fait le serveur
                let isLivre = false;

                // Méthode principale: vérifier visible_resp_acconier (comme dans le serveur)
                if (delivery.visible_resp_acconier === false) {
                  isLivre = true;
                  console.log(
                    "[DEBUG] ✅ Dossier livré (visible_resp_acconier=false):",
                    delivery.dossier_number
                  );
                }

                // Méthode alternative: vérifier les statuts de conteneurs s'ils existent
                if (!isLivre && delivery.container_statuses) {
                  Object.values(delivery.container_statuses).forEach(
                    (status) => {
                      if (status === "livre" || status === "livré") {
                        isLivre = true;
                        console.log(
                          "[DEBUG] ✅ Dossier livré (statut conteneur):",
                          delivery.dossier_number
                        );
                      }
                    }
                  );
                }

                // Compter selon les catégories
                if (isLivre) {
                  counts.livres++;
                } else if (
                  delivery.delivery_status_acconier ===
                  "mise_en_livraison_acconier"
                ) {
                  counts.mise_en_livraison++;
                }

                // Compter les dossiers en retard
                if (delivery.created_at) {
                  const diffDays = Math.floor(
                    (new Date() - new Date(delivery.created_at)) /
                      (1000 * 60 * 60 * 24)
                  );
                  if (diffDays > 2 && !isLivre) {
                    counts.en_retard++;
                  }
                }
              });

              console.log(
                "[DASHBOARD] 📊 Compteurs calculés (correspondant au tableau de suivi):",
                {
                  "🔢 TOTAL dossiers soumis (ne diminue que si suppression)":
                    counts.en_attente_paiement,
                  "🚛 Sous-ensemble mis en livraison": counts.mise_en_livraison,
                  "✅ Sous-ensemble livrés": counts.livres,
                  "⏰ Sous-ensemble en retard": counts.en_retard,
                  "📋 Note":
                    "Le badge 'Dossier soumis' affiche le TOTAL, les autres sont des sous-catégories",
                }
              );

              return counts;
            };

            // Fonction utilitaire pour normaliser les dates (copiée de scriptSuivie.js)
            function normalizeDateToMidnight(date) {
              const normalized = new Date(date);
              normalized.setHours(0, 0, 0, 0);
              return normalized;
            }

            // Fonction utilitaire pour mettre à jour un compteur spécifique (GLOBALE)
            window.updateCardCounter = function (cardId, count) {
              const card = document.getElementById(cardId);
              if (card) {
                let counterElement = card.querySelector(".card-counter");
                let oldValue = 0;

                if (!counterElement) {
                  // Créer l'élément compteur s'il n'existe pas
                  counterElement = document.createElement("div");
                  counterElement.className = "card-counter";

                  // Déterminer le style selon le type de carte
                  let badgeStyle = getBadgeStyleForCard(cardId);

                  counterElement.style.cssText = `
                              position: absolute;
                              top: -8px;
                              right: -8px;
                              background: ${badgeStyle.background};
                              color: ${badgeStyle.color};
                              font-weight: 800;
                              font-size: 0.9em;
                              font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                              padding: 8px 12px;
                              border-radius: 20px;
                              border: 3px solid #ffffff;
                              box-shadow: 0 4px 16px ${badgeStyle.shadowColor}, 0 2px 8px rgba(0, 0, 0, 0.1);
                              min-width: 28px;
                              min-height: 28px;
                              text-align: center;
                              display: flex;
                              align-items: center;
                              justify-content: center;
                              transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                              z-index: 10;
                              backdrop-filter: blur(10px);
                              transform-origin: center;
                            `;

                  // Animation d'apparition
                  counterElement.style.opacity = "0";
                  counterElement.style.transform = "scale(0) rotate(180deg)";
                  card.appendChild(counterElement);

                  setTimeout(() => {
                    counterElement.style.opacity = "1";
                    counterElement.style.transform = "scale(1) rotate(0deg)";
                  }, 50);
                } else {
                  // Pour les valeurs numériques simples, extraire l'ancien nombre
                  const oldText = counterElement.textContent || "0";
                  if (oldText.includes("/")) {
                    // Si l'ancien texte contient "/", extraire le premier nombre
                    oldValue = parseInt(oldText.split("/")[0]) || 0;
                  } else {
                    oldValue = parseInt(oldText) || 0;
                  }
                }

                counterElement.textContent = count;

                // Animation de mise à jour avec couleur selon le changement
                let currentValue;
                if (typeof count === "string" && count.includes("/")) {
                  // Si c'est un format "X / Y", extraire X pour la comparaison
                  currentValue = parseInt(count.split("/")[0]) || 0;
                } else {
                  currentValue = parseInt(count) || 0;
                }

                if (currentValue !== oldValue) {
                  // Animation de pulsation avec couleurs dynamiques
                  if (currentValue > oldValue) {
                    // Augmentation - Animation verte
                    counterElement.style.background =
                      "linear-gradient(135deg, #10b981 0%, #059669 100%)";
                    counterElement.style.color = "#ffffff";
                    counterElement.style.boxShadow =
                      "0 6px 20px rgba(16, 185, 129, 0.4), 0 0 0 4px rgba(16, 185, 129, 0.2)";
                    counterElement.style.transform = "scale(1.4) rotate(10deg)";

                    // Effet de particules
                    // createSuccessParticles(counterElement); // Désactivé pour enlever l'animation
                  } else if (currentValue < oldValue) {
                    // Diminution - Animation rouge
                    counterElement.style.background =
                      "linear-gradient(135deg, #ef4444 0%, #dc2626 100%)";
                    counterElement.style.color = "#ffffff";
                    counterElement.style.boxShadow =
                      "0 6px 20px rgba(239, 68, 68, 0.4), 0 0 0 4px rgba(239, 68, 68, 0.2)";
                    counterElement.style.transform =
                      "scale(1.4) rotate(-10deg)";
                  }

                  // Retour à l'état normal avec animation fluide
                  setTimeout(() => {
                    let originalStyle = getBadgeStyleForCard(cardId);
                    counterElement.style.background = originalStyle.background;
                    counterElement.style.color = originalStyle.color;
                    counterElement.style.boxShadow = `0 4px 16px ${originalStyle.shadowColor}, 0 2px 8px rgba(0, 0, 0, 0.1)`;
                    counterElement.style.transform = "scale(1) rotate(0deg)";
                  }, 600);

                  console.log(
                    `[CARD UPDATE] ${cardId}: ${oldValue} → ${currentValue} (affiché: ${count})`
                  );
                }

                // Effet hover permanent
                counterElement.onmouseenter = function () {
                  this.style.transform = "scale(1.15) translateY(-2px)";
                  this.style.filter = "brightness(1.1)";
                };

                counterElement.onmouseleave = function () {
                  this.style.transform = "scale(1) translateY(0px)";
                  this.style.filter = "brightness(1)";
                };

                return oldValue;
              } else {
                console.warn(`[CARD UPDATE] ⚠️ Carte non trouvée: ${cardId}`);
                return 0;
              }
            };

            // Fonction pour obtenir le style de badge selon la carte
            function getBadgeStyleForCard(cardId) {
              const styles = {
                carteAttentePaiement: {
                  background:
                    "linear-gradient(135deg, #f59e0b 0%, #d97706 100%)",
                  color: "#ffffff",
                  shadowColor: "rgba(245, 158, 11, 0.3)",
                },
                carteMiseLivraison: {
                  background:
                    "linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)",
                  color: "#ffffff",
                  shadowColor: "rgba(59, 130, 246, 0.3)",
                },
                carteLivre: {
                  background:
                    "linear-gradient(135deg, #10b981 0%, #059669 100%)",
                  color: "#ffffff",
                  shadowColor: "rgba(16, 185, 129, 0.3)",
                },
              };

              return (
                styles[cardId] || {
                  background:
                    "linear-gradient(135deg, #6b7280 0%, #4b5563 100%)",
                  color: "#ffffff",
                  shadowColor: "rgba(107, 114, 128, 0.3)",
                }
              );
            }

            // Fonction pour créer des particules de succès
            function createSuccessParticles(element) {
              const particleCount = 6;
              const rect = element.getBoundingClientRect();

              for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement("div");
                particle.style.cssText = `
                            position: fixed;
                            width: 4px;
                            height: 4px;
                            background: #10b981;
                            border-radius: 50%;
                            pointer-events: none;
                            z-index: 9999;
                            left: ${rect.left + rect.width / 2}px;
                            top: ${rect.top + rect.height / 2}px;
                          `;

                document.body.appendChild(particle);

                const angle = (i / particleCount) * Math.PI * 2;
                const distance = 30 + Math.random() * 20;
                const duration = 600 + Math.random() * 200;

                particle.animate(
                  [
                    {
                      transform: "translate(0, 0) scale(1)",
                      opacity: 1,
                    },
                    {
                      transform: `translate(${Math.cos(angle) * distance}px, ${
                        Math.sin(angle) * distance
                      }px) scale(0)`,
                      opacity: 0,
                    },
                  ],
                  {
                    duration: duration,
                    easing: "cubic-bezier(0.25, 0.46, 0.45, 0.94)",
                  }
                ).onfinish = () => particle.remove();
              }
            }

            // Amélioration de la fonction updateCardCounters avec effets visuels
            const originalUpdateCardCounters = window.updateCardCounters;
            window.updateCardCounters = function () {
              console.log("[DASHBOARD] 📊 Début mise à jour des compteurs...");

              // Ajouter une classe temporaire pour l'animation de mise à jour
              const cardIds = [
                "carteAttentePaiement",
                "carteMiseLivraison",
                "carteLivre",
              ];
              cardIds.forEach((cardId) => {
                const card = document.getElementById(cardId);
                if (card) {
                  card.classList.add("card-updating");
                  setTimeout(
                    () => card.classList.remove("card-updating"),
                    1000
                  );
                }
              });

              // Déclencher les animations de liaison lors de la synchronisation
              if (typeof window.triggerCardSyncEffect === "function") {
                setTimeout(() => {
                  window.triggerCardSyncEffect();
                }, 500);
              }

              // Appeler la fonction originale
              return originalUpdateCardCounters.apply(this, arguments);
            };

            // Fonction pour afficher un effet de succès lors de la mise à jour
            window.showCounterUpdateSuccess = function () {
              const successIndicator = document.createElement("div");
              successIndicator.innerHTML = "✨";
              successIndicator.style.cssText = `
                          position: fixed;
                          top: 20px;
                          right: 20px;
                          font-size: 2em;
                          z-index: 9999;
                          animation: successPulse 2s ease-out forwards;
                          pointer-events: none;
                        `;

              document.body.appendChild(successIndicator);
              setTimeout(() => successIndicator.remove(), 2000);
            };

            // Ajout de l'animation CSS pour l'indicateur de succès
            if (!document.getElementById("dynamic-animations")) {
              const style = document.createElement("style");
              style.id = "dynamic-animations";
              style.textContent = `
                          @keyframes successPulse {
                            0% { opacity: 0; transform: scale(0) rotate(0deg); }
                            20% { opacity: 1; transform: scale(1.5) rotate(180deg); }
                            80% { opacity: 1; transform: scale(1) rotate(360deg); }
                            100% { opacity: 0; transform: scale(0.5) rotate(540deg); }
                          }
                        `;
              document.head.appendChild(style);
            }

            // Appeler la fonction de mise à jour des compteurs au chargement
            window.updateCardCounters();

            // Mettre à jour les compteurs toutes les 30 secondes
            setInterval(window.updateCardCounters, 30000);

            // Fonction de test pour vérifier la synchronisation des cartes (DEBUG UNIQUEMENT)
            window.testCardSynchronization = function () {
              console.log("[DEBUG] 🧪 Test de synchronisation des cartes...");
              fetch("/api/deliveries/status-counts")
                .then((response) => response.json())
                .then((data) => {
                  if (data.success) {
                    console.log("[DEBUG] 📊 Compteurs actuels:", data.counts);
                    console.log(
                      "[DEBUG] ✅ Test terminé - Les cartes devraient refléter ces valeurs"
                    );
                  } else {
                    console.error("[DEBUG] ❌ Erreur test:", data);
                  }
                })
                .catch((error) => {
                  console.error("[DEBUG] ❌ Erreur réseau test:", error);
                });
            };

            // Fonction pour forcer le rafraîchissement des compteurs (DEBUG)
            window.forceRefreshCounters = function () {
              console.log("[DEBUG] 🔄 Rafraîchissement forcé des compteurs...");
              window.updateCardCounters();
            };

            // Fonction de diagnostic complète pour vérifier la synchronisation
            window.diagnoseTablóeDeBord = function () {
              console.log("🔍 ====== DIAGNOSTIC TABLEAU DE BORD ======");
              console.log("📅 Date/Heure:", new Date().toLocaleString());

              // Vérifier la présence des cartes
              const cartes = [
                { id: "carteAttentePaiement", nom: "Dossier soumis" },
                { id: "carteMiseLivraison", nom: "Dossiers mis en livraison" },
                { id: "carteLivre", nom: "Dossiers livrés" },
              ];

              console.log("🎯 Vérification des cartes:");
              cartes.forEach((carte) => {
                const element = document.getElementById(carte.id);
                const compteur = element
                  ? element.querySelector(".card-counter")
                  : null;
                const valeur = compteur
                  ? compteur.textContent
                  : "aucun compteur";
                console.log(
                  `  ${carte.nom}: ${
                    element ? "✅" : "❌"
                  } | Compteur: ${valeur}`
                );
              });

              // Tester la connectivité API
              console.log("🌐 Test connectivité API...");
              fetch("/api/deliveries/status-counts")
                .then((response) => response.json())
                .then((data) => {
                  if (data.success) {
                    console.log(
                      "✅ API réachable - Compteurs serveur:",
                      data.counts
                    );
                    console.log("📊 Répartition:");
                    console.log(
                      `  • En attente de paiement: ${
                        data.counts.en_attente_paiement || 0
                      }`
                    );
                    console.log(
                      `  • Mis en livraison: ${
                        data.counts.mise_en_livraison || 0
                      }`
                    );
                    console.log(`  • Livrés: ${data.counts.livres || 0}`);
                    console.log(`  • En retard: ${data.counts.en_retard || 0}`);

                    // Comparer avec l'affichage actuel
                    console.log("🔄 Comparaison affichage vs serveur:");
                    cartes.forEach((carte, index) => {
                      const element = document.getElementById(carte.id);
                      const compteur = element
                        ? element.querySelector(".card-counter")
                        : null;
                      const valeurAffichee = compteur
                        ? parseInt(compteur.textContent) || 0
                        : 0;
                      const valeurServeur =
                        Object.values(data.counts)[index] || 0;
                      const status =
                        valeurAffichee === valeurServeur ? "✅" : "⚠️";
                      console.log(
                        `  ${carte.nom}: Affiché=${valeurAffichee}, Serveur=${valeurServeur} ${status}`
                      );
                    });
                  } else {
                    console.error("❌ Erreur API:", data);
                  }
                })
                .catch((error) => {
                  console.error("❌ Erreur réseau API:", error);
                });

              // Vérifier les fonctions globales
              console.log("🔧 Fonctions globales disponibles:");
              console.log(
                `  updateCardCounters: ${
                  typeof window.updateCardCounters === "function" ? "✅" : "❌"
                }`
              );
              console.log(
                `  updateCardCounter: ${
                  typeof window.updateCardCounter === "function" ? "✅" : "❌"
                }`
              );

              console.log(
                "🏁 Diagnostic terminé. Consultez les logs ci-dessus."
              );
            };

            // Écouter les événements WebSocket pour les mises à jour en temps réel
            try {
              const wsUrl =
                (window.location.protocol === "https:" ? "wss://" : "ws://") +
                window.location.hostname +
                ":3000";
              const ws = new ReconnectingWebSocket(wsUrl);

              ws.onmessage = function (event) {
                let data;
                try {
                  data = JSON.parse(event.data);
                } catch (e) {
                  return;
                }

                console.log("[DASHBOARD] WebSocket reçu:", data);

                // Mettre à jour les compteurs si c'est un événement de changement de statut
                if (
                  data &&
                  (data.type === "status-change" ||
                    data.type === "dossier-mise-en-livraison" ||
                    data.type === "container_status_update" ||
                    data.type === "dossier-quitte-acconier" ||
                    data.type === "dossier-entre-en-livraison" ||
                    data.forceCounterUpdate)
                ) {
                  console.log(
                    "[DASHBOARD] Mise à jour des compteurs déclenchée par:",
                    data.type
                  );
                  console.log("[DASHBOARD] Action détectée:", data.action);

                  // Si c'est un dossier qui entre en livraison (depuis resp_acconier)
                  if (
                    data.type === "dossier-entre-en-livraison" &&
                    data.action ===
                      "increment_mise_en_livraison_decrement_attente"
                  ) {
                    console.log(
                      "[DASHBOARD] 🚛⬆️ Dossier entré en livraison, mise à jour des compteurs"
                    );
                    // Mise à jour immédiate forcée
                    setTimeout(() => {
                      window.updateCardCounters();
                    }, 100);
                  }

                  // Si c'est un dossier qui quitte resp_acconier (mis en livraison)
                  if (
                    data.type === "dossier-quitte-acconier" &&
                    data.action === "decrement_mise_en_livraison"
                  ) {
                    console.log(
                      "[DASHBOARD] ⬇️ Dossier quitté resp_acconier, décrément 'Dossiers mis en livraison'"
                    );
                    // Mise à jour immédiate forcée
                    setTimeout(() => {
                      window.updateCardCounters();
                    }, 100);
                  }

                  // Si c'est un dossier complètement livré
                  if (
                    (data.type === "status-change" ||
                      data.type === "container_status_update") &&
                    data.action === "delivery_completed"
                  ) {
                    console.log(
                      "[DASHBOARD] ✅ Dossier complètement livré, incrément 'Dossiers livrés'"
                    );
                    // Mise à jour immédiate forcée
                    setTimeout(() => {
                      window.updateCardCounters();
                    }, 100);
                  }

                  // Si c'est un conteneur marqué livré (mais pas le dernier)
                  if (
                    data.type === "container_status_update" &&
                    (data.action === "container_delivered" ||
                      data.status === "livre" ||
                      data.status === "livré")
                  ) {
                    console.log(
                      "[DASHBOARD] 📦 Conteneur livré:",
                      data.containerNumber
                    );
                    // Mise à jour immédiate forcée
                    setTimeout(() => {
                      window.updateCardCounters();
                    }, 100);
                  }
                  // Mise à jour standard avec léger délai
                  setTimeout(() => {
                    window.updateCardCounters();
                  }, 200);
                }
              };
            } catch (e) {
              console.log(
                "[DASHBOARD] ⚠️ WebSocket non disponible pour les mises à jour temps réel"
              );
            }
          });
        </script>

        <div
          id="suiviContainer"
          class="dynamic-content-area"
          style="display: none"
        ></div>
        <div
          id="historiqueAgentsContainer"
          class="dynamic-content-area"
          style="display: none"
        ></div>
        <!-- Popup résumé jours précédents -->
        <div
          id="popupResumeJoursPrecedents"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #2563eb44;
              padding: 38px 32px 28px 32px;
              max-width: 900px;
              width: 96vw;
              max-height: 92vh;
              overflow-y: auto;
              position: relative;
            "
          >
            <button
              id="closeResumeJoursPrecedents"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #2563eb;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <div
              style="
                font-size: 1.3em;
                font-weight: 700;
                color: #2563eb;
                margin-bottom: 18px;
                display: flex;
                align-items: center;
                gap: 10px;
              "
            >
              <i class="fas fa-calendar-day"></i> Résumé des activité des agents
              (jours précédents)
            </div>
            <div id="resumeJoursPrecedentsContent"></div>
            <script>
              // Filtrer l'affichage pour ne pas montrer "Agent visiteur programmé" dans le résumé des jours précédents
              document.addEventListener("DOMContentLoaded", function () {
                const resumeDiv = document.getElementById(
                  "resumeJoursPrecedentsContent"
                );
                if (resumeDiv) {
                  const observer = new MutationObserver(() => {
                    // Supprime les lignes du tableau contenant "Agent visiteur programmé"
                    resumeDiv.querySelectorAll("tr").forEach((tr) => {
                      if (tr.textContent.includes("Agent visiteur programmé")) {
                        tr.remove();
                      }
                    });
                  });
                  observer.observe(resumeDiv, {
                    childList: true,
                    subtree: true,
                  });
                }
              });
            </script>
            <!-- Popup détail jour sélectionné -->
            <div
              id="popupDetailJourResume"
              style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(30, 41, 59, 0.55);
                z-index: 10000;
                align-items: center;
                justify-content: center;
              "
            >
              <div
                id="popupDetailJourContent"
                style="
                  background: #fff;
                  border-radius: 18px;
                  box-shadow: 0 8px 40px #2563eb44;
                  padding: 32px 28px 24px 28px;
                  max-width: 420px;
                  width: 92vw;
                  max-height: 90vh;
                  overflow-y: auto;
                  position: relative;
                "
              >
                <button
                  id="closePopupDetailJour"
                  style="
                    position: absolute;
                    top: 14px;
                    right: 14px;
                    background: none;
                    border: none;
                    font-size: 1.5em;
                    color: #2563eb;
                    cursor: pointer;
                  "
                >
                  &times;
                </button>
                <div id="popupDetailJourInfos"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="../js/scriptTabBord.js"></script>
    <!-- Script de la popup "En attente de paiement" supprimé -->
    <script>
      // --- Avatar utilisateur moderne dans la sidebar (en bas sous la date) ---
      document.addEventListener("DOMContentLoaded", function () {
        // SÉPARATION STRICTE : NE JAMAIS lire la clé respacconierUser ici !
        // On utilise uniquement la clé 'user' pour le profil du dashboard
        let user = window.currentUser ||
          JSON.parse(localStorage.getItem("user")) || {
            nom: "",
            profil: "",
            photo: "",
            email: "",
          };
        const avatarCircle = document.getElementById("userAvatarCircle");
        const userName = document.getElementById("userNameSidebar");
        const userProfil = document.getElementById("userProfilSidebar");
        // Ajout d'un affichage email sous le nom
        if (avatarCircle && userName && userProfil) {
          // Afficher initiales ou photo
          if (user.photo) {
            avatarCircle.innerHTML = `<img src="${user.photo}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
          } else if (user.nom && user.nom.length > 0) {
            const initiales = user.nom
              .split(" ")
              .map((n) => n[0])
              .join("")
              .substring(0, 2)
              .toUpperCase();
            avatarCircle.innerHTML = initiales;
          }
          userName.textContent = user.nom || "";
          userProfil.textContent = user.profil || "";
          // Affichage email sous le nom
          let emailDiv = document.getElementById("userEmailSidebar");
          if (!emailDiv) {
            emailDiv = document.createElement("div");
            emailDiv.id = "userEmailSidebar";
            emailDiv.style.fontSize = "0.97em";
            emailDiv.style.color = "#374151";
            emailDiv.style.textAlign = "center";
            emailDiv.style.maxWidth = "140px";
            emailDiv.style.overflow = "hidden";
            emailDiv.style.textOverflow = "ellipsis";
            emailDiv.style.whiteSpace = "nowrap";
            userName.parentNode.insertBefore(emailDiv, userProfil);
          }
          emailDiv.textContent = user.email || "";
        }
        // Popup profil détaillé au clic sur l'avatar
        let popup = null;
        if (avatarCircle) {
          avatarCircle.onclick = function (e) {
            e.stopPropagation();
            if (popup) {
              popup.remove();
              popup = null;
              return;
            }
            popup = document.createElement("div");
            popup.style.position = "fixed";
            popup.style.bottom = "32px";
            popup.style.left =
              avatarCircle.getBoundingClientRect().left - 30 + "px";
            popup.style.background = "#fff";
            popup.style.boxShadow = "0 8px 32px #2563eb22";
            popup.style.borderRadius = "1rem";
            popup.style.padding = "22px 32px 18px 32px";
            popup.style.zIndex = 10001;
            popup.style.minWidth = "210px";
            popup.style.fontFamily = "Inter,Segoe UI,sans-serif";
            popup.innerHTML = `
              <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
                <div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#2563eb 60%,#06b6d4 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-size:2em;font-weight:700;box-shadow:0 2px 8px #2563eb22;">${
                  user.photo
                    ? `<img src='${user.photo}' alt='avatar' style='width:100%;height:100%;object-fit:cover;border-radius:50%;'>`
                    : user.nom
                    ? user.nom
                        .split(" ")
                        .map((n) => n[0])
                        .join("")
                        .substring(0, 2)
                        .toUpperCase()
                    : ""
                }</div>
                <div style="font-size:1.12em;font-weight:700;color:#2563eb;text-align:center;">${
                  user.nom || ""
                }</div>
                <div style="font-size:1em;color:#374151;text-align:center;">${
                  user.profil || ""
                }</div>
                <button id='logoutPopupBtn' style='margin-top:10px;background:linear-gradient(90deg,#2563eb 0%,#06b6d4 100%);color:#fff;border:none;border-radius:8px;padding:7px 18px;font-size:0.98em;font-weight:600;box-shadow:0 2px 8px #2563eb22;cursor:pointer;transition:filter 0.18s;'>Se déconnecter</button>
              </div>
            `;
            document.body.appendChild(popup);
            // Fermer au clic extérieur
            setTimeout(() => {
              document.addEventListener("click", closePopup, { once: true });
            }, 10);
            function closePopup(ev) {
              if (popup && !popup.contains(ev.target)) {
                popup.remove();
                popup = null;
              }
            }
            // Déconnexion depuis le popup
            const logoutBtn = popup.querySelector("#logoutPopupBtn");
            if (logoutBtn) {
              logoutBtn.onclick = function () {
                // À adapter selon votre logique de déconnexion
                localStorage.removeItem("user");
                window.location.href = "index.html";
              };
            }
          };
        }
        // Déconnexion directe depuis le sidebar
        const logoutSidebarBtn = document.getElementById("logoutSidebarBtn");
        if (logoutSidebarBtn) {
          logoutSidebarBtn.onclick = function () {
            localStorage.removeItem("user");
            window.location.href = "index.html";
          };
        }
      });
    </script>
    <script>
      // --- Avatar utilisateur dans la sidebar ---
      document.addEventListener("DOMContentLoaded", function () {
        // Simuler récupération du nom et profil utilisateur (à remplacer par vos données réelles)
        let user = window.currentUser || {
          nom: "Utilisateur",
          profil: "Employé",
        };
        // Si vous avez une variable globale ou un stockage local, utilisez-la ici
        // Exemple : user = JSON.parse(localStorage.getItem('user')) || user;
        const avatar = document.getElementById("userAvatarSidebar");
        const avatarCircle = document.getElementById("userAvatarCircle");
        if (avatar && avatarCircle) {
          // Afficher initiales ou icône
          if (user.nom && user.nom.length > 0) {
            const initiales = user.nom
              .split(" ")
              .map((n) => n[0])
              .join("")
              .substring(0, 2)
              .toUpperCase();
            avatarCircle.innerHTML = initiales;
          }
          // Affichage du popup profil
          let popup = null;
          avatar.onclick = function (e) {
            e.stopPropagation();
            if (popup) {
              popup.remove();
              popup = null;
              return;
            }
            popup = document.createElement("div");
            popup.style.position = "fixed";
            popup.style.top = avatar.getBoundingClientRect().bottom + 8 + "px";
            popup.style.left =
              avatar.getBoundingClientRect().right - 180 + "px";
            popup.style.background = "#fff";
            popup.style.boxShadow = "0 8px 32px #2563eb22";
            popup.style.borderRadius = "1rem";
            popup.style.padding = "18px 28px 14px 28px";
            popup.style.zIndex = 10001;
            popup.style.minWidth = "180px";
            popup.style.fontFamily = "Inter,Segoe UI,sans-serif";
            popup.innerHTML = `
              <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                <div style="width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,#2563eb 60%,#06b6d4 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.5em;font-weight:700;box-shadow:0 2px 8px #2563eb22;">${
                  user.nom
                    ? user.nom
                        .split(" ")
                        .map((n) => n[0])
                        .join("")
                        .substring(0, 2)
                        .toUpperCase()
                    : ""
                }</div>
                <div style="font-size:1.08em;font-weight:700;color:#2563eb;text-align:center;">${
                  user.nom || ""
                }</div>
                <div style="font-size:0.98em;color:#374151;text-align:center;">${
                  user.profil || ""
                }</div>
              </div>
            `;
            document.body.appendChild(popup);
            // Fermer au clic extérieur
            setTimeout(() => {
              document.addEventListener("click", closePopup, { once: true });
            }, 10);
            function closePopup(ev) {
              if (popup && !popup.contains(ev.target)) {
                popup.remove();
                popup = null;
              }
            }
          };
        }
      });
    </script>
    <script>
      // --- Gestion du bouton demande code entreprisJESUS ---
      document.addEventListener("DOMContentLoaded", function () {
        const demandeBtn = document.getElementById("demandeCodeEntrepriseBtn");
        const popup = document.getElementById("popupDemandeCodeEntreprise");
        const closeBtn = document.getElementById("closeDemandeCodeEntreprise");
        const envoyerBtn = document.getElementById("envoyerDemandeCodeBtn");
        const msgDiv = document.getElementById("demandeCodeEntrepriseMsg");
        if (demandeBtn && popup) {
          demandeBtn.onclick = function () {
            popup.style.display = "flex";
            msgDiv.textContent = "";
          };
        }
        if (closeBtn && popup) {
          closeBtn.onclick = function () {
            popup.style.display = "none";
          };
          popup.addEventListener("click", function (e) {
            if (e.target === popup) popup.style.display = "none";
          });
        }
        if (envoyerBtn) {
          envoyerBtn.onclick = async function () {
            const nom = document.getElementById("demandeCodeNom").value.trim();
            const email = document
              .getElementById("demandeCodeEmail")
              .value.trim();
            const message = document
              .getElementById("demandeCodeMessage")
              .value.trim();
            msgDiv.textContent = "";
            if (!nom || !email) {
              msgDiv.textContent = "Veuillez renseigner votre nom et email.";
              msgDiv.style.color = "#dc3545";
              return;
            }
            envoyerBtn.disabled = true;
            envoyerBtn.textContent = "Envoi...";
            try {
              // Appel backend SHBSKJà adapter selon ta routesgjhkj
              const res = await fetch("/api/demande-code-entreprise", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nom, email, message }),
              });
              const data = await res.json();
              if (res.ok && data.success) {
                s;
                msgDiv.textContent =
                  "Demande envoyée ! Vous recevrez le code par email.";
                msgDiv.style.color = "#059669";
                document.getElementById("demandeCodeNom").value = "";
                document.getElementById("demandeCodeEmail").value = "";
                document.getElementById("demandeCodeMessage").value = "";
              } else {
                msgDiv.textContent = data.message || "Erreur lors de l'envoi.";
                msgDiv.style.color = "#dc3545";
              }
            } catch (err) {
              msgDiv.textContent = "Erreur réseau ou serveur. Réessayez.";
              msgDiv.style.color = "#dc3545";
            }
            envoyerBtn.disabled = false;
            envoyerBtn.textContent = "Envoyer la demande";
          };
        }
      });
    </script>
    <!-- --- WebSocket pour synchroniser la liste des dossiers en retard en temps réel --- -->
    <script>
      (function () {
        let ws;
        function connectWebSocket() {
          const wsUrl =
            window.location.hostname === "localhost"
              ? "ws://localhost:3000"
              : "wss://plateformdesuivie-its-service-1cjx.onrender.com";
          ws = new WebSocket(wsUrl);
          ws.onopen = function () {};
          ws.onmessage = function (event) {
            try {
              const data = JSON.parse(event.data);

              // === GESTION DES CHANGEMENTS DE STATUT POUR LES COMPTEURS ===
              if (data.type === "status-change" && data.statusChange) {
                console.log(
                  "[DASHBOARD] 🎯 Changement de statut reçu:",
                  data.statusChange
                );

                // Afficher l'alerte
                showCustomAlert(data.message || "Statut mis à jour", "success");

                // Mettre à jour les compteurs immédiatement selon l'action spécifique
                if (typeof window.updateCardCounters === "function") {
                  setTimeout(() => {
                    window.updateCardCounters();
                  }, 100); // Petit délai pour assurer la persistence en base
                }

                // Actions spécifiques pour les transitions de cartes
                if (data.statusChange.action === "delivery_completed") {
                  console.log(
                    `[DASHBOARD] ✅ Transition: "${data.statusChange.dossierNumber}" Mise en livraison → Livré`
                  );
                } else if (data.statusChange.action === "delivery_started") {
                  console.log(
                    `[DASHBOARD] ⚡ Transition: "${data.statusChange.dossierNumber}" En attente → Mise en livraison (via conteneur)`
                  );
                }
              }

              // === NOUVELLE GESTION POUR SYNCHRONISATION DIRECTE DES CARTES ===
              if (
                (data.type === "status-change" && data.action) ||
                data.forceCounterUpdate
              ) {
                console.log(
                  "[DASHBOARD] 🔄 Synchronisation directe des cartes:",
                  data.action,
                  "pour dossier",
                  data.dossierNumber
                );

                // Mise à jour immédiate des compteurs sans délai
                if (typeof window.updateCardCounters === "function") {
                  window.updateCardCounters();
                }

                // Affichage spécifique selon le type de transition
                switch (data.action) {
                  case "delivery_completed":
                    showCustomAlert(
                      `✅ Dossier ${data.dossierNumber} complètement livré`,
                      "success"
                    );
                    break;
                  case "delivery_started":
                    showCustomAlert(
                      `🚛 Dossier ${data.dossierNumber} mis en livraison`,
                      "success"
                    );
                    break;
                  case "increment_mise_en_livraison_decrement_attente":
                    showCustomAlert(
                      `📋→🚛 Dossier ${data.dossierNumber} transféré en livraison`,
                      "success"
                    );
                    break;
                }
              }

              // === GESTION DES TRANSITIONS RESP_ACCONIER → RESP_LIV ===
              if (data.type === "dossier-entre-en-livraison") {
                console.log(
                  "[DASHBOARD] 📋→🚛 Dossier entre en livraison:",
                  data.dossierNumber
                );

                // Afficher l'alerte
                showCustomAlert(
                  `Dossier ${data.dossierNumber} mis en livraison`,
                  "success"
                );

                // Forcer la mise à jour des compteurs avec priorité sur ce type d'événement
                if (typeof window.updateCardCounters === "function") {
                  setTimeout(() => {
                    window.updateCardCounters();
                  }, 50); // Délai très court pour synchronisation rapide
                }
              }

              // === GESTION DES MISES À JOUR FORCÉES DE CONTENEURS ===
              if (
                data.type === "container_status_update" &&
                data.forceCounterUpdate
              ) {
                console.log(
                  "[DASHBOARD] 💥 Mise à jour forcée conteneur:",
                  `${data.containerNumber} -> ${data.status}`,
                  `(${data.deliveredCount}/${data.totalCount})`
                );

                // Afficher l'alerte
                showCustomAlert(
                  `Conteneur ${data.containerNumber} mis à jour: ${data.status}`,
                  "success"
                );

                // Forcer la mise à jour des compteurs immédiatement
                if (typeof window.updateCardCounters === "function") {
                  setTimeout(() => {
                    window.updateCardCounters();
                  }, 50);
                }
              }

              // Synchronisation précise du statut dossier dans la colonne "Responsable Acconier" ou "Statut Dossier" sans rechargement
              if (
                (data.type === "dossier-mise-en-livraison" ||
                  data.type === "bl_status_update" ||
                  data.type === "container_status_update") &&
                data.dossierNumber
              ) {
                // Affiche l'alerte personnalisée pour les autres types
                if (!data.forceCounterUpdate) {
                  showCustomAlert(
                    `Le dossier ${data.dossierNumber} a été mis à jour.`,
                    "success"
                  );
                }

                // Mettre à jour les compteurs immédiatement
                if (typeof window.updateCardCounters === "function") {
                  window.updateCardCounters();
                }

                // Recharge dynamiquement la ligne du tableau concernée
                const table = document.querySelector(
                  "#tableSuiviDossiers, .table-suivi-dossiers"
                );
                if (table) {
                  const rows = table.querySelectorAll("tbody tr");
                  rows.forEach((row) => {
                    // Recherche par attribut data-dossier-id ou cellule dossier-id
                    if (
                      row.getAttribute("data-dossier-id") ==
                        data.dossierNumber ||
                      (row.querySelector(".dossier-id") &&
                        row.querySelector(".dossier-id").textContent.trim() ==
                          data.dossierNumber)
                    ) {
                      // Requête AJAX pour récupérer les données à jour du dossier
                      fetch(
                        `/deliveries/search?dossierNumber=${encodeURIComponent(
                          data.dossierNumber
                        )}`
                      )
                        .then((res) => res.json())
                        .then((result) => {
                          if (result && result.success && result.delivery) {
                            // Met à jour toutes les cellules de la ligne
                            const delivery = result.delivery;
                            // Adapter ici selon l'ordre des colonnes du tableau
                            // Exemple : [dossier-id, client, agent, statut, ...]
                            if (row.querySelector(".dossier-id")) {
                              row.querySelector(".dossier-id").textContent =
                                delivery.dossier_number || delivery.id;
                            }
                            if (row.querySelector(".client-nom")) {
                              row.querySelector(".client-nom").textContent =
                                delivery.client_name || "";
                            }
                            if (row.querySelector(".agent-nom")) {
                              row.querySelector(".agent-nom").textContent =
                                delivery.employee_name || "";
                            }
                            if (row.querySelector(".statut-dossier")) {
                              // Statut dynamique : "Mise en livraison" si livré, sinon "En attente de paiement"
                              let statut = "En attente de paiement";
                              // On considère livré si delivery.delivery_status_acconier contient "livraison"
                              if (
                                delivery.delivery_status_acconier &&
                                delivery.delivery_status_acconier
                                  .toLowerCase()
                                  .includes("livraison")
                              ) {
                                statut = "Mise en livraison";
                              }
                              row.querySelector(".statut-dossier").textContent =
                                statut;
                              row.querySelector(".statut-dossier").style.color =
                                statut === "Mise en livraison"
                                  ? "#059669"
                                  : "#f59e0b";
                              row.querySelector(
                                ".statut-dossier"
                              ).style.fontWeight = "700";
                            }
                            // Ajoutez ici d'autres cellules à mettre à jour si besoin
                          }
                        });
                    }
                  });
                }
                // Mise à jour de la carte "Dossiers en retard" en temps réel
                if (typeof updateCarteDossiersRetard === "function") {
                  updateCarteDossiersRetard();
                }
              }
            } catch (e) {
              console.error("[DASHBOARD] Erreur WebSocket:", e);
            }
          };
          ws.onclose = function () {
            setTimeout(connectWebSocket, 2000);
          };
        }
        // Nouvelle fonction pour mettre à jour la carte Dossiers en retard
        function updateCarteDossiersRetard() {
          // Sélectionne l'élément de la carte
          const carteRetard = document.querySelector(
            ".dossier-retard.etat-card"
          );
          if (!carteRetard) return;
          // Appel API pour récupérer la liste à jour
          fetch("/api/dossiers/retard")
            .then((res) => res.json())
            .then((dossiers) => {
              // Met à jour le nombre affiché sur la carte
              let count = Array.isArray(dossiers) ? dossiers.length : 0;
              // Cherche l'élément qui affiche le nombre (exemple: .etat-title ou .etat-desc)
              let title = carteRetard.querySelector(".etat-title");
              let desc = carteRetard.querySelector(".etat-desc");
              if (title) {
                title.textContent = `Dossiers en retard (${count})`;
              }
              if (desc) {
                desc.textContent =
                  count === 0
                    ? "Aucun dossier en retard."
                    : `${count} dossier${count > 1 ? "s" : ""} en retard.`;
              }
            })
            .catch(() => {
              // En cas d'erreur, affiche un message
              let title = carteRetard.querySelector(".etat-title");
              let desc = carteRetard.querySelector(".etat-desc");
              if (title) title.textContent = "Dossiers en retard";
              if (desc) desc.textContent = "Erreur de chargement.";
            });
        }
        // --- Ajout : fonction d'alerte personnalisée ---
        function showCustomAlert(message, type = "success") {
          let alertDiv = document.createElement("div");
          alertDiv.className = `custom-alert show ${type}`;
          alertDiv.textContent = message;
          alertDiv.style.position = "fixed";
          alertDiv.style.top = "32px";
          alertDiv.style.right = "32px";
          alertDiv.style.zIndex = "99999";
          alertDiv.style.padding = "18px 32px";
          alertDiv.style.background =
            type === "success" ? "#059669" : "#dc3545";
          alertDiv.style.color = "#fff";
          alertDiv.style.fontSize = "1.18em";
          alertDiv.style.borderRadius = "12px";
          alertDiv.style.boxShadow = "0 8px 32px #05966944";
          document.body.appendChild(alertDiv);
          setTimeout(() => {
            alertDiv.classList.remove("show");
            alertDiv.style.opacity = "0";
            setTimeout(() => alertDiv.remove(), 600);
          }, 3200);
        }
        connectWebSocket();

        // Fonction de debug temporaire pour diagnostiquer le problème des compteurs
        window.debugCardCounters = function () {
          console.log("🔍 [DEBUG] État actuel des cartes:");
          const cartes = [
            "carteAttentePaiement",
            "carteMiseLivraison",
            "carteLivre",
          ];
          cartes.forEach((cardId) => {
            const card = document.getElementById(cardId);
            if (card) {
              const counter = card.querySelector(".card-counter");
              const currentValue = counter
                ? counter.textContent
                : "AUCUN COMPTEUR";
              console.log(`  📊 ${cardId}: ${currentValue}`);
            }
          });

          // Forcer la mise à jour des compteurs
          console.log("🔄 Forcement de la mise à jour des compteurs...");
          window.updateCardCounters();
        };

        // Exécuter le debug dans 2 secondes après le chargement complet
        setTimeout(() => {
          console.log(
            "🚀 [SYNCHRONISATION] Initialisation de la synchronisation des cartes..."
          );

          // Vérifier que toutes les cartes existent
          const cartesRequises = [
            "carteAttentePaiement",
            "carteMiseLivraison",
            "carteLivre",
          ];
          const cartesManquantes = cartesRequises.filter(
            (id) => !document.getElementById(id)
          );

          if (cartesManquantes.length > 0) {
            console.error(
              "❌ [SYNCHRONISATION] Cartes manquantes:",
              cartesManquantes
            );
            return;
          }

          console.log("✅ [SYNCHRONISATION] Toutes les cartes sont présentes");

          // Première synchronisation
          window.updateCardCounters();

          // Programmer les synchronisations automatiques
          setInterval(() => {
            console.log("🔄 [SYNCHRONISATION] Mise à jour périodique...");
            window.updateCardCounters();
          }, 30000); // Toutes les 30 secondes

          console.log(
            "✅ [SYNCHRONISATION] Système de synchronisation initialisé"
          );
          console.log(
            "💡 [SYNCHRONISATION] Utilisez window.diagnoseTablóeDeBord() pour diagnostiquer"
          );
        }, 2000);

        // Ajouter une fonction globale pour forcer la correction manuelle si nécessaire
        window.fixCardCounters = function () {
          console.log("🔧 [MANUAL FIX] Correction manuelle des compteurs...");
          window.updateCardCounters();
        };

        // === SYSTÈME DE SURVEILLANCE DES UTILISATEURS CONNECTÉS ===
        function updateConnectedUsers() {
          console.log("🔄 [UPDATE] Mise à jour des utilisateurs connectés...");
          // Utiliser la nouvelle API de statistiques globales
          fetch(`${window.API_BASE_URL}/api/active-users/stats`)
            .then((response) => response.json())
            .then((data) => {
              console.log("📊 [UPDATE] Données reçues:", data);
              // L'API retourne directement les données, pas d'objet avec success
              if (
                data &&
                (data.totalConnectedUsers !== undefined || data.pageStats)
              ) {
                updateSidebarIndicators(data);
                updateDetailedUsersList(data);
                console.log("✅ [UPDATE] Indicateurs mis à jour avec succès");
              } else {
                console.warn("⚠️ [UPDATE] Format de données inattendu:", data);
              }
            })
            .catch((error) => {
              console.warn(
                "❌ [UPDATE] Erreur lors de la récupération des statistiques utilisateurs:",
                error
              );
              updateSidebarIndicators({ pageStats: {} });
              updateDetailedUsersList({
                totalConnectedUsers: 0,
                pageStats: {},
              });
            });
        }

        function updateSidebarIndicators(data) {
          console.log("🎯 [SIDEBAR] Mise à jour des indicateurs avec:", data);
          const pageStats = data.pageStats || {};
          console.log("📈 [SIDEBAR] pageStats:", pageStats);

          // Mettre à jour l'indicateur Acconier
          const acconiersDiv = document.getElementById("acconiersConnected");
          if (acconiersDiv) {
            const acconiersData = pageStats["resp_acconier.html"] || {
              count: 0,
              users: [],
            };
            const count = acconiersData.count;
            console.log("🛡️ [SIDEBAR] Acconiers connectés:", count);
            const circleColor = count > 0 ? "#10b981" : "#dc2626";
            const usersList = acconiersData.users
              .map((user) => user.nom || user.username || "Utilisateur")
              .join(", ");

            acconiersDiv.innerHTML = `
              <i class="fas fa-circle" style="color: ${circleColor}; font-size: 6px; margin-right: 2px;"></i>${count} connecté(s)
            `;
            acconiersDiv.title =
              count > 0
                ? `Connectés: ${usersList}`
                : "Aucun utilisateur connecté sur resp_acconier.html";
          } else {
            console.warn("⚠️ [SIDEBAR] Element acconiersConnected non trouvé");
          }

          // Mettre à jour l'indicateur Livraison
          const livraisonsDiv = document.getElementById("livraisonsConnected");
          if (livraisonsDiv) {
            const livraisonsData = pageStats["resp_liv.html"] || {
              count: 0,
              users: [],
            };
            const count = livraisonsData.count;
            console.log("📦 [SIDEBAR] Livraisons connectées:", count);
            console.log("📦 [SIDEBAR] Livraisons connectées:", count);
            const circleColor = count > 0 ? "#10b981" : "#dc2626";
            const usersList = livraisonsData.users
              .map((user) => user.nom || user.username || "Utilisateur")
              .join(", ");

            livraisonsDiv.innerHTML = `
              <i class="fas fa-circle" style="color: ${circleColor}; font-size: 6px; margin-right: 2px;"></i>${count} connecté(s)
            `;
            livraisonsDiv.title =
              count > 0
                ? `Connectés: ${usersList}`
                : "Aucun utilisateur connecté sur resp_liv.html";
          } else {
            console.warn("⚠️ [SIDEBAR] Element livraisonsConnected non trouvé");
          }
        }

        function updateDetailedUsersList(data) {
          console.log(
            "📝 [DETAILS] Mise à jour de la liste détaillée avec:",
            data
          );
          const totalUsersDiv = document.getElementById("totalUsersCount");
          const usersListDiv = document.getElementById("usersDetailsList");

          if (!totalUsersDiv || !usersListDiv) {
            console.warn(
              "⚠️ [DETAILS] Éléments totalUsersCount ou usersDetailsList non trouvés"
            );
            return;
          }

          const totalUsers = data.totalConnectedUsers || 0;
          console.log("👥 [DETAILS] Total utilisateurs:", totalUsers);
          totalUsersDiv.textContent = `${totalUsers} total`;

          if (totalUsers === 0) {
            usersListDiv.innerHTML = `
              <div style="text-align: center; color: #6b7280; font-style: italic; padding: 8px 0; font-size: 0.8em;">
                Aucun utilisateur connecté
              </div>
            `;
            return;
          }

          let html = "";
          const pageStats = data.pageStats || {};

          Object.keys(pageStats).forEach((pageName) => {
            const pageData = pageStats[pageName];
            if (pageData.count > 0) {
              const pageDisplayName =
                pageName === "resp_acconier.html"
                  ? "🛡️ Acconiers"
                  : "📦 Livraisons";

              html += `
                <div style="margin-bottom: 8px;">
                  <div style="
                    font-weight: 600; 
                    color: #374151; 
                    font-size: 0.85em;
                    margin-bottom: 4px;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                  ">
                    <span>${pageDisplayName}</span>
                    <span style="
                      background: ${pageData.count > 0 ? "#10b981" : "#dc2626"};
                      color: white;
                      font-size: 0.7em;
                      padding: 1px 4px;
                      border-radius: 6px;
                    ">${pageData.count}</span>
                  </div>
              `;

              pageData.users.forEach((user) => {
                const timeAgo = formatTimeAgo(user.timeConnected || 0);

                // Déterminer l'URL de la page spécifique
                const targetPageUrl =
                  pageName === "resp_acconier.html"
                    ? "/html/resp_acconier.html"
                    : "/html/resp_liv.html";

                // Ne pas ajouter de paramètres ici, on les ajoutera dans redirectToUserPage
                const fullUrl = targetPageUrl;

                html += `
                  <div 
                    style="
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      padding: 3px 6px;
                      background: #f9fafb;
                      border-radius: 4px;
                      margin-bottom: 2px;
                      border-left: 2px solid #10b981;
                      font-size: 0.8em;
                      cursor: pointer;
                      transition: background-color 0.2s ease;
                    "
                    onmouseover="this.style.backgroundColor='#f3f4f6'"
                    onmouseout="this.style.backgroundColor='#f9fafb'"
                    onclick="redirectToUserPage('${fullUrl}', '${
                  user.nom || user.username || "Utilisateur"
                }', '${pageName}', '${user.userId}')"
                    title="Cliquer pour aller sur la page de ${
                      user.nom || user.username || "cet utilisateur"
                    }"
                  >
                    <div style="overflow: hidden; display: flex; align-items: center;">
                      <span style="
                        font-size: 0.9em; 
                        margin-right: 6px;
                        color: #10b981;
                      ">🔗</span>
                      <div style="font-weight: 500; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${user.nom || user.username || "Utilisateur"}
                      </div>
                    </div>
                    <div style="
                      font-size: 0.7em;
                      color: #059669;
                      background: #d1fae5;
                      padding: 1px 4px;
                      border-radius: 3px;
                      white-space: nowrap;
                    ">
                      ${timeAgo}
                    </div>
                  </div>

                `;
              });

              html += "</div>";
            }
          });

          usersListDiv.innerHTML = html;
        }

        function formatTimeAgo(seconds) {
          if (seconds < 60) return `${seconds}s`;
          const minutes = Math.floor(seconds / 60);
          if (minutes < 60) return `${minutes}m`;
          const hours = Math.floor(minutes / 60);
          return `${hours}h ${minutes % 60}m`;
        }

        // Fonction accessible globalement pour le toggle
        window.toggleUsersDetails = function () {
          const section = document.getElementById("detailedUsersSection");
          const list = document.getElementById("usersDetailsList");
          if (list.style.display === "none") {
            list.style.display = "block";
            section.style.maxHeight = "200px";
          } else {
            list.style.display = "none";
            section.style.maxHeight = "40px";
          }
        };

        // Fonction de redirection vers la page spécifique de l'utilisateur
        window.redirectToUserPage = function (
          pageUrl,
          userName,
          pageName,
          userId
        ) {
          // Confirmation optionnelle
          const pageType =
            pageName === "resp_acconier.html"
              ? "Responsable Acconier"
              : "Responsable Livraison";
          const confirmed = confirm(
            `Voulez-vous aller à la page de ${userName} (${pageType}) ?\n\n` +
              `Vous allez être redirigé vers la page correspondante en mode admin.`
          );

          if (confirmed) {
            // Stocker les informations de l'utilisateur ciblé dans le localStorage temporairement
            const targetUserInfo = {
              userName: userName,
              userId: userId,
              pageType: pageType,
              redirectTime: Date.now(),
              isRedirectedFromDashboard: true,
            };

            localStorage.setItem(
              "targetUserInfo",
              JSON.stringify(targetUserInfo)
            );

            // Déterminer l'URL complète avec le domaine Render et le mode admin
            const baseUrl =
              "https://plateformdesuivie-its-service-1cjx.onrender.com";
            const fullPageUrl =
              pageName === "resp_acconier.html"
                ? `${baseUrl}/html/resp_acconier.html`
                : `${baseUrl}/html/resp_liv.html`;

            // Créer une URL avec les paramètres pour plus de clarté
            const urlParams = new URLSearchParams({
              mode: "admin",
              fromDashboard: "true",
              targetUser: userName,
              userId: userId || "",
              timestamp: Date.now(),
            });

            const finalUrl = `${fullPageUrl}?${urlParams.toString()}`;

            console.log(`🎯 [ADMIN REDIRECT] Redirection vers: ${finalUrl}`);
            console.log(
              `👤 [ADMIN REDIRECT] Utilisateur ciblé: ${userName} (${pageType})`
            );

            // Redirection dans la même fenêtre pour assurer la transmission des paramètres
            window.location.href = finalUrl;

            // Nettoyer les informations après 30 secondes
            setTimeout(() => {
              localStorage.removeItem("targetUserInfo");
            }, 30000);
          } else {
            console.log(`❌ [REDIRECT] Redirection annulée par l'utilisateur`);
          }
        };

        // Mettre à jour les utilisateurs connectés toutes les 15 secondes
        setInterval(updateConnectedUsers, 15000);

        // Première mise à jour après 3 secondes (pour laisser le temps à la page de se charger)
        setTimeout(updateConnectedUsers, 3000);

        console.log(
          "✅ [CONNECTED USERS] Système de surveillance des utilisateurs connectés initialisé"
        );
        console.log(
          "🧪 [TEST] Utilisez window.testActiveUsers() pour tester les indicateurs"
        );
        console.log(
          "🔍 [DIAGNOSTIC] Utilisez window.diagnosisConnectedUsers() pour diagnostiquer les problèmes"
        );
      })();
    </script>

    <!-- Script de filtrage pour la modal dossiers en retard -->
    <script>
      // Variable globale pour stocker tous les dossiers
      window.tousLesDossiersRetard = [];

      // Fonction de filtrage
      function filtrerDossiers() {
        const input = document.getElementById("rechercheRetard");
        const recherche = input.value.toLowerCase().trim();
        const contenu = document.getElementById("contenuDossiersRetard");

        if (
          !window.tousLesDossiersRetard ||
          window.tousLesDossiersRetard.length === 0
        ) {
          return;
        }

        // Filtrer les dossiers
        let dossiersFilters = window.tousLesDossiersRetard;
        if (recherche) {
          dossiersFilters = window.tousLesDossiersRetard.filter((dossier) => {
            const client = (
              dossier.client_name ||
              dossier.client ||
              ""
            ).toLowerCase();
            const agent = (
              dossier.employee_name ||
              dossier.agent ||
              ""
            ).toLowerCase();
            const numeroDossier = (
              dossier.dossier_number ||
              dossier.numero ||
              ""
            )
              .toString()
              .toLowerCase();

            return (
              client.includes(recherche) ||
              agent.includes(recherche) ||
              numeroDossier.includes(recherche)
            );
          });
        }

        // Afficher les résultats
        if (dossiersFilters.length === 0) {
          contenu.innerHTML = `
            <div style='text-align:center;padding:40px 20px;color:#6b7280;'>
              <i class="fas fa-search" style="font-size:3em;color:#94a3b8;margin-bottom:15px;"></i>
              <p style="font-size:1.2em;margin:0;">Aucun résultat trouvé</p>
              <p style="font-size:1em;margin:8px 0 0 0;">Essayez avec d'autres mots-clés</p>
            </div>
          `;
          return;
        }

        let html = `
          <div style="margin-bottom:16px; padding: 12px 16px; background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 12px; border-left: 4px solid #dc3545;">
            <p style="color:#374151;font-size:1.05em;margin:0;text-align:center;font-weight:600;">
              <i class="fas fa-exclamation-triangle" style="color:#dc3545;margin-right:8px;"></i>
              <strong>${dossiersFilters.length}</strong> dossier${
          dossiersFilters.length > 1 ? "s" : ""
        } ${
          recherche
            ? "trouvé" + (dossiersFilters.length > 1 ? "s" : "")
            : "en retard"
        }
            </p>
          </div>
          <div style="max-height:450px;overflow-y:auto;padding-right:8px;">
            <div style="display:grid;gap:16px;">
        `;

        dossiersFilters.forEach((dossier, index) => {
          const dossierId =
            dossier.id ||
            dossier.numero_bl ||
            dossier.numero ||
            dossier._id ||
            "";
          const clientName =
            dossier.client_name ||
            dossier.client ||
            dossier.nom ||
            "Client non défini";
          const employeeName = dossier.employee_name || "Agent non défini";
          const dossierNumber =
            dossier.dossier_number || dossier.numero || dossierId;

          const createdAtDate = dossier.created_at
            ? new Date(dossier.created_at)
            : null;
          const deliveryDate = dossier.delivery_date
            ? new Date(dossier.delivery_date)
            : null;
          const now = new Date();

          let daysLate = 0;
          let formattedCreatedDate = "Date non disponible";
          let formattedDeliveryDate = "Non définie";

          if (createdAtDate) {
            daysLate = Math.floor(
              (now - createdAtDate) / (1000 * 60 * 60 * 24)
            );
            formattedCreatedDate = createdAtDate.toLocaleDateString("fr-FR", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            });
          }

          if (deliveryDate) {
            formattedDeliveryDate = deliveryDate.toLocaleDateString("fr-FR", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            });
          }

          const isLivraisonType = dossier.type === "livraison";
          const redirectUrl = isLivraisonType
            ? `https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_liv.html?dossier=${encodeURIComponent(
                dossierId
              )}&flash=true`
            : `https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_acconier.html?dossier=${encodeURIComponent(
                dossierId
              )}&flash=true`;

          const typeColor = isLivraisonType ? "#2563eb" : "#dc3545";
          const typeIcon = isLivraisonType
            ? "fas fa-truck"
            : "fas fa-folder-open";
          const typeLabel = isLivraisonType ? "LIVRAISON" : "ACCONIER";

          html += `
            <li style='
              background: linear-gradient(135deg, ${
                isLivraisonType ? "#eff6ff" : "#fef2f2"
              } 80%, ${isLivraisonType ? "#dbeafe" : "#fecaca"} 100%);
              border: 2px solid ${isLivraisonType ? "#dbeafe" : "#fecaca"};
              border-radius: 12px;
              margin-bottom: 12px;
              padding: 18px 20px;
              cursor: pointer;
              transition: all 0.2s ease;
              border-left: 4px solid ${typeColor};
              position: relative;
            '
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(${
              isLivraisonType ? "37, 99, 235" : "220, 53, 69"
            }, 0.25)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
            onclick="window.location.href='${redirectUrl}'">

              <div style="position: absolute; top: 8px; right: 8px; background: ${typeColor}; color: white; font-size: 0.7em; font-weight: 700; padding: 2px 6px; border-radius: 4px; text-transform: uppercase;">
                ${typeLabel}
              </div>

              <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                <span style="background:${typeColor}; color:#fff; font-weight:700; font-size:0.9em; padding:4px 8px; border-radius:6px; min-width:30px; text-align:center;">${
            index + 1
          }</span>

                <div style="flex:1;">
                  <div style="font-size:1.15em; font-weight:700; color:${typeColor}; margin-bottom:2px;">
                    <i class="${typeIcon}" style="margin-right:6px;"></i>
                    ${clientName}
                  </div>
                  <div style="font-size:0.95em; color:#6b7280; margin-bottom:4px;">
                    Dossier: <strong style="color:#374151;">${dossierNumber}</strong>
                  </div>
                  
                  <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 1px solid #cbd5e1; border-radius: 8px; padding: 8px 10px; margin-top: 6px; font-size: 0.85em;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                      <span style="color: #475569; font-weight: 600;"><i class="fas fa-calendar-plus" style="margin-right: 4px; color: #059669;"></i>Créé le:</span>
                      <span style="color: #374151; font-weight: 700;">${formattedCreatedDate}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; background: ${
                      daysLate > 7
                        ? "#fef2f2"
                        : daysLate > 3
                        ? "#fff7ed"
                        : "#fefce8"
                    }; border: 1px solid ${
            daysLate > 7 ? "#fecaca" : daysLate > 3 ? "#fed7aa" : "#fde68a"
          }; border-radius: 6px; margin-top: 4px;">
                      <span style="color: #475569; font-weight: 600;"><i class="fas fa-clock" style="margin-right: 4px; color: ${
                        daysLate > 7
                          ? "#dc2626"
                          : daysLate > 3
                          ? "#ea580c"
                          : "#d97706"
                      };"></i>En retard depuis:</span>
                      <span style="color: ${
                        daysLate > 7
                          ? "#dc2626"
                          : daysLate > 3
                          ? "#ea580c"
                          : "#d97706"
                      }; font-weight: 800; font-size: 0.95em;">${daysLate} jour${
            daysLate > 1 ? "s" : ""
          }</span>
                    </div>
                  </div>
                </div>

                <div style="text-align:right;">
                  <div style="font-size:0.9em; color:#6b7280; margin-bottom:2px;">${
                    isLivraisonType ? "Livreur" : "Agent"
                  }</div>
                  <div style="font-size:1em; font-weight:600; color:#374151;">${employeeName}</div>
                </div>
              </div>

              <div style="font-size:0.85em; color:${typeColor}; background:#fff; padding:6px 10px; border-radius:6px; text-align:center; font-weight:600;">
                <i class="fas fa-external-link-alt" style="margin-right:4px;"></i>
                ${
                  isLivraisonType
                    ? "Livraison en retard - Cliquer pour ouvrir"
                    : "Dossier en retard - Cliquer pour gérer"
                }
              </div>
            </li>
          `;
        });

        html += "</div></div>";
        contenu.innerHTML = html;
      }
    </script>
  </body>
</html>
<!--CODE123000-->
