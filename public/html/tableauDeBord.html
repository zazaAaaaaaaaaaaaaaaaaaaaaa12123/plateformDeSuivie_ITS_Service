<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/reconnecting-websocket@4.4.0/dist/reconnecting-websocket.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Centre de Contact Clients</title>

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    />

    <link rel="stylesheet" href="/css/styledeTabBord.css" />
    <link rel="stylesheet" href="/css/styleDeSuivie.css" />
    <link rel="stylesheet" href="/css/styleHistoriqueAgents.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      /* Styles généraux pour le corps */
      html,
      body {
        overflow: hidden;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      body {
        background: linear-gradient(145deg, #007bff, #0056b3);
        color: #333;
        min-height: 90vh;
        padding: 20px;
      }

      .layout {
        display: flex;
        max-width: 100%;
        margin: 0 auto;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        background: white;
        transition: all 0.3s ease;
        height: 100vh;
      }

      /* --- AMELIORATIONS POUR LA SIDEBAR - Version "Sublimée" --- */

      /* SIDEBAR - Styles généraux */
      .sidebar {
        background: linear-gradient(180deg, #303d4c 0%, #212a33 100%);
        color: #e0e6ec;
        padding: 25px 20px;
        width: 250px;
        min-height: 100vh;
        box-shadow: 8px 0 25px rgba(0, 0, 0, 0.3);
        font-family: "Inter", sans-serif;
        transition: width 0.4s ease-in-out, padding 0.4s ease-in-out,
          background 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
      }

      /* Titre du menu */
      .sidebar h2 {
        font-size: 1.8em;
        margin-bottom: 35px;
        font-weight: 700;
        color: #a3daff;
        border-bottom: 2px solid #63b3ed;
        padding-bottom: 15px;
        text-align: center;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        overflow: hidden;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      /* Cache l'icône de bascule du H2 si tu ne l'utilises pas en mode déplié */
      .sidebar h2 .toggle-icon {
        display: none;
      }

      /* Liste menu */
      .sidebar ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .sidebar ul li {
        margin-bottom: 12px;
        width: 100%;
      }

      /* Liens du menu */
      .sidebar ul li a {
        display: flex;
        align-items: center;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.05rem;
        padding: 12px 18px;
        border-radius: 8px;
        transition: background-color 0.25s ease, color 0.25s ease,
          transform 0.25s ease, box-shadow 0.25s ease;
        color: #e0e6ec;
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 0 0 0px rgba(99, 179, 237, 0.4);
      }

      /* Hover des liens - Effet de surbrillance plus doux et élégant */
      .sidebar ul li a:hover {
        background-color: #3f5166;
        color: #a3daff;
        transform: translateX(8px);
        box-shadow: inset 0 0 0 2px #63b3ed, 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      /* Icône des liens */
      .sidebar ul li a .icon {
        margin-right: 18px;
        font-size: 1.3em;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: transparent;
        color: #a3daff;
        border-radius: 0;
        transition: color 0.25s ease, transform 0.25s ease;
      }

      /* Icône hover avec lien */
      .sidebar ul li a:hover .icon {
        color: #e0e6ec;
        transform: scale(1.15) rotate(5deg);
      }

      /* Texte des liens */
      .link-text {
        opacity: 1;
        transition: opacity 0.3s ease, width 0.3s ease;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      /* Style pour le calendrier - Visibilité par défaut */
      .calendar-container {
        margin-top: 40px;
        padding: 0 10px;
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .calendar-container label {
        font-weight: 500;
        color: #b0bec5;
        display: block;
        margin-bottom: 10px;
        font-size: 0.95rem;
      }

      .calendar-container input[type="date"] {
        width: 100%;
        padding: 10px 12px;
        font-size: 0.95rem;
        border: 1px solid #4a5d6f;
        background-color: #2a3540;
        color: #e0e6ec;
        border-radius: 6px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        -webkit-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%23e0e6ec"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 30px;
      }

      .calendar-container input[type="date"]:focus {
        border-color: #63b3ed;
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.4);
      }

      /* --- État COLLAPSED de la sidebar (quand le body a la classe 'sidebar-collapsed') --- */
      body.sidebar-collapsed .sidebar {
        width: 90px;
        padding: 20px 0;
        background: linear-gradient(180deg, #303d4c 0%, #212a33 100%);
        box-shadow: 8px 0 25px rgba(0, 0, 0, 0.3);
      }
      body.sidebar-collapsed
        #sidebarUserProfile
        > div[style*="flex-direction: row"] {
        justify-content: center !important;
        gap: 8px !important;
        margin-top: 8px !important;
      }
      body.sidebar-collapsed
        #sidebarUserProfile
        > div[style*="flex-direction: row"]
        span {
        width: 28px !important;
        height: 28px !important;
        font-size: 1em !important;
        margin: 0 1px !important;
        box-shadow: none !important;
        padding: 0 !important;
      }
      body.sidebar-collapsed
        #sidebarUserProfile
        > div[style*="flex-direction: row"]
        i {
        font-size: 1em !important;
      }

      body.sidebar-collapsed .sidebar h2 {
        justify-content: center;
        border-bottom: none;
        padding-bottom: 0;
        color: #a3daff;
        font-size: 1.5em;
      }

      /* Texte "Menu" à masquer quand la sidebar est pliée */
      body.sidebar-collapsed .sidebar h2 span.link-text {
        opacity: 0;
        visibility: hidden;
        width: 0;
        margin-right: 0;
      }

      /* Centrage des éléments de la liste UL en mode plié */
      body.sidebar-collapsed .sidebar ul {
        align-items: center;
      }

      /* Centrage des liens LI en mode plié */
      body.sidebar-collapsed .sidebar ul li {
        justify-content: center;
        width: auto;
      }

      /* Texte des liens (masqué en mode plié) */
      body.sidebar-collapsed .link-text {
        opacity: 0;
        visibility: hidden;
        width: 0;
        padding: 0;
        margin: 0;
      }

      body.sidebar-collapsed .calendar-container label,
      body.sidebar-collapsed .calendar-container input {
        opacity: 0;
        visibility: hidden;
        width: 0;
        padding: 0;
        margin: 0;
        height: 0;
      }

      /* Styles pour les bulles en mode plié */
      body.sidebar-collapsed .sidebar ul li a .icon {
        margin-right: 0;
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background-color: #63b3ed;
        color: white !important;
        font-size: 1.6em;
        box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.4);
        transform: scale(1);
        transition: all 0.3s ease;
      }

      /* Ajustements pour l'icône au survol en mode plié */
      body.sidebar-collapsed .sidebar ul li a:hover .icon {
        background-color: #4299e1;
        transform: translateY(-5px) scale(1.15);
        box-shadow: 6px 6px 15px rgba(0, 0, 0, 0.5);
      }

      body.sidebar-collapsed .sidebar ul li a {
        justify-content: center;
        padding: 10px 0;
        align-items: center;
        background-color: transparent !important;
        color: white !important;
        width: 100%;
      }

      /* Supprime le pseudo-élément au survol qui était caché précédemment */
      body.sidebar-collapsed .sidebar ul li a:hover::before {
        display: none !important;
      }

      /* Médias queries pour les petits écrans - S'assure que les icônes redeviennent normales */
      @media (max-width: 768px) {
        .sidebar ul li a .icon {
          width: auto !important;
          height: auto !important;
          border-radius: 0 !important;
          background-color: transparent !important;
          box-shadow: none !important;
          transform: none !important;
          font-size: 1em !important;
          margin-right: 14px !important;
        }

        .sidebar ul li a:hover .icon {
          background-color: transparent !important;
          transform: none !important;
          box-shadow: none !important;
        }
        .sidebar ul li a {
          padding: 10px 15px !important;
          justify-content: flex-start !important;
        }
      }

      /* --- Styles pour l'indicateur de connexion --- */
      .connection-status {
        margin-left: 10px;
        font-size: 1.2em;
        transition: color 0.3s ease, transform 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* Couleur par défaut (connecté) */
      .connection-status .fas {
        color: #28a745; /* Vert pour connecté */
      }

      /* Style quand l'utilisateur est hors ligne */
      .connection-status.offline .fas {
        color: #dc3545; /* Rouge pour déconnecté */
        transform: rotate(
          45deg
        ); /* Petite rotation pour indiquer le changement */
      }

      /* Ajustements pour le mode plié de la sidebar */
      body.sidebar-collapsed .sidebar h2 .connection-status {
        margin-left: 0;
        font-size: 1.5em;
      }

      body.sidebar-collapsed .sidebar h2 {
        justify-content: center;
      }

      /* --- Styles pour l'alerte de connexion/déconnexion --- */
      .custom-alert {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 25px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .custom-alert.success {
        background-color: #28a745;
      }

      .custom-alert.error {
        background-color: #dc3545;
      }

      .custom-alert.show {
        opacity: 1;
        visibility: visible;
      }

      /* --- Styles pour le contenu principal (welcome, buttons) --- */
      .welcome-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 80vh;
        text-align: center;
        padding: 0 20px;
        background: linear-gradient(to right, #ffffff, #f3f4f6);
        animation: fadeIn 1.2s ease-in-out;
      }

      .welcome-container h1 {
        font-size: 3rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1rem;
        font-family: "Inter", sans-serif;
      }

      .welcome-container p {
        font-size: 1.2rem;
        color: #4b5563;
        margin-bottom: 2.5rem;
        max-width: 600px;
        line-height: 1.6;
      }

      .bottom-buttons {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 18px;
        z-index: 10;
        width: 100%;
        padding: 0;
      }

      .bottom-buttons button {
        background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%);
        color: #fff;
        border: none;
        padding: 7px 10px;
        border-radius: 8px;
        font-size: 0.92rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 8px #2563eb22, 0 1px 4px #0001;
        transition: background 0.25s, transform 0.18s, box-shadow 0.25s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-family: "Inter", sans-serif;
        letter-spacing: 0.2px;
        outline: none;
        min-width: 90px;
        max-width: 160px;
        height: 32px;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .bottom-buttons button:hover,
      .bottom-buttons button:focus {
        background: linear-gradient(90deg, #1d4ed8 0%, #2563eb 100%);
        transform: translateY(-3px) scale(1.04);
        box-shadow: 0 12px 32px #2563eb33, 0 4px 16px #0002;
      }

      .bottom-buttons i {
        font-size: 1.05em;
        margin-right: 4px;
      }

      @media (max-width: 700px) {
        .bottom-buttons {
          flex-direction: column;
          gap: 10px;
          bottom: 12px;
        }
        .bottom-buttons button {
          width: 90vw;
          max-width: 320px;
          font-size: 0.98em;
          padding: 10px 0;
          height: 40px;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .main-content {
        flex-grow: 1;
        padding: 30px;
        background-color: #f7f9fc;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
        min-width: 0;
        transition: margin-left 0.3s ease, width 0.3s ease;
        box-sizing: border-box;
      }
      .dynamic-content-area,
      #content {
        flex-grow: 1;
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        min-width: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .green-dot-animated {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #28a745;
        margin-left: 12px;
        box-shadow: 0 0 0 0 #28a745;
        animation: greenDotPulse 1s infinite cubic-bezier(0.66, 0, 0, 1);
        vertical-align: middle;
      }
      #btnResumeJoursPrecedents {
        font-size: 0.8rem;
      }
      @keyframes greenDotPulse {
        0% {
          box-shadow: 0 0 0 0 #28a74599;
          opacity: 1;
        }
        70% {
          box-shadow: 0 0 0 10px #28a74500;
          opacity: 1;
        }
        100% {
          box-shadow: 0 0 0 0 #28a74500;
          opacity: 1;
        }
      }

      /* === POPUP MODIFICATION CODE ENTREPRISE (ADMIN) === */
      #popupEditCompanyCode {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(30, 41, 59, 0.55);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }

      #popupEditCompanyCode .content {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 40px #05966944;
        padding: 38px 32px 28px 32px;
        max-width: 420px;
        width: 96vw;
        max-height: 92vh;
        overflow-y: auto;
        position: relative;
      }

      #popupEditCompanyCode h2 {
        font-size: 1.3em;
        font-weight: 700;
        color: #059669;
        margin-bottom: 18px;
      }

      #popupEditCompanyCode label {
        font-weight: 600;
        color: #374151;
      }

      #popupEditCompanyCode input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1.1em;
        margin-top: 6px;
        margin-bottom: 14px;
      }

      #popupEditCompanyCode button {
        width: 100%;
        background: #059669;
        color: #fff;
        font-weight: 700;
        padding: 10px 0;
        border-radius: 8px;
        font-size: 1.1em;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
      }

      #popupEditCompanyCode button:hover {
        background: #047857;
      }

      #popupEditCompanyCode .close {
        position: absolute;
        top: 18px;
        right: 18px;
        background: none;
        border: none;
        font-size: 1.5em;
        color: #059669;
        cursor: pointer;
      }

      #popupEditCompanyCode .message {
        font-size: 0.98em;
        margin-bottom: 10px;
        text-align: center;
      }

      /* --- Fin styles popup admin --- */

      /* === STYLES AMÉLIORÉS POUR LES CARTES ET BADGES === */

      /* Animation de pulsation simplifiée pour les cartes actives */
      @keyframes cardPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.01);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Animation de bouncing simplifiée pour les nouvelles valeurs */
      @keyframes badgeBounce {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.15);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Styles pour les cartes avec effet glassmorphism et animations subtiles */
      .etat-card {
        position: relative;
        backdrop-filter: blur(20px);
        background: rgba(255, 255, 255, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        overflow: visible;
        animation: cardFloat 4s ease-in-out infinite;
      }

      /* Animation d'arrière-plan subtile derrière chaque carte */
      .etat-card::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(
          45deg,
          rgba(59, 130, 246, 0.15),
          rgba(6, 182, 212, 0.12),
          rgba(139, 92, 246, 0.15),
          rgba(16, 185, 129, 0.12)
        );
        background-size: 200% 200%;
        border-radius: inherit;
        z-index: -1;
        animation: backgroundShift 6s ease-in-out infinite;
        opacity: 0.6;
      }

      /* Délais différents pour chaque carte */
      .etat-card:nth-child(1) {
        animation-delay: 0s;
      }

      .etat-card:nth-child(1)::before {
        animation-delay: 0.5s;
      }

      .etat-card:nth-child(2) {
        animation-delay: 1s;
      }

      .etat-card:nth-child(2)::before {
        animation-delay: 1.5s;
      }

      .etat-card:hover {
        transform: translateY(-8px) scale(1.03);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
          0 8px 30px rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.35);
        animation-play-state: paused;
      }

      /* Animation de flottement subtil permanent - MOUVEMENT VISIBLE */
      @keyframes cardFloat {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        25% {
          transform: translateY(-5px) rotate(0.8deg);
        }
        50% {
          transform: translateY(-2px) rotate(0deg);
        }
        75% {
          transform: translateY(-4px) rotate(-0.5deg);
        }
      }

      /* Animation d'arrière-plan subtile mais visible */
      @keyframes backgroundShift {
        0%,
        100% {
          background-position: 0% 50%;
          opacity: 0.4;
        }
        25% {
          background-position: 100% 50%;
          opacity: 0.7;
        }
        50% {
          background-position: 100% 100%;
          opacity: 0.5;
        }
        75% {
          background-position: 0% 100%;
          opacity: 0.6;
        }
      }

      .etat-card:nth-child(3) {
        animation-delay: -4s;
      }

      .etat-card:nth-child(4) {
        animation-delay: -1s;
      }

      .etat-card:hover {
        transform: translateY(-8px) scale(1.03);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
          0 8px 30px rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.35);
        animation-play-state: paused;
      }

      /* Animation de flottement subtil permanent */
      @keyframes cardFloatGentle {
        0%,
        100% {
          transform: translateY(0px) rotateZ(0deg);
        }
        25% {
          transform: translateY(-3px) rotateZ(0.5deg);
        }
        50% {
          transform: translateY(-1px) rotateZ(0deg);
        }
        75% {
          transform: translateY(-2px) rotateZ(-0.3deg);
        }
      }

      /* Animation d'arrière-plan subtile */
      @keyframes subtleGradientMove {
        0%,
        100% {
          background-position: 0% 50%;
          opacity: 0.2;
        }
        25% {
          background-position: 100% 50%;
          opacity: 0.4;
        }
        50% {
          background-position: 100% 100%;
          opacity: 0.3;
        }
        75% {
          background-position: 0% 100%;
          opacity: 0.35;
        }
      }

      /* Animation pour l'apparition progressive */
      .etat-card.appear {
        opacity: 1;
        transform: translateY(0px);
        transition: opacity 0.6s ease-out, transform 0.6s ease-out;
      }

      /* Amélioration des badges de compteurs */
      .card-counter {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif !important;
        font-weight: 800 !important;
        letter-spacing: -0.5px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        user-select: none;
        animation: badgeBounce 0.6s ease-out;
      }

      .card-counter:hover {
        animation: badgeRotate 0.8s ease-in-out;
      }

      /* Effet de brillance sur les badges */
      .card-counter::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(
          45deg,
          transparent 30%,
          rgba(255, 255, 255, 0.3) 50%,
          transparent 70%
        );
        border-radius: inherit;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: -1;
      }

      .card-counter:hover::before {
        opacity: 1;
        animation: shimmer 1.5s ease-in-out infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) rotate(45deg);
        }
      }

      /* Styles spécifiques selon le type de carte */
      #carteAttentePaiement .card-counter {
        background: linear-gradient(
          135deg,
          #f59e0b 0%,
          #d97706 100%
        ) !important;
        box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3),
          0 2px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      }

      #carteMiseLivraison .card-counter {
        background: linear-gradient(
          135deg,
          #3b82f6 0%,
          #2563eb 100%
        ) !important;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3),
          0 2px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      }

      #carteLivre .card-counter {
        background: linear-gradient(
          135deg,
          #10b981 0%,
          #059669 100%
        ) !important;
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3),
          0 2px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      }

      /* Animation de mise à jour des cartes - DÉSACTIVÉEs */
      .card-updating {
        /* animation: cardPulse 1s ease-in-out; */
      }

      /* Effet de glow pour les badges actifs */
      .card-counter.updating {
        animation: badgeBounce 0.6s ease-out,
          glow 2s ease-in-out infinite alternate;
      }

      @keyframes glow {
        from {
          filter: drop-shadow(0 0 5px currentColor);
        }
        to {
          filter: drop-shadow(0 0 15px currentColor);
        }
      }

      /* Responsive pour les badges */
      @media (max-width: 768px) {
        .card-counter {
          font-size: 0.8em !important;
          padding: 6px 10px !important;
          min-width: 24px !important;
          min-height: 24px !important;
        }
      }

      /* === FIN STYLES CARTES ET BADGES === */

      /* === ANIMATION DE PARTICULES VISIBLES EN ARRIÈRE-PLAN === */
      .etat-cards-row {
        position: relative;
        z-index: 1;
      }

      .etat-cards-row::before {
        content: "";
        position: absolute;
        top: -30px;
        left: -30px;
        right: -30px;
        bottom: -30px;
        background: radial-gradient(
            circle at 25% 25%,
            rgba(59, 130, 246, 0.12) 0%,
            transparent 60%
          ),
          radial-gradient(
            circle at 75% 75%,
            rgba(6, 182, 212, 0.1) 0%,
            transparent 60%
          ),
          radial-gradient(
            circle at 50% 50%,
            rgba(139, 92, 246, 0.11) 0%,
            transparent 60%
          );
        background-size: 200px 200px, 250px 250px, 180px 180px;
        background-position: 0% 0%, 100% 100%, 50% 50%;
        animation: particlesFloat 10s ease-in-out infinite;
        pointer-events: none;
        z-index: -1;
        opacity: 0.7;
        border-radius: 20px;
      }

      @keyframes particlesFloat {
        0%,
        100% {
          background-position: 0% 0%, 100% 100%, 50% 50%;
          opacity: 0.6;
          transform: scale(1);
        }
        25% {
          background-position: 100% 25%, 25% 75%, 75% 25%;
          opacity: 0.9;
          transform: scale(1.02);
        }
        50% {
          background-position: 75% 100%, 25% 25%, 100% 75%;
          opacity: 0.7;
          transform: scale(0.98);
        }
        75% {
          background-position: 25% 50%, 75% 50%, 25% 100%;
          opacity: 0.85;
          transform: scale(1.01);
        }
      }

      /* === ANIMATIONS DE LIAISON DES CARTES SYNCHRONISÉES === */

      /* Conteneur pour les lignes de connexion */
      .card-connections {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
        overflow: hidden;
      }

      /* Lignes de connexion animées avec transitions de couleurs fluides */
      .connection-line {
        position: absolute;
        height: 3px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          var(--connection-color-1) 20%,
          var(--connection-color-2) 40%,
          var(--connection-color-3) 60%,
          var(--connection-color-1) 80%,
          transparent 100%
        );
        --connection-color-1: #3b82f6;
        --connection-color-2: #06b6d4;
        --connection-color-3: #8b5cf6;
        opacity: 0.7;
        transform-origin: left center;
        animation: connectionPulse 4s ease-in-out infinite,
          connectionColorShift 6s ease-in-out infinite;
        filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5));
      }

      .connection-line::before {
        content: "";
        position: absolute;
        top: -2px;
        left: 0;
        width: 100%;
        height: 7px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(59, 130, 246, 0.3) 25%,
          rgba(6, 182, 212, 0.4) 50%,
          rgba(139, 92, 246, 0.3) 75%,
          transparent 100%
        );
        filter: blur(3px);
        animation: connectionGlow 3s ease-in-out infinite;
      }

      .connection-line::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        width: 12px;
        height: 12px;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.9) 0%,
          var(--connection-color-2) 50%,
          transparent 100%
        );
        border-radius: 50%;
        transform: translateY(-50%);
        animation: sparkleTravel 4s linear infinite;
      }

      @keyframes connectionPulse {
        0%,
        100% {
          opacity: 0.4;
          transform: scaleX(0.8) scaleY(1);
          filter: brightness(1) drop-shadow(0 0 8px rgba(59, 130, 246, 0.3));
        }
        50% {
          opacity: 0.9;
          transform: scaleX(1.2) scaleY(1.5);
          filter: brightness(1.8) drop-shadow(0 0 15px rgba(59, 130, 246, 0.8));
        }
      }

      @keyframes connectionColorShift {
        0%,
        100% {
          --connection-color-1: #3b82f6;
          --connection-color-2: #06b6d4;
          --connection-color-3: #3b82f6;
        }
      }

      @keyframes connectionGlow {
        0%,
        100% {
          opacity: 0.3;
          filter: blur(3px);
        }
        50% {
          opacity: 0.6;
          filter: blur(4px);
        }
      }

      @keyframes sparkleTravel {
        0% {
          left: -6px;
          opacity: 0;
          background: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.8) 0%,
            #3b82f6 50%,
            transparent 100%
          );
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          left: calc(100% + 6px);
          opacity: 0;
          background: radial-gradient(
            circle,
            rgba(255, 255, 255, 0.8) 0%,
            #3b82f6 50%,
            transparent 100%
          );
        }
      }

      @keyframes particleColorCycle {
        0%,
        100% {
          --particle-color-primary: #06b6d4;
          --particle-color-secondary: #3b82f6;
        }
      }

      @keyframes particleAura {
        0%,
        100% {
          opacity: 0.3;
          transform: scale(0.8);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.4);
        }
      }

      /* Animation des particules simplifiée */
      @keyframes particleTravel1 {
        0% {
          left: 20%;
          top: 50%;
          opacity: 0;
          transform: scale(0);
        }
        10% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          left: 50%;
          top: 45%;
          opacity: 1;
          transform: scale(1);
        }
        90% {
          opacity: 1;
          transform: scale(1);
        }
        100% {
          left: 80%;
          top: 50%;
          opacity: 0;
          transform: scale(0);
        }
      }

      @keyframes particleTravel2 {
        0% {
          left: 50%;
          top: 45%;
          opacity: 0;
          transform: scale(0);
        }
        10% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          left: 75%;
          top: 70%;
          opacity: 1;
          transform: scale(1);
        }
        90% {
          opacity: 1;
          transform: scale(1);
        }
        100% {
          left: 100%;
          top: 95%;
          opacity: 0;
          transform: scale(0);
        }
      }

      @keyframes particleTravel3 {
        0% {
          left: 80%;
          top: 50%;
          opacity: 0;
          transform: scale(0);
        }
        10% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          left: 50%;
          top: 75%;
          opacity: 1;
          transform: scale(1);
        }
        90% {
          opacity: 1;
          transform: scale(1);
        }
        100% {
          left: 20%;
          top: 50%;
          opacity: 0;
          transform: scale(0);
        }
      }

      /* Effet de synchronisation - DÉSACTIVÉ */
      .cards-synchronized {
        /* animation: syncPulse 2s ease-in-out; */
        /* filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.4)); */
      }

      @keyframes syncPulse {
        0% {
          transform: scale(1);
          filter: brightness(1);
        }
        50% {
          transform: scale(1.02);
          filter: brightness(1.1);
        }
        100% {
          transform: scale(1);
          filter: brightness(1);
        }
      }

      /* Onde d'énergie simplifiée */
      .energy-wave {
        position: absolute;
        width: 120px;
        height: 120px;
        border: 2px solid #06b6d4;
        border-radius: 50%;
        opacity: 0;
        pointer-events: none;
        z-index: 2;
        background: radial-gradient(
          circle,
          transparent 50%,
          rgba(6, 182, 212, 0.1) 70%,
          transparent 100%
        );
        box-shadow: 0 0 20px #06b6d4;
      }

      .energy-wave::before {
        content: "";
        position: absolute;
        top: -5px;
        left: -5px;
        width: calc(100% + 10px);
        height: calc(100% + 10px);
        border: 1px solid #06b6d4;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          transparent 60%,
          rgba(6, 182, 212, 0.05) 80%,
          transparent 100%
        );
      }

      /* Energy wave animation - DÉSACTIVÉE 
      @keyframes energyWave {
        0% {
          transform: scale(0.1);
          opacity: 0.8;
          border-width: 3px;
        }
        50% {
          transform: scale(2);
          opacity: 0.4;
          border-width: 2px;
        }
        100% {
          transform: scale(4);
          opacity: 0;
          border-width: 1px;
        }
      }
      */

      /* === FOND WELCOME SECTION SIMPLIFIÉ === */

      #welcomeSection {
        background: linear-gradient(
          135deg,
          #f8fafc 0%,
          #e2e8f0 50%,
          #f1f5f9 100%
        ) !important;
        position: relative;
        overflow: hidden;
      }

      /* Motifs géométriques simplifiés */
      #welcomeSection::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: radial-gradient(
            circle at 20% 20%,
            rgba(59, 130, 246, 0.08) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(6, 182, 212, 0.06) 0%,
            transparent 50%
          );
        opacity: 0.7;
        pointer-events: none;
        z-index: 1;
      }

      /* Effet glassmorphism simplifié sur les cartes */
      .etat-card {
        backdrop-filter: blur(10px);
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.8) 0%,
          rgba(255, 255, 255, 0.7) 100%
        ) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08),
          0 2px 12px rgba(0, 0, 0, 0.06) !important;
        position: relative;
        z-index: 2;
        transition: all 0.3s ease;
      }

      .dossier-attente.etat-card {
        --card-glow-color: rgba(245, 158, 11, 0.12);
      }

      .dossier-mise-livraison.etat-card {
        --card-glow-color: rgba(14, 165, 233, 0.12);
      }

      .dossier-livre.etat-card {
        --card-glow-color: rgba(16, 185, 129, 0.12);
      }

      .dossier-retard.etat-card {
        border-left: 4px solid #dc3545;
      }

      /* Amélioration hover simplifiée */
      .etat-card:hover {
        backdrop-filter: blur(14px);
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.9) 0%,
          rgba(255, 255, 255, 0.85) 100%
        ) !important;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12),
          0 6px 16px rgba(0, 0, 0, 0.08) !important;
        transform: translateY(-8px) scale(1.02);
      }

      /* === FIN ANIMATIONS DE LIAISON === */
    </style>
  </head>

  <body class="sidebar-expanded">
    <div class="layout">
      <aside class="sidebar">
        <h2 id="sidebarTitle" style="position: relative">
          <span class="link-text">Menu</span>
          <span class="connection-status" id="connectionStatusIcon">
            <i class="fas fa-wifi"></i>
          </span>
        </h2>
        <ul>
          <li>
            <a href="tableauDeBord.html" id="lienAccueil">
              <span class="icon"><i class="fas fa-home"></i></span>
              <span class="link-text">Accueil</span>
            </a>
          </li>

          <li>
            <a href="#" id="lienSuivi">
              <span class="icon"><i class="fas fa-chart-bar"></i></span>
              <span class="link-text">Suivi des Livraisons de Conteneurs</span>
            </a>
          </li>
        </ul>
        <div class="calendar-container">
          <label for="date-selection">Sélectionner une date :</label>
          <input type="date" id="date-selection" />
        </div>
        <!-- Avatar utilisateur moderne sous la date -->
        <div
          id="sidebarUserProfile"
          style="
            margin-top: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
          "
        >
          <div
            id="userAvatarCircle"
            style="
              width: 56px;
              height: 56px;
              border-radius: 50%;
              background: linear-gradient(135deg, #2563eb 60%, #06b6d4 100%);
              color: #fff;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 2em;
              font-weight: 700;
              box-shadow: 0 2px 8px #2563eb22;
              cursor: pointer;
              transition: filter 0.18s;
              position: relative;
            "
          >
            <i class="fas fa-user"></i>
          </div>
          <div
            id="userNameSidebar"
            style="
              font-size: 1.08em;
              font-weight: 700;
              color: #2563eb;
              text-align: center;
              max-width: 140px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            "
          ></div>
          <div
            id="userProfilSidebar"
            style="
              font-size: 0.98em;
              color: #374151;
              text-align: center;
              max-width: 140px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            "
          ></div>
          <button
            id="logoutSidebarBtn"
            style="
              margin-top: 6px;
              background: linear-gradient(90deg, #2563eb 0%, #06b6d4 100%);
              color: #fff;
              border: none;
              border-radius: 8px;
              padding: 7px 18px;
              font-size: 0.98em;
              font-weight: 600;
              box-shadow: 0 2px 8px #2563eb22;
              cursor: pointer;
              transition: filter 0.18s;
            "
          >
            Se déconnecter
          </button>
          <!-- Icônes responsables sous l'avatar -->
          <div
            style="
              display: flex;
              flex-direction: row;
              align-items: center;
              gap: 18px;
              margin-top: 8px;
            "
          >
            <span
              id="iconRespAcconier"
              title="Responsable Acconier"
              style="
                display: flex;
                align-items: center;
                justify-content: center;
                background: #fff7e3;
                border-radius: 50%;
                width: 38px;
                height: 38px;
                box-shadow: 0 2px 8px #f59e0b22;
                cursor: pointer;
              "
            >
              <i
                class="fas fa-user-shield"
                style="font-size: 1.45em; color: #f59e0b"
              ></i>
            </span>
            <span
              id="iconRespLivraison"
              title="Responsable Livraison"
              style="
                display: flex;
                align-items: center;
                justify-content: center;
                background: #e3ffe3;
                border-radius: 50%;
                width: 38px;
                height: 38px;
                box-shadow: 0 2px 8px #05966922;
                cursor: pointer;
              "
            >
              <i
                class="fas fa-user-check"
                style="font-size: 1.45em; color: #059669"
              ></i>
            </span>
          </div>
        </div>
        <!-- Popup modification code entreprise -->
        <div
          id="popupEditCompanyCode"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            class="content"
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #05966944;
              padding: 38px 32px 28px 32px;
              max-width: 420px;
              width: 96vw;
              max-height: 92vh;
              overflow-y: auto;
              position: relative;
            "
          >
            <button
              class="close"
              id="closeEditCompanyCode"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #059669;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <h2
              style="
                font-size: 1.3em;
                font-weight: 700;
                color: #059669;
                margin-bottom: 18px;
              "
            >
              Modifier le code de l'entreprise
            </h2>
            <form id="formEditCompanyCode">
              <label
                for="newCompanyCode"
                style="font-weight: 600; color: #374151"
                >Nouveau code :</label
              >
              <input
                type="text"
                id="newCompanyCode"
                name="newCompanyCode"
                required
                style="
                  width: 100%;
                  padding: 8px 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 8px;
                  font-size: 1.1em;
                  margin-top: 6px;
                  margin-bottom: 14px;
                "
              />
              <button
                type="submit"
                style="
                  width: 100%;
                  background: #059669;
                  color: #fff;
                  font-weight: 700;
                  padding: 10px 0;
                  border-radius: 8px;
                  font-size: 1.1em;
                  border: none;
                  cursor: pointer;
                  transition: background 0.2s;
                "
              >
                Enregistrer
              </button>
              <div
                id="editCompanyCodeMsg"
                class="message"
                style="font-size: 0.98em; margin-top: 10px; text-align: center"
              ></div>
            </form>
          </div>
        </div>
      </aside>

      <main class="main-content">
        <!-- Popup demande code entreprise -->
        <div
          id="popupDemandeCodeEntreprise"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #2563eb44;
              padding: 32px 28px 24px 28px;
              max-width: 900px;
              width: 98vw;
              max-height: 96vh;
              overflow-y: auto;
              position: relative;
              border: 3px solid #2563eb;
              font-size: 1.08em;
            "
          >
            <button
              id="closeDemandeCodeEntreprise"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #2563eb;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <h2
              style="
                font-size: 1.15em;
                font-weight: 700;
                color: #2563eb;
                margin-bottom: 18px;
                text-align: center;
              "
            >
              Demandes de code entreprise
            </h2>
            <div
              id="tableDemandesCodeEntreprise"
              style="
                margin-bottom: 18px;
                border: 1px dashed #2563eb;
                min-height: 40px;
                padding: 8px;
                background: #f7faff;
                text-align: center;
              "
            >
              <!-- Les demandes seront affichées ici par JS -->
            </div>
            <div
              id="demandeCodeEntrepriseMsg"
              style="
                margin-top: 10px;
                font-size: 0.98em;
                text-align: center;
                color: #dc3545;
              "
            >
              <!-- Les messages d'erreur ou d'information JS s'affichent ici -->
            </div>
          </div>
        </div>
        <!-- Section Statistiques (masquée par défaut) -->
        <section
          id="statistiquesSection"
          class="dynamic-content-area"
          style="display: none; min-height: 70vh"
        >
          <div style="width: 100%; max-width: 1200px; margin: 0 auto">
            <h1
              style="
                font-size: 2.3em;
                font-weight: 800;
                color: #2563eb;
                text-align: center;
                margin-bottom: 32px;
                letter-spacing: 1px;
              "
            >
              Statistiques par Acteur
            </h1>
            <div
              style="
                display: flex;
                gap: 32px;
                flex-wrap: wrap;
                justify-content: center;
                align-items: stretch;
              "
            >
              <div
                class="stat-bloc"
                style="
                  flex: 1 1 320px;
                  min-width: 280px;
                  background: linear-gradient(
                    135deg,
                    #e3f0ff 60%,
                    #f7faff 100%
                  );
                  border-radius: 18px;
                  box-shadow: 0 4px 18px #2563eb18, 0 2px 8px #0001;
                  padding: 32px 24px 24px 24px;
                  margin-bottom: 18px;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                "
              >
                <div
                  style="
                    font-size: 1.4em;
                    font-weight: 700;
                    color: #2563eb;
                    margin-bottom: 10px;
                  "
                >
                  <i class="fas fa-user-tie"></i> Agent Acconier
                </div>
                <div
                  id="statAgentAcconier"
                  style="
                    font-size: 2.2em;
                    font-weight: 900;
                    color: #1d3557;
                    margin-bottom: 8px;
                  "
                >
                  -
                </div>
                <div style="font-size: 1.05em; color: #374151">
                  Livraisons traitées
                </div>
                <div
                  id="stats-agentAcconier"
                  style="width: 100%; margin-top: 12px"
                ></div>
              </div>
              <div
                class="stat-bloc"
                style="
                  flex: 1 1 320px;
                  min-width: 280px;
                  background: linear-gradient(
                    135deg,
                    #fff7e3 60%,
                    #fffbe9 100%
                  );
                  border-radius: 18px;
                  box-shadow: 0 4px 18px #f59e0b18, 0 2px 8px #0001;
                  padding: 32px 24px 24px 24px;
                  margin-bottom: 18px;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                "
              >
                <div
                  style="
                    font-size: 1.4em;
                    font-weight: 700;
                    color: #f59e0b;
                    margin-bottom: 10px;
                  "
                >
                  <i class="fas fa-user-shield"></i> Responsable Acconier
                </div>
                <div
                  id="statRespAcconier"
                  style="
                    font-size: 2.2em;
                    font-weight: 900;
                    color: #b26a00;
                    margin-bottom: 8px;
                  "
                >
                  -
                </div>
                <div style="font-size: 1.05em; color: #7c5e2a">
                  Validations réalisées
                </div>
                <div
                  id="stats-responsableAcconier"
                  style="width: 100%; margin-top: 12px"
                ></div>
              </div>
              <div
                class="stat-bloc"
                style="
                  flex: 1 1 320px;
                  min-width: 280px;
                  background: linear-gradient(
                    135deg,
                    #e3ffe3 60%,
                    #f7fff7 100%
                  );
                  border-radius: 18px;
                  box-shadow: 0 4px 18px #05966918, 0 2px 8px #0001;
                  padding: 32px 24px 24px 24px;
                  margin-bottom: 18px;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                "
              >
                <div
                  style="
                    font-size: 1.4em;
                    font-weight: 700;
                    color: #059669;
                    margin-bottom: 10px;
                  "
                >
                  <i class="fas fa-user-check"></i> Responsable Livraison
                </div>
                <div
                  id="statRespLivraison"
                  style="
                    font-size: 2.2em;
                    font-weight: 900;
                    color: #059669;
                    margin-bottom: 8px;
                  "
                >
                  -
                </div>
                <div style="font-size: 1.05em; color: #27734d">
                  Livraisons validées
                </div>
                <div
                  id="stats-responsableLivraison"
                  style="width: 100%; margin-top: 12px"
                ></div>
              </div>
            </div>
            <div id="statistiquesDetails" style="margin-top: 32px"></div>
          </div>
        </section>
        <!-- Section demandes code entreprise oublié (admin) -->
        <!-- Section demandes de code d'entreprise oublié supprimée (remplacée par le bouton sidebar) -->

        <div
          id="welcomeSection"
          class="welcome-container"
          style="
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            background: none;
            box-shadow: none;
            min-height: 320px;
            gap: 0;
            margin-top: 0;
            padding-top: 18px;
            position: relative;
            height: 100%;
          "
        >
          <!-- Message de bienvenue animé -->
          <div id="welcomeTypewriter" class="welcome-typewriter"></div>
          <div style="height: 38px"></div>
          <div class="etat-cards-row">
            <div
              class="etat-card dossier-attente animated-card"
              id="carteAttentePaiement"
              style="cursor: pointer"
              title="💡 Synchronisation: Dossiers visibles dans resp_acconier.html. Décrément automatique quand un dossier passe en 'mise en livraison'."
            >
              <div class="etat-icon"><i class="fas fa-hourglass-half"></i></div>
              <div class="etat-title">Dossier soumis</div>
              <div class="etat-desc">
                Dossiers en attente de règlement avant traitement.
              </div>
            </div>

            <div
              class="etat-card dossier-mise-livraison animated-card"
              id="carteMiseLivraison"
              style="cursor: pointer"
              title="💡 Synchronisation: Dossiers visibles dans resp_liv.html. Incrément quand un dossier quitte resp_acconier, décrément quand tous conteneurs sont livrés."
            >
              <div class="etat-icon"><i class="fas fa-truck-loading"></i></div>
              <div class="etat-title">Dossiers mis en livraison</div>
              <div class="etat-desc">
                Dossiers prêts pour la livraison et en cours de traitement.
              </div>
            </div>
            <!-- La pop-up dossiers en attentes de paiement a été supprimée -->

            <!-- Popup détails dossier -->
            <div
              id="popupDetailDossier"
              style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(30, 41, 59, 0.55);
                z-index: 10001;
                align-items: center;
                justify-content: center;
              "
            >
              <div
                style="
                  background: #fff;
                  border-radius: 18px;
                  box-shadow: 0 8px 40px #2563eb44;
                  padding: 32px 28px 24px 28px;
                  max-width: 600px;
                  width: 95vw;
                  max-height: 88vh;
                  overflow-y: auto;
                  position: relative;
                "
              >
                <button
                  id="closePopupDetailDossier"
                  style="
                    position: absolute;
                    top: 18px;
                    right: 18px;
                    background: none;
                    border: none;
                    font-size: 1.5em;
                    color: #2563eb;
                    cursor: pointer;
                  "
                >
                  &times;
                </button>
                <h2
                  style="
                    font-size: 1.12em;
                    font-weight: 700;
                    color: #2563eb;
                    margin-bottom: 18px;
                    text-align: center;
                  "
                >
                  Détails du dossier
                </h2>
                <div id="contenuDetailDossier"></div>
              </div>
            </div>
            <style>
              /* Liste stylisée des dossiers en attente de paiement */
              #listeAttentePaiement {
                display: flex;
                flex-direction: column;
                gap: 14px;
                margin-bottom: 8px;
              }
              .dossier-item-liste {
                background: linear-gradient(90deg, #fff7e3 80%, #f8fafc 100%);
                border: 1.5px solid #f59e0b;
                border-radius: 12px;
                padding: 14px 18px;
                cursor: pointer;
                transition: box-shadow 0.15s, transform 0.15s;
                box-shadow: 0 2px 8px #f59e0b11;
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
              }
              .dossier-item-liste:hover {
                box-shadow: 0 6px 18px #f59e0b33;
                transform: translateY(-2px) scale(1.01);
              }
              .dossier-item-info {
                display: flex;
                flex-direction: column;
                gap: 2px;
              }
              .dossier-item-date {
                font-size: 0.98em;
                color: #b26a00;
                font-weight: 600;
              }
              .dossier-item-nom {
                font-size: 1.08em;
                color: #1d3557;
                font-weight: 700;
              }
            </style>
            <!-- Carte 'En cours de mise en livraison' supprimée -->
          </div>
          <div class="etat-cards-row">
            <div
              class="etat-card dossier-livre animated-card"
              id="carteLivre"
              title="💡 Synchronisation: Incrément automatique quand tous les conteneurs d'un dossier sont marqués 'livré' dans resp_liv.html."
            >
              <div class="etat-icon"><i class="fas fa-check-circle"></i></div>
              <div class="etat-title">Dossier livré</div>
              <div class="etat-desc">
                Dossiers livrés avec succès au client.
              </div>
            </div>
            <div class="etat-card dossier-retard animated-card">
              <div class="etat-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="etat-title">Dossier en retard</div>
              <div class="etat-desc">
                Dossiers dont la livraison a dépassé le délai prévu.
              </div>
            </div>
            <!-- Popup dossiers en retard -->
            <div
              id="popupDossiersRetard"
              style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(220, 53, 69, 0.25);
                z-index: 10001;
                align-items: center;
                justify-content: center;
              "
            >
              <div
                style="
                  background: #fff;
                  border-radius: 18px;
                  box-shadow: 0 12px 40px rgba(220, 53, 69, 0.3);
                  padding: 32px 28px 24px 28px;
                  max-width: 680px;
                  width: 95vw;
                  max-height: 85vh;
                  overflow-y: auto;
                  position: relative;
                  border: 2.5px solid #dc3545;
                "
              >
                <button
                  id="closePopupDossiersRetard"
                  style="
                    position: absolute;
                    top: 18px;
                    right: 18px;
                    background: none;
                    border: none;
                    font-size: 1.5em;
                    color: #dc3545;
                    cursor: pointer;
                  "
                >
                  &times;
                </button>
                <h2
                  style="
                    font-size: 1.4em;
                    font-weight: 700;
                    color: #dc3545;
                    margin-bottom: 22px;
                    text-align: center;
                    border-bottom: 2px solid #dc3545;
                    padding-bottom: 12px;
                  "
                >
                  <i
                    class="fas fa-exclamation-triangle"
                    style="margin-right: 8px"
                  ></i>
                  Dossiers en retard
                </h2>
                <div id="contenuDossiersRetard"></div>
              </div>
            </div>
          </div>
        </div>
        <style>
          /* Cartes états des dossiers (3D, moderne, esthétique) */
          .etat-cards-row {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 38px;
            margin-bottom: 22px;
            /* Animation subtile des conteneurs de cartes */
            animation: softPulse 10s ease-in-out infinite;
          }

          /* Délai différent pour chaque ligne de cartes */
          .etat-cards-row:first-of-type {
            margin-top: 18px;
            animation-delay: 0s;
          }

          .etat-cards-row:last-of-type {
            animation-delay: 5s;
          }
          .etat-card {
            border-radius: 18px;
            box-shadow: 0 8px 24px #2563eb18, 0 2px 0 #fff8;
            padding: 28px 16px 22px 16px;
            min-width: 240px;
            max-width: 300px;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin: 0 10px;
            transition: transform 0.18s, box-shadow 0.18s;
            position: relative;
            cursor: default;
            opacity: 0;
            animation: cardFadeInUp 0.7s cubic-bezier(0.23, 1.01, 0.32, 1)
              forwards;
          }
          .dossier-attente.etat-card {
            background: linear-gradient(135deg, #fff7e3 80%, #f8fafc 100%);
            border: 2.5px solid #f59e0b;
          }
          .dossier-mise-livraison.etat-card {
            background: linear-gradient(135deg, #e3f2ff 80%, #f8fafc 100%);
            border: 2.5px solid #0ea5e9;
          }
          .dossier-cours.etat-card {
            background: linear-gradient(135deg, #e3f0ff 80%, #f8fafc 100%);
            border: 2.5px solid #2563eb;
          }
          .dossier-livre.etat-card {
            background: linear-gradient(135deg, #e3ffe3 80%, #f8fafc 100%);
            border: 2.5px solid #059669;
          }
          .dossier-retard.etat-card {
            background: linear-gradient(135deg, #ffe3e3 80%, #f8fafc 100%);
            border: 2.5px solid #dc3545;
          }
          .etat-cards-row .etat-card:nth-child(1) {
            animation-delay: 0.05s;
          }
          .etat-cards-row .etat-card:nth-child(2) {
            animation-delay: 0.18s;
          }
          .etat-cards-row + .etat-cards-row .etat-card:nth-child(1) {
            animation-delay: 0.32s;
          }
          .etat-cards-row + .etat-cards-row .etat-card:nth-child(2) {
            animation-delay: 0.45s;
          }
          @keyframes cardFadeInUp {
            0% {
              opacity: 0;
              transform: translateY(40px) scale(0.98);
            }
            60% {
              opacity: 1;
              transform: translateY(-8px) scale(1.03);
            }
            100% {
              opacity: 1;
              transform: translateY(0) scale(1);
            }
          }
          .etat-card:hover {
            transform: translateY(-8px) scale(1.035) rotate(-1deg);
            box-shadow: 0 16px 48px #2563eb33, 0 4px 16px #0002;
            z-index: 2;
          }
          .etat-icon {
            font-size: 2.7em;
            margin-bottom: 12px;
            color: #2563eb;
            filter: drop-shadow(0 2px 8px #2563eb22);
            background: #fff;
            border-radius: 50%;
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #2563eb18, 0 1px 2px #0001;
            margin-top: -28px;
            margin-bottom: 12px;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translate(-50%, -50%);
          }
          .etat-title {
            font-size: 1.45em;
            font-weight: 700;
            color: #1d3557;
            margin-bottom: 10px;
            text-align: center;
            letter-spacing: 0.2px;
          }
          .etat-desc {
            font-size: 1.18em;
            color: #374151;
            text-align: center;
            margin-bottom: 0;
            margin-top: 0;
            line-height: 1.5;
          }
          .dossier-attente .etat-icon {
            color: #f59e0b;
            background: #fff7e3;
            box-shadow: 0 2px 12px #f59e0b22, 0 1px 2px #0001;
          }
          .dossier-mise-livraison .etat-icon {
            color: #0ea5e9;
            background: #e3f2ff;
            box-shadow: 0 2px 12px #0ea5e922, 0 1px 2px #0001;
          }
          .dossier-cours .etat-icon {
            color: #2563eb;
            background: #e3f0ff;
            box-shadow: 0 2px 12px #2563eb22, 0 1px 2px #0001;
          }
          .dossier-livre .etat-icon {
            color: #059669;
            background: #e3ffe3;
            box-shadow: 0 2px 12px #05966922, 0 1px 2px #0001;
          }
          .dossier-retard .etat-icon {
            color: #dc3545;
            background: #ffe3e3;
            box-shadow: 0 2px 12px #dc354522, 0 1px 2px #0001;
          }
          .etat-card:not(:hover) {
            will-change: auto;
          }
          @media (max-width: 1100px) {
            .etat-cards-row {
              gap: 16px;
            }
            .etat-card {
              min-width: 140px;
              max-width: 98vw;
              padding: 18px 6px 14px 6px;
            }
            .etat-icon {
              font-size: 1.5em;
              width: 38px;
              height: 38px;
              margin-top: -18px;
            }
          }
          @media (max-width: 700px) {
            #welcomeSection {
              flex-direction: column;
              align-items: stretch;
              gap: 0;
              margin-top: 0;
              padding-top: 8px;
            }
            .etat-cards-row {
              flex-direction: column;
              gap: 16px;
              margin-bottom: 0;
            }
            .etat-cards-row:first-of-type {
              margin-top: 10px;
            }
            .etat-card {
              min-width: 92vw;
              max-width: 99vw;
              padding: 14px 4px 10px 4px;
            }
            .etat-icon {
              font-size: 1.4em;
              width: 34px;
              height: 34px;
              margin-top: -12px;
            }
          }

          /* Message de bienvenue animé (typewriter) */
          .welcome-typewriter {
            font-size: 2.1em;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 28px;
            min-height: 48px;
            letter-spacing: 0.5px;
            text-align: center;
            width: 100%;
            max-width: 600px;
            white-space: nowrap;
            overflow: hidden;
            border-right: 2.5px solid #2563eb;
            box-sizing: border-box;
            background: none;
            animation: fadeIn 1.2s;
          }
          @media (max-width: 700px) {
            .welcome-typewriter {
              font-size: 1.25em;
              min-height: 32px;
              margin-bottom: 18px;
            }
          }
          @keyframes blinkCursor {
            0% {
              border-right-color: #2563eb;
            }
            49% {
              border-right-color: #2563eb;
            }
            50% {
              border-right-color: transparent;
            }
            100% {
              border-right-color: transparent;
            }
          }
          .welcome-typewriter.typing {
            animation: blinkCursor 0.9s steps(1) infinite;
          }
        </style>

        <div id="bottomButtons" class="bottom-buttons">
          <button onclick="afficherSuivi()">
            <span
              style="
                display: flex;
                align-items: center;
                gap: 4px;
                width: 100%;
                justify-content: center;
              "
            >
              <i class="fas fa-truck-loading"></i>
              <span style="flex: 1; text-align: center">Suivi</span>
            </span>
          </button>
          <!-- Boutons Jours précédents et Mois passé supprimés -->
        </div>

        <!-- Popup résumé du mois passé (structure cachée au départ, insérée dans le DOM) -->
        <div
          id="popupResumeMoisPasse"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #2563eb44;
              padding: 38px 32px 28px 32px;
              max-width: 900px;
              width: 96vw;
              max-height: 92vh;
              overflow-y: auto;
              position: relative;
            "
          >
            <button
              id="closeResumeMoisPasse"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #2563eb;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <div
              id="moisPasseSelector"
              style="
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
                margin-bottom: 18px;
              "
            ></div>
            <div id="resumeMoisPasseContent"></div>
          </div>
        </div>

        <script>
          // Message de bienvenue animé (typewriter)
          document.addEventListener("DOMContentLoaded", function () {
            // === MARQUER LA SESSION ADMIN POUR LES REDIRECTIONS ===
            // Marquer cette session comme étant une session administrateur
            // pour que les pages responsables sachent qu'elles sont accédées en mode visualisation
            const adminUser = localStorage.getItem("user");
            if (adminUser) {
              try {
                const user = JSON.parse(adminUser);
                if (user && user.role === "admin") {
                  // Marquer la session admin pour les redirections
                  localStorage.setItem("adminViewMode", "true");
                  localStorage.setItem(
                    "adminViewTimestamp",
                    Date.now().toString()
                  );
                }
              } catch (e) {
                console.log(
                  "Erreur lors de la vérification de la session admin:",
                  e
                );
              }
            }

            // --- WebSocket notification temps réel dossier mis en livraison ---
            try {
              const wsUrl =
                (window.location.protocol === "https:" ? "wss://" : "ws://") +
                window.location.hostname +
                ":3000";
              const ws = new ReconnectingWebSocket(wsUrl);
              ws.onmessage = function (event) {
                let data;
                try {
                  data = JSON.parse(event.data);
                } catch (e) {
                  return;
                }
                if (
                  data &&
                  data.type === "dossier-mise-en-livraison" &&
                  data.dossierNumber
                ) {
                  // Affiche l'alerte
                  if (typeof showCustomAlert === "function") {
                    showCustomAlert(
                      `Le dossier [${data.dossierNumber}] a été mis en livraison.`,
                      "success",
                      5000
                    );
                  } else {
                    alert(
                      `Le dossier [${data.dossierNumber}] a été mis en livraison.`
                    );
                  }
                  // Met à jour le statut dans le tableau si affiché
                  const row = document.querySelector(
                    `[data-delivery-id='${data.deliveryId}']`
                  );
                  if (row) {
                    const statusCell = Array.from(row.cells).find(
                      (cell) =>
                        cell.dataset.fieldName === "delivery_status_acconier"
                    );
                    if (statusCell) {
                      statusCell.innerHTML = `<span class='text-blue-600'><i class='fas fa-truck mr-1' style='color:#2563eb;'></i> Mise en livraison</span>`;
                    }
                  }
                }
              };
            } catch (e) {
              /* ignore erreur ws */
            }
            // Affiche le nom de l'utilisateur connecté (stocké dans localStorage.user)
            var nom = null;
            try {
              var user = JSON.parse(localStorage.getItem("user"));
              if (user && user.nom) {
                nom = user.nom;
              }
            } catch (e) {}
            if (!nom || nom.length < 2) nom = "Utilisateur";
            var message = `Bonjour ${nom}, Bienvenue`;
            var el = document.getElementById("welcomeTypewriter");
            if (el) {
              el.textContent = "";
              let i = 0;
              function typeWriter() {
                if (i <= message.length) {
                  el.textContent = message.slice(0, i);
                  el.classList.add("typing");
                  i++;
                  setTimeout(typeWriter, 55 + Math.random() * 60);
                } else {
                  el.textContent = message;
                  el.classList.remove("typing");
                  el.style.borderRight = "none";
                }
              }
              typeWriter();
            }
            // Ajout du filtre : redirection sur la carte "En attente de paiement"
            var carteAttentePaiement = document.getElementById(
              "carteAttentePaiement"
            );
            if (carteAttentePaiement) {
              carteAttentePaiement.addEventListener("click", function () {
                window.location.href =
                  "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_acconier.html";
              });
            }

            // Ajout de la logique pour la carte "Dossiers mis en livraison"
            var carteMiseLivraison =
              document.getElementById("carteMiseLivraison");
            if (carteMiseLivraison) {
              carteMiseLivraison.addEventListener("click", function () {
                window.location.href =
                  "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_liv.html";
              });
            }
            // --- Ajout gestion carte dossier en retard ---
            // Fonction de filtrage métier des dossiers en retard (copiée de scriptRespAcconier.js)
            function getLateDeliveries(allDeliveries) {
              const now = new Date();
              return (allDeliveries || []).filter((d) => {
                let dDate = d.delivery_date || d.created_at;
                if (!dDate) return false;
                let dateObj = new Date(dDate);
                if (isNaN(dateObj.getTime())) return false;
                const diffDays = Math.floor(
                  (now - dateObj) / (1000 * 60 * 60 * 24)
                );
                if (diffDays <= 2) return false;
                if (d.delivery_status_acconier === "en attente de paiement") {
                  return true;
                }
                let blList = [];
                if (Array.isArray(d.bl_number)) {
                  blList = d.bl_number.filter(Boolean);
                } else if (typeof d.bl_number === "string") {
                  blList = d.bl_number.split(/[,;\s]+/).filter(Boolean);
                }
                let blStatuses = blList.map((bl) =>
                  d.bl_statuses && d.bl_statuses[bl]
                    ? d.bl_statuses[bl]
                    : "aucun"
                );
                if (
                  blStatuses.length > 0 &&
                  blStatuses.every((s) => s === "mise_en_livraison")
                ) {
                  return false;
                }
                if (
                  d.delivery_status_acconier === "mise_en_livraison_acconier"
                ) {
                  return false;
                }
                return true;
              });
            }

            var carteRetard = document.querySelector(
              ".dossier-retard.etat-card"
            );
            var popupRetard = document.getElementById("popupDossiersRetard");
            var closeRetard = document.getElementById(
              "closePopupDossiersRetard"
            );
            var contenuRetard = document.getElementById(
              "contenuDossiersRetard"
            );
            if (carteRetard && popupRetard && contenuRetard) {
              carteRetard.addEventListener("click", function () {
                // Appel API pour récupérer la liste à jour
                fetch("/api/dossiers/retard")
                  .then((res) => res.json())
                  .then((dossiers) => {
                    if (!dossiers || dossiers.length === 0) {
                      contenuRetard.innerHTML = `
                        <div style='text-align:center;padding:40px 20px;color:#6b7280;'>
                          <i class="fas fa-check-circle" style="font-size:3em;color:#22c55e;margin-bottom:15px;"></i>
                          <p style="font-size:1.2em;margin:0;">Aucun dossier en retard</p>
                          <p style="font-size:1em;margin:8px 0 0 0;">Tous les dossiers sont à jour !</p>
                        </div>
                      `;
                    } else {
                      let html = `
                        <div style="margin-bottom:12px;">
                          <p style="color:#374151;font-size:1.05em;margin:0;text-align:center;">
                            <strong>${dossiers.length}</strong> dossier${
                        dossiers.length > 1 ? "s" : ""
                      } en retard
                          </p>
                        </div>
                        <div style="max-height:400px;overflow-y:auto;">
                          <ul style='list-style:none;padding:0;margin:0;'>
                      `;

                      dossiers.forEach((dossier, index) => {
                        const dossierId =
                          dossier.id ||
                          dossier.numero_bl ||
                          dossier.numero ||
                          dossier._id ||
                          "";
                        const clientName =
                          dossier.client_name ||
                          dossier.nom ||
                          "Client non défini";
                        const employeeName =
                          dossier.employee_name || "Agent non défini";
                        const dossierNumber =
                          dossier.dossier_number || dossierId;

                        html += `
                          <li style='
                            background: linear-gradient(135deg, #fef2f2 80%, #fecaca 100%);
                            border: 2px solid #fecaca;
                            border-radius: 12px;
                            margin-bottom: 12px;
                            padding: 18px 20px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            border-left: 4px solid #dc3545;
                            position: relative;
                          ' 
                          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(220,53,69,0.25)';"
                          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                          onclick="window.location.href='https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_acconier.html?dossier=${encodeURIComponent(
                            dossierId
                          )}'">
                            
                            <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                              <span style="
                                background:#dc3545;
                                color:#fff;
                                font-weight:700;
                                font-size:0.9em;
                                padding:4px 8px;
                                border-radius:6px;
                                min-width:30px;
                                text-align:center;
                              ">${index + 1}</span>
                              
                              <div style="flex:1;">
                                <div style="font-size:1.15em; font-weight:700; color:#dc3545; margin-bottom:2px;">
                                  <i class="fas fa-folder-open" style="margin-right:6px;"></i>
                                  ${clientName}
                                </div>
                                <div style="font-size:0.95em; color:#6b7280;">
                                  Dossier: <strong style="color:#374151;">${dossierNumber}</strong>
                                </div>
                              </div>
                              
                              <div style="text-align:right;">
                                <div style="font-size:0.9em; color:#6b7280; margin-bottom:2px;">Agent</div>
                                <div style="font-size:1em; font-weight:600; color:#374151;">${employeeName}</div>
                              </div>
                            </div>
                            
                            <div style="
                              font-size:0.85em;
                              color:#dc3545;
                              background:#fff;
                              padding:6px 10px;
                              border-radius:6px;
                              text-align:center;
                              font-weight:600;
                            ">
                              <i class="fas fa-clock" style="margin-right:4px;"></i>
                              Cliquez pour voir les détails
                            </div>
                          </li>
                        `;
                      });

                      html += "</ul></div>";
                      contenuRetard.innerHTML = html;
                    }
                    popupRetard.style.display = "flex";
                  })
                  .catch((error) => {
                    console.error(
                      "Erreur lors du chargement des dossiers en retard:",
                      error
                    );
                    contenuRetard.innerHTML = `
                      <div style='text-align:center;padding:40px 20px;color:#dc3545;'>
                        <i class="fas fa-exclamation-circle" style="font-size:3em;margin-bottom:15px;"></i>
                        <p style="font-size:1.2em;margin:0;">Erreur de chargement</p>
                        <p style="font-size:1em;margin:8px 0 0 0;color:#6b7280;">Impossible de récupérer les dossiers en retard</p>
                      </div>
                    `;
                    popupRetard.style.display = "flex";
                  });
              });
              if (closeRetard) {
                closeRetard.onclick = function () {
                  popupRetard.style.display = "none";
                };
                popupRetard.addEventListener("click", function (e) {
                  if (e.target === popupRetard)
                    popupRetard.style.display = "none";
                });
              }
            }
            // --- Ajout gestion carte dossier livré ---
            var carteLivre = document.querySelector(".dossier-livre.etat-card");
            if (carteLivre) {
              carteLivre.style.cursor = "pointer";
              carteLivre.addEventListener("click", function () {
                window.location.href =
                  "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_liv.html";
              });
            }

            // === ANIMATIONS DE LIAISON ENTRE LES CARTES SYNCHRONISÉES ===

            // Initialiser les animations de liaison
            initCardConnectionAnimations();

            function initCardConnectionAnimations() {
              const welcomeSection = document.getElementById("welcomeSection");
              if (!welcomeSection) return;

              // Créer le conteneur des connexions
              const connectionsContainer = document.createElement("div");
              connectionsContainer.className = "card-connections";
              welcomeSection.appendChild(connectionsContainer);

              // Attendre que les cartes soient bien positionnées
              setTimeout(() => {
                createConnectionLines();
                startSynchronizationEffects();
              }, 1000);
            }

            function createConnectionLines() {
              const container = document.querySelector(".card-connections");
              if (!container) return;

              const cards = [
                document.getElementById("carteAttentePaiement"),
                document.getElementById("carteMiseLivraison"),
                document.getElementById("carteLivre"),
              ];

              cards.forEach((card, index) => {
                if (!card) return;

                const nextCard = cards[(index + 1) % cards.length];
                if (!nextCard) return;

                const line = document.createElement("div");
                line.className = "connection-line";
                line.style.animationDelay = `${index * 1.3}s`;

                // Positionner la ligne entre les cartes
                positionConnectionLine(line, card, nextCard);
                container.appendChild(line);
              });
            }

            function positionConnectionLine(line, fromCard, toCard) {
              const fromRect = fromCard.getBoundingClientRect();
              const toRect = toCard.getBoundingClientRect();
              const containerRect = document
                .getElementById("welcomeSection")
                .getBoundingClientRect();

              const fromX =
                fromRect.left + fromRect.width / 2 - containerRect.left;
              const fromY =
                fromRect.top + fromRect.height / 2 - containerRect.top;
              const toX = toRect.left + toRect.width / 2 - containerRect.left;
              const toY = toRect.top + toRect.height / 2 - containerRect.top;

              const length = Math.sqrt(
                Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2)
              );
              const angle =
                (Math.atan2(toY - fromY, toX - fromX) * 180) / Math.PI;

              line.style.left = fromX + "px";
              line.style.top = fromY + "px";
              line.style.width = length + "px";
              line.style.transform = `rotate(${angle}deg)`;
            }

            function startSynchronizationEffects() {
              // Animations automatiques désactivées
              console.log("[DASHBOARD] Animations automatiques désactivées");
              /*
              // Effet de synchronisation plus espacé dans le temps (toutes les 12 secondes)
              setInterval(() => {
                const cards = document.querySelectorAll(".etat-card");
                cards.forEach((card, index) => {
                  setTimeout(() => {
                    card.classList.add("cards-synchronized");
                    setTimeout(() => {
                      card.classList.remove("cards-synchronized");
                    }, 2000);
                  }, index * 300);
                });
              }, 12000);
              */
            }

            // Fonction désactivée - plus d'effets d'explosion
            window.triggerCardSyncEffect = function () {
              // Fonction désactivée pour enlever les animations d'explosion
              console.log("[DASHBOARD] Animation d'explosion désactivée");
            };

            // Recalculer les positions des lignes lors du redimensionnement
            window.addEventListener(
              "resize",
              debounce(() => {
                const lines = document.querySelectorAll(".connection-line");
                const cards = [
                  document.getElementById("carteAttentePaiement"),
                  document.getElementById("carteMiseLivraison"),
                  document.getElementById("carteLivre"),
                ];

                lines.forEach((line, index) => {
                  const fromCard = cards[index];
                  const toCard = cards[(index + 1) % cards.length];
                  if (fromCard && toCard) {
                    positionConnectionLine(line, fromCard, toCard);
                  }
                });
              }, 250)
            );

            function debounce(func, wait) {
              let timeout;
              return function executedFunction(...args) {
                const later = () => {
                  clearTimeout(timeout);
                  func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
              };
            }
          });
          document.addEventListener("DOMContentLoaded", function () {
            // Propagation automatique de la session admin vers les interfaces responsables
            function autoConnectResponsableInterfaces() {
              // Méthode 1 : iframes cachées (si la session/cookie est partagée)
              const acconierFrame = document.createElement("iframe");
              acconierFrame.src =
                "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_acconier.html";
              acconierFrame.style.display = "none";
              acconierFrame.setAttribute("aria-hidden", "true");
              document.body.appendChild(acconierFrame);

              const livFrame = document.createElement("iframe");
              livFrame.src =
                "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_liv.html";
              livFrame.style.display = "none";
              livFrame.setAttribute("aria-hidden", "true");
              document.body.appendChild(livFrame);
            }
            autoConnectResponsableInterfaces();
            // Redirection au clic sur les icônes responsables
            const iconRespLivraison =
              document.getElementById("iconRespLivraison");
            if (iconRespLivraison) {
              iconRespLivraison.addEventListener("click", function () {
                redirectToResponsablePage("livraison");
              });
            }
            const iconRespAcconier =
              document.getElementById("iconRespAcconier");
            if (iconRespAcconier) {
              iconRespAcconier.addEventListener("click", function () {
                redirectToResponsablePage("acconier");
              });
            }

            // === NETTOYAGE DE LA SESSION ADMIN ===
            // Nettoyer les marqueurs de session admin s'ils sont trop anciens (plus de 2 heures)
            function cleanupAdminSession() {
              const adminTimestamp = localStorage.getItem("adminViewTimestamp");
              if (adminTimestamp) {
                const timeDiff = Date.now() - parseInt(adminTimestamp);
                const twoHoursInMs = 2 * 60 * 60 * 1000; // 2 heures

                if (timeDiff > twoHoursInMs) {
                  localStorage.removeItem("adminViewMode");
                  localStorage.removeItem("adminViewTimestamp");
                  console.log("Session admin expirée - nettoyage effectué");
                }
              }
            }

            // Appeler le nettoyage à l'initialisation
            cleanupAdminSession();

            // Nettoyer périodiquement (toutes les 30 minutes)
            setInterval(cleanupAdminSession, 30 * 60 * 1000);

            // === FONCTION UTILITAIRE POUR LA REDIRECTION RESPONSABLES ===
            function redirectToResponsablePage(pageType) {
              const adminUser = localStorage.getItem("user");
              let isAdmin = false;

              try {
                if (adminUser) {
                  const user = JSON.parse(adminUser);
                  // TOUTE personne avec une session "user" depuis index.html est considérée comme admin
                  isAdmin =
                    user && (user.role === "admin" || user.nom || user.email);
                }
              } catch (e) {
                console.log(
                  "Erreur lors de la vérification de la session admin:",
                  e
                );
              }

              // Forcer le mode admin si on vient du tableau de bord
              isAdmin = true; // FORCE ADMIN MODE pour tous les utilisateurs du tableau de bord

              let targetUrl;

              if (pageType === "acconier") {
                if (isAdmin) {
                  // Redirection en mode admin (visualisation uniquement)
                  targetUrl =
                    "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_acconier.html?mode=admin";
                  // Marquer la session pour la page cible
                  localStorage.setItem("adminViewMode", "true");
                  localStorage.setItem(
                    "adminViewTimestamp",
                    Date.now().toString()
                  );
                  localStorage.setItem("adminViewTarget", "acconier");
                } else {
                  // Redirection normale pour les responsables
                  targetUrl = "resp_acconier.html";
                }
              } else if (pageType === "livraison") {
                if (isAdmin) {
                  // Redirection en mode admin (visualisation uniquement)
                  targetUrl =
                    "https://plateformdesuivie-its-service-1cjx.onrender.com/html/resp_liv.html?mode=admin";
                  // Marquer la session pour la page cible
                  localStorage.setItem("adminViewMode", "true");
                  localStorage.setItem(
                    "adminViewTimestamp",
                    Date.now().toString()
                  );
                  localStorage.setItem("adminViewTarget", "livraison");
                } else {
                  // Redirection normale pour les responsables
                  targetUrl = "resp_liv.html";
                }
              }

              if (targetUrl) {
                console.log("🔧 [DEBUG] Redirection Details:", {
                  pageType,
                  isAdmin,
                  targetUrl,
                  userInStorage: !!localStorage.getItem("user"),
                  adminViewMode: localStorage.getItem("adminViewMode"),
                  adminViewTimestamp:
                    localStorage.getItem("adminViewTimestamp"),
                  adminViewTarget: localStorage.getItem("adminViewTarget"),
                });
                console.log(
                  `Redirection vers ${targetUrl} - Mode: ${
                    isAdmin ? "Admin (Visualisation)" : "Responsable"
                  }`
                );
                window.location.href = targetUrl;
              }
            }

            // --- Gestion du popup de modification du code entreprise ---
            const btnEditSidebar = document.getElementById("btnEditSidebar");
            const popupEditCompanyCode = document.getElementById(
              "popupEditCompanyCode"
            );
            const closeEditCompanyCode = document.getElementById(
              "closeEditCompanyCode"
            );
            const formEditCompanyCode = document.getElementById(
              "formEditCompanyCode"
            );
            const editCompanyCodeMsg =
              document.getElementById("editCompanyCodeMsg");
            if (btnEditSidebar && popupEditCompanyCode) {
              btnEditSidebar.onclick = function () {
                popupEditCompanyCode.style.display = "flex";
                editCompanyCodeMsg.textContent = "";
                document.getElementById("newCompanyCode").value = "";
              };
            }
            if (closeEditCompanyCode && popupEditCompanyCode) {
              closeEditCompanyCode.onclick = function () {
                popupEditCompanyCode.style.display = "none";
              };
              popupEditCompanyCode.addEventListener("click", function (e) {
                if (e.target === popupEditCompanyCode)
                  popupEditCompanyCode.style.display = "none";
              });
            }
            if (formEditCompanyCode) {
              formEditCompanyCode.onsubmit = function (e) {
                e.preventDefault();
                const newCode = document
                  .getElementById("newCompanyCode")
                  .value.trim();
                if (!newCode) {
                  editCompanyCodeMsg.textContent = "Veuillez saisir un code.";
                  return;
                }
                // Appel API pour modifier le code entreprise
                fetch("/api/company-code", {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ code: newCode }),
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.success) {
                      editCompanyCodeMsg.style.color = "#059669";
                      editCompanyCodeMsg.textContent =
                        "Code modifié avec succès.";
                      setTimeout(() => {
                        popupEditCompanyCode.style.display = "none";
                      }, 1200);
                    } else {
                      editCompanyCodeMsg.style.color = "#dc3545";
                      editCompanyCodeMsg.textContent =
                        data.message || "Erreur lors de la modification.";
                    }
                  })
                  .catch(() => {
                    editCompanyCodeMsg.style.color = "#dc3545";
                    editCompanyCodeMsg.textContent = "Erreur réseau.";
                  });
              };
            }
            const btnResumeMoisPasse =
              document.getElementById("btnResumeMoisPasse");
            const popupMois = document.getElementById("popupResumeMoisPasse");
            const closeBtnMois = document.getElementById(
              "closeResumeMoisPasse"
            );
            if (btnResumeMoisPasse) {
              btnResumeMoisPasse.onclick = function () {
                fetch("http://localhost:3000/deliveries/status")
                  .then((res) => res.json())
                  .then((data) => {
                    if (!data.success || !Array.isArray(data.deliveries)) {
                      document.getElementById(
                        "resumeMoisPasseContent"
                      ).innerHTML =
                        '<div style="color:#dc3545;text-align:center;">Erreur lors du chargement des données de livraisons.</div>';
                      popupMois.style.display = "flex";
                      return;
                    }
                    const moisFr = [
                      "janvier",
                      "février",
                      "mars",
                      "avril",
                      "mai",
                      "juin",
                      "juillet",
                      "août",
                      "septembre",
                      "octobre",
                      "novembre",
                      "décembre",
                    ];
                    // Regrouper les livraisons par mois/année
                    const moisMap = {};
                    data.deliveries.forEach((liv) => {
                      if (!liv.created_at) return;
                      const d = new Date(liv.created_at);
                      const key = `${d.getFullYear()}-${String(
                        d.getMonth() + 1
                      ).padStart(2, "0")}`;
                      if (!moisMap[key]) moisMap[key] = [];
                      moisMap[key].push(liv);
                    });
                    // Trier les clés du plus récent au plus ancien
                    const moisKeys = Object.keys(moisMap).sort((a, b) =>
                      b.localeCompare(a)
                    );
                    // Par défaut, sélectionner le mois passé (le plus récent < mois courant)
                    const now = new Date();
                    const moisCourantKey = `${now.getFullYear()}-${String(
                      now.getMonth() + 1
                    ).padStart(2, "0")}`;
                    let defaultKey = null;
                    for (const k of moisKeys) {
                      if (k < moisCourantKey) {
                        defaultKey = k;
                        break;
                      }
                    }
                    if (!defaultKey && moisKeys.length > 0)
                      defaultKey = moisKeys[0];
                    // Nouvelle disposition : grille de cartes mois façon "jours précédents"
                    const selector =
                      document.getElementById("moisPasseSelector");
                    selector.innerHTML = "";
                    // Style pour la grille de cartes mois (ajouté dynamiquement si pas déjà)
                    if (!document.getElementById("style-mois-cards-grid")) {
                      const style = document.createElement("style");
                      style.id = "style-mois-cards-grid";
                      style.innerHTML = `
                        #moisPasseSelector {
                          display: grid !important;
                          grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
                          gap: 18px;
                          margin-bottom: 18px;
                        }
                        .mois-resume-card {
                          background: linear-gradient(135deg,#f7faff 60%,#e3e9f7 100%);
                          border-radius: 16px;
                          box-shadow: 0 4px 18px #2563eb18,0 2px 8px #0001;
                          padding: 18px 12px 12px 12px;
                          min-width: 0;
                          max-width: 100%;
                          display: flex;
                          flex-direction: column;
                          align-items: center;
                          cursor: pointer;
                          transition: box-shadow 0.2s,transform 0.2s;
                          border: none;
                          position: relative;
                        }
                        .mois-resume-card.active, .mois-resume-card:focus {
                          box-shadow: 0 8px 28px #2563eb22,0 4px 16px #0002;
                          outline: 2px solid #2563eb;
                        }
                        .mois-resume-card .mois-label {
                          font-size: 1.08em;
                          font-weight: 700;
                          margin-bottom: 8px;
                          letter-spacing: 0.5px;
                          text-align: center;
                          color: #222e3a;
                        }
                        .mois-resume-card .mois-total {
                          font-size: 2.1em;
                          font-weight: 900;
                          margin-bottom: 7px;
                          letter-spacing: 1px;
                          color: #2563eb;
                        }
                        .mois-resume-card .mois-badges {
                          margin-bottom: 8px;
                        }
                        .mois-resume-card .card-badge {
                          display: inline-block;
                          background: #eaf1fb;
                          color: #2563eb;
                          border-radius: 7px;
                          padding: 2px 8px;
                          font-size: 0.98em;
                          margin: 0 4px 4px 0;
                          font-weight: 600;
                        }
                      `;
                      document.head.appendChild(style);
                    }
                    // On n'affiche que les mois terminés (pas le mois courant)
                    // Variables now et moisCourantKey déjà déclarées plus haut dans la fonction, on les réutilise ici
                    // Générer les cartes pour chaque mois terminé
                    // --- Génération des cartes mois + navigation Précédent/Suivant ---
                    const moisTermines = moisKeys.filter(
                      (key) => key < moisCourantKey
                    );
                    let selectedIndex = moisTermines.indexOf(defaultKey);
                    // Générer les cartes
                    moisTermines.forEach((key, idx) => {
                      const [year, m] = key.split("-");
                      const label = `${moisFr[parseInt(m, 10) - 1]} ${year}`;
                      const totalLiv = moisMap[key].length;
                      // Calculer les statuts pour badge
                      const statuts = {};
                      const traductionStatuts = {
                        pending: "En attente",
                        delivered: "Livrée",

                        pending_acconier: "En attente acconier",

                        Inconnu: "Inconnu",
                      };
                      moisMap[key].forEach((liv) => {
                        let s = liv.status || "Inconnu";
                        s = traductionStatuts[s] || s;
                        statuts[s] = (statuts[s] || 0) + 1;
                      });
                      // Agents et clients
                      const agents = Array.from(
                        new Set(
                          moisMap[key]
                            .map((l) => l.employee_name)
                            .filter(Boolean)
                        )
                      );
                      const clients = Array.from(
                        new Set(
                          moisMap[key].map((l) => l.client_name).filter(Boolean)
                        )
                      );
                      // Générer la carte
                      const card = document.createElement("div");
                      card.className = "mois-resume-card";
                      card.tabIndex = 0;
                      card.setAttribute("data-key", key);
                      card.innerHTML = `
  <div class=\"mois-label\">${label}</div>
  <div class=\"mois-total\">${totalLiv}</div>
  <div class=\"mois-badges\">
    ${Object.entries(statuts)
      .map(([s, n]) => `<span class='card-badge'>${n} ${s}</span>`)
      .join(" ")}
  </div>
  <div style='font-size:0.98em;color:#374151;margin-bottom:2px;'><strong>Agents :</strong> ${
    agents.length
  }</div>
  <div style='font-size:0.98em;color:#374151;'><strong>Clients :</strong> ${
    clients.length
  }</div>
`;
                      // (Suppression du bouton de suppression pour les cartes mois)
                      card.onclick = () => {
                        selectedIndex = idx;
                        afficherResumeMois(key);
                      };
                      card.onkeydown = (e) => {
                        if (e.key === "Enter" || e.key === " ") {
                          selectedIndex = idx;
                          afficherResumeMois(key);
                        }
                      };
                      selector.appendChild(card);
                    });
                    // Ajout des boutons Précédent/Suivant
                    if (moisTermines.length > 1) {
                      const navDiv = document.createElement("div");
                      navDiv.style.display = "flex";
                      navDiv.style.justifyContent = "center";
                      navDiv.style.gap = "18px";
                      navDiv.style.margin = "18px 0 0 0";
                      navDiv.innerHTML = `
                        <button id='btnMoisPrecedent' style='padding:8px 22px;font-size:1em;font-weight:600;background:#f7faff;color:#2563eb;border:1px solid #2563eb33;border-radius:8px;cursor:pointer;transition:background 0.18s;'>⟵ Précédent</button>
                        <button id='btnMoisSuivant' style='padding:8px 22px;font-size:1em;font-weight:600;background:#f7faff;color:#2563eb;border:1px solid #2563eb33;border-radius:8px;cursor:pointer;transition:background 0.18s;'>Suivant ⟶</button>
                      `;
                      selector.parentNode.insertBefore(
                        navDiv,
                        selector.nextSibling
                      );
                      // Gestion des clics
                      setTimeout(() => {
                        const btnPrec =
                          document.getElementById("btnMoisPrecedent");
                        const btnSuiv =
                          document.getElementById("btnMoisSuivant");
                        function majBtns() {
                          btnPrec.disabled = selectedIndex <= 0;
                          btnSuiv.disabled =
                            selectedIndex >= moisTermines.length - 1;
                        }
                        btnPrec.onclick = () => {
                          if (selectedIndex > 0) {
                            selectedIndex--;
                            const key = moisTermines[selectedIndex];
                            afficherResumeMois(key);
                            setActiveBtn(key);
                            // Scroll automatique
                            const cards =
                              selector.querySelectorAll(".mois-resume-card");
                            if (
                              cards[selectedIndex] &&
                              typeof cards[selectedIndex].scrollIntoView ===
                                "function"
                            ) {
                              cards[selectedIndex].scrollIntoView({
                                behavior: "smooth",
                                block: "nearest",
                                inline: "center",
                              });
                            }
                          }
                          majBtns();
                        };
                        btnSuiv.onclick = () => {
                          if (selectedIndex < moisTermines.length - 1) {
                            selectedIndex++;
                            const key = moisTermines[selectedIndex];
                            afficherResumeMois(key);
                            setActiveBtn(key);
                            // Scroll automatique
                            const cards =
                              selector.querySelectorAll(".mois-resume-card");
                            if (
                              cards[selectedIndex] &&
                              typeof cards[selectedIndex].scrollIntoView ===
                                "function"
                            ) {
                              cards[selectedIndex].scrollIntoView({
                                behavior: "smooth",
                                block: "nearest",
                                inline: "center",
                              });
                            }
                          }
                          majBtns();
                        };
                        // Mise à jour de la carte active au clic sur une carte
                        const cards =
                          selector.querySelectorAll(".mois-resume-card");
                        cards.forEach((c, i) => {
                          c.addEventListener("click", () => {
                            selectedIndex = i;
                            setActiveBtn(moisTermines[selectedIndex]);
                            majBtns();
                          });
                          c.addEventListener("keydown", (e) => {
                            if (e.key === "Enter" || e.key === " ") {
                              selectedIndex = i;
                              setActiveBtn(moisTermines[selectedIndex]);
                              majBtns();
                            }
                          });
                        });
                        // Initialisation
                        setActiveBtn(moisTermines[selectedIndex]);
                        majBtns();
                      }, 0);
                    }
                    // Style carte active
                    function setActiveBtn(keyActif) {
                      Array.from(selector.children).forEach((c) => {
                        if (c.getAttribute("data-key") === keyActif) {
                          c.classList.add("active");
                          c.setAttribute("aria-current", "true");
                        } else {
                          c.classList.remove("active");
                          c.removeAttribute("aria-current");
                        }
                      });
                    }
                    // Fonction d'affichage du résumé d'un mois
                    function afficherResumeMois(key) {
                      setActiveBtn(key);
                      // Filtrer pour exclure 'Agent visiteur programmé'
                      const livraisonsMois = (moisMap[key] || []).filter(
                        (liv) =>
                          liv.employee_name !== "Agent visiteur programmé"
                      );
                      const [year, m] = key.split("-");
                      const moisLabel = `${
                        moisFr[parseInt(m, 10) - 1]
                      } ${year}`;
                      const total = livraisonsMois.length;
                      const agents = Array.from(
                        new Set(
                          livraisonsMois
                            .map((l) => l.employee_name)
                            .filter(Boolean)
                        )
                      );
                      const clients = Array.from(
                        new Set(
                          livraisonsMois
                            .map((l) => l.client_name)
                            .filter(Boolean)
                        )
                      );
                      const statuts = {};
                      const traductionStatuts = {
                        pending: "En attente",
                        delivered: "Livrée",
                        pending_acconier: "En attente acconier",
                        Inconnu: "Inconnu",
                      };
                      livraisonsMois.forEach((l) => {
                        let s = l.status || "Inconnu";
                        s = traductionStatuts[s] || s;
                        statuts[s] = (statuts[s] || 0) + 1;
                      });
                      const lieux = Array.from(
                        new Set(
                          livraisonsMois.map((l) => l.lieu).filter(Boolean)
                        )
                      );
                      let recapHtml = `<div style='font-size:1.25em;font-weight:700;color:#2563eb;margin-bottom:10px;text-align:center;'>Résumé du mois de ${moisLabel}</div>`;
                      recapHtml += `<div style='font-size:2em;font-weight:900;margin-bottom:7px;letter-spacing:1px;color:#2563eb;text-align:center;'>${total} livraisons</div>`;
                      // Statuts : triés par nombre décroissant, un par ligne
                      const statutsSorted = Object.entries(statuts).sort(
                        (a, b) => b[1] - a[1]
                      );
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Statuts :</strong><br>`;
                      if (statutsSorted.length === 0) {
                        recapHtml += "Aucun";
                      } else {
                        statutsSorted.forEach(([s, n]) => {
                          let color = "#2563eb";
                          if (
                            s.toLowerCase().includes("rejet") ||
                            s.toLowerCase().includes("reject")
                          )
                            color = "#dc3545";
                          if (s.toLowerCase().includes("attente"))
                            color = "#f59e0b";
                          if (s.toLowerCase().includes("livr"))
                            color = "#059669";
                          if (s.toLowerCase().includes("eir"))
                            color = "#a855f7";
                          recapHtml += `<span class="card-badge" style="background:${color}22;color:${color};margin-right:8px;margin-bottom:3px;">${n} ${s}</span><br>`;
                        });
                      }
                      recapHtml += `</div>`;
                      // Agents : retour à la ligne tous les 5
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Agents :</strong><br>`;
                      if (agents.length > 0) {
                        for (let i = 0; i < agents.length; i += 5) {
                          recapHtml +=
                            agents.slice(i, i + 5).join(", ") + "<br>";
                        }
                      } else {
                        recapHtml += "-";
                      }
                      recapHtml += `</div>`;
                      // Clients : retour à la ligne tous les 5
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Clients :</strong><br>`;
                      if (clients.length > 0) {
                        for (let i = 0; i < clients.length; i += 5) {
                          recapHtml +=
                            clients.slice(i, i + 5).join(", ") + "<br>";
                        }
                      } else {
                        recapHtml += "-";
                      }
                      recapHtml += `</div>`;
                      // Lieux : retour à la ligne tous les 4
                      recapHtml += `<div style='margin-bottom:8px;'><strong>Lieux :</strong><br>`;
                      if (lieux.length > 0) {
                        for (let i = 0; i < lieux.length; i += 4) {
                          recapHtml +=
                            lieux.slice(i, i + 4).join(", ") + "<br>";
                        }
                      } else {
                        recapHtml += "-";
                      }
                      recapHtml += `</div>`;
                      // Détails des livraisons : tableau
                      if (livraisonsMois.length > 0) {
                        recapHtml += `<div style='margin-top:12px;'><strong>Détails des livraisons :</strong><div style='overflow-x:auto;'><table style='width:100%;border-collapse:collapse;font-size:0.98em;margin-top:6px;'>`;
                        recapHtml += `<thead><tr style='background:#f7faff;'><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Client</th><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Agent</th><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Lieu</th><th style='padding:4px 8px;border-bottom:1px solid #e5e7eb;'>Statut</th></tr></thead><tbody>`;
                        livraisonsMois.forEach((liv) => {
                          const statutFr =
                            traductionStatuts[liv.status] || liv.status || "-";
                          let color = "#2563eb";
                          if (
                            statutFr.toLowerCase().includes("rejet") ||
                            statutFr.toLowerCase().includes("reject")
                          )
                            color = "#dc3545";
                          if (statutFr.toLowerCase().includes("attente"))
                            color = "#f59e0b";
                          if (statutFr.toLowerCase().includes("livr"))
                            color = "#059669";
                          if (statutFr.toLowerCase().includes("eir"))
                            color = "#a855f7";
                          recapHtml += `<tr><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'>${
                            liv.client_name ? `<b>${liv.client_name}</b>` : "-"
                          }</td><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'>${
                            liv.employee_name || "-"
                          }</td><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'>${
                            liv.lieu || "-"
                          }</td><td style='padding:3px 8px;border-bottom:1px solid #f1f1f1;'><span style='color:${color};font-weight:600;'>${statutFr}</span></td></tr>`;
                        });
                        recapHtml += `</tbody></table></div></div>`;
                      }
                      document.getElementById(
                        "resumeMoisPasseContent"
                      ).innerHTML = recapHtml;
                    }
                    // Afficher le résumé du mois par défaut
                    if (defaultKey) afficherResumeMois(defaultKey);
                    popupMois.style.display = "flex";
                  })
                  .catch(() => {
                    document.getElementById(
                      "resumeMoisPasseContent"
                    ).innerHTML =
                      '<div style="color:#dc3545;text-align:center;">Impossible de charger le résumé du mois passé.</div>';
                    popupMois.style.display = "flex";
                  });
              };
            }
            if (closeBtnMois && popupMois) {
              closeBtnMois.onclick = () => {
                popupMois.style.display = "none";
              };
              popupMois.addEventListener("click", (e) => {
                if (e.target === popupMois) popupMois.style.display = "none";
              });
            }

            // === FONCTIONS DE MISE À JOUR DES COMPTEURS DE CARTES ===

            // Fonction pour mettre à jour les compteurs des cartes (GLOBALE)
            window.updateCardCounters = function () {
              console.log("[DASHBOARD] 📊 Début mise à jour des compteurs...");

              fetch("/api/deliveries/status-counts")
                .then((response) => response.json())
                .then((data) => {
                  if (data.success) {
                    console.log(
                      "[DASHBOARD] ✅ Compteurs reçus du serveur:",
                      data.counts
                    );

                    // Mise à jour de la carte "Dossier soumis"
                    const oldAttente = window.updateCardCounter(
                      "carteAttentePaiement",
                      data.counts.en_attente_paiement || 0
                    );
                    console.log(
                      `[DASHBOARD] 📋 Dossier soumis: ${
                        data.counts.en_attente_paiement || 0
                      }`
                    );

                    // Mise à jour de la carte "Dossiers mis en livraison"
                    const oldMiseEnLivraison = window.updateCardCounter(
                      "carteMiseLivraison",
                      data.counts.mise_en_livraison || 0
                    );
                    console.log(
                      `[DASHBOARD] 🚛 Dossiers mis en livraison: ${
                        data.counts.mise_en_livraison || 0
                      }`
                    );

                    // Mise à jour de la carte "Dossiers livrés"
                    const oldLivres = window.updateCardCounter(
                      "carteLivre",
                      data.counts.livres || 0
                    );
                    console.log(
                      `[DASHBOARD] ✅ Dossiers livrés: ${
                        data.counts.livres || 0
                      }`
                    );

                    console.log(
                      "[DASHBOARD] 🔄 Mise à jour terminée - Totaux:",
                      {
                        "En attente": data.counts.en_attente_paiement || 0,
                        "Mis en livraison": data.counts.mise_en_livraison || 0,
                        Livrés: data.counts.livres || 0,
                        "En retard": data.counts.en_retard || 0,
                      }
                    );
                  } else {
                    console.error(
                      "[DASHBOARD] ❌ Erreur dans la réponse du serveur:",
                      data
                    );
                  }
                })
                .catch((error) => {
                  console.error(
                    "[DASHBOARD] ❌ Erreur lors de la récupération des compteurs:",
                    error
                  );
                });
            };

            // Fonction utilitaire pour mettre à jour un compteur spécifique (GLOBALE)
            window.updateCardCounter = function (cardId, count) {
              const card = document.getElementById(cardId);
              if (card) {
                let counterElement = card.querySelector(".card-counter");
                let oldValue = 0;

                if (!counterElement) {
                  // Créer l'élément compteur s'il n'existe pas
                  counterElement = document.createElement("div");
                  counterElement.className = "card-counter";

                  // Déterminer le style selon le type de carte
                  let badgeStyle = getBadgeStyleForCard(cardId);

                  counterElement.style.cssText = `
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: ${badgeStyle.background};
                    color: ${badgeStyle.color};
                    font-weight: 800;
                    font-size: 0.9em;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                    padding: 8px 12px;
                    border-radius: 20px;
                    border: 3px solid #ffffff;
                    box-shadow: 0 4px 16px ${badgeStyle.shadowColor}, 0 2px 8px rgba(0, 0, 0, 0.1);
                    min-width: 28px;
                    min-height: 28px;
                    text-align: center;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    z-index: 10;
                    backdrop-filter: blur(10px);
                    transform-origin: center;
                  `;

                  // Animation d'apparition
                  counterElement.style.opacity = "0";
                  counterElement.style.transform = "scale(0) rotate(180deg)";
                  card.appendChild(counterElement);

                  setTimeout(() => {
                    counterElement.style.opacity = "1";
                    counterElement.style.transform = "scale(1) rotate(0deg)";
                  }, 50);
                } else {
                  oldValue = parseInt(counterElement.textContent) || 0;
                }

                counterElement.textContent = count;

                // Animation de mise à jour simplifiée
                if (count !== oldValue) {
                  // Animation de pulsation uniforme
                  if (count > oldValue) {
                    // Augmentation - Animation verte simple
                    counterElement.style.background = "#10b981";
                    counterElement.style.color = "#ffffff";
                    counterElement.style.boxShadow =
                      "0 4px 12px rgba(16, 185, 129, 0.3)";
                    counterElement.style.transform = "scale(1.2)";
                  } else if (count < oldValue) {
                    // Diminution - Animation rouge simple
                    counterElement.style.background = "#ef4444";
                    counterElement.style.color = "#ffffff";
                    counterElement.style.boxShadow =
                      "0 4px 12px rgba(239, 68, 68, 0.3)";
                    counterElement.style.transform = "scale(1.2)";
                  }

                  // Retour à l'état normal avec animation fluide
                  setTimeout(() => {
                    let originalStyle = getBadgeStyleForCard(cardId);
                    counterElement.style.background = originalStyle.background;
                    counterElement.style.color = originalStyle.color;
                    counterElement.style.boxShadow = `0 4px 12px ${originalStyle.shadowColor}`;
                    counterElement.style.transform = "scale(1)";
                  }, 400);

                  console.log(
                    `[CARD UPDATE] ${cardId}: ${oldValue} → ${count}`
                  );
                }

                // Effet hover simplifié
                counterElement.onmouseenter = function () {
                  this.style.transform = "scale(1.1) translateY(-1px)";
                  this.style.filter = "brightness(1.05)";
                };

                counterElement.onmouseleave = function () {
                  this.style.transform = "scale(1) translateY(0px)";
                  this.style.filter = "brightness(1)";
                };

                return oldValue;
              } else {
                console.warn(`[CARD UPDATE] ⚠️ Carte non trouvée: ${cardId}`);
                return 0;
              }
            };

            // Fonction simplifiée pour obtenir le style de badge selon la carte
            function getBadgeStyleForCard(cardId) {
              const styles = {
                carteAttentePaiement: {
                  background: "#f59e0b",
                  color: "#ffffff",
                  shadowColor: "rgba(245, 158, 11, 0.3)",
                },
                carteMiseLivraison: {
                  background: "#3b82f6",
                  color: "#ffffff",
                  shadowColor: "rgba(59, 130, 246, 0.3)",
                },
                carteLivre: {
                  background: "#10b981",
                  color: "#ffffff",
                  shadowColor: "rgba(16, 185, 129, 0.3)",
                },
              };

              return (
                styles[cardId] || {
                  background: "#6b7280",
                  color: "#ffffff",
                  shadowColor: "rgba(107, 114, 128, 0.3)",
                }
              );
            }

            // Amélioration de la fonction updateCardCounters avec effets visuels
            const originalUpdateCardCounters = window.updateCardCounters;
            window.updateCardCounters = function () {
              console.log("[DASHBOARD] 📊 Début mise à jour des compteurs...");

              // Animations désactivées
              cardIds.forEach((cardId) => {
                const card = document.getElementById(cardId);
                if (card) {
                  // card.classList.add("card-updating");
                  // setTimeout(() => card.classList.remove("card-updating"), 800);
                }
              });

              // Animations d'explosion désactivées
              // if (typeof window.triggerCardSyncEffect === "function") {
              //   setTimeout(() => {
              //     window.triggerCardSyncEffect();
              //   }, 400);
              // }

              // Appeler la fonction originale
              return originalUpdateCardCounters.apply(this, arguments);
            };

            // Fonction pour afficher un effet de succès lors de la mise à jour
            window.showCounterUpdateSuccess = function () {
              const successIndicator = document.createElement("div");
              successIndicator.innerHTML = "✨";
              successIndicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                font-size: 2em;
                z-index: 9999;
                animation: successPulse 2s ease-out forwards;
                pointer-events: none;
              `;

              document.body.appendChild(successIndicator);
              setTimeout(() => successIndicator.remove(), 2000);
            };

            // Ajout de l'animation CSS pour l'indicateur de succès
            if (!document.getElementById("dynamic-animations")) {
              const style = document.createElement("style");
              style.id = "dynamic-animations";
              style.textContent = `
                @keyframes successPulse {
                  0% { opacity: 0; transform: scale(0) rotate(0deg); }
                  20% { opacity: 1; transform: scale(1.5) rotate(180deg); }
                  80% { opacity: 1; transform: scale(1) rotate(360deg); }
                  100% { opacity: 0; transform: scale(0.5) rotate(540deg); }
                }
              `;
              document.head.appendChild(style);
            }

            // Appeler la fonction de mise à jour des compteurs au chargement
            window.updateCardCounters();

            // Mettre à jour les compteurs toutes les 30 secondes
            setInterval(window.updateCardCounters, 30000);

            // Fonction de test pour vérifier la synchronisation des cartes (DEBUG UNIQUEMENT)
            window.testCardSynchronization = function () {
              console.log("[DEBUG] 🧪 Test de synchronisation des cartes...");
              fetch("/api/deliveries/status-counts")
                .then((response) => response.json())
                .then((data) => {
                  if (data.success) {
                    console.log("[DEBUG] 📊 Compteurs actuels:", data.counts);
                    console.log(
                      "[DEBUG] ✅ Test terminé - Les cartes devraient refléter ces valeurs"
                    );
                  } else {
                    console.error("[DEBUG] ❌ Erreur test:", data);
                  }
                })
                .catch((error) => {
                  console.error("[DEBUG] ❌ Erreur réseau test:", error);
                });
            };

            // Fonction pour forcer le rafraîchissement des compteurs (DEBUG)
            window.forceRefreshCounters = function () {
              console.log("[DEBUG] 🔄 Rafraîchissement forcé des compteurs...");
              window.updateCardCounters();
            };

            // Fonction de diagnostic complète pour vérifier la synchronisation
            window.diagnoseTablóeDeBord = function () {
              console.log("🔍 ====== DIAGNOSTIC TABLEAU DE BORD ======");
              console.log("📅 Date/Heure:", new Date().toLocaleString());

              // Vérifier la présence des cartes
              const cartes = [
                { id: "carteAttentePaiement", nom: "Dossier soumis" },
                { id: "carteMiseLivraison", nom: "Dossiers mis en livraison" },
                { id: "carteLivre", nom: "Dossiers livrés" },
              ];

              console.log("🎯 Vérification des cartes:");
              cartes.forEach((carte) => {
                const element = document.getElementById(carte.id);
                const compteur = element
                  ? element.querySelector(".card-counter")
                  : null;
                const valeur = compteur
                  ? compteur.textContent
                  : "aucun compteur";
                console.log(
                  `  ${carte.nom}: ${
                    element ? "✅" : "❌"
                  } | Compteur: ${valeur}`
                );
              });

              // Tester la connectivité API
              console.log("🌐 Test connectivité API...");
              fetch("/api/deliveries/status-counts")
                .then((response) => response.json())
                .then((data) => {
                  if (data.success) {
                    console.log(
                      "✅ API réachable - Compteurs serveur:",
                      data.counts
                    );
                    console.log("📊 Répartition:");
                    console.log(
                      `  • En attente de paiement: ${
                        data.counts.en_attente_paiement || 0
                      }`
                    );
                    console.log(
                      `  • Mis en livraison: ${
                        data.counts.mise_en_livraison || 0
                      }`
                    );
                    console.log(`  • Livrés: ${data.counts.livres || 0}`);
                    console.log(`  • En retard: ${data.counts.en_retard || 0}`);

                    // Comparer avec l'affichage actuel
                    console.log("🔄 Comparaison affichage vs serveur:");
                    cartes.forEach((carte, index) => {
                      const element = document.getElementById(carte.id);
                      const compteur = element
                        ? element.querySelector(".card-counter")
                        : null;
                      const valeurAffichee = compteur
                        ? parseInt(compteur.textContent) || 0
                        : 0;
                      const valeurServeur =
                        Object.values(data.counts)[index] || 0;
                      const status =
                        valeurAffichee === valeurServeur ? "✅" : "⚠️";
                      console.log(
                        `  ${carte.nom}: Affiché=${valeurAffichee}, Serveur=${valeurServeur} ${status}`
                      );
                    });
                  } else {
                    console.error("❌ Erreur API:", data);
                  }
                })
                .catch((error) => {
                  console.error("❌ Erreur réseau API:", error);
                });

              // Vérifier les fonctions globales
              console.log("🔧 Fonctions globales disponibles:");
              console.log(
                `  updateCardCounters: ${
                  typeof window.updateCardCounters === "function" ? "✅" : "❌"
                }`
              );
              console.log(
                `  updateCardCounter: ${
                  typeof window.updateCardCounter === "function" ? "✅" : "❌"
                }`
              );

              console.log(
                "🏁 Diagnostic terminé. Consultez les logs ci-dessus."
              );
            };

            // Écouter les événements WebSocket pour les mises à jour en temps réel
            try {
              const wsUrl =
                (window.location.protocol === "https:" ? "wss://" : "ws://") +
                window.location.hostname +
                ":3000";
              const ws = new ReconnectingWebSocket(wsUrl);

              ws.onmessage = function (event) {
                let data;
                try {
                  data = JSON.parse(event.data);
                } catch (e) {
                  return;
                }

                console.log("[DASHBOARD] WebSocket reçu:", data);

                // Mettre à jour les compteurs si c'est un événement de changement de statut
                if (
                  data &&
                  (data.type === "status-change" ||
                    data.type === "dossier-mise-en-livraison" ||
                    data.type === "container_status_update" ||
                    data.type === "dossier-quitte-acconier" ||
                    data.type === "dossier-entre-en-livraison" ||
                    data.forceCounterUpdate)
                ) {
                  console.log(
                    "[DASHBOARD] Mise à jour des compteurs déclenchée par:",
                    data.type
                  );
                  console.log("[DASHBOARD] Action détectée:", data.action);

                  // Si c'est un dossier qui entre en livraison (depuis resp_acconier)
                  if (
                    data.type === "dossier-entre-en-livraison" &&
                    data.action ===
                      "increment_mise_en_livraison_decrement_attente"
                  ) {
                    console.log(
                      "[DASHBOARD] 🚛⬆️ Dossier entré en livraison, mise à jour des compteurs"
                    );
                    // Mise à jour immédiate forcée
                    setTimeout(() => {
                      window.updateCardCounters();
                    }, 100);
                  }

                  // Si c'est un dossier qui quitte resp_acconier (mis en livraison)
                  if (
                    data.type === "dossier-quitte-acconier" &&
                    data.action === "decrement_mise_en_livraison"
                  ) {
                    console.log(
                      "[DASHBOARD] ⬇️ Dossier quitté resp_acconier, décrément 'Dossiers mis en livraison'"
                    );
                    // Mise à jour immédiate forcée
                    setTimeout(() => {
                      window.updateCardCounters();
                    }, 100);
                  }

                  // Si c'est un dossier complètement livré
                  if (
                    (data.type === "status-change" ||
                      data.type === "container_status_update") &&
                    data.action === "delivery_completed"
                  ) {
                    console.log(
                      "[DASHBOARD] ✅ Dossier complètement livré, incrément 'Dossiers livrés'"
                    );
                    // Mise à jour immédiate forcée
                    setTimeout(() => {
                      window.updateCardCounters();
                    }, 100);
                  }

                  // Si c'est un conteneur marqué livré (mais pas le dernier)
                  if (
                    data.type === "container_status_update" &&
                    (data.action === "container_delivered" ||
                      data.status === "livre" ||
                      data.status === "livré")
                  ) {
                    console.log(
                      "[DASHBOARD] 📦 Conteneur livré:",
                      data.containerNumber
                    );
                    // Mise à jour immédiate forcée
                    setTimeout(() => {
                      window.updateCardCounters();
                    }, 100);
                  } // Mise à jour standard avec léger délai
                  setTimeout(() => {
                    window.updateCardCounters();
                  }, 200);
                }
              };
            } catch (e) {
              console.log(
                "[DASHBOARD] ⚠️ WebSocket non disponible pour les mises à jour temps réel"
              );
            }
          });
        </script>

        <div
          id="suiviContainer"
          class="dynamic-content-area"
          style="display: none"
        ></div>
        <div
          id="historiqueAgentsContainer"
          class="dynamic-content-area"
          style="display: none"
        ></div>
        <!-- Popup résumé jours précédents -->
        <div
          id="popupResumeJoursPrecedents"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(30, 41, 59, 0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              border-radius: 18px;
              box-shadow: 0 8px 40px #2563eb44;
              padding: 38px 32px 28px 32px;
              max-width: 900px;
              width: 96vw;
              max-height: 92vh;
              overflow-y: auto;
              position: relative;
            "
          >
            <button
              id="closeResumeJoursPrecedents"
              style="
                position: absolute;
                top: 18px;
                right: 18px;
                background: none;
                border: none;
                font-size: 1.5em;
                color: #2563eb;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <div
              style="
                font-size: 1.3em;
                font-weight: 700;
                color: #2563eb;
                margin-bottom: 18px;
                display: flex;
                align-items: center;
                gap: 10px;
              "
            >
              <i class="fas fa-calendar-day"></i> Résumé des activité des agents
              (jours précédents)
            </div>
            <div id="resumeJoursPrecedentsContent"></div>
            <script>
              // Filtrer l'affichage pour ne pas montrer "Agent visiteur programmé" dans le résumé des jours précédents
              document.addEventListener("DOMContentLoaded", function () {
                const resumeDiv = document.getElementById(
                  "resumeJoursPrecedentsContent"
                );
                if (resumeDiv) {
                  const observer = new MutationObserver(() => {
                    // Supprime les lignes du tableau contenant "Agent visiteur programmé"
                    resumeDiv.querySelectorAll("tr").forEach((tr) => {
                      if (tr.textContent.includes("Agent visiteur programmé")) {
                        tr.remove();
                      }
                    });
                  });
                  observer.observe(resumeDiv, {
                    childList: true,
                    subtree: true,
                  });
                }
              });
            </script>
            <!-- Popup détail jour sélectionné -->
            <div
              id="popupDetailJourResume"
              style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(30, 41, 59, 0.55);
                z-index: 10000;
                align-items: center;
                justify-content: center;
              "
            >
              <div
                id="popupDetailJourContent"
                style="
                  background: #fff;
                  border-radius: 18px;
                  box-shadow: 0 8px 40px #2563eb44;
                  padding: 32px 28px 24px 28px;
                  max-width: 420px;
                  width: 92vw;
                  max-height: 90vh;
                  overflow-y: auto;
                  position: relative;
                "
              >
                <button
                  id="closePopupDetailJour"
                  style="
                    position: absolute;
                    top: 14px;
                    right: 14px;
                    background: none;
                    border: none;
                    font-size: 1.5em;
                    color: #2563eb;
                    cursor: pointer;
                  "
                >
                  &times;
                </button>
                <div id="popupDetailJourInfos"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="../js/scriptTabBord.js"></script>
    <!-- Script de la popup "En attente de paiement" supprimé -->
    <script>
      // --- Avatar utilisateur moderne dans la sidebar (en bas sous la date) ---
      document.addEventListener("DOMContentLoaded", function () {
        // SÉPARATION STRICTE : NE JAMAIS lire la clé respacconierUser ici !
        // On utilise uniquement la clé 'user' pour le profil du dashboard
        let user = window.currentUser ||
          JSON.parse(localStorage.getItem("user")) || {
            nom: "",
            profil: "",
            photo: "",
            email: "",
          };
        const avatarCircle = document.getElementById("userAvatarCircle");
        const userName = document.getElementById("userNameSidebar");
        const userProfil = document.getElementById("userProfilSidebar");
        // Ajout d'un affichage email sous le nom
        if (avatarCircle && userName && userProfil) {
          // Afficher initiales ou photo
          if (user.photo) {
            avatarCircle.innerHTML = `<img src="${user.photo}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
          } else if (user.nom && user.nom.length > 0) {
            const initiales = user.nom
              .split(" ")
              .map((n) => n[0])
              .join("")
              .substring(0, 2)
              .toUpperCase();
            avatarCircle.innerHTML = initiales;
          }
          userName.textContent = user.nom || "";
          userProfil.textContent = user.profil || "";
          // Affichage email sous le nom
          let emailDiv = document.getElementById("userEmailSidebar");
          if (!emailDiv) {
            emailDiv = document.createElement("div");
            emailDiv.id = "userEmailSidebar";
            emailDiv.style.fontSize = "0.97em";
            emailDiv.style.color = "#374151";
            emailDiv.style.textAlign = "center";
            emailDiv.style.maxWidth = "140px";
            emailDiv.style.overflow = "hidden";
            emailDiv.style.textOverflow = "ellipsis";
            emailDiv.style.whiteSpace = "nowrap";
            userName.parentNode.insertBefore(emailDiv, userProfil);
          }
          emailDiv.textContent = user.email || "";
        }
        // Popup profil détaillé au clic sur l'avatar
        let popup = null;
        if (avatarCircle) {
          avatarCircle.onclick = function (e) {
            e.stopPropagation();
            if (popup) {
              popup.remove();
              popup = null;
              return;
            }
            popup = document.createElement("div");
            popup.style.position = "fixed";
            popup.style.bottom = "32px";
            popup.style.left =
              avatarCircle.getBoundingClientRect().left - 30 + "px";
            popup.style.background = "#fff";
            popup.style.boxShadow = "0 8px 32px #2563eb22";
            popup.style.borderRadius = "1rem";
            popup.style.padding = "22px 32px 18px 32px";
            popup.style.zIndex = 10001;
            popup.style.minWidth = "210px";
            popup.style.fontFamily = "Inter,Segoe UI,sans-serif";
            popup.innerHTML = `
              <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
                <div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#2563eb 60%,#06b6d4 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-size:2em;font-weight:700;box-shadow:0 2px 8px #2563eb22;">${
                  user.photo
                    ? `<img src='${user.photo}' alt='avatar' style='width:100%;height:100%;object-fit:cover;border-radius:50%;'>`
                    : user.nom
                    ? user.nom
                        .split(" ")
                        .map((n) => n[0])
                        .join("")
                        .substring(0, 2)
                        .toUpperCase()
                    : ""
                }</div>
                <div style="font-size:1.12em;font-weight:700;color:#2563eb;text-align:center;">${
                  user.nom || ""
                }</div>
                <div style="font-size:1em;color:#374151;text-align:center;">${
                  user.profil || ""
                }</div>
                <button id='logoutPopupBtn' style='margin-top:10px;background:linear-gradient(90deg,#2563eb 0%,#06b6d4 100%);color:#fff;border:none;border-radius:8px;padding:7px 18px;font-size:0.98em;font-weight:600;box-shadow:0 2px 8px #2563eb22;cursor:pointer;transition:filter 0.18s;'>Se déconnecter</button>
              </div>
            `;
            document.body.appendChild(popup);
            // Fermer au clic extérieur
            setTimeout(() => {
              document.addEventListener("click", closePopup, { once: true });
            }, 10);
            function closePopup(ev) {
              if (popup && !popup.contains(ev.target)) {
                popup.remove();
                popup = null;
              }
            }
            // Déconnexion depuis le popup
            const logoutBtn = popup.querySelector("#logoutPopupBtn");
            if (logoutBtn) {
              logoutBtn.onclick = function () {
                // À adapter selon votre logique de déconnexion
                localStorage.removeItem("user");
                window.location.href = "index.html";
              };
            }
          };
        }
        // Déconnexion directe depuis le sidebar
        const logoutSidebarBtn = document.getElementById("logoutSidebarBtn");
        if (logoutSidebarBtn) {
          logoutSidebarBtn.onclick = function () {
            localStorage.removeItem("user");
            window.location.href = "index.html";
          };
        }
      });
    </script>
    <script>
      // --- Avatar utilisateur dans la sidebar ---
      document.addEventListener("DOMContentLoaded", function () {
        // Simuler récupération du nom et profil utilisateur (à remplacer par vos données réelles)
        let user = window.currentUser || {
          nom: "Utilisateur",
          profil: "Employé",
        };
        // Si vous avez une variable globale ou un stockage local, utilisez-la ici
        // Exemple : user = JSON.parse(localStorage.getItem('user')) || user;
        const avatar = document.getElementById("userAvatarSidebar");
        const avatarCircle = document.getElementById("userAvatarCircle");
        if (avatar && avatarCircle) {
          // Afficher initiales ou icône
          if (user.nom && user.nom.length > 0) {
            const initiales = user.nom
              .split(" ")
              .map((n) => n[0])
              .join("")
              .substring(0, 2)
              .toUpperCase();
            avatarCircle.innerHTML = initiales;
          }
          // Affichage du popup profil
          let popup = null;
          avatar.onclick = function (e) {
            e.stopPropagation();
            if (popup) {
              popup.remove();
              popup = null;
              return;
            }
            popup = document.createElement("div");
            popup.style.position = "fixed";
            popup.style.top = avatar.getBoundingClientRect().bottom + 8 + "px";
            popup.style.left =
              avatar.getBoundingClientRect().right - 180 + "px";
            popup.style.background = "#fff";
            popup.style.boxShadow = "0 8px 32px #2563eb22";
            popup.style.borderRadius = "1rem";
            popup.style.padding = "18px 28px 14px 28px";
            popup.style.zIndex = 10001;
            popup.style.minWidth = "180px";
            popup.style.fontFamily = "Inter,Segoe UI,sans-serif";
            popup.innerHTML = `
              <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                <div style="width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,#2563eb 60%,#06b6d4 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.5em;font-weight:700;box-shadow:0 2px 8px #2563eb22;">${
                  user.nom
                    ? user.nom
                        .split(" ")
                        .map((n) => n[0])
                        .join("")
                        .substring(0, 2)
                        .toUpperCase()
                    : ""
                }</div>
                <div style="font-size:1.08em;font-weight:700;color:#2563eb;text-align:center;">${
                  user.nom || ""
                }</div>
                <div style="font-size:0.98em;color:#374151;text-align:center;">${
                  user.profil || ""
                }</div>
              </div>
            `;
            document.body.appendChild(popup);
            // Fermer au clic extérieur
            setTimeout(() => {
              document.addEventListener("click", closePopup, { once: true });
            }, 10);
            function closePopup(ev) {
              if (popup && !popup.contains(ev.target)) {
                popup.remove();
                popup = null;
              }
            }
          };
        }
      });
    </script>
    <script>
      // --- Gestion du bouton demande code entreprisJESUS ---
      document.addEventListener("DOMContentLoaded", function () {
        const demandeBtn = document.getElementById("demandeCodeEntrepriseBtn");
        const popup = document.getElementById("popupDemandeCodeEntreprise");
        const closeBtn = document.getElementById("closeDemandeCodeEntreprise");
        const envoyerBtn = document.getElementById("envoyerDemandeCodeBtn");
        const msgDiv = document.getElementById("demandeCodeEntrepriseMsg");
        if (demandeBtn && popup) {
          demandeBtn.onclick = function () {
            popup.style.display = "flex";
            msgDiv.textContent = "";
          };
        }
        if (closeBtn && popup) {
          closeBtn.onclick = function () {
            popup.style.display = "none";
          };
          popup.addEventListener("click", function (e) {
            if (e.target === popup) popup.style.display = "none";
          });
        }
        if (envoyerBtn) {
          envoyerBtn.onclick = async function () {
            const nom = document.getElementById("demandeCodeNom").value.trim();
            const email = document
              .getElementById("demandeCodeEmail")
              .value.trim();
            const message = document
              .getElementById("demandeCodeMessage")
              .value.trim();
            msgDiv.textContent = "";
            if (!nom || !email) {
              msgDiv.textContent = "Veuillez renseigner votre nom et email.";
              msgDiv.style.color = "#dc3545";
              return;
            }
            envoyerBtn.disabled = true;
            envoyerBtn.textContent = "Envoi...";
            try {
              // Appel backend SHBSKJà adapter selon ta routesgjhkj
              const res = await fetch("/api/demande-code-entreprise", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nom, email, message }),
              });
              const data = await res.json();
              if (res.ok && data.success) {
                s;
                msgDiv.textContent =
                  "Demande envoyée ! Vous recevrez le code par email.";
                msgDiv.style.color = "#059669";
                document.getElementById("demandeCodeNom").value = "";
                document.getElementById("demandeCodeEmail").value = "";
                document.getElementById("demandeCodeMessage").value = "";
              } else {
                msgDiv.textContent = data.message || "Erreur lors de l'envoi.";
                msgDiv.style.color = "#dc3545";
              }
            } catch (err) {
              msgDiv.textContent = "Erreur réseau ou serveur. Réessayez.";
              msgDiv.style.color = "#dc3545";
            }
            envoyerBtn.disabled = false;
            envoyerBtn.textContent = "Envoyer la demande";
          };
        }
      });
    </script>
    <!-- --- WebSocket pour synchroniser la liste des dossiers en retard en temps réel --- -->
    <script>
      (function () {
        let ws;
        function connectWebSocket() {
          const wsUrl =
            window.location.hostname === "localhost"
              ? "ws://localhost:3000"
              : "wss://plateformdesuivie-its-service-1cjx.onrender.com";
          ws = new WebSocket(wsUrl);
          ws.onopen = function () {};
          ws.onmessage = function (event) {
            try {
              const data = JSON.parse(event.data);

              // === GESTION DES CHANGEMENTS DE STATUT POUR LES COMPTEURS ===
              if (data.type === "status-change" && data.statusChange) {
                console.log(
                  "[DASHBOARD] 🎯 Changement de statut reçu:",
                  data.statusChange
                );

                // Afficher l'alerte
                showCustomAlert(data.message || "Statut mis à jour", "success");

                // Mettre à jour les compteurs immédiatement selon l'action spécifique
                if (typeof window.updateCardCounters === "function") {
                  setTimeout(() => {
                    window.updateCardCounters();
                  }, 100); // Petit délai pour assurer la persistence en base
                }

                // Actions spécifiques pour les transitions de cartes
                if (data.statusChange.action === "delivery_completed") {
                  console.log(
                    `[DASHBOARD] ✅ Transition: "${data.statusChange.dossierNumber}" Mise en livraison → Livré`
                  );
                } else if (data.statusChange.action === "delivery_started") {
                  console.log(
                    `[DASHBOARD] ⚡ Transition: "${data.statusChange.dossierNumber}" En attente → Mise en livraison (via conteneur)`
                  );
                }
              }

              // === NOUVELLE GESTION POUR SYNCHRONISATION DIRECTE DES CARTES ===
              if (
                (data.type === "status-change" && data.action) ||
                data.forceCounterUpdate
              ) {
                console.log(
                  "[DASHBOARD] 🔄 Synchronisation directe des cartes:",
                  data.action,
                  "pour dossier",
                  data.dossierNumber
                );

                // Mise à jour immédiate des compteurs sans délai
                if (typeof window.updateCardCounters === "function") {
                  window.updateCardCounters();
                }

                // Affichage spécifique selon le type de transition
                switch (data.action) {
                  case "delivery_completed":
                    showCustomAlert(
                      `✅ Dossier ${data.dossierNumber} complètement livré`,
                      "success"
                    );
                    break;
                  case "delivery_started":
                    showCustomAlert(
                      `🚛 Dossier ${data.dossierNumber} mis en livraison`,
                      "success"
                    );
                    break;
                  case "increment_mise_en_livraison_decrement_attente":
                    showCustomAlert(
                      `📋→🚛 Dossier ${data.dossierNumber} transféré en livraison`,
                      "success"
                    );
                    break;
                }
              }

              // === GESTION DES TRANSITIONS RESP_ACCONIER → RESP_LIV ===
              if (data.type === "dossier-entre-en-livraison") {
                console.log(
                  "[DASHBOARD] 📋→🚛 Dossier entre en livraison:",
                  data.dossierNumber
                );

                // Afficher l'alerte
                showCustomAlert(
                  `Dossier ${data.dossierNumber} mis en livraison`,
                  "success"
                );

                // Forcer la mise à jour des compteurs avec priorité sur ce type d'événement
                if (typeof window.updateCardCounters === "function") {
                  setTimeout(() => {
                    window.updateCardCounters();
                  }, 50); // Délai très court pour synchronisation rapide
                }
              }

              // === GESTION DES MISES À JOUR FORCÉES DE CONTENEURS ===
              if (
                data.type === "container_status_update" &&
                data.forceCounterUpdate
              ) {
                console.log(
                  "[DASHBOARD] 💥 Mise à jour forcée conteneur:",
                  `${data.containerNumber} -> ${data.status}`,
                  `(${data.deliveredCount}/${data.totalCount})`
                );

                // Afficher l'alerte
                showCustomAlert(
                  `Conteneur ${data.containerNumber} mis à jour: ${data.status}`,
                  "success"
                );

                // Forcer la mise à jour des compteurs immédiatement
                if (typeof window.updateCardCounters === "function") {
                  setTimeout(() => {
                    window.updateCardCounters();
                  }, 50);
                }
              }

              // Synchronisation précise du statut dossier dans la colonne "Responsable Acconier" ou "Statut Dossier" sans rechargement
              if (
                (data.type === "dossier-mise-en-livraison" ||
                  data.type === "bl_status_update" ||
                  data.type === "container_status_update") &&
                data.dossierNumber
              ) {
                // Affiche l'alerte personnalisée pour les autres types
                if (!data.forceCounterUpdate) {
                  showCustomAlert(
                    `Le dossier ${data.dossierNumber} a été mis à jour.`,
                    "success"
                  );
                }

                // Mettre à jour les compteurs immédiatement
                if (typeof window.updateCardCounters === "function") {
                  window.updateCardCounters();
                }

                // Recharge dynamiquement la ligne du tableau concernée
                const table = document.querySelector(
                  "#tableSuiviDossiers, .table-suivi-dossiers"
                );
                if (table) {
                  const rows = table.querySelectorAll("tbody tr");
                  rows.forEach((row) => {
                    // Recherche par attribut data-dossier-id ou cellule dossier-id
                    if (
                      row.getAttribute("data-dossier-id") ==
                        data.dossierNumber ||
                      (row.querySelector(".dossier-id") &&
                        row.querySelector(".dossier-id").textContent.trim() ==
                          data.dossierNumber)
                    ) {
                      // Requête AJAX pour récupérer les données à jour du dossier
                      fetch(
                        `/deliveries/search?dossierNumber=${encodeURIComponent(
                          data.dossierNumber
                        )}`
                      )
                        .then((res) => res.json())
                        .then((result) => {
                          if (result && result.success && result.delivery) {
                            // Met à jour toutes les cellules de la ligne
                            const delivery = result.delivery;
                            // Adapter ici selon l'ordre des colonnes du tableau
                            // Exemple : [dossier-id, client, agent, statut, ...]
                            if (row.querySelector(".dossier-id")) {
                              row.querySelector(".dossier-id").textContent =
                                delivery.dossier_number || delivery.id;
                            }
                            if (row.querySelector(".client-nom")) {
                              row.querySelector(".client-nom").textContent =
                                delivery.client_name || "";
                            }
                            if (row.querySelector(".agent-nom")) {
                              row.querySelector(".agent-nom").textContent =
                                delivery.employee_name || "";
                            }
                            if (row.querySelector(".statut-dossier")) {
                              // Statut dynamique : "Mise en livraison" si livré, sinon "En attente de paiement"
                              let statut = "En attente de paiement";
                              // On considère livré si delivery.delivery_status_acconier contient "livraison"
                              if (
                                delivery.delivery_status_acconier &&
                                delivery.delivery_status_acconier
                                  .toLowerCase()
                                  .includes("livraison")
                              ) {
                                statut = "Mise en livraison";
                              }
                              row.querySelector(".statut-dossier").textContent =
                                statut;
                              row.querySelector(".statut-dossier").style.color =
                                statut === "Mise en livraison"
                                  ? "#059669"
                                  : "#f59e0b";
                              row.querySelector(
                                ".statut-dossier"
                              ).style.fontWeight = "700";
                            }
                            // Ajoutez ici d'autres cellules à mettre à jour si besoin
                          }
                        });
                    }
                  });
                }
                // Mise à jour de la carte "Dossiers en retard" en temps réel
                if (typeof updateCarteDossiersRetard === "function") {
                  updateCarteDossiersRetard();
                }
              }
            } catch (e) {
              console.error("[DASHBOARD] Erreur WebSocket:", e);
            }
          };
          ws.onclose = function () {
            setTimeout(connectWebSocket, 2000);
          };
        }
        // Nouvelle fonction pour mettre à jour la carte Dossiers en retard
        function updateCarteDossiersRetard() {
          // Sélectionne l'élément de la carte
          const carteRetard = document.querySelector(
            ".dossier-retard.etat-card"
          );
          if (!carteRetard) return;
          // Appel API pour récupérer la liste à jour
          fetch("/api/dossiers/retard")
            .then((res) => res.json())
            .then((dossiers) => {
              // Met à jour le nombre affiché sur la carte
              let count = Array.isArray(dossiers) ? dossiers.length : 0;
              // Cherche l'élément qui affiche le nombre (exemple: .etat-title ou .etat-desc)
              let title = carteRetard.querySelector(".etat-title");
              let desc = carteRetard.querySelector(".etat-desc");
              if (title) {
                title.textContent = `Dossiers en retard (${count})`;
              }
              if (desc) {
                desc.textContent =
                  count === 0
                    ? "Aucun dossier en retard."
                    : `${count} dossier${count > 1 ? "s" : ""} en retard.`;
              }
            })
            .catch(() => {
              // En cas d'erreur, affiche un message
              let title = carteRetard.querySelector(".etat-title");
              let desc = carteRetard.querySelector(".etat-desc");
              if (title) title.textContent = "Dossiers en retard";
              if (desc) desc.textContent = "Erreur de chargement.";
            });
        }
        // --- Ajout : fonction d'alerte personnalisée ---
        function showCustomAlert(message, type = "success") {
          let alertDiv = document.createElement("div");
          alertDiv.className = `custom-alert show ${type}`;
          alertDiv.textContent = message;
          alertDiv.style.position = "fixed";
          alertDiv.style.top = "32px";
          alertDiv.style.right = "32px";
          alertDiv.style.zIndex = "99999";
          alertDiv.style.padding = "18px 32px";
          alertDiv.style.background =
            type === "success" ? "#059669" : "#dc3545";
          alertDiv.style.color = "#fff";
          alertDiv.style.fontSize = "1.18em";
          alertDiv.style.borderRadius = "12px";
          alertDiv.style.boxShadow = "0 8px 32px #05966944";
          document.body.appendChild(alertDiv);
          setTimeout(() => {
            alertDiv.classList.remove("show");
            alertDiv.style.opacity = "0";
            setTimeout(() => alertDiv.remove(), 600);
          }, 3200);
        }
        connectWebSocket();

        // Fonction de debug temporaire pour diagnostiquer le problème des compteurs
        window.debugCardCounters = function () {
          console.log("🔍 [DEBUG] État actuel des cartes:");
          const cartes = [
            "carteAttentePaiement",
            "carteMiseLivraison",
            "carteLivre",
          ];
          cartes.forEach((cardId) => {
            const card = document.getElementById(cardId);
            if (card) {
              const counter = card.querySelector(".card-counter");
              const currentValue = counter
                ? counter.textContent
                : "AUCUN COMPTEUR";
              console.log(`  📊 ${cardId}: ${currentValue}`);
            }
          });

          // Forcer la mise à jour des compteurs
          console.log("🔄 Forcement de la mise à jour des compteurs...");
          window.updateCardCounters();
        };

        // Exécuter le debug dans 2 secondes après le chargement complet
        setTimeout(() => {
          console.log(
            "🚀 [SYNCHRONISATION] Initialisation de la synchronisation des cartes..."
          );

          // Vérifier que toutes les cartes existent
          const cartesRequises = [
            "carteAttentePaiement",
            "carteMiseLivraison",
            "carteLivre",
          ];
          const cartesManquantes = cartesRequises.filter(
            (id) => !document.getElementById(id)
          );

          if (cartesManquantes.length > 0) {
            console.error(
              "❌ [SYNCHRONISATION] Cartes manquantes:",
              cartesManquantes
            );
            return;
          }

          console.log("✅ [SYNCHRONISATION] Toutes les cartes sont présentes");

          // Première synchronisation
          window.updateCardCounters();

          // Programmer les synchronisations automatiques
          setInterval(() => {
            console.log("🔄 [SYNCHRONISATION] Mise à jour périodique...");
            window.updateCardCounters();
          }, 30000); // Toutes les 30 secondes

          console.log(
            "✅ [SYNCHRONISATION] Système de synchronisation initialisé"
          );
          console.log(
            "💡 [SYNCHRONISATION] Utilisez window.diagnoseTablóeDeBord() pour diagnostiquer"
          );
        }, 2000);

        // Ajouter une fonction globale pour forcer la correction manuelle si nécessaire
        window.fixCardCounters = function () {
          console.log("🔧 [MANUAL FIX] Correction manuelle des compteurs...");
          window.updateCardCounters();
        };
      })();
    </script>
  </body>
</html>
<!--CODE123-->
