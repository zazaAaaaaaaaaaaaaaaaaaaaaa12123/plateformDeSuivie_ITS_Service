<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test - Niveau de stockage</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container mt-5">
      <div class="row">
        <div class="col-12">
          <h1>Test du système de niveau de stockage</h1>
          <p class="text-muted">
            Démonstration du nouveau système de suivi du stockage des archives
          </p>

          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5><i class="fas fa-chart-pie me-2"></i>Interface de test</h5>
            </div>
            <div class="card-body">
              <button
                class="btn btn-primary"
                id="storageStatsBtn"
                data-bs-toggle="modal"
                data-bs-target="#storageStatsModal"
              >
                <i class="fas fa-chart-pie me-2"></i>
                Afficher le niveau de stockage
              </button>

              <div class="mt-3">
                <h6>Fonctionnalités implémentées :</h6>
                <ul>
                  <li>
                    ✅ API de calcul du stockage
                    (<code>/api/storage-stats</code>)
                  </li>
                  <li>
                    ✅ Fonction de recalcul manuel
                    (<code>/api/storage-stats/recalculate</code>)
                  </li>
                  <li>✅ Interface utilisateur moderne avec modale</li>
                  <li>✅ Calcul automatique lors de l'archivage</li>
                  <li>
                    ✅ Intégration dans les pages Archives et Tableau de bord
                  </li>
                  <li>✅ Visualisation par type d'archive</li>
                  <li>✅ Barre de progression avec code couleur</li>
                  <li>✅ Suivi de l'historique des variations</li>
                </ul>
              </div>

              <div class="mt-3">
                <h6>Mode démo :</h6>
                <button class="btn btn-success" id="loadDemoData">
                  <i class="fas fa-play me-2"></i>
                  Charger des données de démonstration
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modale Niveau de stockage -->
    <div
      class="modal fade"
      id="storageStatsModal"
      tabindex="-1"
      aria-labelledby="storageStatsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="storageStatsModalLabel">
              <i class="fas fa-chart-pie me-2"></i>Niveau de stockage des
              archives
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Fermer"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Loading Indicator -->
            <div id="storageStatsLoading" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden"
                  >Chargement des statistiques...</span
                >
              </div>
              <p class="mt-2 mb-0">Calcul des statistiques de stockage...</p>
            </div>

            <!-- Content -->
            <div id="storageStatsContent" style="display: none">
              <!-- Vue d'ensemble -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                      <h6 class="card-title">Espace utilisé</h6>
                      <h3 class="text-primary mb-0" id="totalSizeDisplay">-</h3>
                      <small class="text-muted" id="totalArchivesCount"
                        >0 archives</small
                      >
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                      <h6 class="card-title">Pourcentage d'utilisation</h6>
                      <h3 class="mb-0" id="usagePercentageDisplay">0%</h3>
                      <small class="text-muted" id="maxStorageDisplay"
                        >sur 10 GB</small
                      >
                    </div>
                  </div>
                </div>
              </div>

              <!-- Barre de progression -->
              <div class="mb-4">
                <label class="form-label">Utilisation du stockage</label>
                <div class="progress" style="height: 20px">
                  <div
                    class="progress-bar"
                    id="storageProgressBar"
                    role="progressbar"
                    style="width: 0%"
                    aria-valuenow="0"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  >
                    0%
                  </div>
                </div>
              </div>

              <!-- Détail par type de dossier -->
              <div class="row">
                <div class="col-12">
                  <h6>Répartition par type d'archive</h6>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Type d'action</th>
                          <th>Taille</th>
                          <th>Pourcentage</th>
                        </tr>
                      </thead>
                      <tbody id="storageByTypeTable">
                        <!-- Content will be populated by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Dernière mise à jour -->
              <div class="mt-3">
                <small class="text-muted">
                  <i class="fas fa-clock me-1"></i>
                  Dernière mise à jour : <span id="lastUpdatedDisplay">-</span>
                </small>
              </div>
            </div>

            <!-- Error Display -->
            <div
              id="storageStatsError"
              class="alert alert-danger"
              style="display: none"
            >
              <i class="fas fa-exclamation-triangle me-2"></i>
              <span id="storageStatsErrorMessage"
                >Erreur lors du chargement des statistiques</span
              >
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              id="recalculateStorageBtn"
              title="Recalculer toutes les tailles de stockage"
            >
              <i class="fas fa-sync-alt me-1"></i>Recalculer
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Fermer
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Version simplifiée du gestionnaire de stockage pour la démo
      class DemoStorageStatsManager {
        constructor() {
          this.modal = null;
          this.lastStats = null;
          this.init();
        }

        init() {
          this.modal = document.getElementById("storageStatsModal");
          this.bindEvents();
          console.log(
            "[STORAGE DEMO] Gestionnaire de stockage démonstration initialisé"
          );
        }

        bindEvents() {
          // Événement lors de l'ouverture de la modale
          if (this.modal) {
            this.modal.addEventListener("shown.bs.modal", () => {
              this.loadStorageStats();
            });
          }

          // Bouton de recalcul
          const recalculateBtn = document.getElementById(
            "recalculateStorageBtn"
          );
          if (recalculateBtn) {
            recalculateBtn.addEventListener("click", () => {
              this.recalculateStorage();
            });
          }

          // Bouton de démonstration
          const loadDemoBtn = document.getElementById("loadDemoData");
          if (loadDemoBtn) {
            loadDemoBtn.addEventListener("click", () => {
              this.loadDemoData();
            });
          }
        }

        async loadStorageStats() {
          try {
            this.showLoading();
            console.log(
              "[STORAGE DEMO] Chargement des statistiques de stockage..."
            );

            // Simuler un délai de chargement
            await new Promise((resolve) => setTimeout(resolve, 1500));

            // Données de démonstration
            const demoStats = {
              totalSizeBytes: 2684354560, // ~2.5 GB
              totalSizeFormatted: "2.50 GB",
              maxStorageBytes: 10737418240, // 10 GB
              maxStorageFormatted: "10.00 GB",
              usagePercentage: 25,
              sizeByType: {
                suppression: {
                  bytes: 1342177280,
                  formatted: "1.25 GB",
                },
                livraison: {
                  bytes: 805306368,
                  formatted: "768.00 MB",
                },
                mise_en_livraison: {
                  bytes: 402653184,
                  formatted: "384.00 MB",
                },
                ordre_livraison_etabli: {
                  bytes: 134217728,
                  formatted: "128.00 MB",
                },
              },
              totalArchives: 1247,
              processedArchives: 1247,
              history: [
                {
                  date: "2025-08-22",
                  archives_count: 15,
                  daily_size: 104857600,
                },
                {
                  date: "2025-08-21",
                  archives_count: 23,
                  daily_size: 157286400,
                },
              ],
              lastUpdated: new Date().toISOString(),
            };

            this.lastStats = demoStats;
            this.displayStats(demoStats);
            this.hideLoading();

            console.log("[STORAGE DEMO] Statistiques chargées:", demoStats);
          } catch (error) {
            console.error("[STORAGE DEMO] Erreur lors du chargement:", error);
            this.showError(
              "Impossible de charger les statistiques de stockage: " +
                error.message
            );
            this.hideLoading();
          }
        }

        loadDemoData() {
          alert(
            "📊 Données de démonstration chargées !\n\n" +
              "• Espace utilisé : 2.50 GB sur 10.00 GB (25%)\n" +
              "• Total archives : 1,247 dossiers\n" +
              "• Répartition :\n" +
              "  - Supprimés : 1.25 GB\n" +
              "  - Livrés : 768 MB\n" +
              "  - En livraison : 384 MB\n" +
              "  - Ordres : 128 MB\n\n" +
              "Cliquez sur le bouton 'Niveau de stockage' pour voir l'interface !"
          );
        }

        async recalculateStorage() {
          try {
            const recalculateBtn = document.getElementById(
              "recalculateStorageBtn"
            );
            const originalText = recalculateBtn.innerHTML;

            // Désactiver le bouton et afficher le spinner
            recalculateBtn.disabled = true;
            recalculateBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin me-1"></i>Recalcul en cours...';

            console.log("[STORAGE DEMO] Démarrage du recalcul des tailles...");

            // Simuler le recalcul
            await new Promise((resolve) => setTimeout(resolve, 3000));

            console.log("[STORAGE DEMO] Recalcul terminé");

            // Recharger les statistiques
            await this.loadStorageStats();

            // Réactiver le bouton
            recalculateBtn.disabled = false;
            recalculateBtn.innerHTML = originalText;

            // Afficher une notification de succès
            this.showSuccessMessage(
              "Recalcul terminé: 1247 archives mises à jour"
            );
          } catch (error) {
            console.error("[STORAGE DEMO] Erreur lors du recalcul:", error);

            // Réactiver le bouton
            const recalculateBtn = document.getElementById(
              "recalculateStorageBtn"
            );
            if (recalculateBtn) {
              recalculateBtn.disabled = false;
              recalculateBtn.innerHTML =
                '<i class="fas fa-sync-alt me-1"></i>Recalculer';
            }

            this.showError("Erreur lors du recalcul: " + error.message);
          }
        }

        displayStats(stats) {
          try {
            // Affichage principal
            const totalSizeEl = document.getElementById("totalSizeDisplay");
            const totalArchivesEl =
              document.getElementById("totalArchivesCount");
            const usagePercentageEl = document.getElementById(
              "usagePercentageDisplay"
            );
            const maxStorageEl = document.getElementById("maxStorageDisplay");

            if (totalSizeEl) totalSizeEl.textContent = stats.totalSizeFormatted;
            if (totalArchivesEl)
              totalArchivesEl.textContent = `${stats.totalArchives} archive${
                stats.totalArchives > 1 ? "s" : ""
              }`;
            if (usagePercentageEl)
              usagePercentageEl.textContent = `${stats.usagePercentage}%`;
            if (maxStorageEl)
              maxStorageEl.textContent = `sur ${stats.maxStorageFormatted}`;

            // Barre de progression
            const progressBar = document.getElementById("storageProgressBar");
            if (progressBar) {
              const percentage = Math.min(stats.usagePercentage, 100);
              progressBar.style.width = `${percentage}%`;
              progressBar.textContent = `${percentage}%`;
              progressBar.setAttribute("aria-valuenow", percentage);

              // Couleur de la barre selon le niveau d'utilisation
              progressBar.className = "progress-bar";
              if (percentage < 50) {
                progressBar.classList.add("bg-success");
              } else if (percentage < 80) {
                progressBar.classList.add("bg-warning");
              } else {
                progressBar.classList.add("bg-danger");
              }
            }

            // Tableau par type
            this.displayTypeBreakdown(stats);

            // Dernière mise à jour
            const lastUpdatedEl = document.getElementById("lastUpdatedDisplay");
            if (lastUpdatedEl) {
              const lastUpdated = new Date(stats.lastUpdated).toLocaleString(
                "fr-FR"
              );
              lastUpdatedEl.textContent = lastUpdated;
            }
          } catch (error) {
            console.error("[STORAGE DEMO] Erreur lors de l'affichage:", error);
            this.showError("Erreur lors de l'affichage des statistiques");
          }
        }

        displayTypeBreakdown(stats) {
          const tableBody = document.getElementById("storageByTypeTable");
          if (!tableBody) return;

          tableBody.innerHTML = "";

          const typeLabels = {
            suppression: "Dossiers supprimés",
            livraison: "Dossiers livrés",
            mise_en_livraison: "Mise en livraison",
            ordre_livraison_etabli: "Ordre de livraison établi",
          };

          const totalSize = stats.totalSizeBytes;

          Object.entries(stats.sizeByType).forEach(([type, data]) => {
            const row = document.createElement("tr");
            const percentage =
              totalSize > 0 ? Math.round((data.bytes / totalSize) * 100) : 0;

            row.innerHTML = `
                        <td>
                            <i class="fas fa-${this.getTypeIcon(
                              type
                            )} me-2 text-muted"></i>
                            ${typeLabels[type] || type}
                        </td>
                        <td><strong>${data.formatted}</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="me-2">${percentage}%</span>
                                <div class="progress flex-grow-1" style="height: 8px; width: 60px;">
                                    <div 
                                        class="progress-bar bg-secondary" 
                                        style="width: ${percentage}%"
                                    ></div>
                                </div>
                            </div>
                        </td>
                    `;

            tableBody.appendChild(row);
          });
        }

        getTypeIcon(type) {
          const icons = {
            suppression: "trash",
            livraison: "truck",
            mise_en_livraison: "shipping-fast",
            ordre_livraison_etabli: "clipboard-list",
          };
          return icons[type] || "archive";
        }

        showLoading() {
          const loadingEl = document.getElementById("storageStatsLoading");
          const contentEl = document.getElementById("storageStatsContent");
          const errorEl = document.getElementById("storageStatsError");

          if (loadingEl) loadingEl.style.display = "block";
          if (contentEl) contentEl.style.display = "none";
          if (errorEl) errorEl.style.display = "none";
        }

        hideLoading() {
          const loadingEl = document.getElementById("storageStatsLoading");
          const contentEl = document.getElementById("storageStatsContent");

          if (loadingEl) loadingEl.style.display = "none";
          if (contentEl) contentEl.style.display = "block";
        }

        showError(message) {
          const errorEl = document.getElementById("storageStatsError");
          const errorMessageEl = document.getElementById(
            "storageStatsErrorMessage"
          );
          const contentEl = document.getElementById("storageStatsContent");
          const loadingEl = document.getElementById("storageStatsLoading");

          if (errorEl) errorEl.style.display = "block";
          if (errorMessageEl) errorMessageEl.textContent = message;
          if (contentEl) contentEl.style.display = "none";
          if (loadingEl) loadingEl.style.display = "none";
        }

        showSuccessMessage(message) {
          // Créer une notification temporaire
          this.createTempNotification(message, "success");
        }

        createTempNotification(message, type = "info") {
          const notification = document.createElement("div");
          notification.className = `alert alert-${
            type === "success" ? "success" : "info"
          } position-fixed`;
          notification.style.cssText = `
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    min-width: 300px;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
          notification.innerHTML = `
                    <i class="fas fa-${
                      type === "success" ? "check-circle" : "info-circle"
                    } me-2"></i>
                    ${message}
                `;

          document.body.appendChild(notification);

          // Animation d'apparition
          setTimeout(() => {
            notification.style.opacity = "1";
          }, 100);

          // Suppression automatique après 4 secondes
          setTimeout(() => {
            notification.style.opacity = "0";
            setTimeout(() => {
              document.body.removeChild(notification);
            }, 300);
          }, 4000);
        }
      }

      // Initialisation automatique
      document.addEventListener("DOMContentLoaded", () => {
        new DemoStorageStatsManager();
      });
    </script>
  </body>
</html>
