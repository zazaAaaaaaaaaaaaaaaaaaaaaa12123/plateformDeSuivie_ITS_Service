<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portail Client - Société de Transit</title>
    <!-- TAILWIND CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FONT AWESOME -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- STYLE PERSONNALISÉ -->
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      @keyframes fade-in-up {
        0% {
          opacity: 0;
          transform: translateY(60px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in-up {
        animation: fade-in-up 1.2s cubic-bezier(0.4, 0, 0.2, 1) both;
      }
      @keyframes fade-in {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }
      .animate-fade-in {
        animation: fade-in 1.5s cubic-bezier(0.4, 0, 0.2, 1) both;
      }
      @keyframes gradient-text {
        0% {
          background-position: 0% 50%;
        }
        100% {
          background-position: 100% 50%;
        }
      }
      .animate-gradient-text {
        background-size: 200% 200%;
        animation: gradient-text 3s ease-in-out infinite alternate;
      }
      @keyframes float {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-20px);
        }
        100% {
          transform: translateY(0);
        }
      }
      .animate-float {
        animation: float 3s ease-in-out infinite;
      }
      .bg-blur {
        backdrop-filter: blur(4px);
      }
    </style>
  </head>
  <body
    class="relative min-h-screen w-full overflow-hidden flex flex-col bg-white"
  >
    <!-- Animation de présentation ENTIÈRE PAGE -->
    <section
      class="absolute inset-0 z-30 flex items-center justify-center w-full h-full"
    >
      <!-- Dégradé dominant blanc, touches bleu et jaune -->
      <div
        class="absolute inset-0 bg-gradient-to-br from-white via-blue-100 to-yellow-100"
      ></div>
      <div class="absolute inset-0 pointer-events-none">
        <!-- Cercles décoratifs bleu et jaune -->
        <div
          class="absolute top-[-100px] left-[-100px] w-[350px] h-[350px] rounded-full bg-blue-200 opacity-40 blur-2xl"
        ></div>
        <div
          class="absolute bottom-[-120px] right-[-120px] w-[400px] h-[400px] rounded-full bg-yellow-200 opacity-40 blur-2xl"
        ></div>
        <div
          class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[200px] rounded-full bg-blue-50 opacity-30 blur-2xl"
        ></div>
      </div>
      <div
        class="relative z-10 flex flex-col items-center justify-center w-full h-full"
      >
        <!-- Illustration animée -->
        <div class="mb-10 animate-float">
          <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
            <circle cx="60" cy="60" r="55" fill="#facc15" fill-opacity="0.18" />
            <circle cx="60" cy="60" r="40" fill="#2563eb" fill-opacity="0.10" />
            <circle cx="60" cy="60" r="28" fill="#2563eb" fill-opacity="0.22" />
            <circle cx="60" cy="60" r="18" fill="#facc15" fill-opacity="0.5" />
            <circle cx="60" cy="60" r="8" fill="#2563eb" />
          </svg>
        </div>
        <h1
          class="text-5xl md:text-7xl font-extrabold animate-gradient-text bg-gradient-to-r from-blue-700 via-yellow-400 to-blue-400 bg-clip-text text-transparent drop-shadow-lg mb-6 animate-fade-in-up"
        >
          Bienvenue sur ITS Service
        </h1>
        <p
          class="text-2xl md:text-3xl text-blue-900 mb-10 font-medium animate-fade-in"
          style="animation-delay: 0.5s"
        >
          Gérez vos opérations en toute simplicité et sécurité.<br />
          <span class="font-extrabold text-yellow-400 text-3xl"
            >ITS Service</span
          >
          accompagne les entreprises au quotidien.
        </p>
        <div
          class="flex flex-col md:flex-row justify-center gap-8 mt-4 animate-fade-in"
          style="animation-delay: 1s"
        >
          <button
            id="ctaLogin"
            class="bg-blue-700 hover:bg-yellow-400 hover:text-blue-900 text-white font-bold py-4 px-12 rounded-2xl shadow-xl text-2xl transition duration-200"
          >
            Se connecter
          </button>
        </div>
      </div>
    </section>

    <!-- NAVBAR -->
    <nav
      class="relative z-40 w-full flex justify-between items-center px-8 py-4 bg-blue-900 shadow-lg"
    >
      <a href="index.html" class="flex items-center gap-2">
        <span class="text-2xl font-bold text-yellow-300 tracking-wide"
          >ITS Service</span
        >
      </a>
      <div class="flex gap-4">
        <button
          id="accessRequestBtn"
          class="bg-yellow-400 hover:bg-yellow-300 text-blue-900 font-bold py-2 px-6 rounded-lg shadow transition duration-200"
        >
          <i class="fa-solid fa-key mr-2"></i>Demande d'accès
        </button>
        <button
          id="openLoginBtn"
          class="bg-blue-700 hover:bg-yellow-400 hover:text-blue-900 text-white font-bold py-2 px-6 rounded-lg shadow transition duration-200"
        >
          <i class="fa-solid fa-right-to-bracket mr-2"></i>Se connecter
        </button>
        <button
          id="logoutBtn"
          class="hidden bg-yellow-400 hover:bg-yellow-300 text-blue-900 font-bold py-2 px-6 rounded-lg shadow transition duration-200"
        >
          <i class="fa-solid fa-right-from-bracket mr-2"></i>Déconnexion
        </button>
      </div>
    </nav>

    <!-- LOGIN CARD (modale) -->
    <div
      id="loginModal"
      class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden"
    >
      <div
        class="w-full max-w-md bg-white/90 rounded-2xl shadow-2xl p-8 flex flex-col gap-6 relative"
      >
        <button
          onclick="closeLoginModal()"
          class="absolute top-3 right-4 text-blue-700 hover:text-yellow-500 text-xl"
        >
          <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="text-center">
          <h2 class="text-3xl font-extrabold text-blue-900 mb-2">
            Connexion Utilisateur
          </h2>
          <p class="text-blue-700">
            Accédez à votre espace personnel avec vos identifiants
          </p>
        </div>
        <form id="loginForm" autocomplete="off" class="flex flex-col gap-4">
          <div>
            <label
              for="loginEmail"
              class="block text-blue-900 font-semibold mb-1"
              >Email</label
            >
            <input
              type="email"
              id="loginEmail"
              class="w-full px-4 py-2 border-2 border-blue-200 rounded-lg focus:outline-none focus:border-yellow-400 transition"
              placeholder="Votre email"
              required
            />
          </div>
          <div>
            <label
              for="loginPassword"
              class="block text-blue-900 font-semibold mb-1"
              >Code d'accès</label
            >
            <p class="text-xs text-gray-600 mb-2">
              Utilisez uniquement le code d'accès envoyé par email après
              approbation de votre demande
            </p>
            <div class="relative">
              <input
                type="password"
                id="loginPassword"
                maxlength="15"
                class="w-full px-4 py-2 border-2 border-blue-200 rounded-lg focus:outline-none focus:border-yellow-400 transition pr-12"
                placeholder="Code d'accès fourni"
                required
              />
              <button
                type="button"
                onclick="togglePw(this, 'loginPassword')"
                class="absolute right-2 top-2 text-blue-700 hover:text-yellow-500"
              >
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
          </div>
          <div id="loginError" class="text-sm text-red-600"></div>
          <button
            type="submit"
            class="bg-blue-700 hover:bg-yellow-400 hover:text-blue-900 text-white font-bold py-2 rounded-lg shadow transition duration-200"
          >
            Se connecter
          </button>
          <div class="text-center mt-4">
            <button
              type="button"
              onclick="openForgotPasswordModal()"
              class="text-blue-700 hover:text-yellow-500 text-sm underline"
            >
              Code d'accès oublié ?
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- FORGOT PASSWORD MODAL -->
    <div
      id="forgotPasswordModal"
      class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden"
    >
      <div
        class="w-full max-w-md bg-white/90 rounded-2xl shadow-2xl p-8 flex flex-col gap-6 relative"
      >
        <button
          onclick="closeForgotPasswordModal()"
          class="absolute top-3 right-4 text-blue-700 hover:text-yellow-500 text-xl"
        >
          <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="text-center">
          <h2 class="text-3xl font-extrabold text-blue-900 mb-2">
            Code d'accès oublié
          </h2>
          <p class="text-blue-700">
            Saisissez votre email pour demander un nouveau code d'accès
          </p>
        </div>
        <form
          id="forgotPasswordForm"
          autocomplete="off"
          class="flex flex-col gap-4"
        >
          <div>
            <label
              for="forgotEmail"
              class="block text-blue-900 font-semibold mb-1"
              >Email</label
            >
            <input
              type="email"
              id="forgotEmail"
              class="w-full px-4 py-2 border-2 border-blue-200 rounded-lg focus:outline-none focus:border-yellow-400 transition"
              placeholder="Votre email"
              required
            />
          </div>
          <div id="forgotError" class="text-sm text-red-600"></div>
          <button
            type="submit"
            id="sendForgotRequestBtn"
            class="bg-yellow-400 hover:bg-blue-700 hover:text-white text-blue-900 font-bold py-2 rounded-lg shadow transition duration-200 flex items-center justify-center"
          >
            <span id="sendForgotText">Demander un nouveau code</span>
            <span id="sendForgotLoading" class="hidden">
              <i class="fa-solid fa-spinner fa-spin mr-2"></i>Envoi en cours...
            </span>
          </button>
        </form>
      </div>
    </div>

    <!-- FORGOT PASSWORD SUCCESS MODAL -->
    <div
      id="forgotPasswordSuccessModal"
      class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden"
    >
      <div
        class="w-full max-w-md bg-white/90 rounded-2xl shadow-2xl p-8 flex flex-col gap-6 relative text-center"
      >
        <button
          onclick="closeForgotPasswordSuccessModal()"
          class="absolute top-3 right-4 text-blue-700 hover:text-yellow-500 text-xl"
        >
          <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="text-center">
          <div
            class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <i class="fa-solid fa-envelope text-blue-600 text-2xl"></i>
          </div>
          <h2 class="text-2xl font-extrabold text-blue-900 mb-2">
            Demande envoyée !
          </h2>
          <p class="text-blue-700 mb-4">
            Le nouveau code d'accès sera disponible sur votre email
          </p>
          <p class="text-sm text-blue-600">
            Veuillez vérifier votre boîte de réception. Si la demande est
            approuvée, vous recevrez votre nouveau code d'accès par email.
          </p>
        </div>
        <button
          onclick="closeForgotPasswordSuccessModal()"
          class="bg-blue-700 hover:bg-yellow-400 hover:text-blue-900 text-white font-bold py-2 rounded-lg shadow transition duration-200"
        >
          Compris
        </button>
      </div>
    </div>

    <!-- ACCESS REQUEST MODAL -->
    <div
      id="accessRequestModal"
      class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden"
    >
      <div
        class="w-full max-w-md bg-white/90 rounded-2xl shadow-2xl p-8 flex flex-col gap-6 relative"
      >
        <button
          onclick="closeAccessRequestModal()"
          class="absolute top-3 right-4 text-blue-700 hover:text-yellow-500 text-xl"
        >
          <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="text-center">
          <h2 class="text-3xl font-extrabold text-blue-900 mb-2">
            Demande d'accès
          </h2>
          <p class="text-blue-700">
            Demandez un accès à votre espace ITS Service
          </p>
        </div>
        <form
          id="accessRequestForm"
          autocomplete="off"
          class="flex flex-col gap-4"
        >
          <div>
            <label
              for="requestName"
              class="block text-blue-900 font-semibold mb-1"
              >Nom complet</label
            >
            <input
              type="text"
              id="requestName"
              class="w-full px-4 py-2 border-2 border-blue-200 rounded-lg focus:outline-none focus:border-yellow-400 transition"
              placeholder="Votre nom complet"
              required
            />
          </div>
          <div>
            <label
              for="requestEmail"
              class="block text-blue-900 font-semibold mb-1"
              >Email professionnel</label
            >
            <input
              type="email"
              id="requestEmail"
              class="w-full px-4 py-2 border-2 border-blue-200 rounded-lg focus:outline-none focus:border-yellow-400 transition"
              placeholder="votre.email@entreprise.com"
              required
            />
          </div>
          <div>
            <label
              for="requestDate"
              class="block text-blue-900 font-semibold mb-1"
              >Date de la demande</label
            >
            <input
              type="date"
              id="requestDate"
              class="w-full px-4 py-2 border-2 border-blue-200 rounded-lg focus:outline-none focus:border-yellow-400 transition"
              required
            />
          </div>
          <button
            type="submit"
            id="sendRequestBtn"
            class="bg-yellow-400 hover:bg-blue-700 hover:text-white text-blue-900 font-bold py-2 rounded-lg shadow transition duration-200 flex items-center justify-center"
          >
            <span id="sendRequestText">Envoyer la requête</span>
            <span id="sendRequestLoading" class="hidden">
              <i class="fa-solid fa-spinner fa-spin mr-2"></i>Envoi en cours...
            </span>
          </button>
        </form>
      </div>
    </div>

    <!-- ACCESS REQUEST SUCCESS MODAL -->
    <div
      id="accessRequestSuccessModal"
      class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden"
    >
      <div
        class="w-full max-w-md bg-white/90 rounded-2xl shadow-2xl p-8 flex flex-col gap-6 relative text-center"
      >
        <button
          onclick="closeAccessRequestSuccessModal()"
          class="absolute top-3 right-4 text-blue-700 hover:text-yellow-500 text-xl"
        >
          <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="text-center">
          <div
            class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <i class="fa-solid fa-check text-green-600 text-2xl"></i>
          </div>
          <h2 class="text-2xl font-extrabold text-blue-900 mb-2">
            Demande envoyée !
          </h2>
          <p class="text-blue-700 mb-4">
            Votre demande d'accès a été envoyée avec succès.
          </p>
          <p class="text-sm text-blue-600">
            Nous traitons votre requête... Vous recevrez vos identifiants de
            connexion par email une fois votre demande approuvée.
          </p>
        </div>
        <button
          onclick="closeAccessRequestSuccessModal()"
          class="bg-blue-700 hover:bg-yellow-400 hover:text-blue-900 text-white font-bold py-2 rounded-lg shadow transition duration-200"
        >
          Compris
        </button>
      </div>
    </div>

    <!-- ALERTE PERSONNALISÉE -->
    <div
      id="customAlert"
      class="fixed top-8 left-1/2 -translate-x-1/2 z-50 hidden bg-yellow-400 text-blue-900 font-bold px-6 py-3 rounded-lg shadow-lg border-2 border-blue-700"
    >
      <span id="customAlertMessage"></span>
    </div>

    <!-- SCRIPTS -->
    <script src="/js/script.js"></script>
    <script>
      // Ouvre/ferme les modales
      document.getElementById("openLoginBtn").onclick = () => {
        document.getElementById("loginModal").classList.remove("hidden");
      };
      document.getElementById("accessRequestBtn").onclick = () => {
        document
          .getElementById("accessRequestModal")
          .classList.remove("hidden");
        // Définir la date d'aujourd'hui par défaut
        document.getElementById("requestDate").value = new Date()
          .toISOString()
          .split("T")[0];
      };
      function closeLoginModal() {
        document.getElementById("loginModal").classList.add("hidden");
      }
      function closeAccessRequestModal() {
        document.getElementById("accessRequestModal").classList.add("hidden");
      }
      function closeAccessRequestSuccessModal() {
        document
          .getElementById("accessRequestSuccessModal")
          .classList.add("hidden");
      }
      function openForgotPasswordModal() {
        document.getElementById("loginModal").classList.add("hidden");
        document
          .getElementById("forgotPasswordModal")
          .classList.remove("hidden");
      }
      function closeForgotPasswordModal() {
        document.getElementById("forgotPasswordModal").classList.add("hidden");
      }
      function closeForgotPasswordSuccessModal() {
        document
          .getElementById("forgotPasswordSuccessModal")
          .classList.add("hidden");
      }

      // Fermer modale au clic sur fond noir
      document.getElementById("loginModal").onclick = (e) => {
        if (e.target.id === "loginModal") closeLoginModal();
      };
      document.getElementById("accessRequestModal").onclick = (e) => {
        if (e.target.id === "accessRequestModal") closeAccessRequestModal();
      };
      document.getElementById("accessRequestSuccessModal").onclick = (e) => {
        if (e.target.id === "accessRequestSuccessModal")
          closeAccessRequestSuccessModal();
      };
      document.getElementById("forgotPasswordModal").onclick = (e) => {
        if (e.target.id === "forgotPasswordModal") closeForgotPasswordModal();
      };
      document.getElementById("forgotPasswordSuccessModal").onclick = (e) => {
        if (e.target.id === "forgotPasswordSuccessModal")
          closeForgotPasswordSuccessModal();
      };

      // Affichage/Masquage code d'accès
      window.togglePw = function (btn, inputId) {
        const input = document.getElementById(inputId);
        if (input.type === "password") {
          input.type = "text";
          btn.querySelector("i").classList.remove("fa-eye");
          btn.querySelector("i").classList.add("fa-eye-slash");
        } else {
          input.type = "password";
          btn.querySelector("i").classList.remove("fa-eye-slash");
          btn.querySelector("i").classList.add("fa-eye");
        }
      };

      // Animation : boutons de présentation
      document.getElementById("ctaLogin").onclick = () => {
        document.getElementById("openLoginBtn").click();
      };

      // Gestion du formulaire de demande d'accès
      document
        .getElementById("accessRequestForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const name = document.getElementById("requestName").value.trim();
          const email = document.getElementById("requestEmail").value.trim();
          const date = document.getElementById("requestDate").value;

          if (!name || !email || !date) {
            alert("Veuillez remplir tous les champs.");
            return;
          }

          // Afficher le chargement
          document.getElementById("sendRequestText").classList.add("hidden");
          document
            .getElementById("sendRequestLoading")
            .classList.remove("hidden");
          document.getElementById("sendRequestBtn").disabled = true;

          // Simuler l'envoi de la requête (6 secondes)
          setTimeout(() => {
            // Appeler la fonction pour soumettre la demande
            if (window.submitAccessRequest) {
              window.submitAccessRequest({ name, email, date });
            }

            // Cacher le chargement
            document
              .getElementById("sendRequestText")
              .classList.remove("hidden");
            document
              .getElementById("sendRequestLoading")
              .classList.add("hidden");
            document.getElementById("sendRequestBtn").disabled = false;

            // Fermer la modale de demande
            closeAccessRequestModal();

            // Afficher la modale de succès
            document
              .getElementById("accessRequestSuccessModal")
              .classList.remove("hidden");

            // Réinitialiser le formulaire
            document.getElementById("accessRequestForm").reset();
          }, 2000); // 2 secondes de chargement
        });

      // Gestion du formulaire "code d'accès oublié"
      document
        .getElementById("forgotPasswordForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const email = document.getElementById("forgotEmail").value.trim();

          if (!email) {
            document.getElementById("forgotError").textContent =
              "Veuillez saisir votre email.";
            return;
          }

          // Afficher le chargement
          document.getElementById("sendForgotText").classList.add("hidden");
          document
            .getElementById("sendForgotLoading")
            .classList.remove("hidden");
          document.getElementById("sendForgotRequestBtn").disabled = true;

          // Envoyer la demande de nouveau code d'accès
          fetch("/api/forgot-access-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          })
            .then((res) => res.json())
            .then((data) => {
              // Cacher le chargement
              document
                .getElementById("sendForgotText")
                .classList.remove("hidden");
              document
                .getElementById("sendForgotLoading")
                .classList.add("hidden");
              document.getElementById("sendForgotRequestBtn").disabled = false;

              if (data.success) {
                // Fermer la modale de demande
                closeForgotPasswordModal();

                // Afficher la modale de succès
                document
                  .getElementById("forgotPasswordSuccessModal")
                  .classList.remove("hidden");

                // Réinitialiser le formulaire
                document.getElementById("forgotPasswordForm").reset();
                document.getElementById("forgotError").textContent = "";
              } else {
                document.getElementById("forgotError").textContent =
                  data.message || "Erreur lors de l'envoi de la demande.";
              }
            })
            .catch(() => {
              // Cacher le chargement
              document
                .getElementById("sendForgotText")
                .classList.remove("hidden");
              document
                .getElementById("sendForgotLoading")
                .classList.add("hidden");
              document.getElementById("sendForgotRequestBtn").disabled = false;

              document.getElementById("forgotError").textContent =
                "Erreur réseau.";
            });
        });

      // Redirection automatique vers tableauDeBord.html après connexion réussie
      document.addEventListener("DOMContentLoaded", function () {
        const loginForm = document.getElementById("loginForm");
        if (loginForm) {
          loginForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const email = document.getElementById("loginEmail").value.trim();
            const accessCode = document.getElementById("loginPassword").value;

            if (!email || !accessCode) {
              document.getElementById("loginError").textContent =
                "Veuillez remplir tous les champs.";
              return;
            }

            // Appel API pour la connexion avec le nouveau système
            fetch("/api/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password: accessCode }),
            })
              .then((res) => res.json())
              .then((data) => {
                if (data.success) {
                  // Stocke les infos utilisateur pour le dashboard
                  const userData = {
                    nom: data.nom || email.split("@")[0],
                    email: email,
                    profil: data.profil || "Responsable",
                    photo: data.photo || "",
                  };
                  localStorage.setItem("user", JSON.stringify(userData));
                  localStorage.setItem("userEmail", email);

                  // Pour la connexion depuis index.html, on redirige toujours vers le tableau de bord
                  // C'est l'interface utilisateur normal, pas l'interface admin
                  localStorage.removeItem("isAdminLoggedIn");

                  // Redirige vers le tableau de bord
                  window.location.href =
                    "https://dossiv.ci/html/tableauDeBord.html";
                } else {
                  document.getElementById("loginError").textContent =
                    data.message || "Email ou code d'accès incorrect.";
                }
              })
              .catch(() => {
                document.getElementById("loginError").textContent =
                  "Erreur réseau.";
              });
          });
        }
      });
    </script>
  </body>
</html>
