<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Suivi ITS - Livraisons</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Les liens vers les fichiers CSS locaux sont conserv√©s comme dans votre original.
         Assurez-vous que ces fichiers sont accessibles depuis le chemin relatif. -->
    <link rel="stylesheet" href="../css/styleDeSuivie.css" />
    <link rel="stylesheet" href="../css/styledeTabBord.css" />
    <link rel="stylesheet" href="../css/style.css" />

    <!-- CSS pour le mode admin (visualisation uniquement) -->
    <link rel="stylesheet" href="../css/adminMode.css" />

    <style>
      /* Couleurs titre et sous-titre en mode sombre */
      [data-theme="dark"] .main-title-acconier {
        color: #ffd600 !important;
      }
      [data-theme="dark"] .main-subtitle-acconier {
        color: #3b82f6 !important;
      }
      /* Variables CSS pour les th√®mes */
      :root {
        /* Mode Clair (par d√©faut) */
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-card: #ffffff;
        --bg-table: #ffffff;
        --bg-dropdown: #ffffff;
        --bg-header: #ffffff;
        --bg-filter: #f8fafc;
        --bg-button: #2563eb;
        --bg-button-hover: #1d4ed8;
        --bg-accent: #e0e7ef;
        --bg-floating: #1666e7;

        --text-primary: #0e274e;
        --text-secondary: #64748b;
        --text-muted: #64748b;
        --text-white: #ffffff;
        --text-button: #ffffff;

        --border-color: #e5e7eb;
        --border-input: #2563eb;
        --border-table: #e9ecef;

        --shadow-card: 0 4px 24px rgba(30, 41, 59, 0.07);
        --shadow-dropdown: 0 8px 32px rgba(30, 41, 59, 0.18);
        --shadow-table: 0 8px 32px rgba(37, 99, 235, 0.1);
        --shadow-filter: 0 2px 8px #2563eb11;

        --gradient-header: linear-gradient(90deg, #2563eb 0%, #1e293b 100%);
        --gradient-avatar: linear-gradient(135deg, #2563eb 60%, #1e293b 100%);
      }

      /* Mode Sombre */
      [data-theme="dark"] {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-card: #1e293b;
        --bg-table: #1e293b;
        --bg-dropdown: #1e293b;
        --bg-header: #1e293b;
        --bg-filter: #334155;
        --bg-button: #3b82f6;
        --bg-button-hover: #2563eb;
        --bg-accent: #334155;
        --bg-floating: #0f172a;

        --text-primary: #f1f5f9;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --text-white: #ffffff;
        --text-button: #ffffff;

        --border-color: #334155;
        --border-input: #3b82f6;
        --border-table: #334155;

        --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.3);
        --shadow-dropdown: 0 8px 32px rgba(0, 0, 0, 0.4);
        --shadow-table: 0 8px 32px rgba(59, 130, 246, 0.2);
        --shadow-filter: 0 2px 8px rgba(59, 130, 246, 0.1);

        --gradient-header: linear-gradient(90deg, #3b82f6 0%, #1e293b 100%);
        --gradient-avatar: linear-gradient(135deg, #3b82f6 60%, #1e293b 100%);
      }

      /* Application des variables aux √©l√©ments */
      body {
        background: var(--bg-primary) !important;
        color: var(--text-primary) !important;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .container-fluid {
        background: var(--bg-primary) !important;
      }

      /* S√©lecteur de th√®me */
      .theme-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 8px 0;
        padding: 8px 0;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
      }

      .theme-toggle {
        display: flex;
        align-items: center;
        background: var(--bg-accent);
        border-radius: 20px;
        padding: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        width: 100%;
        position: relative;
      }

      .theme-option {
        flex: 1;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 0.85em;
        font-weight: 600;
        text-align: center;
        transition: all 0.3s ease;
        background: transparent;
        color: var(--text-secondary);
        border: none;
        cursor: pointer;
      }

      .theme-option.active {
        background: var(--bg-button);
        color: var(--text-white);
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
      }

      .theme-icon {
        font-size: 0.9em;
        margin-right: 4px;
      }

      /* Styles sp√©cifiques pour le mode sombre */
      [data-theme="dark"] .sticky-col {
        background-color: var(--bg-secondary) !important;
      }

      [data-theme="dark"] .table {
        background-color: var(--bg-table);
        color: var(--text-primary);
      }

      [data-theme="dark"] .table th,
      [data-theme="dark"] .table td {
        border-color: var(--border-table);
        background-color: var(--bg-table);
        color: var(--text-primary);
      }

      [data-theme="dark"] .table tbody tr:hover {
        background-color: var(--bg-secondary) !important;
      }

      [data-theme="dark"] .btn-primary {
        background-color: var(--bg-button);
        border-color: var(--bg-button);
      }

      [data-theme="dark"] .btn-primary:hover {
        background-color: var(--bg-button-hover);
        border-color: var(--bg-button-hover);
      }

      [data-theme="dark"] input[type="date"],
      [data-theme="dark"] input[type="search"] {
        background-color: var(--bg-card);
        color: var(--text-primary);
        border-color: var(--border-input);
      }

      [data-theme="dark"] input[type="date"]:focus,
      [data-theme="dark"] input[type="search"]:focus {
        border-color: var(--bg-button);
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
      }

      [data-theme="dark"] .pagination .page-link {
        background-color: var(--bg-card);
        border-color: var(--border-color);
        color: var(--text-primary);
      }

      [data-theme="dark"] .pagination .page-link:hover {
        background-color: var(--bg-secondary);
        border-color: var(--border-input);
        color: var(--text-primary);
      }

      [data-theme="dark"] .pagination .page-item.active .page-link {
        /* Champ de recherche en vert en mode admin */
        body.admin-view-mode #searchInput,
        body.admin-view-mode .search-input,
        body.admin-view-mode input[placeholder*="Recherche"],
        body.admin-view-mode input[placeholder*="recherche"] {
          color: #28a745 !important;
          font-weight: 600 !important;
        }
        background-color: var(--bg-button);
        border-color: var(--bg-button);
      }

      /* Styles sp√©cifiques pour le mode sombre - Overlays et loading */
      [data-theme="dark"] .loading-overlay {
        background-color: rgba(0, 0, 0, 0.8);
      }

      [data-theme="dark"] .loading-overlay-content {
        color: var(--text-white);
      }

      [data-theme="dark"] .custom-alert {
        border: 1px solid var(--border-color);
      }

      /* Application du th√®me aux en-t√™tes de tableau */
      [data-theme="dark"] .table thead tr:first-child th {
        background: var(--gradient-header) !important;
      }

      [data-theme="dark"] .table thead tr:first-child th:nth-child(1) {
        background-color: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
      }

      [data-theme="dark"] .table thead tr:nth-child(2) th {
        background-color: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
      }

      [data-theme="dark"] .table thead tr:nth-child(2) .sticky-col {
        background-color: var(--bg-secondary) !important;
      }

      /* Responsive pour Num√©ro TC(s), Lieus et Statut sur tablette/mobile */
      /* Responsive Num√©ro TC(s) : retour √† la ligne optimal tablette/mobile */
      @media (max-width: 900px) and (min-width: 660px) {
        [data-col-id="container_number"] {
          max-width: 220px !important;
          min-width: 140px !important;
          white-space: normal !important;
          word-break: break-word !important;
          text-align: center !important;
          vertical-align: middle !important;
          font-size: 0.98em !important;
          padding-left: 4px !important;
          padding-right: 4px !important;
        }
        [data-col-id="container_number"] .tc-number-responsive {
          display: block;
          white-space: normal !important;
          word-break: break-all !important;
          overflow-wrap: anywhere !important;
          font-size: 0.97em;
          line-height: 1.2;
        }
      }
      @media (max-width: 660px) {
        [data-col-id="container_number"] {
          max-width: 120px !important;
          min-width: 90px !important;
          font-size: 0.95em !important;
          white-space: normal !important;
          word-break: break-word !important;
          text-align: center !important;
          vertical-align: middle !important;
          padding-left: 2px !important;
          padding-right: 2px !important;
        }
        [data-col-id="container_number"] .tc-number-responsive {
          display: block;
          white-space: normal !important;
          word-break: break-all !important;
          overflow-wrap: anywhere !important;
          font-size: 0.93em;
          line-height: 1.15;
        }
      }

      [data-col-id="container_number"] .tc-pied {
        display: block;
        font-size: 0.98em;
        color: #222;
        margin-top: 0px;
        word-break: break-all;
      }
      /* Ajustement sp√©cifique pour la colonne Statuts pour √©viter la coupure du texte */
      [data-col-id*="statut"] {
        max-width: 240px !important;
        min-width: 150px !important;
      }

      @media (max-width: 600px) {
        [data-col-id="container_number"],
        [data-col-id="lieu"],
        [data-col-id*="statut"] {
          max-width: 120px !important;
          min-width: 90px !important;
          font-size: 0.95em !important;
          white-space: normal !important;
          word-break: break-word !important;
          text-align: center !important;
          vertical-align: middle !important;
          padding-left: 2px !important;
          padding-right: 2px !important;
        }
      }
      /* Boutons de suppression historique (sidebar)
   - .delete-history-btn.desktop-in : bouton dans la carte (desktop)
   - .delete-history-btn.mobile-out : bouton sous la carte (mobile)
   - .delete-history-btn-mobile-wrap : conteneur du bouton mobile
*/
      .delete-history-btn.desktop-in {
        background: none;
        border: none;
        color: #dc2626;
        font-size: 1.25em;
        cursor: pointer;
        padding: 0 6px 0 6px;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 2;
        display: inline-flex;
        align-items: center;
        transition: filter 0.18s;
      }
      .delete-history-btn.mobile-out {
        background: #f1f5f9;
        border: none;
        color: #dc2626;
        font-size: 1.1em;
        cursor: pointer;
        padding: 7px 16px;
        border-radius: 8px;
        box-shadow: 0 1px 4px #2563eb11;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
        margin-top: 2px;
      }
      .delete-history-btn-mobile-wrap {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 13px;
      }

      /* Par d√©faut, bouton mobile cach√©, bouton desktop visible */
      .delete-history-btn.desktop-in {
        display: inline-flex;
      }
      .delete-history-btn.mobile-out,
      .delete-history-btn-mobile-wrap {
        display: none;
      }

      @media (max-width: 600px) {
        .delete-history-btn.desktop-in {
          display: none !important;
        }
        .delete-history-btn.mobile-out,
        .delete-history-btn-mobile-wrap {
          display: flex !important;
        }
      }

      /* Responsive header, avatar, dropdown, filtres et tableau */
      @media (max-width: 900px) {
        .card-section
          > .d-flex.align-items-center.justify-content-between.flex-wrap {
          flex-direction: column;
          align-items: stretch !important;
          padding: 18px 8px 12px 8px !important;
          gap: 12px !important;
        }
        .card-section h1 {
          font-size: 1.25em !important;
        }
        .card-section > .d-flex > div {
          max-width: 100% !important;
        }
      }
      @media (max-width: 600px) {
        .card-section
          > .d-flex.align-items-center.justify-content-between.flex-wrap {
          flex-direction: column;
          align-items: stretch !important;
          padding: 10px 2vw 8px 2vw !important;
          gap: 8px !important;
        }
        .card-section h1 {
          font-size: 1.05em !important;
        }
        #profileAvatar {
          width: 44px !important;
          height: 44px !important;
        }
        #profileDropdown {
          min-width: 170px !important;
          padding: 12px 10px !important;
          top: 54px !important;
        }
        .card-section .scrolling-message-bar {
          max-width: 100vw !important;
          font-size: 0.95em;
        }
        .d-flex.justify-content-center.align-items-center.mb-3.flex-wrap.gap-2 {
          flex-direction: column !important;
          align-items: stretch !important;
          padding: 10px 2vw 6px 2vw !important;
          gap: 8px !important;
        }
        .d-flex.align-items-center.gap-2.flex-wrap {
          flex-direction: column !important;
          align-items: stretch !important;
          gap: 6px !important;
        }
        #searchInput,
        #mainTableDateStartFilter,
        #mainTableDateEndFilter {
          font-size: 0.98em !important;
          min-width: 80px !important;
          padding: 5px 8px !important;
        }
        #searchButton {
          font-size: 0.98em !important;
          padding: 5px 10px !important;
        }
      }

      /* Responsive tableau */
      #tableScrollContainer {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      @media (max-width: 900px) {
        .table th,
        .table td {
          padding: 0.45rem !important;
          font-size: 0.98em !important;
        }
        .table thead tr:first-child th {
          font-size: 0.98em !important;
        }
      }
      @media (max-width: 600px) {
        .table th,
        .table td {
          padding: 0.32rem 0.3rem !important;
          font-size: 0.93em !important;
          min-width: 90px;
        }
        .table thead tr:first-child th {
          font-size: 0.93em !important;
          padding-top: 4px !important;
          padding-bottom: 4px !important;
        }
        .table thead tr:nth-child(2) th {
          top: 32px !important;
        }
        .sticky-col-index {
          min-width: 38px !important;
          max-width: 48px !important;
        }
        .sticky-col-agent {
          min-width: 70px !important;
          max-width: 110px !important;
          left: 48px !important;
        }
        .table-responsive {
          border-radius: 8px !important;
        }
      }

      /* Pagination responsive */
      @media (max-width: 600px) {
        .pagination {
          font-size: 0.95em !important;
          gap: 2px !important;
        }
        .pagination .page-link {
          padding: 4px 8px !important;
        }
      }

      /* Overlay, alert, etc. responsive */
      @media (max-width: 600px) {
        .custom-alert {
          min-width: 140px !important;
          font-size: 0.98em !important;
          padding: 10px 8px !important;
        }
        .loading-overlay-content {
          font-size: 1em !important;
        }
        .confirm-box {
          padding: 14px !important;
          font-size: 0.98em !important;
        }
      }

      /* Styles pour l'alerte personnalis√©e (conserv√©s de votre version originale) */
      .custom-alert {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #f8d7da; /* Default background for error */
        color: #721c24; /* Default text color for error */
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: var(--shadow-card);
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-20px);
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out,
          visibility 0.5s linear 0.5s;
        z-index: 1000;
        min-width: 250px;
      }
      .custom-alert.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out,
          visibility 0.5s linear 0s;
      }
      .custom-alert.hide {
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      }
      .custom-alert.visually-hidden {
        display: none;
      }
      .custom-alert i {
        font-size: 20px;
      }
      /* Type colors for custom-alert */
      .custom-alert.success {
        background-color: #d4edda;
        color: #155724;
      }
      .custom-alert.error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .custom-alert.warning {
        background-color: #fff3cd;
        color: #856404;
      }
      .custom-alert.info {
        background-color: #d1ecf1;
        color: #0c5460;
      }

      /* Styles for confirmation overlay (conserv√©s de votre version originale) */
      .confirm-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
        display: flex;
        justify-content: center; /* Center horizontally */
        align-items: center; /* Center vertically */
        z-index: 1000; /* Ensure it's on top of other content */
      }
      .confirm-box {
        background-color: var(--bg-card);
        color: var(--text-primary);
        padding: 30px;
        border-radius: 10px;
        box-shadow: var(--shadow-dropdown);
        text-align: center;
        max-width: 400px;
        width: 90%; /* Responsive width */
        display: flex;
        flex-direction: column;
        gap: 20px;
        border: 1px solid var(--border-color);
      }
      .confirm-box p {
        font-size: 1.1rem;
        color: var(--text-primary);
        margin-bottom: 15px;
      }
      .confirm-box button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s ease;
        margin: 0 5px; /* Add some spacing between buttons */
      }
      .confirm-box button.btn-danger {
        background-color: #dc3545;
        color: white;
      }
      .confirm-box button.btn-danger:hover {
        background-color: #c82333;
      }
      .confirm-box button.btn-secondary {
        background-color: #6c757d;
        color: white;
      }
      .confirm-box button.btn-secondary:hover {
        background-color: #5a6268;
      }

      /* Styles pour la stabilit√© du tableau (conserv√©s de votre version originale) */
      .table {
        width: 100%;
        table-layout: auto; /* Permet aux colonnes de s'auto-ajuster au contenu */
      }
      .table th,
      .table td {
        vertical-align: top; /* Aligne le contenu en haut des cellules */
        padding: 0.75rem; /* Padding standard de Bootstrap */
        white-space: normal; /* Permet au texte de passer √† la ligne */
        word-break: break-word; /* Casse les mots longs pour √©viter le d√©bordement */
      }
      .sticky-col {
        position: sticky;
        z-index: 2; /* Plus haut que les cellules normales mais moins que les popups */
        background-color: #f8f9fa; /* Couleur de fond pour les colonnes fig√©es */
      }
      .sticky-col-index {
        left: 0;
        min-width: 50px; /* Largeur minimale pour la colonne N¬∞ */
        max-width: 70px; /* Largeur maximale pour la colonne N¬∞ */
      }
      .sticky-col-agent {
        /* Calcule le 'left' en fonction de la largeur de la colonne 'N¬∞' */
        left: 70px; /* Assumant 70px de largeur pour sticky-col-index */
        min-width: 120px; /* Largeur minimale pour le nom de l'agent */
        max-width: 180px; /* Largeur maximale pour le nom de l'agent */
      }
      .dropdown-cell-container .dropdown-toggle-button {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* NOUVEAUX STYLES POUR LES BANDEAUX COLOR√âS */
      .table thead tr:first-child th {
        border-bottom: none; /* Supprime la bordure inf√©rieure pour le bandeau */
        border-top: none; /* Supprime la bordure sup√©rieure */
        padding-top: 8px;
        padding-bottom: 8px;
        color: white; /* Couleur de texte par d√©faut pour les bandeaux */
        font-size: 1.1em;
        text-transform: uppercase;
        position: sticky; /* Rendre la ligne de bandeau fig√©e */
        top: 0; /* Coller en haut */
        z-index: 11; /* Plus haut que les en-t√™tes de colonnes normales */
        cursor: pointer; /* Indique que le bandeau est cliquable */
      }
      /* La premi√®re cellule du bandeau (pour N¬∞ et Date & Heure) reste neutre */
      .table thead tr:first-child th:nth-child(1) {
        background-color: #f8f9fa; /* Correspond √† l'arri√®re-plan de l'en-t√™te normal */
        color: #495057; /* Correspond √† la couleur de texte de l'en-t√™te normal */
        border-right: 1px solid #e9ecef; /* Conserver la bordure droite pour la s√©paration */
        cursor: default; /* Pas de curseur pointeur pour la premi√®re colonne */
      }
      /* Styles sp√©cifiques pour chaque bandeau */
      .table thead tr:first-child th:nth-child(2) {
        /* Agent Acconier (bleu) */
        background-color: #007bff; /* Bleu */
        border-right: none; /* Supprime la bordure droite pour fusionner avec le bandeau suivant */
      }
      .table thead tr:first-child th:nth-child(3) {
        /* Responsable Acconier (jaune) */
        background-color: #ffc107; /* Jaune */
        border-right: none; /* Supprime la bordure droite pour fusionner avec le bandeau suivant */
      }
      .table thead tr:first-child th:nth-child(4) {
        /* Responsable de livraison (vert) */
        background-color: #28a745; /* Vert */
        border-right: 1px solid #e9ecef; /* Assure une bordure droite */
      }

      /* Rendre la deuxi√®me ligne d'en-t√™te (vos en-t√™tes de colonnes originaux) fig√©e en dessous du bandeau */
      .table thead tr:nth-child(2) th {
        position: sticky;
        top: 40px; /* Ajuster cette valeur en fonction de la hauteur r√©elle du bandeau (environ 40px) */
        background-color: #f8f9fa; /* Assurez-vous que le fond correspond √† votre design */
        z-index: 10; /* Inf√©rieur aux colonnes sticky-col pour qu'elles soient au-dessus */
      }

      /* S'assurer que les en-t√™tes des colonnes fig√©es sont au-dessus de l'en-t√™te de table g√©n√©ral */
      .table thead tr:nth-child(2) .sticky-col {
        z-index: 12; /* Plus haut que le bandeau et l'en-t√™te de table g√©n√©ral */
      }

      /* Animation clignotement vert pour nouvelle ligne */
      @keyframes green-blink {
        0% {
          background-color: #bbf7d0;
        }
        20% {
          background-color: #4ade80;
        }
        40% {
          background-color: #bbf7d0;
        }
        60% {
          background-color: #4ade80;
        }
        80% {
          background-color: #bbf7d0;
        }
        100% {
          background-color: inherit;
        }
      }
      .row-blink-green {
        animation: green-blink 1.2s linear 0s 5;
      }

      /* Animation clignotement rouge pour ligne cibl√©e - forc√©e !important */
      @keyframes red-blink {
        0% {
          background-color: #fecaca !important;
          color: #b91c1c !important;
        }
        20% {
          background-color: #ef4444 !important;
          color: #b91c1c !important;
        }
        40% {
          background-color: #fecaca !important;
          color: #b91c1c !important;
        }
        60% {
          background-color: #ef4444 !important;
          color: #b91c1c !important;
        }
        80% {
          background-color: #fecaca !important;
          color: #b91c1c !important;
        }
        100% {
          background-color: inherit !important;
          color: inherit !important;
        }
      }
      .row-blink-red {
        animation: red-blink 1.2s linear 0s 5 !important;
      }

      /* Styles pour l'effet de mise en √©vidence */
      .highlight-cell {
        transition: background-color 0.3s ease-in-out; /* Transition douce pour l'effet de flash */
      }
      .highlight-blue-flash {
        background-color: rgba(
          0,
          123,
          255,
          0.2
        ) !important; /* Bleu avec opacit√© l√©g√®re */
      }
      .highlight-yellow-flash {
        background-color: rgba(
          255,
          193,
          7,
          0.2
        ) !important; /* Jaune avec opacit√© l√©g√®re */
      }
      .highlight-green-flash {
        background-color: rgba(
          40,
          167,
          69,
          0.2
        ) !important; /* Vert avec opacit√© l√©g√®re */
      }

      /* Responsive √©largissement de la carte et du tableau */
      @media (min-width: 1800px) {
        .card-section {
          width: 100vw !important;
          max-width: 100vw !important;
          margin: 0 !important;
          padding: 0 !important;
          border-radius: 0 !important;
        }
        #tableScrollContainer,
        #deliveriesTable {
          width: 100vw !important;
          max-width: 100vw !important;
          min-width: 1200px !important;
        }
      }
      @media (min-width: 1200px) and (max-width: 1799px) {
        .card-section {
          width: 100vw !important;
          max-width: 100vw !important;
          margin: 0 !important;
          padding: 0 !important;
          border-radius: 0 !important;
        }
        #tableScrollContainer,
        #deliveriesTable {
          width: 100vw !important;
          max-width: 100vw !important;
        }
      }
      @media (max-width: 1200px) {
        .card-section {
          width: 100vw !important;
          max-width: 100vw !important;
          margin: 0 !important;
          padding: 0 !important;
          border-radius: 0 !important;
        }
        #tableScrollContainer,
        #deliveriesTable {
          width: 100vw !important;
          max-width: 100vw !important;
        }
      }
      @media (max-width: 900px) {
        .card-section {
          width: 100vw !important;
          max-width: 100vw !important;
          margin: 0 !important;
          padding: 0 !important;
          border-radius: 0 !important;
        }
        #tableScrollContainer,
        #deliveriesTable {
          width: 100vw !important;
          max-width: 100vw !important;
        }
      }
      @media (max-width: 600px) {
        .card-section {
          width: 100vw !important;
          max-width: 100vw !important;
          margin: 0 !important;
          padding: 0 !important;
          border-radius: 0 !important;
        }
        #tableScrollContainer,
        #deliveriesTable {
          width: 100vw !important;
          max-width: 100vw !important;
        }
      }
    </style>
  </head>

  <body
    style="
      background: #ffffff !important;
      position: relative;
      min-height: 100vh;
    "
  >
    <div
      class="container-fluid p-0 m-0"
      style="
        background: #ffffff !important;
        min-width: 100vw;
        max-width: 100vw;
        z-index: 2;
        position: relative;
      "
    >
      <section
        class="card-section"
        style="width: 100%; max-width: 1200px; margin: 0 auto"
      >
        <!-- EN-T√äTE MODERNE AVEC AVATAR √Ä DROITE -->
        <div
          class="d-flex align-items-center justify-content-between flex-wrap gap-1 mb-1"
          style="
            background: var(--bg-card);
            border-radius: 12px;
            padding: 8px 14px 6px 14px;
            box-shadow: var(--shadow-card);
            position: relative;
          "
        >
          <div style="min-width: 0; flex: 1 1 0">
            <h1
              class="mb-1 main-title-acconier"
              style="
                font-size: 1.7em;
                font-weight: 700;
                color: var(--text-primary);
                letter-spacing: -1px;
              "
            >
              Tableau - Responsable Acconier
            </h1>
            <div
              class="main-subtitle-acconier"
              style="
                font-size: 1.13em;
                color: var(--text-secondary);
                font-weight: 500;
              "
            >
              Paiement de l'acconage des conteneurs
            </div>

            <!-- BANDEAU D'INFORMATION UTILISATEUR CIBL√â (affich√© quand redirig√© depuis le tableau de bord) -->
            <div
              id="targetUserInfoBanner"
              style="
                display: none;
                margin-top: 8px;
                padding: 8px 20px;
                background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 100%);
                border: 1px solid #2196f3;
                border-radius: 20px;
                box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
                width: 100%;
                max-width: 100%;
                min-height: 36px;
                align-items: center;
                justify-content: space-between;
              "
            >
              <div style="
                display: flex;
                align-items: center;
                gap: 15px;
                font-size: 0.9em;
                font-weight: 500;
                color: #1565c0;
                flex: 1;
                min-width: 0;
              ">
                <span style="
                  background: #2196f3;
                  color: white;
                  border-radius: 50%;
                  width: 24px;
                  height: 24px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 12px;
                  flex-shrink: 0;
                ">üéØ</span>
                
                <div id="targetUserDetails" style="
                  display: flex;
                  align-items: center;
                  gap: 15px;
                  flex: 1;
                  overflow: hidden;
                  white-space: nowrap;
                ">
                  <!-- Les d√©tails de l'utilisateur seront ins√©r√©s ici -->
                </div>
              </div>
              
              <button
                onclick="document.getElementById('targetUserInfoBanner').style.display='none'"
                style="
                  background: none;
                  border: none;
                  color: #1565c0;
                  font-size: 16px;
                  cursor: pointer;
                  padding: 4px;
                  border-radius: 50%;
                  width: 28px;
                  height: 28px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  flex-shrink: 0;
                "
                title="Fermer"
              >‚úï</button>
            </div>
                  ‚úï
                </button>
              </div>
            </div>
            <!-- BARRE DE D√âFILEMENT POUR LES AGENTS (conserv√©e) -->
            <div
              class="scrolling-message-bar"
              id="newAgentScrollingContainer"
              style="
                margin-top: 10px;
                max-width: 350px;
                width: 100%;
                overflow-x: auto;
              "
            >
              <div
                class="scrolling-message-content"
                id="newAgentScrollingContent"
              ></div>
            </div>
          </div>
          <div
            class="d-flex flex-column align-items-end flex-shrink-0"
            style="min-width: 60px; position: relative"
          >
            <div
              id="profileAvatar"
              style="
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: #e0e7ef;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px #2563eb22;
                cursor: pointer;
              "
            >
              <i
                class="fas fa-user"
                id="mainAvatarIcon"
                style="font-size: 2.1em; color: #2563eb"
              ></i>
              <img
                id="mainAvatarPhoto"
                src=""
                alt="Photo de profil"
                style="
                  display: none;
                  width: 100%;
                  height: 100%;
                  object-fit: cover;
                  position: absolute;
                  top: 0;
                  left: 0;
                  border-radius: 50%;
                  z-index: 1;
                "
              />
            </div>
            <!-- Dropdown profil -->
            <div
              id="profileDropdown"
              style="
                display: none;
                position: absolute;
                top: 76px;
                right: 0;
                min-width: 220px;
                background: var(--bg-dropdown);
                border-radius: 12px;
                box-shadow: var(--shadow-dropdown);
                padding: 18px 20px;
                z-index: 1001;
                border: 1px solid var(--border-color);
              "
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  margin-bottom: 10px;
                  position: relative;
                "
              >
                <span
                  id="profilePhotoCircle"
                  style="
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    width: 48px;
                    height: 48px;
                    border-radius: 50%;
                    background: linear-gradient(
                      135deg,
                      #2563eb 60%,
                      #1e293b 100%
                    );
                    box-shadow: 0 2px 8px #2563eb22;
                    overflow: hidden;
                    cursor: pointer;
                    position: relative;
                  "
                >
                  <i
                    class="fas fa-camera"
                    id="cameraIcon"
                    style="font-size: 1.5em; color: #fff; z-index: 2"
                  ></i>
                  <img
                    id="profilePhotoPreview"
                    src=""
                    alt="Photo de profil"
                    style="
                      display: none;
                      width: 100%;
                      height: 100%;
                      object-fit: cover;
                      position: absolute;
                      top: 0;
                      left: 0;
                      z-index: 1;
                    "
                  />
                  <button
                    id="removePhotoBtn"
                    title="Supprimer la photo"
                    style="
                      display: none;
                      position: absolute;
                      top: 2px;
                      right: 2px;
                      width: 22px;
                      height: 22px;
                      border-radius: 50%;
                      background: #fff;
                      border: none;
                      box-shadow: 0 1px 4px #2563eb22;
                      z-index: 3;
                      align-items: center;
                      justify-content: center;
                      padding: 0;
                      cursor: pointer;
                    "
                  >
                    <i
                      class="fas fa-times"
                      style="color: #2563eb; font-size: 1em"
                    ></i>
                  </button>
                </span>
                <input
                  type="file"
                  id="profilePhotoInput"
                  accept="image/*"
                  style="display: none"
                />
              </div>
              <div
                id="profileName"
                style="
                  font-weight: 600;
                  font-size: 1.08em;
                  color: var(--text-primary);
                "
              >
                Nom de l'utilisateur
              </div>
              <div
                id="profileEmail"
                style="font-size: 0.98em; color: var(--text-secondary)"
              >
                email@exemple.com
              </div>

              <!-- S√©lecteur de th√®me -->
              <div class="theme-selector">
                <div class="theme-toggle" id="themeToggle">
                  <button class="theme-option active" id="lightTheme">
                    <i class="fas fa-sun theme-icon"></i>Clair
                  </button>
                  <button class="theme-option" id="darkTheme">
                    <i class="fas fa-moon theme-icon"></i>Sombre
                  </button>
                </div>
              </div>

              <hr
                style="
                  margin: 12px 0 10px 0;
                  border: 0;
                  border-top: 1.5px solid var(--border-color);
                "
              />
              <button
                id="logoutBtn"
                class="btn btn-outline-danger w-100"
                style="font-size: 0.98em"
              >
                Se d√©connecter
              </button>
            </div>
          </div>
        </div>
        <script>
          // Affichage du menu profil au clic sur l'avatar et gestion photo profil
          window.addEventListener("DOMContentLoaded", function () {
            const avatar = document.getElementById("profileAvatar");
            const dropdown = document.getElementById("profileDropdown");
            const logoutBtn = document.getElementById("logoutBtn");
            const photoCircle = document.getElementById("profilePhotoCircle");
            const photoInput = document.getElementById("profilePhotoInput");
            const photoPreview = document.getElementById("profilePhotoPreview");
            const cameraIcon = document.getElementById("cameraIcon");
            const removePhotoBtn = document.getElementById("removePhotoBtn");
            const mainAvatarPhoto = document.getElementById("mainAvatarPhoto");
            const mainAvatarIcon = document.getElementById("mainAvatarIcon");

            // === GESTION DU TH√àME ===
            const lightThemeBtn = document.getElementById("lightTheme");
            const darkThemeBtn = document.getElementById("darkTheme");

            // Fonction pour appliquer le th√®me
            function applyTheme(theme) {
              if (theme === "dark") {
                document.documentElement.setAttribute("data-theme", "dark");
                lightThemeBtn.classList.remove("active");
                darkThemeBtn.classList.add("active");
                // Mettre √† jour le fond flottant
                const floatingBg = document.getElementById("floatingBlueBg");
                if (floatingBg) {
                  floatingBg.style.background = "var(--bg-floating)";
                }
              } else {
                document.documentElement.removeAttribute("data-theme");
                darkThemeBtn.classList.remove("active");
                lightThemeBtn.classList.add("active");
                // Mettre √† jour le fond flottant
                const floatingBg = document.getElementById("floatingBlueBg");
                if (floatingBg) {
                  floatingBg.style.background = "#1666e7";
                }
              }
              // Sauvegarder le th√®me dans localStorage
              localStorage.setItem("theme", theme);
            }

            // Charger le th√®me sauvegard√© ou utiliser le th√®me clair par d√©faut
            const savedTheme = localStorage.getItem("theme") || "light";
            applyTheme(savedTheme);

            // Gestionnaires d'√©v√©nements pour les boutons de th√®me
            if (lightThemeBtn) {
              lightThemeBtn.addEventListener("click", () =>
                applyTheme("light")
              );
            }
            if (darkThemeBtn) {
              darkThemeBtn.addEventListener("click", () => applyTheme("dark"));
            }

            // Affichage du menu profil
            if (avatar && dropdown) {
              avatar.onclick = function (e) {
                e.stopPropagation();
                dropdown.style.display =
                  dropdown.style.display === "block" ? "none" : "block";
              };
              document.addEventListener("click", function (e) {
                if (!dropdown.contains(e.target) && e.target !== avatar) {
                  dropdown.style.display = "none";
                }
              });
            }
            // Gestion photo de profil
            function updateMainAvatar(photoUrl) {
              if (mainAvatarPhoto && mainAvatarIcon) {
                if (photoUrl) {
                  mainAvatarPhoto.src = photoUrl;
                  mainAvatarPhoto.style.display = "block";
                  mainAvatarIcon.style.display = "none";
                } else {
                  mainAvatarPhoto.src = "";
                  mainAvatarPhoto.style.display = "none";
                  mainAvatarIcon.style.display = "block";
                }
              }
            }
            if (
              photoCircle &&
              photoInput &&
              photoPreview &&
              cameraIcon &&
              removePhotoBtn
            ) {
              // Affiche la photo si d√©j√† stock√©e
              const savedPhoto = localStorage.getItem("profilePhotoDataUrl");
              const showPhoto = (dataUrl) => {
                photoPreview.src = dataUrl;
                photoPreview.style.display = "block";
                cameraIcon.style.display = "none";
                removePhotoBtn.style.display = "flex";
                updateMainAvatar(dataUrl);
              };
              const hidePhoto = () => {
                photoPreview.src = "";
                photoPreview.style.display = "none";
                cameraIcon.style.display = "block";
                removePhotoBtn.style.display = "none";
                updateMainAvatar(null);
              };
              // Gestion d'erreur d'affichage d'image
              photoPreview.onerror = function () {
                hidePhoto();
                // Ne rien afficher pour √©viter le clignotement
              };
              if (mainAvatarPhoto) {
                mainAvatarPhoto.onerror = function () {
                  updateMainAvatar(null);
                  // Ne rien afficher pour √©viter le clignotement
                };
              }
              if (savedPhoto) {
                showPhoto(savedPhoto);
              } else {
                hidePhoto();
              }
              photoCircle.onclick = function (e) {
                e.stopPropagation();
                photoInput.value = "";
                photoInput.click();
              };
              photoInput.onchange = function (e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith("image/")) {
                  // Limite de taille (1,5 Mo)
                  const maxSize = 1.5 * 1024 * 1024; // 1,5 Mo
                  if (file.size > maxSize) {
                    hidePhoto();
                    showProfilePhotoError(
                      "Fichier trop volumineux (max 1,5 Mo)."
                    );
                    return;
                  }
                  const reader = new FileReader();
                  reader.onload = function (evt) {
                    // Teste si l'image est bien affichable
                    const testImg = new window.Image();
                    testImg.onload = function () {
                      try {
                        localStorage.setItem(
                          "profilePhotoDataUrl",
                          evt.target.result
                        );
                        showPhoto(evt.target.result);
                      } catch (err) {
                        hidePhoto();
                        showProfilePhotoError(
                          "Stockage insuffisant pour cette image."
                        );
                      }
                    };
                    testImg.onerror = function () {
                      hidePhoto();
                      // Ne rien afficher pour √©viter le clignotement
                    };
                    testImg.src = evt.target.result;
                  };
                  reader.readAsDataURL(file);
                } else {
                  hidePhoto();
                  showProfilePhotoError(
                    "Veuillez s√©lectionner un fichier image valide."
                  );
                }
              };
              removePhotoBtn.onclick = function (e) {
                e.stopPropagation();
                try {
                  localStorage.removeItem("profilePhotoDataUrl");
                } catch (err) {}
                hidePhoto();
              };
              // Message d'erreur pour la photo de profil
              function showProfilePhotoError(msg) {
                let err = document.getElementById("profilePhotoErrorMsg");
                if (!err) {
                  err = document.createElement("div");
                  err.id = "profilePhotoErrorMsg";
                  err.style.color = "#dc3545";
                  err.style.fontSize = "0.93em";
                  err.style.marginTop = "6px";
                  err.style.textAlign = "center";
                  photoCircle.parentNode.appendChild(err);
                }
                err.textContent = msg;
                setTimeout(() => {
                  if (err) err.textContent = "";
                }, 3500);
              }
            }
            if (logoutBtn) {
              logoutBtn.onclick = function (e) {
                e.preventDefault();
                window.location.href =
                  "https://plateformdesuivie-its-service-1cjx.onrender.com/html/auth.html#login";
              };
            }
            // Pour int√©gration future : remplacer ces valeurs dynamiquement apr√®s connexion
            // document.getElementById('profileName').textContent = 'Nom Pr√©nom';
            // document.getElementById('profileEmail').textContent = 'email@exemple.com';
          });
        </script>

        <div
          class="d-flex justify-content-center align-items-center mb-2 flex-wrap gap-2"
          style="
            background: var(--bg-filter);
            border-radius: 10px;
            padding: 8px 12px 6px 12px;
            box-shadow: var(--shadow-filter);
          "
        >
          <div
            class="d-flex align-items-center gap-2 flex-wrap"
            style="flex: 1 1 220px; min-width: 120px"
          >
            <span
              style="
                font-weight: 600;
                color: var(--text-primary);
                font-size: 1.08em;
              "
              >Filtrer du</span
            >
            <input
              type="date"
              id="mainTableDateStartFilter"
              style="
                padding: 6px 14px;
                border-radius: 8px;
                border: 1.5px solid var(--border-input);
                font-size: 1em;
                min-width: 80px;
                max-width: 100%;
                background: var(--bg-card);
                color: var(--text-primary);
              "
            />
            <span
              style="
                font-weight: 600;
                color: var(--text-primary);
                font-size: 1.08em;
              "
              >au</span
            >
            <input
              type="date"
              id="mainTableDateEndFilter"
              style="
                padding: 6px 14px;
                border-radius: 8px;
                border: 1.5px solid var(--border-input);
                font-size: 1em;
                min-width: 80px;
                max-width: 100%;
                background: var(--bg-card);
                color: var(--text-primary);
              "
            />
          </div>
          <div
            class="d-flex align-items-center gap-2 flex-wrap"
            style="flex: 1 1 260px; min-width: 120px; max-width: 100vw"
          >
            <i
              class="fas fa-search search-icon"
              style="color: #2563eb; font-size: 1.15em"
            ></i>
            <input
              type="search"
              id="searchInput"
              class="search-input"
              placeholder="Rechercher une livraison."
              aria-label="Recherche"
              style="
                flex: 1 1 80px;
                min-width: 80px;
                max-width: 100%;
                padding: 6px 12px;
                border-radius: 8px;
                border: 1.5px solid var(--border-input);
                font-size: 1em;
                background: var(--bg-card);
                color: var(--text-primary);
              "
            />
            <button
              id="searchButton"
              class="btn btn-primary"
              style="
                font-weight: 600;
                font-size: 1em;
                padding: 6px 22px;
                border-radius: 8px;
                background: var(--bg-button);
                border-color: var(--bg-button);
              "
            >
              Rechercher
            </button>
          </div>
        </div>

        <div
          id="tableScrollContainer"
          class="table-responsive overflow-x-auto"
          style="
            border-radius: 18px;
            box-shadow: var(--shadow-table);
            background: var(--bg-table);
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
          "
        >
          <table
            id="deliveriesTable"
            class="table table-bordered table-hover align-middle"
            style="
              width: 100%;
              max-width: 1200px;
              min-width: 900px;
              border-radius: 18px;
              table-layout: auto;
              margin: 0 auto;
            "
          >
            <thead>
              <tr>
                <th
                  colspan="31"
                  id="agentAcconierHeader"
                  class="header-agent-acconier"
                  style="
                    font-size: 1.25em;
                    font-weight: 700;
                    background: var(--gradient-header);
                    color: var(--text-white);
                    border-radius: 18px 18px 0 0;
                    letter-spacing: 1px;
                  "
                >
                  Responsable Acconier
                </th>
              </tr>
              <tr id="deliveriesTableHead">
                <th style="min-width: 36px; text-align: center">
                  <input type="checkbox" id="selectAllRowsCheckbox" />
                </th>
                <th style="min-width: 50px">N¬∞</th>
                <th style="min-width: 90px">Date</th>
                <th style="min-width: 120px">Agent</th>
                <th style="min-width: 120px">Client (Nom)</th>
                <th style="min-width: 110px">Client (T√©l)</th>
                <th style="min-width: 150px">Num√©ro TC(s)</th>
                <th style="min-width: 100px">Lieu</th>
                <th style="min-width: 110px">Type Conteneur (pied)</th>
                <th style="min-width: 110px">Contenu</th>
                <th style="min-width: 110px">N¬∞ D√©claration</th>
                <th style="min-width: 110px">N¬∞ BL</th>
                <th style="min-width: 110px">N¬∞ Dossier</th>
                <th style="min-width: 110px">Nombre de conteneurs</th>
                <th style="min-width: 120px">Compagnie Maritime</th>
                <th style="min-width: 90px">Poids</th>
                <th style="min-width: 110px">Nom du navire</th>
                <th style="min-width: 90px">Circuit</th>
                <th style="min-width: 150px">Mode de Transport</th>
                <th style="min-width: 150px">Statut Dossier</th>
                <th style="min-width: 120px">Observation</th>
              </tr>
            </thead>

            <tbody id="deliveriesTableBody">
              <!-- Les lignes seront g√©n√©r√©es dynamiquement par JS -->
              <tr>
                <td
                  colspan="31"
                  class="text-center text-muted"
                  style="font-size: 1.08em; padding: 32px 0"
                >
                  <i class="fas fa-spinner fa-spin me-2"></i> Chargement des
                  livraisons...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <nav aria-label="Pagination livraisons" class="mt-3">
          <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>

        <div
          id="noDeliveriesMessage"
          class="text-center mt-3 text-muted d-none"
        >
          <i class="fas fa-box-open me-1"></i> Aucune livraison enregistr√©e pour
          le moment.
        </div>
      </section>
    </div>
    <p id="countdownMessage" class="countdown-message d-none"></p>
    <!-- Fond bleu flottant qui occupe le reste du body, sans couper la bo√Æte -->
    <div
      id="floatingBlueBg"
      style="
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100vw;
        height: 0;
        z-index: -1;
        background: #1666e7;
        pointer-events: none;
        display: none;
      "
    ></div>

    <!-- IMPORTANT: J'ai ajout√© cet √©l√©ment, il √©tait r√©f√©renc√© dans votre JS mais manquant dans le HTML -->
    <div id="loadingOverlay" class="loading-overlay d-none">
      <div class="loading-overlay-content">
        <i class="fas fa-spinner fa-spin loading-spinner-large mb-3"></i>
        <p class="loading-overlay-text">Chargement...</p>
      </div>
    </div>

    <div id="customAlert" class="custom-alert">
      <h3 id="customAlertTitle" class="custom-alert-title"></h3>
      <p id="customAlertMessage" class="custom-alert-message"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script de gestion du mode admin (doit √™tre charg√© AVANT le script principal) -->
    <script src="../js/adminModeManager.js"></script>

    <script src="../js/scriptRespAcconier.js"></script>
    <style>
      /* Fond bleu flottant responsive, d√©sactiv√© pour √©viter de cacher le contenu */
      #floatingBlueBg {
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100vw;
        height: 0;
        z-index: -1;
        background: var(--bg-floating);
        pointer-events: none;
        transition: background-color 0.3s ease;
        display: none;
      }
      @media (max-width: 900px) {
        #floatingBlueBg {
          height: 100vh;
        }
      }
      @media (max-width: 600px) {
        #floatingBlueBg {
          display: none;
        }
      }
    </style>
    <script>
      // Injection du nom et email dans l'avatar et le dropdown profil apr√®s connexion
      document.addEventListener("DOMContentLoaded", function () {
        const userName = localStorage.getItem("userName");
        const userEmail = localStorage.getItem("userEmail");
        if (userName && userEmail) {
          // Affiche le nom et l'email dans le dropdown profil
          const nameEl = document.getElementById("profileName");
          const emailEl = document.getElementById("profileEmail");
          if (nameEl) nameEl.textContent = userName;
          if (emailEl) emailEl.textContent = userEmail;
          // Avatar avec initiales (overlay sur l'ic√¥ne FontAwesome)
          const avatarEl = document.getElementById("profileAvatar");
          if (avatarEl) {
            let initials = userName
              .split(" ")
              .map((w) => w[0])
              .join("")
              .toUpperCase();
            if (initials.length > 2) initials = initials.slice(0, 2);
            // Cherche l'ic√¥ne FontAwesome d√©j√† pr√©sente
            let icon = avatarEl.querySelector("i.fas.fa-user");
            if (!icon) {
              icon = document.createElement("i");
              icon.className = "fas fa-user";
              icon.style.fontSize = "2.1em";
              icon.style.color = "#2563eb";
              avatarEl.appendChild(icon);
            }
            // Ajoute les initiales en overlay (position absolue)
            let initialsSpan = avatarEl.querySelector(".avatar-initials");
            if (!initialsSpan) {
              initialsSpan = document.createElement("span");
              initialsSpan.className = "avatar-initials";
              initialsSpan.style.position = "absolute";
              initialsSpan.style.right = "8px";
              initialsSpan.style.bottom = "8px";
              initialsSpan.style.fontSize = "1.1em";
              initialsSpan.style.fontWeight = "700";
              initialsSpan.style.color = "#2563eb";
              initialsSpan.style.background = "#fff";
              initialsSpan.style.borderRadius = "50%";
              initialsSpan.style.padding = "2px 7px";
              initialsSpan.style.boxShadow = "0 1px 4px #2563eb22";
              avatarEl.appendChild(initialsSpan);
            }
            initialsSpan.textContent = initials;
            avatarEl.style.position = "relative";
          }
        }
      });
    </script>
    <script>
      // --- Flash sur la ligne du dossier cibl√© depuis le dashboard ---
      document.addEventListener("DOMContentLoaded", function () {
        // Fonction utilitaire pour r√©cup√©rer le param√®tre dossier dans l'URL
        function getParam(name) {
          const url = new URL(window.location.href);
          return url.searchParams.get(name);
        }
        const dossierId = getParam("dossier");
        if (dossierId) {
          // Fonction pour flasher la ligne en rouge (sur chaque cellule)
          function flashRow(row) {
            if (!row) return;
            let count = 0;
            const maxFlashes = 5;
            const tds = Array.from(row.cells);
            function doFlash() {
              tds.forEach((td) => td.classList.add("row-blink-red"));
              setTimeout(() => {
                tds.forEach((td) => td.classList.remove("row-blink-red"));
                count++;
                if (count < maxFlashes) setTimeout(doFlash, 180);
              }, 180);
            }
            doFlash();
            // Scroll vers la ligne
            row.scrollIntoView({ behavior: "smooth", block: "center" });
          }
          // Attend que le tableau soit charg√©
          function tryHighlight() {
            const tbody = document.getElementById("deliveriesTableBody");
            if (!tbody) return;
            // Cherche la ligne qui contient l'identifiant du dossier
            let foundRow = null;
            Array.from(tbody.rows).forEach((tr) => {
              Array.from(tr.cells).forEach((td) => {
                if (
                  td.textContent &&
                  td.textContent.trim().includes(dossierId)
                ) {
                  foundRow = tr;
                }
              });
            });
            if (foundRow) {
              flashRow(foundRow);
            } else {
              // Si pas trouv√©, r√©essaie apr√®s un court d√©lai (cas o√π le tableau se charge en asynchrone)
              setTimeout(tryHighlight, 400);
            }
          }
          tryHighlight();
        }
      });
    </script>

    <!-- === SYST√àME DE TRACKING DES UTILISATEURS CONNECT√âS ======== -->
    <script>
      (function () {
        // D√©tection automatique de l'URL backend
        function getApiBaseUrl() {
          const isLocal = ["localhost", "127.0.0.1"].includes(
            window.location.hostname
          );
          if (isLocal) {
            return "http://localhost:3000";
          } else {
            return window.location.origin;
          }
        }

        const API_BASE_URL = getApiBaseUrl();

        // R√©cup√©rer les informations utilisateur depuis localStorage
        function getUserInfo() {
          const userName = localStorage.getItem("userName") || "Utilisateur";
          const userEmail = localStorage.getItem("userEmail") || "";
          const userId = userEmail || "user_" + Date.now();

          return {
            userId: userId,
            username: userName,
            nom: userName,
          };
        }

        // Envoyer un heartbeat au serveur
        function sendHeartbeat() {
          const userInfo = getUserInfo();

          fetch(`${API_BASE_URL}/api/active-users/heartbeat`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              page: "resp_acconier.html",
              userId: userInfo.userId,
              username: userInfo.username,
              nom: userInfo.nom,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log(
                  "‚úÖ [HEARTBEAT] Utilisateur enregistr√© comme actif sur resp_acconier.html"
                );
              }
            })
            .catch((error) => {
              console.warn(
                "‚ö†Ô∏è [HEARTBEAT] Erreur lors de l'envoi du heartbeat:",
                error
              );
            });
        }

        // Envoyer un heartbeat imm√©diatement au chargement de la page
        setTimeout(sendHeartbeat, 2000);

        // Envoyer un heartbeat toutes les 30 secondes
        setInterval(sendHeartbeat, 30000);

        // Envoyer un heartbeat quand l'utilisateur devient actif
        ["click", "keypress", "mousemove", "scroll"].forEach((eventType) => {
          document.addEventListener(
            eventType,
            () => {
              clearTimeout(window.heartbeatTimeout);
              window.heartbeatTimeout = setTimeout(sendHeartbeat, 1000);
            },
            { passive: true }
          );
        });

        console.log(
          "‚úÖ [TRACKING] Syst√®me de tracking utilisateur initialis√© pour resp_acconier.html"
        );
      })();

      // === SYST√àME DE TRACKING DES UTILISATEURS CONNECT√âS ===
      (function () {
        const API_BASE_URL =
          "https://plateformdesuivie-its-service-1cjx.onrender.com";

        // R√©cup√©rer les informations utilisateur depuis localStorage
        function getUserInfo() {
          const userName = localStorage.getItem("userName") || "Utilisateur";
          const userEmail = localStorage.getItem("userEmail") || "";
          const userId =
            localStorage.getItem("userId") || userEmail || "user_" + Date.now();

          return {
            userId: userId,
            username: userName,
            nom: userName,
          };
        }

        // Envoyer un heartbeat au serveur
        function sendHeartbeat() {
          const userInfo = getUserInfo();

          fetch(`${API_BASE_URL}/api/active-users/heartbeat`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              page: "resp_acconier.html",
              userId: userInfo.userId,
              username: userInfo.username,
              nom: userInfo.nom,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log(
                  "‚úÖ [HEARTBEAT] Utilisateur enregistr√© comme actif sur resp_acconier.html"
                );
              }
            })
            .catch((error) => {
              console.warn(
                "‚ö†Ô∏è [HEARTBEAT] Erreur lors de l'envoi du heartbeat:",
                error
              );
            });
        }

        // Envoyer un heartbeat imm√©diatement au chargement de la page
        setTimeout(sendHeartbeat, 2000);

        // Envoyer un heartbeat toutes les 30 secondes
        setInterval(sendHeartbeat, 30000);

        // Envoyer un heartbeat quand l'utilisateur devient actif
        ["click", "keypress", "mousemove", "scroll"].forEach((eventType) => {
          document.addEventListener(
            eventType,
            () => {
              clearTimeout(window.heartbeatTimeout);
              window.heartbeatTimeout = setTimeout(sendHeartbeat, 1000);
            },
            { passive: true }
          );
        });

        console.log(
          "‚úÖ [ACTIVE USERS] Syst√®me de tracking des utilisateurs connect√©s activ√© pour resp_acconier.html"
        );
      })();
    </script>

    <!-- SCRIPT POUR AFFICHER LES INFORMATIONS DE L'UTILISATEUR CIBL√â -->
    <script>
      (function () {
        // Fonction pour afficher les informations de l'utilisateur cibl√©
        function showTargetUserInfo() {
          const banner = document.getElementById("targetUserInfoBanner");
          const detailsDiv = document.getElementById("targetUserDetails");

          if (!banner || !detailsDiv) return;

          // V√©rifier les param√®tres URL
          const urlParams = new URLSearchParams(window.location.search);
          const fromDashboard = urlParams.get("fromDashboard");
          const targetUser = urlParams.get("targetUser");
          const userId = urlParams.get("userId");

          // V√©rifier localStorage
          const targetUserInfo = localStorage.getItem("targetUserInfo");
          let userInfo = null;

          if (targetUserInfo) {
            try {
              userInfo = JSON.parse(targetUserInfo);
              // V√©rifier si l'info n'est pas trop ancienne (30 secondes max)
              if (Date.now() - userInfo.redirectTime > 30000) {
                localStorage.removeItem("targetUserInfo");
                userInfo = null;
              }
            } catch (e) {
              localStorage.removeItem("targetUserInfo");
            }
          }

          // Afficher les informations si disponibles
          if ((fromDashboard === "true" && targetUser) || userInfo) {
            const displayName =
              userInfo?.userName || targetUser || "Utilisateur inconnu";
            const displayUserId =
              userInfo?.userId || userId || "ID non disponible";
            const pageType = userInfo?.pageType || "Responsable Acconier";

            detailsDiv.innerHTML = `
              <span><strong>Page de l'utilisateur connect√©</strong></span>
              <span style="color: #1976d2;">‚Ä¢</span>
              <span><strong>üë§</strong> ${displayName}</span>
              <span style="color: #1976d2;">‚Ä¢</span>
              <span><strong>üÜî</strong> ${displayUserId}</span>
              <span style="color: #1976d2;">‚Ä¢</span>
              <span><strong>üìã</strong> ${pageType}</span>
            `;

            banner.style.display = "flex";

            console.log(
              "üéØ [TARGET USER] Affichage des informations utilisateur:",
              {
                displayName,
                displayUserId,
                pageType,
              }
            );

            // Auto-masquer apr√®s 15 secondes
            setTimeout(() => {
              banner.style.display = "none";
            }, 15000);
          }
        }

        // Ex√©cuter au chargement de la page
        document.addEventListener("DOMContentLoaded", showTargetUserInfo);

        // Ex√©cuter imm√©diatement si la page est d√©j√† charg√©e
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", showTargetUserInfo);
        } else {
          showTargetUserInfo();
        }
      })();
    </script>
  </body>
</html>
<!--djkhfbzqjd-->
