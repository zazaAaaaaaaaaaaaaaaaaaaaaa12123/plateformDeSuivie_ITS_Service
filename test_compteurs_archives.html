<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Compteurs Archives</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
      }
      .counter {
        display: inline-block;
        margin: 10px;
        padding: 10px 15px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
      }
      .counter.orange {
        background: #ff8c00;
      }
      .counter.blue {
        background: #007bff;
      }
      .counter.green {
        background: #28a745;
      }
      .counter.red {
        background: #dc3545;
      }
      .counter.purple {
        background: #6f42c1;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .log {
        background: #f8f9fa;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”„ Test Compteurs Archives vs Dashboard</h1>

      <h3>ğŸ“Š Compteurs Dashboard (attendus)</h3>
      <div>
        <span class="counter orange" id="dashCard1"
          >Dossiers soumis: <span id="dashCount1">168</span></span
        >
        <span class="counter blue" id="dashCard2"
          >Mis en livraison: <span id="dashCount2">78</span></span
        >
        <span class="counter green" id="dashCard3"
          >Dossiers livrÃ©s: <span id="dashCount3">50</span></span
        >
      </div>

      <h3>ğŸ“ Compteurs Archives (calculÃ©s)</h3>
      <div>
        <span class="counter orange" id="archCount1"
          >Toutes archives: <span id="archVal1">-</span></span
        >
        <span class="counter blue" id="archCount2"
          >Mis en livraison: <span id="archVal2">-</span></span
        >
        <span class="counter green" id="archCount3"
          >Dossiers livrÃ©s: <span id="archVal3">-</span></span
        >
        <span class="counter red" id="archCount4"
          >SupprimÃ©s: <span id="archVal4">-</span></span
        >
        <span class="counter purple" id="archCount5"
          >Ordres: <span id="archVal5">-</span></span
        >
      </div>

      <div style="margin: 20px 0">
        <button onclick="testSynchronization()">
          ğŸ”„ Tester Synchronisation
        </button>
        <button onclick="testApiDeliveries()">
          ğŸ“¡ Test API /deliveries/status
        </button>
        <button onclick="clearLog()">ğŸ—‘ï¸ Vider Log</button>
      </div>

      <div class="log" id="logArea"></div>
    </div>

    <script>
      let logEntries = [];

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const entry = `[${timestamp}] ${message}`;
        logEntries.push(entry);
        document.getElementById("logArea").innerHTML = logEntries
          .slice(-50)
          .join("\n");
        document.getElementById("logArea").scrollTop =
          document.getElementById("logArea").scrollHeight;
        console.log(entry);
      }

      // Copie de la fonction calculateCountsFromDeliveries
      function calculateCountsFromDeliveries(deliveries) {
        log(`ğŸ“‹ Calcul compteurs Ã  partir de ${deliveries.length} livraisons`);

        const counts = {
          en_attente_paiement: deliveries.length, // TOTAL des dossiers soumis
          mise_en_livraison: 0,
          livres: 0,
          en_retard: 0,
        };

        deliveries.forEach((delivery, index) => {
          // Debug pour quelques dossiers
          if (index < 3) {
            log(
              `[DEBUG] Dossier ${delivery.dossier_number}: statut_acconier=${delivery.delivery_status_acconier}, visible_resp_acconier=${delivery.visible_resp_acconier}`
            );
          }

          let isLivre = false;

          // MÃ©thode principale: vÃ©rifier visible_resp_acconier
          if (delivery.visible_resp_acconier === false) {
            isLivre = true;
          }

          // MÃ©thode alternative: vÃ©rifier les statuts de conteneurs s'ils existent
          if (!isLivre && delivery.container_statuses) {
            Object.values(delivery.container_statuses).forEach((status) => {
              if (status === "livre" || status === "livrÃ©") {
                isLivre = true;
              }
            });
          }

          // Compter selon les catÃ©gories
          if (isLivre) {
            counts.livres++;
          } else if (
            delivery.delivery_status_acconier === "mise_en_livraison_acconier"
          ) {
            counts.mise_en_livraison++;
          }

          // Compter les dossiers en retard
          if (delivery.created_at) {
            const diffDays = Math.floor(
              (new Date() - new Date(delivery.created_at)) /
                (1000 * 60 * 60 * 24)
            );
            if (diffDays > 2 && !isLivre) {
              counts.en_retard++;
            }
          }
        });

        log(`ğŸ“Š Compteurs calculÃ©s:`);
        log(`  - Total dossiers soumis: ${counts.en_attente_paiement}`);
        log(`  - Mis en livraison: ${counts.mise_en_livraison}`);
        log(`  - LivrÃ©s: ${counts.livres}`);
        log(`  - En retard: ${counts.en_retard}`);

        return counts;
      }

      async function testApiDeliveries() {
        try {
          log("ğŸ“¡ Test API /deliveries/status (utilisÃ©e par les cartes)...");

          const response = await fetch("/deliveries/status");
          const data = await response.json();

          if (data.success && data.deliveries) {
            log(
              `âœ… API /deliveries/status: ${data.deliveries.length} dossiers`
            );

            const counts = calculateCountsFromDeliveries(data.deliveries);

            // Mettre Ã  jour l'affichage archives
            document.getElementById("archVal1").textContent =
              counts.en_attente_paiement;
            document.getElementById("archVal2").textContent =
              counts.mise_en_livraison;
            document.getElementById("archVal3").textContent = counts.livres;

            // Comparer avec l'API status-counts (qui donne de mauvaises valeurs)
            log("ğŸ“¡ Test API /api/deliveries/status-counts (incorrecte)...");
            const statusCountsResponse = await fetch(
              "/api/deliveries/status-counts"
            );
            const statusCountsData = await statusCountsResponse.json();

            if (statusCountsData.success) {
              log("ğŸ” COMPARAISON des sources:");
              log(`  Source CORRECTE (/deliveries/status):`);
              log(`    - Dossiers soumis: ${counts.en_attente_paiement}`);
              log(`    - Mis en livraison: ${counts.mise_en_livraison}`);
              log(`    - LivrÃ©s: ${counts.livres}`);

              log(`  Source INCORRECTE (/api/deliveries/status-counts):`);
              log(
                `    - en_attente_paiement: ${statusCountsData.counts.en_attente_paiement}`
              );
              log(
                `    - mise_en_livraison: ${statusCountsData.counts.mise_en_livraison}`
              );
              log(`    - livres: ${statusCountsData.counts.livres}`);

              log("ğŸ“‹ CONCLUSION:");
              log(`  Les cartes affichent 168/78/50 (source correcte)`);
              log(
                `  L'API status-counts retourne ${statusCountsData.counts.en_attente_paiement}/${statusCountsData.counts.mise_en_livraison}/${statusCountsData.counts.livres} (source incorrecte)`
              );
              log(`  Les archives doivent utiliser la source CORRECTE!`);
            }

            // Tester les APIs archives pour supprimÃ©s et ordres
            const [suppressionData, ordreData] = await Promise.all([
              fetch("/api/archives?action_type=suppression&limit=1").then((r) =>
                r.json()
              ),
              fetch(
                "/api/archives?action_type=ordre_livraison_etabli&limit=1"
              ).then((r) => r.json()),
            ]);

            document.getElementById("archVal4").textContent =
              suppressionData.pagination?.totalItems || 0;
            document.getElementById("archVal5").textContent =
              ordreData.pagination?.totalItems || 0;

            log("âœ… Tous les compteurs archives mis Ã  jour");

            // VÃ©rifier la correspondance avec les VRAIES cartes (168/78/50)
            const realDashboardValues = {
              soumis: 168, // Valeur RÃ‰ELLE affichÃ©e dans la carte
              mise_en_livraison: 78, // Valeur RÃ‰ELLE affichÃ©e dans la carte
              livres: 50, // Valeur RÃ‰ELLE affichÃ©e dans la carte
            };

            log("ğŸ” VÃ©rification correspondance avec les VRAIES cartes:");
            log(`  Cartes RÃ‰ELLES vs Archives calculÃ©es:`);
            log(
              `  Soumis: ${realDashboardValues.soumis} vs ${
                counts.en_attente_paiement
              } ${
                realDashboardValues.soumis === counts.en_attente_paiement
                  ? "âœ…"
                  : "âŒ"
              }`
            );
            log(
              `  Mis en livraison: ${
                realDashboardValues.mise_en_livraison
              } vs ${counts.mise_en_livraison} ${
                realDashboardValues.mise_en_livraison ===
                counts.mise_en_livraison
                  ? "âœ…"
                  : "âŒ"
              }`
            );
            log(
              `  LivrÃ©s: ${realDashboardValues.livres} vs ${counts.livres} ${
                realDashboardValues.livres === counts.livres ? "âœ…" : "âŒ"
              }`
            );

            if (
              realDashboardValues.soumis !== counts.en_attente_paiement ||
              realDashboardValues.mise_en_livraison !==
                counts.mise_en_livraison ||
              realDashboardValues.livres !== counts.livres
            ) {
              log(
                "âš ï¸ ATTENTION: Il y a une diffÃ©rence entre les cartes affichÃ©es et nos calculs!"
              );
              log(
                "   Les cartes utilisent peut-Ãªtre une logique diffÃ©rente ou des donnÃ©es filtrÃ©es."
              );
            } else {
              log(
                "ğŸ‰ PARFAIT: Synchronisation exacte avec les cartes du dashboard!"
              );
            }
          } else {
            log("âŒ Erreur dans la rÃ©ponse API");
          }
        } catch (error) {
          log(`âŒ Erreur: ${error.message}`);
        }
      }

      async function testSynchronization() {
        log("ğŸ”„ Test de synchronisation archives...");

        // Simuler la mÃ©thode updateCounts des archives
        await testApiDeliveries();

        log("âœ… Test de synchronisation terminÃ©");
      }

      function clearLog() {
        logEntries = [];
        document.getElementById("logArea").innerHTML = "";
      }

      // Auto-test au chargement
      document.addEventListener("DOMContentLoaded", () => {
        log("ğŸš€ Page de test chargÃ©e");
        setTimeout(testSynchronization, 1000);
      });
    </script>
  </body>
</html>
